<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FC KELAPA GADING - SYSTEM</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00F0FF">
    
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;500;700&family=Rajdhani:wght@500;600;700;800;900&family=Orbitron:wght@700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* === TEMA DARK NEON CYBERPUNK === */
        :root { 
            --bg: #050A15; 
            --primary: #00F0FF;       
            --primary-dim: rgba(0, 240, 255, 0.15);
            --primary-glow: 0 0 15px rgba(0, 240, 255, 0.5);
            --accent: #FF003C;        
            --accent-glow: 0 0 15px rgba(255, 0, 60, 0.5);
            --gold: #FFD700;
            --font-tech: 'Rajdhani', sans-serif;
            --font-num: 'Teko', sans-serif;
            --font-head: 'Orbitron', sans-serif;
            --ornament-display: none;
            --bg-pattern: linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px),
                          linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
            
            /* Warna Slot Default */
            --slot-active-bg: rgba(0, 240, 255, 0.05);
            --slot-border: var(--primary);
        }

        /* === TEMA RAMADAN (AKTIF TGL 20 FEB 2026) === */
        body.ramadan-mode {
            --primary: #00FF88; /* Hijau Neon */
            --primary-dim: rgba(0, 255, 136, 0.15);
            --primary-glow: 0 0 15px rgba(0, 255, 136, 0.5);
            --bg: #05100A;      /* Hijau Sangat Gelap */
            --ornament-display: block;
            --bg-pattern: linear-gradient(rgba(0,255,136,0.03) 1px, transparent 1px),
                          linear-gradient(90deg, rgba(0,255,136,0.03) 1px, transparent 1px),
                          radial-gradient(rgba(255,215,0,0.1) 1px, transparent 2px);
            
            /* Warna Slot Ramadan (Hijau Emas) */
            --slot-active-bg: rgba(0, 255, 136, 0.05);
            --slot-border: #FFD700; /* Border Emas */
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        
        body { 
            font-family: var(--font-tech); 
            background-color: var(--bg);
            background-image: var(--bg-pattern);
            background-size: 30px 30px, 30px 30px, 60px 60px;
            color: #fff; margin: 0; padding: 15px 20px 40px 20px; 
            min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
            transition: all 0.5s ease;
        }

        /* --- ORNAMEN GANTUNG ATAS --- */
        .ramadan-ornaments { display: var(--ornament-display); pointer-events: none; position: absolute; width: 100%; height: 200px; top:0; left:0; z-index: 1; overflow: hidden; }
        .hanging-item { position: absolute; top: -10px; display: flex; flex-direction: column; align-items: center; transform-origin: top center; animation: swing 3s infinite ease-in-out alternate; }
        .hi-string { width: 1px; height: 30px; background: var(--gold); box-shadow: 0 0 10px var(--gold);}
        .hi-body { color: var(--gold); filter: drop-shadow(0 0 10px var(--gold)); font-size: 20px; }
        .pos-1 { left: 20px; animation-delay: 0.2s; } .pos-2 { right: 20px; animation-delay: 0.5s; }
        @keyframes swing { 0% { transform: rotate(5deg); } 100% { transform: rotate(-5deg); } }

        /* --- HEADER --- */
        .header { text-align: center; margin-bottom: 30px; margin-top: 10px; cursor: pointer; position: relative; z-index: 5; } 
        .main-title { font-family: var(--font-tech); font-weight: 900; font-size: 42px; line-height: 0.9; color: #fff; text-shadow: var(--primary-glow); letter-spacing: 2px; text-transform: uppercase; }
        .sub-title { font-family: var(--font-head); font-size: 10px; color: var(--primary); letter-spacing: 4px; font-weight: 800; text-transform: uppercase; margin-top: 10px; background: rgba(0,0,0,0.5); border:1px solid var(--primary); padding: 4px 15px; display: inline-block; box-shadow: var(--primary-glow); backdrop-filter: blur(5px);}

        /* --- SLOT CONTAINER & CARDS (CYBERPUNK GLASS) --- */
        .slot-container { display: flex; flex-direction: column; gap: 12px; width: 100%; position: relative; z-index: 5; }
        
        .armor-card { 
            width: 100%; min-height: 95px; position: relative; 
            background: rgba(10, 15, 30, 0.85); backdrop-filter: blur(10px);
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px); 
            margin-bottom: 2px; transition: all 0.3s; 
        }
        
        /* Garis Tepi Slot */
        .armor-card::before { 
            content: ''; position: absolute; inset: 0; 
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1); pointer-events: none; z-index: 1; 
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px); 
        }
        
        /* Slot Aktif */
        .armor-card.active { background: var(--slot-active-bg); box-shadow: inset 0 0 20px var(--primary-dim); }
        .armor-card.active::before { box-shadow: inset 0 0 0 2px var(--slot-border); filter: drop-shadow(var(--primary-glow)); }

        /* --- DEKORASI KHUSUS RAMADAN DI DALAM BOX (BULAN SABIT) --- */
        .ramadan-box-decor {
            display: none;
            position: absolute; top: 5px; right: 8px; z-index: 0;
            font-size: 40px; color: rgba(255, 215, 0, 0.1);
            transform: rotate(-15deg); pointer-events: none;
        }
        body.ramadan-mode .ramadan-box-decor { display: block; }
        body.ramadan-mode .armor-card.active .ramadan-box-decor {
            color: rgba(255, 215, 0, 0.4);
            filter: drop-shadow(0 0 10px rgba(255,215,0,0.3));
            animation: pulseMoon 3s infinite alternate;
        }

        .armor-inner { display: flex; align-items: center; height: 100%; width: 100%; padding: 0; position: relative; z-index: 2; }
        .armor-num { width: 60px; height: 95px; display: flex; align-items: center; justify-content: center; font-family: var(--font-tech); font-weight: 800; font-size: 36px; color: rgba(255,255,255,0.2); background: rgba(0,0,0,0.4); border-right: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
        .armor-card.active .armor-num { color: var(--primary); text-shadow: var(--primary-glow); border-right: 1px solid var(--primary); background: rgba(0,240,255,0.05); }
        .armor-info { flex: 1; padding: 0 12px; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .info-name { font-family: var(--font-head); font-weight: 700; font-size: 10px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: var(--primary-glow);}
        .info-plat { font-family: var(--font-num); font-size: 32px; line-height: 0.9; color: #fff; letter-spacing: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 0 10px rgba(255,255,255,0.3);}
        
        .armor-badge { width: 100px; flex-shrink: 0; height: 100%; display: flex; align-items: center; justify-content: center; padding-right: 15px; }

        /* --- QUEUE BAR --- */
        .queue-bar-wrapper { width: 100%; margin-bottom: 25px; cursor: pointer; position: relative; z-index: 5; }
        .queue-bar { background: rgba(10, 15, 30, 0.9); backdrop-filter: blur(5px); clip-path: polygon(0 0, 100% 0, 95% 100%, 0% 100%); border-left: 6px solid var(--primary); padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--primary-glow); border-top: 1px solid rgba(0,240,255,0.2); border-bottom: 1px solid rgba(0,240,255,0.2); }
        .qb-lbl { font-size: 11px; color: var(--primary); letter-spacing: 2px; text-transform: uppercase; font-weight: 800; font-family: var(--font-head); text-shadow: var(--primary-glow);}
        .qb-val { font-family: var(--font-tech); font-weight:700; font-size: 24px; color: #fff; display: flex; align-items: center; gap: 10px; letter-spacing: 1px; text-shadow: 0 0 10px rgba(255,255,255,0.5); text-transform: uppercase; }
        .qb-tot { font-family: var(--font-tech); font-weight: 800; font-size: 42px; line-height: 0.8; color: var(--primary); text-shadow: var(--primary-glow); }

        /* --- TACTICAL BADGE SYSTEM --- */
        .badge-container { display: flex; align-items: center; justify-content: flex-end; width: 100px; }
        .tactical-badge { display: flex; align-items: center; width: 90px; height: 38px; background: rgba(0,0,0,0.8); border: 1px solid #333; position: relative; overflow: hidden; clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px); }
        .tb-icon { width: 30px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #000; clip-path: polygon(0 0, 100% 0, 75% 100%, 0 100%); margin-right: -2px; z-index: 2; position: relative; }
        .tb-text { flex: 1; display: flex; flex-direction: column; justify-content: center; padding-left: 2px; text-align: center; z-index: 1; }
        .tb-label { font-size: 6px; letter-spacing: 1px; color: #aaa; text-transform: uppercase; font-family: var(--font-head); line-height: 1; margin-bottom: 2px; }
        .tb-role { font-size: 9px; font-weight: 800; text-transform: uppercase; line-height: 0.9; font-family: var(--font-tech); letter-spacing: 0.5px; }

        /* BADGE VARIANTS */
        .b-platinum { border-color: #E5E4E2; } .b-platinum .tb-icon { background: linear-gradient(135deg, #E5E4E2, #708090); color: #000; } .b-platinum .tb-role { color: #E5E4E2; }
        .b-gold { border-color: #FFD700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.4); } .b-gold .tb-icon { background: linear-gradient(135deg, #FFD700, #B8860B); color: #000; } .b-gold .tb-role { color: #FFD700; } 
        .b-cyan { border-color: #00F0FF; box-shadow: 0 0 10px rgba(0, 240, 255, 0.4);} .b-cyan .tb-icon { background: linear-gradient(135deg, #00F0FF, #0088AA); color: #000; } .b-cyan .tb-role { color: #00F0FF; }
        .b-red { border-color: #FF003C; box-shadow: 0 0 10px rgba(255, 0, 60, 0.4);} .b-red .tb-icon { background: repeating-linear-gradient(45deg, #FF003C, #FF003C 5px, #900 5px, #900 10px); color: #fff; } .b-red .tb-role { color: #FF003C; }
        .b-tech { border-color: #39FF14; box-shadow: 0 0 10px rgba(57, 255, 20, 0.4);} .b-tech .tb-icon { background: #39FF14; color: #000; } .b-tech .tb-role { color: #39FF14; }
        .b-vip { border-color: #9932CC; } .b-vip .tb-icon { background: linear-gradient(135deg, #DA70D6, #800080); color: #fff; } .b-vip .tb-role { color: #DA70D6; }
        .b-family { border-color: #fff; } .b-family .tb-icon { background: linear-gradient(135deg, #ffffff 0%, #bdc3c7 100%); color: #D80027; } .b-family .tb-role { color: #fff; }
        .b-ninja { border-color: #333; background: #000; } .b-ninja .tb-icon { background: #111; color: #ccc; border-right: 1px solid #333; } .b-ninja .tb-role { color: #aaa; }

        /* --- ACTIONS --- */
        .bottom-action-area { flex: 1; min-height: 160px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-top: 20px;}
        .btn-kudeta { position: absolute; right: 5px; top: 5px; background: rgba(255,0,0,0.2); border: 1px solid var(--accent); color: var(--accent); font-size: 9px; padding: 4px 8px; font-weight: 900; cursor: pointer; transform: skewX(-10deg); font-family: var(--font-tech); letter-spacing: 1px; box-shadow: var(--accent-glow); animation: blinkKudeta 0.5s infinite; z-index: 20; }
        .mini-timer { position: absolute; bottom: 5px; right: 10px; font-size: 10px; color: #888; font-family: var(--font-head); letter-spacing: 1px; font-weight: 600; display:flex; gap:8px; align-items:center;}
        .mini-batre { color: var(--gold); font-size: 11px; font-family: 'Rajdhani'; font-weight:900; text-shadow: 0 0 5px rgba(255,215,0,0.5);}

        /* --- MODALS CYBERPUNK --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 20000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-box { width: 90%; max-width: 380px; background: rgba(5,10,21,0.95); border: 1px solid var(--primary); clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px); padding: 30px; text-align: center; position: relative; box-shadow: var(--primary-glow); }
        .modal-title { font-family: var(--font-tech); font-weight: 800; color: var(--primary); font-size: 24px; margin-bottom: 15px; letter-spacing: 1px; text-shadow: var(--primary-glow);}
        .modal-msg { font-family: var(--font-tech); color: #ccc; font-size: 18px; margin-bottom: 25px; line-height: 1.4; }
        .modal-btns { display: flex; gap: 15px; justify-content: center; position: relative; z-index: 2; }
        .btn-modal { flex: 1; padding: 12px; font-family: var(--font-head); font-size: 14px; border: none; cursor: pointer; font-weight: bold; letter-spacing: 1px; clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px); }
        .btn-yes { background: var(--primary); color: #000; box-shadow: var(--primary-glow);}
        .btn-no { background: transparent; color: var(--accent); border: 1px solid var(--accent); box-shadow: var(--accent-glow);}
        
        .btn-cancel-q { margin-top: 15px; background: rgba(255, 0, 60, 0.1); border: 1px solid var(--accent); color: var(--accent); padding: 15px 30px; font-family: var(--font-head); font-size: 14px; font-weight: 900; cursor: pointer; letter-spacing: 2px; display: none; box-shadow: var(--accent-glow); clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px); width: 100%; transition:0.2s;}
        .btn-cancel-q:active { transform: scale(0.98); background: var(--accent); color: #000; }

        .queue-list-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; flex-direction: column; padding: 20px; backdrop-filter: blur(10px); align-items: center; justify-content: center; }
        .ql-card { background: rgba(5,10,21,0.95); border: 1px solid var(--primary); width: 100%; max-width: 400px; margin: auto; overflow: hidden; display: flex; flex-direction: column; height: 70vh; box-shadow: var(--primary-glow); position: relative; clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px); }
        .ql-body { padding: 15px; flex: 1; overflow-y: auto; }
        .btn-close-mini { width: 100%; padding: 15px; background: rgba(255,0,60,0.1); color: var(--accent); border: none; border-top: 1px solid var(--accent); font-family: var(--font-head); font-size: 14px; font-weight: 800; letter-spacing: 2px; cursor: pointer; transition: 0.2s; box-shadow: var(--accent-glow); }
        .btn-close-mini:active { background: var(--accent); color: #000; }

        /* --- POP-UP BEDUG (SINKRON APLIKASI PUTIH) --- */
        .buka-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 99999; padding: 20px; text-align: center; }
        .buka-box { background: rgba(5,10,21,0.95); border: 1px solid var(--primary); padding: 40px 20px; border-radius: 35px; box-shadow: var(--primary-glow); width: 100%; max-width: 350px; transform: scale(0.8); animation: popBounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popBounce { to { transform: scale(1); } }
        .bedug-icon { font-size: 70px; margin-bottom: 15px; animation: beatDrum 0.4s infinite alternate; display: inline-block; filter: drop-shadow(0 0 15px var(--primary)); color: var(--primary); }
        @keyframes beatDrum { 0% { transform: rotate(-15deg) scale(1); } 100% { transform: rotate(15deg) scale(1.1); } }
        .buka-title { font-family: 'Rajdhani'; font-size: 32px; font-weight: 900; color: var(--primary); margin: 0 0 10px 0; letter-spacing: 2px; text-shadow: var(--primary-glow);}
        .buka-desc { color: #ccc; font-family: 'Inter'; font-size: 13px; line-height: 1.5; margin-bottom: 25px; font-weight: 600; }
        .btn-tutup-buka { background: var(--primary); color: #000; border: none; padding: 16px 30px; border-radius: 16px; font-family: 'Rajdhani'; font-weight: 900; font-size: 16px; cursor: pointer; width: 100%; box-shadow: var(--primary-glow); }

        body.ramadan-mode .buka-box { border-color: var(--gold); box-shadow: 0 0 50px rgba(255,215,0,0.3); }
        body.ramadan-mode .bedug-icon { color: var(--gold); filter: drop-shadow(0 0 15px var(--gold)); }
        body.ramadan-mode .buka-title { color: var(--gold); text-shadow: 0 0 15px var(--gold); }
        body.ramadan-mode .btn-tutup-buka { background: var(--gold); box-shadow: 0 0 20px rgba(255,215,0,0.4); }

        @keyframes pulseText { 0%,100% {opacity: 1; text-shadow: var(--primary-glow);} 50% {opacity: 0.5; text-shadow: none;} }
        @keyframes blinkKudeta { 0%, 100% { opacity: 1; transform: skewX(-10deg) scale(1); box-shadow: 0 0 20px #ff0000; } 50% { opacity: 0.6; transform: skewX(-10deg) scale(0.95); box-shadow: 0 0 5px #ff0000; } }
        @keyframes swing { 0% { transform: rotate(5deg); } 100% { transform: rotate(-5deg); } }
        @keyframes pulseMoon { 0% {opacity:0.5; transform:rotate(-15deg) scale(1);} 100% {opacity:1; transform:rotate(-15deg) scale(1.1);} }
    </style>
</head>
<body>

    <div class="ramadan-ornaments">
        <div class="hanging-item pos-1"><div class="hi-string"></div><div class="hi-body"><i class="fas fa-moon"></i></div></div>
        <div class="hanging-item pos-2"><div class="hi-string"></div><div class="hi-body"><i class="fas fa-mosque"></i></div></div>
    </div>

    <div id="gate-screen" style="position:fixed; inset:0; background:#000; z-index:99999; display:flex; align-items:center; justify-content:center;">
        <div style="font-family:'Orbitron'; color:var(--primary); font-size:24px; animation:pulseText 1s infinite;">VERIFYING ACCESS...</div>
    </div>

    <div id="customModal" class="modal-overlay">
        <div class="modal-box">
            <div id="modalTitle" class="modal-title">TITLE</div>
            <div id="modalMsg" class="modal-msg">Message goes here...</div>
            <div id="modalBtns" class="modal-btns"></div>
        </div>
    </div>

    <div class="header" ondblclick="toggleAdmin()" style="position: relative;">
        <div onclick="window.location.href='infomlu.html'" 
             style="position: absolute; right: 0px; top: 50%; transform: translateY(-50%); cursor: pointer; z-index: 50;">
            <i class="fas fa-info-circle" style="font-size: 24px; color: var(--primary); text-shadow: var(--primary-glow);"></i>
        </div>

        <div class="main-title">FC KELAPA GADING</div>
        <div class="sub-title">MAKA LINTAS UTARA</div>
    </div>

    <div class="queue-bar-wrapper" onclick="openQueueList()">
        <div class="queue-bar">
            <div class="qb-left">
                <span class="qb-lbl">ANTRIAN BERIKUTNYA</span>
                <div class="qb-val" id="nextQDisplay">--</div>
            </div>
            <div class="qb-right">
                <div class="qb-tot" id="totalQDisplay">0</div>
            </div>
        </div>
    </div>

    <div class="slot-container" id="slotsContainer"></div>

    <div class="bottom-action-area">
        <button id="btnCancelQ" class="btn-cancel-q" onclick="cancelQueue()">‚ùå BATAL ANTRIAN</button>
        <div onclick="resetApp()" style="margin-top:20px; font-size:10px; color:var(--primary); text-decoration:underline; cursor:pointer; font-family:var(--font-tech); opacity:0.5;">[ SYSTEM RESET ]</div>
    </div>

    <div id="queueListModal" class="queue-list-modal">
        <div class="ql-card">
            <div style="padding:15px; text-align:center; border-bottom:1px dashed rgba(0,240,255,0.3); font-family:var(--font-tech); font-weight:800; font-size:24px; color:var(--primary); letter-spacing:1px; text-shadow:var(--primary-glow);">DAFTAR TUNGGU</div>
            <div id="qlBody" class="ql-body"></div>
            <button class="btn-close-mini" onclick="closeModal('queueListModal')">TUTUP</button>
        </div>
    </div>

    <div class="buka-overlay" id="bukaPuasaPopup">
        <div class="buka-box">
            <div class="bedug-icon"><i class="fas fa-drum"></i></div>
            <h2 class="buka-title" id="bedugTitle">ALHAMDULILLAH</h2>
            <p class="buka-desc" id="bedugDesc">Selamat berbuka puasa bagi wilayah Jakarta dan sekitarnya. Jangan lupa berdoa sebelum makan!</p>
            <button class="btn-tutup-buka" onclick="document.getElementById('bukaPuasaPopup').style.display='none'">TERIMA KASIH</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, runTransaction, collection, addDoc, getDoc, updateDoc, arrayUnion, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // === KONFIGURASI ===
        const firebaseConfig = { apiKey: "AIzaSyB666i9lYWIpxOdkwpoX9EvFvHLmHczeq8", authDomain: "fcgadingnew22.firebaseapp.com", projectId: "fcgadingnew22", storageBucket: "fcgadingnew22.firebasestorage.app", messagingSenderId: "537736846678", appId: "1:537736846678:web:53788d71a196423ac08af7" };
        const STATION_LAT = -6.171583; const STATION_LNG = 106.899844; const MAX_DIST_KM = 0.2; 
        
        const RAMADAN_START_DATE = "2026/02/19 00:00:00"; 
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const mainRef = doc(db, "antrian", "utama");
        const historyRef = collection(db, "riwayatCharging");
        const logRef = collection(db, "activityLog");

        const $ = (id) => document.getElementById(id);
        let localSlots = [null, null, null]; let localQueue = []; 

        function cleanStr(s) { return s ? s.replace(/[^A-Z0-9]/gi, '').toUpperCase() : ''; }
        function escapeHtml(text) { if (!text) return ""; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        function addUserLog(action, details) { addDoc(logRef, { actor: myPlat || "GUEST", action: action, details: details, timestamp: new Date() }).catch(e=>{}); }
        function calculateDist(lat1, lon1, lat2, lon2) { const R = 6371; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180; const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }

        // --- CEK MODE RAMADAN ---
        function checkRamadanMode() {
            const now = new Date();
            const start = new Date(RAMADAN_START_DATE);
            if (now >= start) { document.body.classList.add('ramadan-mode'); }
        }
        checkRamadanMode();

        // --- SISTEM JADWAL PUASA KEMENAG (LIVE API + 10 MINS TOLERANCE) ---
        let jadwalSholat = null;
        async function fetchJadwalAPI() {
            try {
                const now = new Date();
                const yr = now.getFullYear(); const mo = String(now.getMonth()+1).padStart(2,'0'); const dt = String(now.getDate()).padStart(2,'0');
                const res = await fetch(`https://api.myquran.com/v2/sholat/jadwal/1301/${yr}/${mo}/${dt}`);
                const data = await res.json();
                if(data.status) jadwalSholat = data.data.jadwal;
            } catch (e) { console.error("API Jadwal Gagal"); }
        }
        fetchJadwalAPI();

        function showBedugPopup(namaWaktu) {
            const title = document.getElementById('bedugTitle'); const desc = document.getElementById('bedugDesc');
            if(namaWaktu === 'MAGHRIB') { title.innerText = "ALHAMDULILLAH"; title.style.color = "var(--gold)"; desc.innerText = "Telah masuk waktu Maghrib untuk wilayah Jakarta dan sekitarnya. Selamat berbuka puasa!"; } 
            else { title.innerText = "WAKTU " + namaWaktu; title.style.color = "var(--primary)"; desc.innerText = `Mari sejenak hentikan aktivitas. Telah masuk waktu sholat ${namaWaktu} untuk wilayah Jakarta dan sekitarnya.`; }
            document.getElementById('bukaPuasaPopup').style.display = 'flex';
        }

        setInterval(() => {
            if(!jadwalSholat) return;
            const now = new Date(); 
            const currMins = now.getHours() * 60 + now.getMinutes();
            const wktSholat = [ {n:'SUBUH', v:jadwalSholat.subuh}, {n:'DZUHUR', v:jadwalSholat.dzuhur}, {n:'ASHAR', v:jadwalSholat.ashar}, {n:'MAGHRIB', v:jadwalSholat.maghrib}, {n:'ISYA', v:jadwalSholat.isya} ];
            
            wktSholat.forEach(t => {
                let parts = t.v.split(':');
                let sholatMins = parseInt(parts[0]) * 60 + parseInt(parts[1]);
                if (currMins >= sholatMins && currMins <= sholatMins + 10) {
                    const recKey = now.toDateString() + '_' + t.n;
                    if(localStorage.getItem('maka_bedug_notif') !== recKey) { 
                        showBedugPopup(t.n); 
                        localStorage.setItem('maka_bedug_notif', recKey); 
                    }
                }
            });
        }, 5000);

        // --- GATEKEEPER ---
        const myPlat = localStorage.getItem('myPlat');
        const isSuperAdmin = localStorage.getItem('sa_sess');

        if(!myPlat && !isSuperAdmin) {
            window.location.href = 'antrian.html';
        } else {
            setTimeout(() => { const g = document.getElementById('gate-screen'); if(g) g.style.opacity = '0'; setTimeout(()=> { if(g) g.style.display = 'none'; }, 500); }, 1000);
            if(myPlat && !isSuperAdmin) { setTimeout(() => { checkAndFixMyRole(myPlat); }, 2000); }
            const AUTO_KICK_KM = 0.3;
            if(navigator.geolocation && !isSuperAdmin) {
                navigator.geolocation.watchPosition((pos) => {
                    const dist = calculateDist(STATION_LAT, STATION_LNG, pos.coords.latitude, pos.coords.longitude);
                    if(dist > AUTO_KICK_KM) { alert(`PERINGATAN: ANDA KELUAR RADIUS (${(dist).toFixed(2)} KM).\nAUTO-LOGOUT.`); localStorage.removeItem('myPlat'); window.location.href = 'antrian.html'; }
                }, (err) => console.log(err), {enableHighAccuracy: true, maximumAge: 10000});
            }
        }

        async function checkAndFixMyRole(plat) {
            try {
                const cleanPlat = plat.replace(/[^A-Z0-9]/g, '');
                const memberRef = doc(db, "members", cleanPlat);
                const memberSnap = await getDoc(memberRef);
                if (memberSnap.exists() && memberSnap.data().role) {
                    const correctRole = memberSnap.data().role;
                    await runTransaction(db, async (t) => {
                        const d = (await t.get(mainRef)).data();
                        let updated = false;
                        if (d.waitingQueue) { d.waitingQueue.forEach(q => { if (cleanStr(q.plat) === cleanStr(plat) && q.role !== correctRole) { q.role = correctRole; updated = true; } }); }
                        if (d.chargingSlots) { d.chargingSlots.forEach(s => { if (s && cleanStr(s.plat) === cleanStr(plat) && s.role !== correctRole) { s.role = correctRole; updated = true; } }); }
                        if (updated) { t.update(mainRef, { waitingQueue: d.waitingQueue, chargingSlots: d.chargingSlots }); }
                    });
                }
            } catch (e) { console.log(e); }
        }

        window.toggleAdmin = () => { 
            const pass = prompt("ADMIN CODE:"); 
            if(pass === "2505") window.location.href = "admin.html"; 
            else if (pass === "090815") { if(localStorage.getItem('sa_sess')) { localStorage.removeItem('sa_sess'); alert("GOD MODE MATI."); } else { localStorage.setItem('sa_sess', '1'); alert("GOD MODE AKTIF."); } location.reload(); }
            else if (pass) alert("WRONG CODE!"); 
        };

        window.showAlert = (msg, title="INFO") => { $('modalTitle').innerText = title; $('modalMsg').innerText = msg; $('modalBtns').innerHTML = `<button class="btn-modal btn-yes" onclick="closeCustomModal()">OK</button>`; $('customModal').style.display = 'flex'; };
        window.showConfirm = (msg, callback) => { $('modalTitle').innerText = "KONFIRMASI"; $('modalMsg').innerText = msg; $('modalBtns').innerHTML = `<button class="btn-modal btn-no" onclick="closeCustomModal()">BATAL</button><button class="btn-modal btn-yes" id="btnYes">YA</button>`; $('btnYes').onclick = () => { closeCustomModal(); callback(); }; $('customModal').style.display = 'flex'; };
        window.closeCustomModal = () => { $('customModal').style.display = 'none'; };
        window.closeModal = (id) => { $(id).style.display = 'none'; };

        onSnapshot(mainRef, (snap) => {
            if (!snap.exists()) return; const d = snap.data(); localSlots = d.chargingSlots || [null, null, null]; localQueue = d.waitingQueue || []; updateUI();
        });

        function updateUI() {
            const container = $('slotsContainer'); container.innerHTML = ''; let myQIndex = -1;
            if (myPlat && localQueue.length > 0) { myQIndex = localQueue.findIndex(q => cleanStr(q.plat) === cleanStr(myPlat)); }
            const btnCancel = $('btnCancelQ'); 
            if(myQIndex > -1) { btnCancel.style.display = 'block'; btnCancel.innerHTML = `‚ùå BATAL ANTRIAN (URUTAN #${myQIndex+1})`; } else { btnCancel.style.display = 'none'; }

            localSlots.forEach((s, i) => {
                const isActive = s !== null; const div = document.createElement('div'); div.className = `armor-card ${isActive ? 'active' : ''}`;
                if (isActive) {
                    const role = s.role ? s.role.toUpperCase() : "GUEST"; 
                    const isMe = (cleanStr(s.plat) === cleanStr(myPlat)); 
                    let kudetaHTML = '', timerHTML = '';
                    const durationMs = Date.now() - (s.startTime || Date.now()); const durationMin = Math.floor(durationMs / 60000);
                    
                    let batVal = s.batre || s.battery || s.batreSisa || '-';
                    
                    // TOMBOL KUDETA MUNCUL OTOMATIS JIKA DURASI LEWAT
                    if(isMe) timerHTML = `<div class="mini-timer" style="color:var(--primary)"><span class="mini-batre"><i class="fas fa-bolt"></i> ${batVal}</span> ${durationMin} MIN (ANDA)</div>`; 
                    else {
                        timerHTML = `<div class="mini-timer"><span class="mini-batre"><i class="fas fa-bolt"></i> ${batVal}</span> ${durationMin} MIN</div>`; 
                        if (myQIndex === 0 && durationMin >= 20) { kudetaHTML = `<button class="btn-kudeta" onclick="window.userTriggerKudeta(${i}, '${escapeHtml(s.plat)}')">‚ö° KUDETA</button>`; } else if (myQIndex === 1 && durationMin >= 25) { kudetaHTML = `<button class="btn-kudeta" onclick="window.userTriggerKudeta(${i}, '${escapeHtml(s.plat)}')">‚ö° KUDETA</button>`; }
                    }
                    
                    div.innerHTML = `
                        <div class="armor-inner">
                            <div class="ramadan-box-decor"><i class="fas fa-star-and-crescent"></i></div>
                            <div class="armor-num">${i+1}</div>
                            <div class="armor-info"><div class="info-name">${escapeHtml(s.userName)}</div><div class="info-plat">${s.plat}</div></div>
                            <div class="armor-badge">${getBadgeHTML(role)}</div>
                            ${timerHTML} ${kudetaHTML}
                        </div>`;
                    if(isMe) { div.onclick = () => showConfirm("SELESAI CHARGING?", () => stopCharging(i)); }
                } else {
                    let btnHTML = ''; 
                    if (localQueue.length === 0 || myQIndex === 0) btnHTML = `<button style="width:100%; padding:5px 0; background:var(--primary); color:#000; border:none; border-radius:3px; font-family:'Rajdhani'; font-weight:bold; box-shadow:var(--primary-glow);" onclick="window.selectSlot(${i})">PILIH</button>`; 
                    else if (myQIndex > 0) btnHTML = `<div style="font-size:9px; color:var(--text-muted); font-weight:bold;">ANTRIAN ${myQIndex + 1}</div>`; 
                    else btnHTML = `<div style="font-size:9px; color:#444;">LOCKED</div>`;
                    div.innerHTML = `<div class="armor-inner"><div class="armor-num" style="color:rgba(255,255,255,0.1); border-right:1px solid rgba(255,255,255,0.1);">${i+1}</div><div class="armor-info"><div class="info-plat" style="color:#333; letter-spacing:3px; text-shadow:none;">OPEN</div></div><div class="armor-badge" style="padding:10px;">${btnHTML}</div></div>`;
                }
                container.appendChild(div);
            });
            $('totalQDisplay').innerText = localQueue.length; $('nextQDisplay').innerText = localQueue.length > 0 ? localQueue[0].userName : "--";
        }

        function getBadgeHTML(r) {
            if (!r || r === "GUEST") return ""; 
            if (r.includes("SENYAP") || r.includes("NINJA")) return `<div class="badge-container"><div class="tactical-badge b-ninja"><div class="tb-icon"><i class="fas fa-user-ninja"></i></div><div class="tb-text"><div class="tb-role" style="font-size:8px;">PASUKAN SENYAP</div></div></div></div>`;
            if (r.includes("KELUARGA") || r === "MEMBER") return `<div class="badge-container"><div class="tactical-badge b-family"><div class="tb-icon"><i class="fas fa-heart"></i></div><div class="tb-text"><div class="tb-role">KELUARGA MLU</div></div></div></div>`;
            let css = "b-platinum"; let icon = "fa-user"; let label = "MEMBER"; let roleTxt = r;
            if (r.includes("PEMBINA")) { css="b-platinum"; icon="fa-star"; label="SENIOR"; roleTxt="PEMBINA"; }
            else if (r.includes("WAKETUM")) { css="b-gold"; icon="fa-chess-king"; label="CO-LEAD"; roleTxt="WAKETUM"; } 
            else if (r.includes("KETUM")) { css="b-gold"; icon="fa-crown"; label="LEADER"; roleTxt="KETUM"; }
            else if (r.includes("VIP")) { css="b-vip"; icon="fa-gem"; label="GUEST"; roleTxt="VIP"; }
            else if (r.includes("DONATUR")) { css="b-donatur"; icon="fa-hand-holding-usd"; label="SPONSOR"; roleTxt="DONATUR"; }
            return `<div class="badge-container"><div class="tactical-badge ${css}"><div class="tb-icon"><i class="fas ${icon}"></i></div><div class="tb-text">${label ? `<div class="tb-label">${label}</div>` : ''}<div class="tb-role">${roleTxt}</div></div></div></div>`;
        }

        window.selectSlot = async (i) => { showConfirm(`MASUK SLOT ${i+1}?`, () => { runTransaction(db, async(t)=>{ const d = (await t.get(mainRef)).data(); if(d.chargingSlots[i]) throw "SLOT PENUH!"; let q = d.waitingQueue; const idx = q.findIndex(x => cleanStr(x.plat) === cleanStr(myPlat)); if(idx === -1) throw "DATA ANTRIAN HILANG!"; const me = q[idx]; q.splice(idx, 1); me.startTime = Date.now(); d.chargingSlots[i] = me; t.update(mainRef, { chargingSlots: d.chargingSlots, waitingQueue: q }); }).then(() => addUserLog("START", `Slot ${i+1}`)).catch(e => showAlert(e)); }); };
        window.stopCharging = (i) => { runTransaction(db, async(t)=>{ const d = (await t.get(mainRef)).data(); const u = d.chargingSlots[i]; if(u) addDoc(historyRef, {...u, finishTime: new Date(), action: "STOP"}); d.chargingSlots[i] = null; t.update(mainRef, {chargingSlots: d.chargingSlots}); }).then(() => { localStorage.removeItem('myPlat'); window.location.href = 'antrian.html'; }); };
        
        // --- LOGIKA KUDETA USER BIASA INSTAN ---
        window.userTriggerKudeta = (idx, plat) => {
            event.stopPropagation(); 
            if(!confirm(`YAKIN INGIN MENGKUDETA SLOT INI (${plat})?\nPengguna ini sudah melewati batas waktu dan akan dikeluarkan paksa.`)) return;
            
            runTransaction(db, async(t) => {
                const d = (await t.get(mainRef)).data();
                let q = d.waitingQueue || [];
                
                const myIdx = q.findIndex(x => cleanStr(x.plat) === cleanStr(myPlat));
                if(myIdx === -1) throw "Anda tidak ada di antrian!";
                
                let me = q.splice(myIdx, 1)[0]; 
                me.userName = me.userName + " üëë";
                me.role = "KUDETA";
                me.startTime = Date.now();
                
                d.chargingSlots[idx] = me;
                
                t.update(mainRef, {chargingSlots: d.chargingSlots, waitingQueue: q});
            }).then(() => { 
                alert("KUDETA BERHASIL! Anda langsung menempati slot."); 
            }).catch(e => showAlert("ERROR: " + e));
        };

        // FUNGSI INI HANYA UNTUK ADMIN YANG MENGGUNAKAN TITIK TIGA DI APLIKASI PUTIH (Di aplikasi hitam tidak dipakai karena tidak ada menu titik tiga)
        window.kudeta = (i, targetPlat, durationMin) => { 
            event.stopPropagation(); 
            if(durationMin < 20) { showAlert(`BELUM BISA KUDETA!\nDURASI BARU ${durationMin} MENIT.\n(MINIMAL 20 MENIT)`, "GAGAL"); return; } 
            showConfirm(`KUDETA ${targetPlat}?\nAnda akan langsung masuk slot dan pengguna ini akan dikeluarkan paksa!`, () => { 
                runTransaction(db, async(t) => { 
                    const d = (await t.get(mainRef)).data(); 
                    const u = d.chargingSlots[i]; 
                    if(!u) throw "Slot kosong!"; 
                    addDoc(historyRef, {...u, finishTime: new Date(), action: "KUDETA_BY_" + myPlat}); 
                    addUserLog("KUDETA", `Kudeta ${targetPlat}`); 
                    
                    let q = d.waitingQueue || []; 
                    const myIdx = q.findIndex(x => cleanStr(x.plat) === cleanStr(myPlat)); 
                    let me;
                    if(myIdx > -1) { me = q.splice(myIdx, 1)[0]; } 
                    else { me = { plat: myPlat, userName: "KUDETA", role: "ADMIN", batre: "-" }; }
                    me.startTime = Date.now(); 
                    d.chargingSlots[i] = me; 
                    t.update(mainRef, {chargingSlots: d.chargingSlots, waitingQueue: q}); 
                }).catch(e => showAlert(e)); 
            }); 
        };

        window.cancelQueue = () => { showConfirm("BATAL & KELUAR DARI ANTRIAN?", () => { runTransaction(db, async(t) => { const d = (await t.get(mainRef)).data(); const newQ = d.waitingQueue.filter(q => cleanStr(q.plat) !== cleanStr(myPlat)); t.update(mainRef, { waitingQueue: newQ }); addUserLog("CANCEL", `User ${myPlat} keluar antrian`); }).then(() => { localStorage.removeItem('myPlat'); window.location.href = 'antrian.html'; }).catch(e => showAlert("GAGAL: " + e)); }); };
        
        window.openQueueList = () => { 
            const body = $('qlBody'); body.innerHTML = ''; 
            if(localQueue.length === 0) { body.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">KOSONG</div>'; } 
            else { localQueue.forEach((q, i) => { 
                let bat = q.batre || q.battery || q.batreSisa || '-';
                body.innerHTML += `<div style="background:rgba(0,240,255,0.05); margin:0 0 10px 0; padding:15px; border-left:4px solid var(--primary); display:flex; justify-content:space-between; align-items:center; border-radius:0 4px 4px 0; border:1px solid rgba(0,240,255,0.1);"><div><div style="font-family:'Teko'; font-size:36px; color:#fff; letter-spacing:1px; line-height:1; text-shadow:var(--primary-glow);">${q.plat} <span style="font-size:16px; color:var(--gold); text-shadow:0 0 10px var(--gold);"><i class="fas fa-bolt"></i> ${bat}</span></div><div style="font-family:'Rajdhani'; font-size:16px; color:#ccc; font-weight:bold; text-transform:uppercase;">${q.userName}</div></div><div style="font-family:'Rajdhani'; font-size:14px; color:#000; background:var(--primary); padding:4px 10px; font-weight:800; border-radius:4px; box-shadow:var(--primary-glow);">ANTRIAN #${i+1}</div></div>`; 
            }); } 
            $('queueListModal').style.display = 'flex'; 
        };
        
        window.resetApp = () => showConfirm("RESET APLIKASI?", () => { localStorage.clear(); location.reload(); });

        let idleTime = 0; window.onclick = () => { idleTime = 0; }; window.ontouchstart = () => { idleTime = 0; }; window.onmousemove = () => { idleTime = 0; };
        setInterval(() => { idleTime++; if (idleTime > 180) { window.location.href = 'screensaver.html'; } }, 1000);
    </script>
    <script>if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js'); }); }</script>
</body>
</html>
