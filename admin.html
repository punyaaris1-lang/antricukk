<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADMIN MONITOR - FC KG</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=JetBrains+Mono:wght@500;800&family=Inter:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #000000; 
            --panel: rgba(10, 10, 10, 0.95); 
            --accent: #00F0FF; /* Cyan */
            --warn: #FFCC00;   /* Kuning */
            --danger: #FF003C; /* Merah */
            --success: #39FF14; /* Hijau */
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.9)), url('1763947427555.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #fff; margin: 0; padding: 10px; padding-bottom: 80px; 
        }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }
        .h-title { font-family: 'Orbitron'; font-weight: 900; font-size: 20px; color: var(--accent); letter-spacing: 1px; }
        .header-btns { display: flex; gap: 5px; }
        .btn-head { border: 1px solid #fff; padding: 5px 10px; font-weight: 900; cursor: pointer; font-size: 10px; text-decoration: none; display: flex; align-items: center; justify-content: center; background: #222; color: #fff; }
        .btn-logout { background: var(--danger); border-color: var(--danger); }
        .btn-view { background: var(--accent); color: #000; border-color: var(--accent); }

        /* MINI TV */
        .mini-tv-label { font-family: 'Orbitron'; font-size: 10px; color: #aaa; margin-bottom: 5px; letter-spacing: 1px; }
        .mini-tv-container { display: flex; gap: 5px; margin-bottom: 20px; }
        .mini-slot { 
            flex: 1; background: #111; border: 2px solid #444; padding: 5px; height: 100px; 
            display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; transition: 0.2s; position: relative;
        }
        .mini-slot:active { transform: scale(0.95); border-color: #fff; }
        .mini-slot.active { border-color: var(--success); background: #051a05; }
        .click-hint { position: absolute; top: 0; right: 0; background: #333; color: #fff; font-size: 8px; padding: 2px 4px; border-bottom-left-radius: 4px; }

        .mtv-head { display: flex; justify-content: space-between; font-family: 'Orbitron'; font-size: 10px; color: #666; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .mini-slot.active .mtv-head { color: var(--success); }
        .mtv-plat { font-family: 'JetBrains Mono'; font-size: 13px; font-weight: 900; color: #fff; text-align: center; margin-top: 5px; letter-spacing: -0.5px; }
        .mtv-foot { display: flex; justify-content: space-between; align-items: center; margin-top: auto; background: #222; padding: 2px 4px; border-radius: 3px; }
        .mtv-bat { font-family: 'Orbitron'; color: var(--accent); font-weight: bold; font-size: 10px; }
        .mtv-timer { font-family: 'JetBrains Mono'; color: #fff; font-weight: 900; font-size: 11px; }

        /* CARD */
        .card { background: var(--panel); border: 1px solid #333; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .c-title { font-family: 'Orbitron'; color: var(--warn); font-size: 12px; border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 12px; letter-spacing: 1px; font-weight: 900; }

        /* TOGGLE BUTTONS (REMOTE) */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 11px; font-family: 'JetBrains Mono'; font-weight: bold; }
        .tgl-btn { background: #222; border: 1px solid #444; color: #555; padding: 5px 15px; cursor: pointer; font-weight: bold; font-family: 'Orbitron'; border-radius: 20px; }
        .tgl-btn.on { background: var(--success); color: #000; border-color: var(--success); }

        /* QUEUE LIST TABLE */
        .q-list-container { max-height: 200px; overflow-y: auto; background: #000; border: 1px solid #333; padding: 5px; margin-bottom: 10px; }
        .q-item { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; margin-bottom: 3px; padding: 8px; border-left: 3px solid var(--accent); }
        .q-info { display: flex; flex-direction: column; }
        .q-plat { font-family: 'Orbitron'; font-weight: bold; color: #fff; font-size: 12px; }
        .q-name { font-family: 'JetBrains Mono'; font-size: 10px; color: #aaa; }
        .q-actions { display: flex; gap: 5px; }
        .btn-sm { padding: 4px 8px; font-size: 10px; font-weight: bold; cursor: pointer; border: none; border-radius: 3px; }
        .btn-del { background: var(--danger); color: #fff; }

        /* INPUTS & BUTTONS */
        .row-group { display: flex; gap: 5px; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; background: #000; border: 1px solid #555; color: #fff; font-family: 'JetBrains Mono'; font-weight: bold; font-size: 14px; border-radius: 4px; }
        input:focus, select:focus { border-color: var(--accent); outline: none; }
        
        .btn { width: 100%; padding: 12px; border: none; font-family: 'Orbitron'; font-weight: 900; cursor: pointer; font-size: 12px; text-transform: uppercase; border-radius: 4px; margin-bottom: 5px; }
        .btn:active { transform: translateY(2px); opacity: 0.8; }
        .btn-blue { background: rgba(0, 240, 255, 0.2); border: 1px solid var(--accent); color: var(--accent); }
        .btn-red { background: rgba(255, 0, 60, 0.2); border: 1px solid var(--danger); color: var(--danger); }
        .btn-green { background: rgba(57, 255, 20, 0.2); border: 1px solid var(--success); color: var(--success); }
        .btn-grey { background: #333; color: #ccc; border: 1px solid #555; }
        .btn-warn { background: var(--warn); color: #000; border: none; }

        /* LOG BOX */
        .log-box { background: #000; border: 1px solid #333; height: 150px; overflow-y: auto; padding: 10px; font-family: 'JetBrains Mono'; font-size: 10px; color: #ccc; border-radius: 4px; }
        .log-row { margin-bottom: 4px; border-bottom: 1px solid #111; padding-bottom: 4px; display: flex; flex-wrap: wrap; }
        .l-time { color: var(--accent); margin-right: 5px; font-weight: bold; }
        .l-act { color: var(--warn); font-weight: bold; margin-right: 5px; }
        .l-msg { color: #fff; word-break: break-all; }

        /* SLOT CONTROL MODAL */
        #slotModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .sm-box { background: #111; border: 2px solid var(--accent); padding: 20px; width: 90%; max-width: 350px; text-align: center; border-radius: 15px; box-shadow: 0 0 30px rgba(0, 240, 255, 0.2); }
        .sm-title { font-family: 'Orbitron'; font-size: 18px; color: var(--accent); margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 10px; font-weight: 900; }
        .sm-timer { font-family: 'Orbitron'; font-size: 50px; color: #fff; font-weight: 900; line-height: 1; margin: 10px 0; text-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .sm-info { font-family: 'JetBrains Mono'; font-size: 12px; color: #888; margin-bottom: 20px; }
        .sm-btn-close { position: absolute; top: 20px; right: 20px; background: transparent; border: none; color: #fff; font-size: 20px; cursor: pointer; }

        /* PIN MODAL */
        #pinOverlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-input { font-size: 24px; text-align: center; letter-spacing: 10px; width: 200px; margin-bottom: 15px; border-color: var(--accent); }
    </style>
</head>
<body>

    <div id="pinOverlay">
        <h2 style="color:var(--accent); font-family:'Orbitron';">SECURE ACCESS</h2>
        <input type="password" id="adminPin" class="pin-input" placeholder="****" maxlength="4">
        <button onclick="checkPin()" class="btn btn-blue" style="width:200px;">UNLOCK</button>
    </div>

    <div id="slotModal">
        <button class="sm-btn-close" onclick="closeSlotModal()">✕</button>
        <div class="sm-box">
            <div class="sm-title" id="smTitle">SLOT CONTROL</div>
            <div class="sm-info" id="smInfo">PLAT | NAMA</div>
            <div class="sm-timer" id="smTimer">00:00</div>
            <div id="smControls"></div>
        </div>
    </div>

    <div id="mainContent" style="display:none;">
        <div class="header">
            <div class="h-title">ADMIN PANEL</div>
            <div class="header-btns">
                <button onclick="window.location.href='index.html'" class="btn-head btn-view">LIHAT TV</button>
                <button onclick="logout()" class="btn-head btn-logout">LOGOUT</button>
            </div>
        </div>

        <div class="card">
            <div class="c-title">REMOTE TV DEPAN</div>
            <div class="toggle-row">
                <span>POSISI TIMER</span>
                <select id="timerPos" style="width:120px; padding:5px; font-size:10px;" onchange="updateSettings()">
                    <option value="center">BESAR (TENGAH)</option>
                    <option value="bottom">KECIL (BAWAH)</option>
                </select>
                <button id="btnTglTimer" class="tgl-btn" onclick="toggleSetting('showTimer')">ON</button>
            </div>
            <div class="toggle-row">
                <span>PERSEN BATRE</span>
                <button id="btnTglBat" class="tgl-btn" onclick="toggleSetting('showBattery')">ON</button>
            </div>
            <div class="toggle-row">
                <span>INFO ANTRIAN (#)</span>
                <button id="btnTglQ" class="tgl-btn" onclick="toggleSetting('showQInfo')">ON</button>
            </div>
        </div>

        <div class="mini-tv-label">MONITORING SLOT (KLIK UNTUK DETAIL)</div>
        <div class="mini-tv-container">
            <div class="mini-slot" id="mtv-1" onclick="openSlotControl(0)">
                <div class="click-hint">OPEN</div>
                <div class="mtv-head"><span>SLOT 1</span><span id="s1-stat">OFF</span></div>
                <div class="mtv-plat" id="s1-plat">-</div>
                <div class="mtv-foot"><span class="mtv-bat" id="s1-bat">--%</span><span class="mtv-timer" id="s1-timer">--:--</span></div>
            </div>
            <div class="mini-slot" id="mtv-2" onclick="openSlotControl(1)">
                <div class="click-hint">OPEN</div>
                <div class="mtv-head"><span>SLOT 2</span><span id="s2-stat">OFF</span></div>
                <div class="mtv-plat" id="s2-plat">-</div>
                <div class="mtv-foot"><span class="mtv-bat" id="s2-bat">--%</span><span class="mtv-timer" id="s2-timer">--:--</span></div>
            </div>
            <div class="mini-slot" id="mtv-3" onclick="openSlotControl(2)">
                <div class="click-hint">OPEN</div>
                <div class="mtv-head"><span>SLOT 3</span><span id="s3-stat">OFF</span></div>
                <div class="mtv-plat" id="s3-plat">-</div>
                <div class="mtv-foot"><span class="mtv-bat" id="s3-bat">--%</span><span class="mtv-timer" id="s3-timer">--:--</span></div>
            </div>
        </div>

        <div class="card">
            <div class="c-title">DAFTAR ANTRIAN</div>
            
            <div id="queueListVisual" class="q-list-container">
                <div style="text-align:center; color:#555; padding:10px;">ANTRIAN KOSONG</div>
            </div>

            <div class="c-title" style="color:#aaa; border:none; margin-top:10px;">OPERASI ANTRIAN</div>
            
            <label style="font-size:10px; color:#666;">TARIK ANTRIAN KE SLOT:</label>
            <div class="row-group">
                <select id="qToSlotSrc" style="flex:2; font-weight:bold; color:var(--warn);"></select>
                <span style="padding:10px; color:#fff;">➔</span>
                <select id="qToSlotDest" style="flex:1; font-weight:bold; color:var(--accent);"></select>
            </div>
            <button onclick="moveQueueToSlot()" class="btn btn-green">MASUKKAN KE SLOT</button>
            <button onclick="autoFill()" class="btn btn-blue">AUTO FILL SEMUA SLOT KOSONG</button>

            <div style="border-top:1px dashed #333; margin:10px 0;"></div>

            <label style="font-size:10px; color:#666;">MANUAL EDIT:</label>
            <div class="row-group">
                <select id="reorderSrc" style="flex:2;"></select>
                <input id="reorderDest" type="number" placeholder="Ke No." style="flex:1; text-align:center;">
                <button onclick="reorderQueue()" class="btn btn-blue" style="flex:1;">PINDAH</button>
            </div>
            <button onclick="editQNumber()" class="btn btn-warn">UBAH NOMOR (MANUAL)</button>
        </div>

        <div class="card">
            <div class="c-title">INPUT USER MANUAL (ADMIN)</div>
            <div class="row-group">
                <input id="qPlat" placeholder="PLAT NOMOR" style="flex:2;" oninput="checkHistory(this)">
                <input id="qBat" type="number" placeholder="%" style="flex:1; text-align:center;">
            </div>
            <input id="qName" placeholder="NAMA (Otomatis jika ada history)" style="margin-bottom:5px;">
            <button onclick="regQueue()" class="btn btn-blue">DAFTARKAN KE ANTRIAN</button>
        </div>

        <div class="card">
            <div class="c-title">TOOLS & DATABASE</div>
            <div class="row-group">
                <button onclick="manualAssign()" class="btn btn-green">FORCE START (NO QUEUE)</button>
                <button onclick="returnToQueue()" class="btn btn-grey">SLOT ➔ ANTRIAN</button>
            </div>
            <div class="row-group">
                <button onclick="stopAll()" class="btn btn-red">STOP ALL</button>
                <button onclick="resetDB()" class="btn btn-red">RESET DB</button>
            </div>
            <div style="display:none;">
                <select id="manSlot"><option value="0">0</option></select>
                <input id="manPlat"><input id="manBat">
                <select id="retSlot"><option value="0">0</option></select>
            </div>
        </div>

        <div class="card">
            <div class="c-title">SYSTEM LOG</div>
            <div id="termuxLog" class="log-box"><div class="log-row">Loading...</div></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, runTransaction, updateDoc, arrayUnion, collection, addDoc, query, orderBy, limit, setDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyALIlkIDALIk83K8s1htalvW6rmNNw02Go", authDomain: "sistem-antrian-b1c39.firebaseapp.com", projectId: "sistem-antrian-b1c39", storageBucket: "sistem-antrian-b1c39.firebasestorage.app", messagingSenderId: "454124587608", appId: "1:454124587608:web:34fbb0f5211067a67f982d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const ref = doc(db, "antrian", "utama");
        const settingsRef = doc(db, "antrian", "settings");
        const historyRef = collection(db, "riwayatCharging");
        const logRef = collection(db, "activityLog");

        let latestSlots = [null,null,null];
        let viewingSlotIdx = -1;

        // --- AUTH ---
        window.checkPin = () => {
            if(document.getElementById('adminPin').value === "8080") {
                document.getElementById('pinOverlay').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                localStorage.setItem('adm_ok', '1');
            } else alert("PIN SALAH!");
        };
        if(localStorage.getItem('adm_ok')) {
            document.getElementById('pinOverlay').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }
        window.logout = () => { localStorage.removeItem('adm_ok'); location.reload(); };

        // --- HISTORY CHECK (AUTO FILL) ---
        window.checkHistory = async (el) => {
            el.value = el.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            const val = el.value;
            if(val.length > 3) {
                const q = query(historyRef, where("plat", "==", val), orderBy("timestamp", "desc"), limit(1));
                const snap = await getDocs(q);
                if(!snap.empty) {
                    const d = snap.docs[0].data();
                    document.getElementById('qName').value = d.userName || '';
                }
            }
        };

        // --- REALTIME MONITORING ---
        onSnapshot(ref, (snap) => {
            const d = snap.data(); if(!d) return;
            latestSlots = d.chargingSlots || [null,null,null];
            
            // Render Mini TV
            latestSlots.forEach((s, i) => {
                const div = document.getElementById(`mtv-${i+1}`);
                const statSpan = document.getElementById(`s${i+1}-stat`);
                if(s && s.plat) {
                    div.classList.add('active');
                    document.getElementById(`s${i+1}-plat`).innerText = s.plat;
                    if(s.startTime) {
                        statSpan.innerText = "ON"; statSpan.style.color = "var(--accent)";
                    } else {
                        statSpan.innerText = "READY"; statSpan.style.color = "#fff";
                        document.getElementById(`s${i+1}-bat`).innerText = s.startBattery + "%";
                        document.getElementById(`s${i+1}-timer`).innerText = "WAIT";
                    }
                } else {
                    div.classList.remove('active');
                    document.getElementById(`s${i+1}-plat`).innerText = "-";
                    statSpan.innerText = "OFF"; statSpan.style.color = "#555";
                    document.getElementById(`s${i+1}-bat`).innerText = "--%";
                    document.getElementById(`s${i+1}-timer`).innerText = "--:--";
                }
            });

            if(viewingSlotIdx !== -1) renderSlotModal(viewingSlotIdx);

            // UPDATE QUEUE LIST & DROPDOWNS
            const q = d.waitingQueue || [];
            updateQueueVisuals(q, latestSlots);
        });

        function updateQueueVisuals(q, slots) {
            // 1. Visual List
            const listDiv = document.getElementById('queueListVisual');
            if(q.length === 0) listDiv.innerHTML = '<div style="text-align:center; color:#555; padding:10px;">ANTRIAN KOSONG</div>';
            else {
                let html = '';
                q.forEach((item, i) => {
                    html += `
                        <div class="q-item">
                            <div class="q-info">
                                <span class="q-plat">#${item.qNo} - ${item.plat}</span>
                                <span class="q-name">${item.userName}</span>
                            </div>
                            <div class="q-actions">
                                <button class="btn-sm btn-del" onclick="deleteQ(${i})">HAPUS</button>
                            </div>
                        </div>
                    `;
                });
                listDiv.innerHTML = html;
            }

            // 2. Dropdowns
            const qOpt = q.length ? q.map((x,i)=>`<option value="${i}">#${x.qNo||i+1} ${x.plat}</option>`).join('') : '<option value="-1">KOSONG</option>';
            document.getElementById('reorderSrc').innerHTML = qOpt;
            document.getElementById('qToSlotSrc').innerHTML = qOpt;

            const sOpt = slots.map((s, i) => `<option value="${i}">SLOT ${i+1} (${s ? 'ISI' : 'KOSONG'})</option>`).join('');
            document.getElementById('qToSlotDest').innerHTML = sOpt;
        }

        // --- REMOTE SETTINGS ---
        onSnapshot(settingsRef, (snap) => {
            const s = snap.data() || {};
            setTgl('btnTglTimer', s.showTimer); setTgl('btnTglBat', s.showBattery); setTgl('btnTglQ', s.showQInfo);
            document.getElementById('timerPos').value = s.timerPosition || 'center';
        });
        function setTgl(id, v) { const b=document.getElementById(id); if(v){b.classList.add('on'); b.innerText='ON';b.style.background='var(--success)';b.style.color='#000';} else {b.classList.remove('on'); b.innerText='OFF';b.style.background='#333';b.style.color='#777';} }
        window.toggleSetting = (k) => { runTransaction(db, async(t)=>{ const d=(await t.get(settingsRef)).data(); t.update(settingsRef, {[k]:!d[k]}); }); };
        window.updateSettings = () => { updateDoc(settingsRef, { timerPosition: document.getElementById('timerPos').value }); };

        // --- ACTIONS ---
        window.openSlotControl = (i) => { viewingSlotIdx = i; document.getElementById('slotModal').style.display = 'flex'; renderSlotModal(i); };
        window.closeSlotModal = () => { document.getElementById('slotModal').style.display = 'none'; viewingSlotIdx = -1; };

        function renderSlotModal(i) {
            const s = latestSlots[i];
            const title = document.getElementById('smTitle');
            const info = document.getElementById('smInfo');
            const timer = document.getElementById('smTimer');
            const ctrls = document.getElementById('smControls');
            title.innerText = `KONTROL SLOT ${i+1}`;
            
            if(!s || !s.plat) {
                info.innerText = "SLOT KOSONG"; timer.innerText = "EMPTY";
                ctrls.innerHTML = `<button onclick="closeSlotModal()" class="btn btn-grey">TUTUP</button>`;
                return;
            }
            info.innerText = `${s.plat} | ${s.userName || 'USER'}`;
            if(s.startTime) {
                const st = s.startTime.toDate ? s.startTime.toDate() : new Date(s.startTime);
                const diff = (new Date(st.getTime() + s.durationMinutes*60000)) - new Date();
                const remSec = diff / 1000;
                let txt = "DONE";
                if(remSec > 0) { const m = Math.floor(remSec/60); const sc = Math.floor(remSec%60); txt = `${m}:${sc<10?'0'+sc:sc}`; }
                timer.innerText = txt; timer.style.color = "var(--accent)";
                ctrls.innerHTML = `<button class="btn btn-blue" onclick="editTimer(${i})">EDIT TIMER</button><button class="btn btn-warn" onclick="pauseSlot(${i})">PAUSE</button><button class="btn btn-red" onclick="stopSlot(${i})">STOP & SELESAI</button>`;
            } else {
                timer.innerText = "READY"; timer.style.color = "#fff";
                ctrls.innerHTML = `<button class="btn btn-green" onclick="startSlot(${i})">START</button><button class="btn btn-red" onclick="kickSlot(${i})">HAPUS DARI SLOT</button>`;
            }
        }

        window.startSlot = (i) => { if(confirm("Start?")) { runTransaction(db, async(t)=>{ const d = (await t.get(ref)).data(); d.chargingSlots[i].startTime = new Date(); t.update(ref, {chargingSlots:d.chargingSlots}); addLog('START', `Slot ${i+1}`); }); } };
        window.stopSlot = (i) => { if(confirm("Stop?")) { runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); d.chargingSlots[i] = null; if(d.waitingQueue.length > 0) { const next = d.waitingQueue.shift(); d.waitingQueue.forEach((x,idx)=>x.qNo=idx+1); const dur = calcDur(next.startBattery, 98); d.chargingSlots[i] = {...next, startTime:null, durationMinutes:dur, targetLimit:98, readyTime:new Date(), qNo:null}; } t.update(ref, {chargingSlots:d.chargingSlots, waitingQueue:d.waitingQueue}); addLog('STOP', `Slot ${i+1}`); }); } };
        window.editTimer = (i) => { const m = prompt("Menit:"); if(m) { runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); d.chargingSlots[i].durationMinutes = parseInt(m); d.chargingSlots[i].startTime = new Date(); t.update(ref, {chargingSlots:d.chargingSlots}); addLog('EDIT', `S${i+1} -> ${m}m`); }); } };
        window.pauseSlot = (i) => { if(confirm("Pause?")) { runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); const s = d.chargingSlots[i]; if(s.startTime) { const st = s.startTime.toDate(); const rem = Math.max(0, (new Date(st.getTime() + s.durationMinutes*60000) - new Date())/60000); d.chargingSlots[i] = {...s, startTime:null, durationMinutes:rem}; t.update(ref, {chargingSlots:d.chargingSlots}); addLog('PAUSE', `S${i+1}`); } }); } };
        window.kickSlot = (i) => { if(confirm("Kick?")) { runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); d.chargingSlots[i] = null; t.update(ref, {chargingSlots:d.chargingSlots}); addLog('KICK', `S${i+1}`); }); } };

        window.deleteQ = (idx) => {
            if(confirm("Hapus antrian ini?")) {
                runTransaction(db, async(t)=>{
                    const d = (await t.get(ref)).data();
                    let q = d.waitingQueue || [];
                    const rem = q.splice(idx, 1)[0];
                    q.forEach((x,i)=>x.qNo=i+1);
                    t.update(ref, {waitingQueue:q});
                    addLog('DEL Q', `${rem.plat}`);
                });
            }
        };

        window.moveQueueToSlot = () => {
            const qIdx = document.getElementById('qToSlotSrc').value;
            const sIdx = document.getElementById('qToSlotDest').value;
            if(qIdx < 0) return alert("Pilih Antrian!");
            if(latestSlots[sIdx]!==null && !confirm("Slot isi. Timpa?")) return;
            runTransaction(db, async(t)=>{
                const d=(await t.get(ref)).data(); let q=d.waitingQueue||[];
                const item=q.splice(qIdx,1)[0];
                q.forEach((x,i)=>x.qNo=i+1);
                const dur = calcDur(item.startBattery, 98);
                d.chargingSlots[sIdx] = {...item, startTime:null, durationMinutes:dur, readyTime:new Date(), qNo:null};
                t.update(ref, {chargingSlots:d.chargingSlots, waitingQueue:q});
                addLog('MOVE', `${item.plat} -> S${parseInt(sIdx)+1}`);
            });
        };

        window.autoFill = () => {
            if(!confirm("Auto fill?")) return;
            runTransaction(db, async(t)=>{
                const d=(await t.get(ref)).data(); let q=d.waitingQueue||[]; let s=d.chargingSlots;
                let moved=0;
                for(let i=0;i<3;i++) {
                    if(s[i]===null && q.length>0) {
                        const item=q.shift();
                        const dur=calcDur(item.startBattery, 98);
                        s[i] = {...item, startTime:null, durationMinutes:dur, readyTime:new Date(), qNo:null};
                        moved++;
                    }
                }
                if(moved>0) {
                    q.forEach((x,i)=>x.qNo=i+1);
                    t.update(ref, {chargingSlots:s, waitingQueue:q});
                    addLog('AUTOFILL', `${moved} items`);
                } else alert("Tidak ada yang dipindah");
            });
        };

        window.regQueue = () => {
            const p=document.getElementById('qPlat').value.toUpperCase(), n=document.getElementById('qName').value.toUpperCase()||"ADMIN", b=parseInt(document.getElementById('qBat').value)||0;
            if(!p) return alert("Plat Kosong!");
            runTransaction(db, async(t)=>{
                const d=(await t.get(ref)).data();
                let q=d.waitingQueue||[];
                q.forEach((x,i)=>x.qNo=i+1);
                q.push({plat:p, userName:n, wa:'-', startBattery:b, qNo:q.length+1});
                t.update(ref, {waitingQueue:q});
                addLog('REG', `${p}`);
            });
        };

        window.manualAssign = () => {
            const s=document.getElementById('manSlot').value || 0; // Fallback 0
            const p=prompt("Plat:"); if(!p) return;
            const b=prompt("Baterai %:") || 50;
            runTransaction(db, async(t)=>{
                const d=(await t.get(ref)).data();
                const dur = calcDur(b, 98);
                d.chargingSlots[s] = {plat:p.toUpperCase(), userName:'ADMIN', wa:'-', startBattery:parseInt(b), durationMinutes:dur, startTime:new Date(), targetLimit:98, qNo:'ADM'};
                t.update(ref, {chargingSlots:d.chargingSlots});
                addLog('FORCE', `S${parseInt(s)+1} : ${p}`);
            });
        };

        window.returnToQueue = () => {
            const s=document.getElementById('retSlot').value || 0;
            runTransaction(db, async(t)=>{
                const d=(await t.get(ref)).data();
                const item=d.chargingSlots[s];
                if(!item) return;
                let q=d.waitingQueue||[];
                q.forEach((x,i)=>x.qNo=i+1);
                q.push({...item, startTime:null, qNo:q.length+1});
                d.chargingSlots[s]=null;
                t.update(ref, {chargingSlots:d.chargingSlots, waitingQueue:q});
                addLog('RET', `${item.plat} -> Q`);
            });
        };

        window.stopAll = () => { if(confirm("Stop All?")) { updateDoc(ref, {chargingSlots:[null,null,null]}); addLog('STOP ALL','-'); } };
        window.resetDB = () => { if(confirm("RESET DB?")) { setDoc(ref, {chargingSlots:[null,null,null], waitingQueue:[], blockedList:[]}); addLog('RESET','-'); } };

        // LOG
        onSnapshot(query(logRef, orderBy("timestamp", "desc"), limit(20)), (snap)=>{
            let h=''; 
            snap.forEach(doc=>{
                const d=doc.data();
                const tm = d.timestamp ? d.timestamp.toDate().toLocaleTimeString('en-GB') : '-';
                h+=`<div class="log-row"><span class="l-time">[${tm}]</span><span class="l-act">${d.action}</span><span class="l-msg">${d.details}</span></div>`;
            });
            document.getElementById('termuxLog').innerHTML=h;
        });
        function addLog(a,d){ addDoc(logRef, {timestamp:new Date(), action:a, details:d}); }

        const CHARGING_CURVE = [ [100, 0], [91, 10], [81, 26], [75, 32], [72, 35], [70, 40], [69, 41], [61, 47], [59, 49], [56, 50], [54, 51], [51, 56], [48, 58], [42, 58], [28, 66], [22, 72], [0, 95] ];
        function calcDur(start, target) {
            let s=95, t=0;
            for(let i=0; i<CHARGING_CURVE.length-1; i++){ if(start<=CHARGING_CURVE[i][0] && start>=CHARGING_CURVE[i+1][0]) { const r=(CHARGING_CURVE[i][0]-start)/(CHARGING_CURVE[i][0]-CHARGING_CURVE[i+1][0]); s=CHARGING_CURVE[i][1]+r*(CHARGING_CURVE[i+1][1]-CHARGING_CURVE[i+1][1]); break; } }
            for(let i=0; i<CHARGING_CURVE.length-1; i++){ if(target<=CHARGING_CURVE[i][0] && target>=CHARGING_CURVE[i+1][0]) { const r=(CHARGING_CURVE[i][0]-target)/(CHARGING_CURVE[i][0]-CHARGING_CURVE[i+1][0]); t=CHARGING_CURVE[i][1]+r*(CHARGING_CURVE[i+1][1]-CHARGING_CURVE[i+1][1]); break; } }
            return Math.max(1, Math.ceil(s - t));
        }
        
        // Interval Mini TV Timer
        setInterval(() => {
            latestSlots.forEach((s, i) => {
                if(s && s.plat && s.startTime) {
                    const st = s.startTime.toDate ? s.startTime.toDate() : new Date(s.startTime);
                    const diff = (new Date(st.getTime() + s.durationMinutes*60000)) - new Date();
                    const remSec = diff / 1000;
                    let txt = "DONE";
                    if(remSec > 0) {
                        const m = Math.floor(remSec/60);
                        const sc = Math.floor(remSec%60);
                        txt = `${m}:${sc<10?'0'+sc:sc}`;
                        // Update batre visual
                        const tot = s.durationMinutes * 60;
                        const elap = (new Date() - st)/1000;
                        let p = elap/tot; if(p>1)p=1;
                        let b = Math.round(s.startBattery + ((98-s.startBattery)*p));
                        document.getElementById(`s${i+1}-bat`).innerText = b+"%";
                    }
                    document.getElementById(`s${i+1}-timer`).innerText = txt;
                }
            });
        }, 1000);
    </script>
</body>
</html>
