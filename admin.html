<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN SUPER - FC KG (ULTIMATE)</title>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* === STYLE DASAR & TERMINAL THEME === */
        :root { 
            --bg: #050505; --panel: #111; --border: #333; 
            --accent: #CCFF00; --cyan: #00F0FF; --red: #FF003C; 
            --term-bg: #000; --term-text: #0f0; 
        }
        body { background: #0a0a0a; color: #fff; font-family: 'JetBrains Mono', monospace; padding: 10px; font-size: 11px; margin: 0; }
        
        .box { border: 1px solid #333; padding: 15px; margin-bottom: 15px; background: #000; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        h3 { margin: 0 0 15px 0; color: var(--cyan); border-bottom: 1px solid #333; padding-bottom: 5px; font-family: 'Teko', sans-serif; font-size: 18px; letter-spacing: 1px; }
        
        button { cursor: pointer; padding: 8px 12px; margin: 0; font-weight: bold; font-family: 'Teko'; font-size: 14px; letter-spacing: 0.5px; border-radius: 4px; transition: 0.2s; border: none; text-transform: uppercase; }
        button:hover { filter: brightness(1.2); transform: translateY(-1px); }
        button:active { transform: translateY(1px); }
        
        .btn-red { background: linear-gradient(45deg, #900, #d00); color: #fff; border: 1px solid #f00; }
        .btn-green { background: linear-gradient(45deg, #050, #090); color: #fff; border: 1px solid #0f0; }
        .btn-blue { background: linear-gradient(45deg, #005, #009); color: #fff; border: 1px solid #00f; }
        .btn-yellow { background: linear-gradient(45deg, #B8860B, #FFD700); color: #000; border: 1px solid #FFD700; text-shadow: none; }
        .btn-mini { padding: 4px 8px; font-size: 12px; margin: 2px; }

        input, select { background: #1a1a1a; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 4px; font-family: 'JetBrains Mono'; width: 100%; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        td, th { border: 1px solid #333; padding: 8px; text-align: left; vertical-align: middle; }
        th { background: #111; color: var(--accent); }

        .slot-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
        .slot-item { border: 1px solid #333; padding: 10px; background: #050505; text-align: center; border-radius: 5px; min-height: 120px; display: flex; flex-direction: column; justify-content: space-between; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; }
        .stat-card { background: #111; padding: 10px; border: 1px solid #333; border-radius: 5px; }
        .stat-val { font-size: 20px; color: var(--accent); font-family: 'Teko'; }
        
        /* === TERMUX / BRUTAL LOG STYLE === */
        .term-container {
            background: var(--term-bg); border: 1px solid #333; height: 400px; 
            overflow-y: auto; padding: 10px; font-family: 'JetBrains Mono', monospace; 
            font-size: 10px; color: #ccc; border-radius: 5px;
            display: flex; flex-direction: column-reverse; /* Log baru di bawah */
        }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #111; padding-bottom: 2px; line-height: 1.4; word-wrap: break-word; }
        .ts { color: #666; margin-right: 5px; }
        
        /* WARNA ACTOR */
        .act-admin { color: var(--red); font-weight: bold; }   /* Merah */
        .act-system { color: var(--cyan); font-weight: bold; } /* Cyan */
        .act-user { color: var(--accent); font-weight: bold; } /* Hijau Stabilo */
        
        .cmd { color: #fff; font-weight: bold; margin-right: 5px; }
        .dtl { color: #aaa; font-style: italic; }

        /* MODAL & LOGIN */
        #customModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #111; border: 1px solid var(--cyan); width: 85%; padding: 20px; border-radius: 10px; text-align: center; animation: popIn 0.3s; }
        @keyframes popIn { from{transform:scale(0.8); opacity:0;} to{transform:scale(1); opacity:1;} }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .mb-yes { flex:1; background: var(--cyan); color: #000; }
        .mb-no { flex:1; background: transparent; border: 1px solid #555; color: #888; }

        #loginOverlay { display: flex; position: fixed; inset: 0; background: #000; z-index: 10000; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { width: 300px; padding: 30px; border: 1px solid var(--accent); border-radius: 10px; background: #111; text-align: center; box-shadow: 0 0 30px rgba(204, 255, 0, 0.1); }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="font-family:'Teko'; color:var(--accent); margin-top:0;">LOGIN ADMIN</h2>
            <div style="margin-bottom:15px; text-align:left;">
                <label style="color:#888;">NAMA ADMIN:</label>
                <input type="text" id="loginName" placeholder="Contoh: Admin Budi" style="margin-top:5px; border-color:var(--accent);">
            </div>
            <div style="margin-bottom:20px; text-align:left;">
                <label style="color:#888;">PIN AKSES:</label>
                <input type="password" id="loginPin" placeholder="****" style="margin-top:5px; border-color:var(--accent);">
            </div>
            <button onclick="attemptLogin()" class="btn-green" style="width:100%; font-size:18px;">MASUK</button>
            <div style="margin-top:15px; font-size:10px; color:#555;">SYSTEM V5.0 SUPER LOG</div>
        </div>
    </div>

    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
        <div>
            <span style="font-family:'Teko'; font-size:24px; color:var(--cyan);">ADMIN PANEL <span style="color:var(--accent);">v5.0</span></span>
            <div id="displayAdminName" style="color:#666; font-size:10px;">User: -</div>
        </div>
        <div style="display:flex; gap:5px;">
            <button onclick="window.location.href='antrian.html'" class="btn-blue">DEPAN</button>
            <button onclick="logout()" class="btn-red">KELUAR</button>
        </div>
    </div>

    <div class="box" style="border-top: 3px solid var(--cyan);">
        <h3>1. MONITOR & KONTROL SLOT</h3>
        <div class="slot-grid">
            <div id="slot1" class="slot-item">LOADING...</div>
            <div id="slot2" class="slot-item">LOADING...</div>
            <div id="slot3" class="slot-item">LOADING...</div>
        </div>
        
        <div style="margin-top:15px; padding-top:10px; border-top:1px dashed #333;">
            <div style="color:#888; margin-bottom:5px;">TUKAR POSISI SLOT:</div>
            <div style="display:grid; grid-template-columns: 1fr auto 1fr auto; gap:5px; align-items:center;">
                <select id="moveSrc"><option value="0">S 1</option><option value="1">S 2</option><option value="2">S 3</option></select>
                <div>➟</div>
                <select id="moveDest"><option value="1">S 2</option><option value="2">S 3</option><option value="0">S 1</option></select>
                <button onclick="askConfirm('Tukar User?', moveSlotUser)" class="btn-blue">GO</button>
            </div>
        </div>
    </div>

    <div class="box" style="border-top: 3px solid var(--accent);">
        <h3>2. ANTRIAN & INPUT</h3>
        <div id="queueTable" style="max-height:250px; overflow-y:auto; margin-bottom:10px;"></div>
        
        <div style="border-top:1px dashed #333; padding-top:10px;">
            <div style="margin-bottom:5px; color:#888;">INPUT MANUAL:</div>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input id="newPlat" placeholder="PLAT (B 1234)" style="flex:1; text-transform:uppercase;">
                <input id="newName" placeholder="NAMA" style="flex:1; text-transform:uppercase;">
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <button onclick="askConfirm('Tambah ke Antrian?', () => manualAdd('queue'))" class="btn-green">+ ANTRIAN</button>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:2px;">
                    <button onclick="askConfirm('Force Slot 1?', () => manualAdd(0))" class="btn-yellow">S1</button>
                    <button onclick="askConfirm('Force Slot 2?', () => manualAdd(1))" class="btn-yellow">S2</button>
                    <button onclick="askConfirm('Force Slot 3?', () => manualAdd(2))" class="btn-yellow">S3</button>
                </div>
            </div>
        </div>
    </div>
    <div class="box" style="border-top: 3px solid #fff;">
        <h3 style="display:flex; justify-content:space-between; align-items:center;">
            STATISTIK HARI INI
            <button onclick="loadAnalytics()" class="btn-blue btn-mini">REFRESH</button>
        </h3>
        <div class="stat-grid">
            <div class="stat-card"><div class="stat-val" id="stat-total">0</div><div style="font-size:9px; color:#666">SELESAI</div></div>
            <div class="stat-card"><div class="stat-val" id="stat-busy">-</div><div style="font-size:9px; color:#666">JAM SIBUK</div></div>
            <div class="stat-card"><div class="stat-val" id="stat-avg">0m</div><div style="font-size:9px; color:#666">AVG DURASI</div></div>
            <div class="stat-card"><div class="stat-val" id="stat-active">0</div><div style="font-size:9px; color:#666">QUEUE</div></div>
        </div>
    </div>

    <div class="box">
        <h3>3. LAPORAN & RESET</h3>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <select id="reportRange" onchange="toggleCustomDate()" style="flex:2;">
                <option value="today">HARI INI</option>
                <option value="yesterday">KEMARIN</option>
                <option value="7days">7 HARI</option>
                <option value="custom">CUSTOM...</option>
            </select>
            <button onclick="generateReport()" class="btn-green" style="flex:1;">CSV</button>
        </div>
        <div id="customDateArea" style="display:none; margin-bottom:10px; background:#222; padding:5px;">
            <input type="date" id="dateStart" style="margin-bottom:5px;">
            <input type="date" id="dateEnd">
        </div>
        
        <button onclick="askConfirm('RESET NOMOR JADI 1 (NEW DAY)?', resetDaily)" class="btn-yellow" style="width:100%; margin-bottom:10px;">
            ☀ RESET TIKET HARIAN (NEW DAY) ☀
        </button>

        <button onclick="askConfirm('RESET SEMUA?? (MANUAL)', resetTotal)" class="btn-red" style="width:100%;">⚠ RESET TOTAL MANUAL ⚠</button>
    </div>

    <div class="box">
        <h3>4. SYSTEM LOGS (TERMINAL VIEW)</h3>
        <div class="term-container" id="termLog">
            <div class="log-line">Waiting for logs...</div>
        </div>
    </div>

    <div id="customModal">
        <div class="modal-box">
            <h2 style="margin:0 0 10px 0; font-family:'Teko'; color:#fff;">KONFIRMASI</h2>
            <div id="modalText" style="color:#ccc; margin-bottom:20px;">Text</div>
            <div class="modal-btns">
                <button id="btnYes" class="mb-yes">YA</button>
                <button onclick="closeModal()" class="mb-no">TIDAK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, runTransaction, collection, addDoc, query, orderBy, limit, getDocs, where, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // === CONFIG SAMA DENGAN USER (JANGAN UBAH) ===
        const firebaseConfig = {
            apiKey: "AIzaSyB666i9lYWIpxOdkwpoX9EvFvHLmHczeq8",
            authDomain: "fcgadingnew22.firebaseapp.com",
            projectId: "fcgadingnew22",
            storageBucket: "fcgadingnew22.firebasestorage.app",
            messagingSenderId: "537736846678",
            appId: "1:537736846678:web:53788d71a196423ac08af7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const mainRef = doc(db, "antrian", "utama");
        const logRef = collection(db, "activityLog");
        const histRef = collection(db, "riwayatCharging");

        let cachedSlots = [null, null, null];
        let cachedQueue = [];

        // === LOGIN LOGIC ===
        const SESSION_KEY = 'adm_sess_v5';
        const currentAdmin = localStorage.getItem(SESSION_KEY);
        
        if(currentAdmin) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('displayAdminName').innerText = "User: " + currentAdmin;
        }

        window.attemptLogin = () => {
            const name = document.getElementById('loginName').value;
            const pin = document.getElementById('loginPin').value;
            if(pin === "1131" && name.trim() !== "") {
                localStorage.setItem(SESSION_KEY, name.trim());
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('displayAdminName').innerText = "User: " + name.trim();
                addLog("ADMIN", "LOGIN", "Login success (New Session)");
            } else { alert("PIN Salah!"); }
        };

        window.logout = () => { 
            localStorage.removeItem(SESSION_KEY); 
            window.location.href='index.html'; 
        };

        // === MODAL UTILS ===
        let currentCallback = null;
        window.askConfirm = (text, callback) => {
            document.getElementById('modalText').innerText = text;
            document.getElementById('customModal').style.display = 'flex';
            currentCallback = callback;
        };
        document.getElementById('btnYes').onclick = () => { if(currentCallback) currentCallback(); closeModal(); };
        window.closeModal = () => { document.getElementById('customModal').style.display = 'none'; currentCallback = null; };

        function getTodayString() { return new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Jakarta' }); }

        // === REALTIME LISTENER ===
        onSnapshot(mainRef, (snap) => {
            if (!snap.exists()) return;
            const d = snap.data();
            cachedSlots = d.chargingSlots || [null,null,null];
            cachedQueue = d.waitingQueue || [];

            // Render Slot
            cachedSlots.forEach((s, i) => {
                const el = document.getElementById(`slot${i+1}`);
                if(s) {
                    el.innerHTML = `
                        <div style="color:var(--cyan); font-weight:bold; font-size:14px;">${s.plat}</div>
                        <div style="font-size:10px; color:#ccc;">${s.userName} (#${s.qNo})</div>
                        <div style="margin-top:auto; display:grid; grid-template-columns:1fr 1fr; gap:2px;">
                            <button class="btn-red btn-mini" onclick="askConfirm('Stop Charging?', ()=>forceStop(${i}))">STOP</button>
                            <button class="btn-yellow btn-mini" onclick="askConfirm('Turunkan ke Antrian?', ()=>kickToQueue(${i}))">TURUN KE ANTRIAN</button>
                        </div>
                    `;
                    el.style.border = "1px solid var(--cyan)";
                } else {
                    el.innerHTML = `<div style="color:#444; margin:auto;">KOSONG</div>`;
                    el.style.border = "1px solid #333";
                }
            });
            renderQueueTable();
            document.getElementById('stat-active').innerText = cachedQueue.length;
        });

        // Render Tabel Antrian dengan Panah Naik/Turun
        function renderQueueTable() {
            let h = `<table><tr><th width="20">#</th><th>USER</th><th>AKSI</th></tr>`;
            if(cachedQueue.length === 0) h += `<tr><td colspan="3" style="text-align:center; color:#444;">KOSONG</td></tr>`;
            
            // Urutkan manual (FIFO/Array Order) - JANGAN DISORTIR OTOMATIS SUPAYA BISA NAIK TURUN
            cachedQueue.forEach((q, idx) => {
                const upDisabled = (idx === 0) ? 'disabled style="opacity:0.3"' : '';
                const downDisabled = (idx === cachedQueue.length - 1) ? 'disabled style="opacity:0.3"' : '';

                h += `<tr>
                    <td>${q.qNo}</td>
                    <td><b style="color:var(--accent)">${q.plat}</b><br>${q.userName}</td>
                    <td>
                        <div style="display:flex; gap:2px; flex-wrap:wrap;">
                            <button class="btn-blue btn-mini" onclick="switchQueue(${idx}, -1)" ${upDisabled}>⬆</button>
                            <button class="btn-blue btn-mini" onclick="switchQueue(${idx}, 1)" ${downDisabled}>⬇</button>
                            <button class="btn-green btn-mini" onclick="pushToSlot('${q.plat}',0)">S1</button>
                            <button class="btn-green btn-mini" onclick="pushToSlot('${q.plat}',1)">S2</button>
                            <button class="btn-green btn-mini" onclick="pushToSlot('${q.plat}',2)">S3</button>
                            <button class="btn-red btn-mini" onclick="askConfirm('Hapus?', ()=>delQueue('${q.plat}'))">X</button>
                        </div>
                    </td>
                </tr>`;
            });
            document.getElementById('queueTable').innerHTML = h + `</table>`;
        }

        // === ACTIONS (NAIK TURUN DLL) ===
        
        // FUNGSI NAIK TURUN ANTRIAN (SWAP ARRAY)
        window.switchQueue = (idx, direction) => {
            runTransaction(db, async(t) => {
                const d = (await t.get(mainRef)).data();
                let q = d.waitingQueue || [];
                
                const targetIdx = idx + direction;
                if (targetIdx < 0 || targetIdx >= q.length) return; // Validasi batas
                
                // Swap Posisi
                const temp = q[idx];
                q[idx] = q[targetIdx];
                q[targetIdx] = temp;
                
                t.update(mainRef, { waitingQueue: q });
                addLog("ADMIN", "SWAP_QUEUE", `Swapped Q#${idx+1} with Q#${targetIdx+1}`);
            });
        };

        window.manualAdd = (target) => {
            const p = document.getElementById('newPlat').value.toUpperCase();
            const n = document.getElementById('newName').value.toUpperCase();
            if(!p) return alert("PLAT KOSONG");
            runTransaction(db, async(t) => {
                const docSnap = await t.get(mainRef);
                let d = docSnap.exists() ? docSnap.data() : { chargingSlots: [null,null,null], waitingQueue: [], recycledNumbers: [], lastTicket: 0, lastResetDate: getTodayString() };
                if(!docSnap.exists()) t.set(mainRef, d);

                if([...(d.chargingSlots||[]), ...d.waitingQueue].some(u => u && u.plat === p)) throw "Plat Exist";
                let newNo = (d.recycledNumbers||[]).length>0 ? d.recycledNumbers.sort((a,b)=>a-b).shift() : (d.lastTicket||0)+1;
                const u = { plat:p, userName:n, wa:'ADMIN', qNo:newNo, entryTime:Date.now() };

                let loc = "";
                if(target === 'queue') { d.waitingQueue.push(u); loc="QUEUE"; } 
                else { if(d.chargingSlots[target]) throw "Penuh"; u.startTime=Date.now(); d.chargingSlots[target]=u; loc=`SLOT ${target+1}`; }

                t.set(mainRef, { waitingQueue:d.waitingQueue, chargingSlots:d.chargingSlots, recycledNumbers:d.recycledNumbers||[], lastTicket:Math.max(d.lastTicket||0,newNo), lastResetDate: getTodayString() }, {merge:true});
                addLog("ADMIN", "MANUAL_ADD", `Input ${p} (${n}) to ${loc}`);
            }).then(()=>{ document.getElementById('newPlat').value=''; }).catch(e=>alert(e));
        };

        window.pushToSlot = (p, sIdx) => {
            runTransaction(db, async(t) => {
                const d = (await t.get(mainRef)).data();
                if(d.chargingSlots[sIdx]) throw "Penuh";
                const i = d.waitingQueue.findIndex(x => x.plat === p);
                if(i<0) throw "Hilang";
                const u = d.waitingQueue.splice(i,1)[0];
                u.startTime = Date.now(); d.chargingSlots[sIdx] = u;
                t.update(mainRef, { waitingQueue:d.waitingQueue, chargingSlots:d.chargingSlots });
                addLog("ADMIN", "FORCE_IN", `Pushed ${p} to Slot ${sIdx+1}`);
            }).catch(e=>alert(e));
        };

        window.kickToQueue = (i) => {
            runTransaction(db, async(t) => {
                const d = (await t.get(mainRef)).data();
                const u = d.chargingSlots[i];
                if(!u) return;
                d.chargingSlots[i]=null; delete u.startTime; d.waitingQueue.unshift(u);
                t.update(mainRef, { chargingSlots:d.chargingSlots, waitingQueue:d.waitingQueue });
                addLog("ADMIN", "KICK_TO_QUEUE", `Moved ${u.plat} from S${i+1} down to Queue`);
            });
        };

        window.forceStop = (i) => {
            runTransaction(db, async(t) => {
                const d = (await t.get(mainRef)).data();
                const u = d.chargingSlots[i];
                if(u) { 
                    addDoc(histRef, {...u, finishTime:new Date(), timestamp:new Date(), by:'ADMIN'}); 
                    d.chargingSlots[i]=null; 
                    t.update(mainRef, {chargingSlots:d.chargingSlots}); 
                    addLog("ADMIN", "STOP_CHARGE", `Stopped ${u.plat} at S${i+1}`);
                }
            });
        };

        window.moveSlotUser = () => {
            const s1 = document.getElementById('moveSrc').value;
            const s2 = document.getElementById('moveDest').value;
            if(s1==s2) return alert("Sama");
            runTransaction(db, async(t) => {
                const d = (await t.get(mainRef)).data();
                const t1 = d.chargingSlots[s1]; d.chargingSlots[s1] = d.chargingSlots[s2]; d.chargingSlots[s2] = t1;
                t.update(mainRef, { chargingSlots:d.chargingSlots });
                addLog("ADMIN", "SWAP_SLOT", `Swapped S${parseInt(s1)+1} <-> S${parseInt(s2)+1}`);
            });
        };

        window.delQueue = (p) => {
            runTransaction(db, async(t) => {
                const d = (await t.get(mainRef)).data();
                const i = d.waitingQueue.findIndex(x => x.plat === p);
                if(i>-1) {
                    const u = d.waitingQueue.splice(i,1)[0];
                    let r = d.recycledNumbers||[]; r.push(u.qNo);
                    t.update(mainRef, { waitingQueue:d.waitingQueue, recycledNumbers:r });
                    addLog("ADMIN", "DELETE_Q", `Removed ${p} from queue`);
                }
            });
        };

        // === FUNGSI RESET HARIAN (AMAN) ===
        window.resetDaily = () => {
            runTransaction(db, async(t) => {
                const docSnap = await t.get(mainRef);
                const d = docSnap.data();
                const currentSlots = d.chargingSlots || [null, null, null];
                t.set(mainRef, { 
                    chargingSlots: currentSlots, 
                    waitingQueue: [], recycledNumbers: [], lastTicket: 0, lastResetDate: getTodayString() 
                });
                addLog("ADMIN", "NEW_DAY", "Reset Nomor Antrian ke 1 (Daily Reset)");
            }).then(() => { alert("BERHASIL! Nomor Antrian kembali ke 1. Slot aman."); }).catch(e => alert("Error: " + e));
        };

        // === FUNGSI RESET TOTAL (BAHAYA) ===
        window.resetTotal = () => {
            setDoc(mainRef, { chargingSlots:[null,null,null], waitingQueue:[], recycledNumbers:[], lastTicket:0, lastResetDate: getTodayString() })
            .then(() => { addLog("ADMIN", "RESET_ALL", "System Reset Triggered"); });
        };

        window.toggleCustomDate = () => { document.getElementById('customDateArea').style.display = (document.getElementById('reportRange').value === 'custom') ? 'block' : 'none'; }
        
        window.generateReport = async () => {
            const range = document.getElementById('reportRange').value;
            let start = new Date(); start.setHours(0,0,0,0); let end = new Date(); end.setHours(23,59,59,999);
            if(range === 'yesterday') { start.setDate(start.getDate()-1); end.setDate(end.getDate()-1); }
            else if(range === '7days') { start.setDate(start.getDate()-6); }
            else if(range === 'custom') { start = new Date(document.getElementById('dateStart').value); end = new Date(document.getElementById('dateEnd').value); end.setHours(23,59,59,999); }
            
            const q = query(histRef, orderBy("timestamp", "desc"));
            const snap = await getDocs(q);
            let csv = "TANGGAL,MASUK,KELUAR,DURASI,PLAT,NAMA\n";
            snap.forEach(d => {
                const x = d.data(); const dt = x.timestamp.toDate();
                if(dt >= start && dt <= end) {
                    const dur = (x.startTime && x.finishTime) ? Math.round((x.finishTime.toDate()-x.startTime)/60000) : 0;
                    csv += `${dt.toLocaleDateString()},${x.entryTime?new Date(x.entryTime).toLocaleTimeString():'-'},${x.finishTime?x.finishTime.toDate().toLocaleTimeString():'-'},${dur},${x.plat},${x.userName}\n`;
                }
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a'); a.href = window.URL.createObjectURL(blob); a.download = 'Report.csv'; a.click();
        };

        window.loadAnalytics = async () => {
            const today = new Date(); today.setHours(0,0,0,0);
            const snap = await getDocs(query(histRef, where("timestamp", ">=", today)));
            let tot=0, dur=0, hMap={};
            snap.forEach(d => {
                const x = d.data(); tot++;
                if(x.startTime && x.finishTime) dur += (x.finishTime.toDate()-x.startTime)/60000;
                if(x.entryTime) { const h=new Date(x.entryTime).getHours(); hMap[h]=(hMap[h]||0)+1; }
            });
            let busy='-', mx=0; for(const[k,v] of Object.entries(hMap)) if(v>mx){mx=v; busy=`${k}:00`;}
            document.getElementById('stat-total').innerText = tot;
            document.getElementById('stat-avg').innerText = (tot>0?Math.round(dur/tot):0) + "m";
            document.getElementById('stat-busy').innerText = busy;
        };
        setTimeout(loadAnalytics, 2000);

        // === TERMINAL LOG LISTENER (BRUTAL DETAIL) ===
        onSnapshot(query(logRef, orderBy("timestamp", "desc"), limit(30)), (snap) => {
            let h = '';
            const docs = [];
            snap.forEach(d => docs.push(d.data()));
            docs.reverse(); // Urutan bawah = terbaru

            docs.forEach(data => {
                let timeStr = "??:??:??";
                if(data.timestamp && data.timestamp.toDate) {
                    const dt = data.timestamp.toDate();
                    timeStr = `${dt.getHours().toString().padStart(2,'0')}:${dt.getMinutes().toString().padStart(2,'0')}:${dt.getSeconds().toString().padStart(2,'0')}.${dt.getMilliseconds().toString().padStart(3,'0')}`;
                }

                let actorClass = 'act-system'; 
                const act = (data.actor || 'SYSTEM').toUpperCase();
                if(act.includes('ADMIN')) actorClass = 'act-admin';
                else if(act.includes('SYSTEM')) actorClass = 'act-system';
                else actorClass = 'act-user';

                h += `<div class="log-line">
                    <span class="ts">[${timeStr}]</span>
                    <span class="${actorClass}">[${act}]</span>
                    <span class="cmd">${data.action}</span>
                    <span class="dtl">> ${data.details}</span>
                </div>`;
            });
            const cont = document.getElementById('termLog');
            cont.innerHTML = h;
            cont.scrollTop = cont.scrollHeight; 
        });

        // Add Log Helper
        function addLog(actor, act, det) { 
            let finalActor = actor;
            if(actor === 'ADMIN') {
                finalActor = (localStorage.getItem(SESSION_KEY) || 'ADMIN').toUpperCase();
            }
            addDoc(logRef, { 
                action: act, 
                details: det, 
                actor: finalActor, 
                timestamp: new Date() 
            }); 
        }
    </script>
</body>
</html>
