<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FC Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #141414; --surface: #1e1e1e; --border: #333; --text: #eee; --accent: #CCFF00; --red: #ff4444; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; box-sizing: border-box; }
        
        /* HEADER & LOGIN */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 16px; color: var(--accent); }
        .login-box { max-width: 300px; margin: 50px auto; text-align: center; padding: 20px; border: 1px solid var(--border); border-radius: 10px; background: var(--surface); }
        input, select { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: #fff; margin-bottom: 10px; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        button { width: 100%; padding: 12px; background: var(--accent); border: none; font-weight: 800; cursor: pointer; border-radius: 6px; font-size: 14px; color: #000; }
        button.red { background: rgba(255,68,68,0.2); color: var(--red); border: 1px solid var(--red); }
        
        /* LAYOUT */
        .grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media(min-width: 768px) { .grid { grid-template-columns: 350px 1fr; } } 
        
        .card { background: var(--surface); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; }
        h2 { font-size: 14px; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; color: #888; }
        
        /* LOG LIST */
        .log-container { height: 500px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .log-card { background: #252525; padding: 10px; border-radius: 6px; border-left: 4px solid #555; font-size: 12px; }
        .log-head { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; color: #aaa; font-size: 10px; }
        .log-body { color: #fff; line-height: 1.4; }
        
        .status-KRITIS { border-left-color: var(--red); background: rgba(255,0,0,0.1); }
        .status-AWAS { border-left-color: orange; }
        .status-INFO { border-left-color: var(--accent); }
        
        .action-needed { margin-top: 8px; padding: 8px; background: rgba(255,0,0,0.2); border: 1px dashed var(--red); color: #ffcccc; border-radius: 4px; }
        .action-title { font-weight: 900; color: var(--red); display: block; margin-bottom: 2px; }

        .btn-group { display: flex; gap: 5px; }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-box">
        <h2 style="color:var(--accent)">SUPER ADMIN</h2>
        <input type="password" id="pinInput" placeholder="PIN: 8080" style="text-align:center;">
        <button onclick="login()">MASUK</button>
        <br><br><a href="antrian.html" style="color:#666;font-size:12px;text-decoration:none;">← KEMBALI KE LAYAR USER</a>
    </div>

    <div id="dashboard" style="display:none;">
        <div class="header">
            <h1>ADMIN CONSOLE</h1>
            <button onclick="logout()" class="red" style="width:auto; padding:8px 15px;">KELUAR</button>
        </div>

        <div class="grid">
            <div>
                <div class="card">
                    <h2>KONTROL SLOT</h2>
                    <select id="manSlot"></select>
                    <div class="btn-group">
                        <input id="manPlat" placeholder="Plat">
                        <input id="manBat" type="number" placeholder="%" style="width:60px;">
                    </div>
                    <button onclick="manualAssign()">ISI SLOT (PAKSA)</button>
                    <button onclick="clearSlot()" class="red" style="margin-top:5px;">KOSONGKAN & TARIK ANTRIAN</button>
                </div>

                <div class="card">
                    <h2>ANTRIAN MANUAL</h2>
                    <input id="qPlat" placeholder="Plat">
                    <div class="btn-group">
                        <input id="qName" placeholder="Nama">
                        <input id="qBat" type="number" placeholder="%" style="width:60px;">
                    </div>
                    <input id="qWA" placeholder="WA">
                    <button onclick="regQueue()">DAFTAR ANTRIAN</button>
                    <hr style="border:0; border-top:1px dashed #333; margin:15px 0;">
                    <label style="font-size:10px; color:#888;">PINDAHKAN ANTRIAN</label>
                    <div class="btn-group">
                        <select id="qIdx"></select>
                        <select id="qTarget"></select>
                    </div>
                    <button onclick="moveQueue()">PINDAHKAN</button>
                </div>

                <div class="card">
                    <h2>KEAMANAN (BLOKIR)</h2>
                    <input id="blockPlat" placeholder="Plat Bermasalah">
                    <div class="btn-group">
                        <button onclick="doBlock()" class="red">BLOKIR</button>
                        <button onclick="doUnblock()" style="background:#444; color:#fff;">BUKA BLOKIR</button>
                    </div>
                    <div id="blockList" style="font-size:10px; color:var(--red); margin-top:5px;"></div>
                </div>
            </div>

            <div class="card" style="height:calc(100vh - 100px); padding:0; background:transparent; border:none;">
                <h2 style="color:var(--accent);">LOG AKTIVITAS (REAL-TIME)</h2>
                <div id="logContainer" class="log-container">
                    <div style="text-align:center; color:#666; padding-top:50px;">Menunggu Data...</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, runTransaction, collection, addDoc, query, orderBy, limit, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyALIlkIDALIk83K8s1htalvW6rmNNw02Go", authDomain: "sistem-antrian-b1c39.firebaseapp.com", projectId: "sistem-antrian-b1c39", storageBucket: "sistem-antrian-b1c39.firebasestorage.app", messagingSenderId: "454124587608", appId: "1:454124587608:web:34fbb0f5211067a67f982d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const ref = doc(db, "antrian", "utama");
        const logRef = collection(db, "activityLog");

        const PIN = "8080";
        let isAuth = false;

        // AUTH
        window.login = () => {
            if(document.getElementById('pinInput').value === PIN) {
                localStorage.setItem('saAuth', 'true'); checkAuth();
            } else alert('PIN SALAH');
        };
        window.logout = () => { localStorage.removeItem('saAuth'); window.location.href="antrian.html"; };
        function checkAuth() {
            isAuth = localStorage.getItem('saAuth') === 'true';
            document.getElementById('loginScreen').style.display = isAuth ? 'none' : 'block';
            document.getElementById('dashboard').style.display = isAuth ? 'block' : 'none';
        }

        // LOGIC BATERAI (SAMA DENGAN USER)
        const CHARGING_CURVE = [[100,0],[99,2],[97,5],[95,6],[92,9],[91,10],[87,21],[81,26],[72,35],[68,42],[61,47],[56,50],[20,72],[10,80],[0,90]];
        function calculateDuration(start, target) {
            if (start >= target) return 5;
            let timeStart=90, timeTarget=0;
            for(let i=0; i<CHARGING_CURVE.length-1; i++){ if(start<=CHARGING_CURVE[i][0] && start>=CHARGING_CURVE[i+1][0]) { const r=(CHARGING_CURVE[i][0]-start)/(CHARGING_CURVE[i][0]-CHARGING_CURVE[i+1][0]); timeStart=CHARGING_CURVE[i][1]+r*(CHARGING_CURVE[i+1][1]-CHARGING_CURVE[i][1]); break; }}
            for(let i=0; i<CHARGING_CURVE.length-1; i++){ if(target<=CHARGING_CURVE[i][0] && target>=CHARGING_CURVE[i+1][0]) { const r=(CHARGING_CURVE[i][0]-target)/(CHARGING_CURVE[i][0]-CHARGING_CURVE[i+1][0]); timeTarget=CHARGING_CURVE[i][1]+r*(CHARGING_CURVE[i+1][1]-CHARGING_CURVE[i][1]); break; }}
            return Math.max(1, Math.ceil(timeStart - timeTarget));
        }
        function calculateTargetLimit(len) { return len>=6?90 : len>=3?95 : 100; }

        // INIT
        window.onload = () => {
            checkAuth();
            const qLog = query(logRef, orderBy("timestamp", "desc"), limit(50));
            onSnapshot(qLog, renderLogs);
            onSnapshot(ref, (snap) => {
                const d = snap.data() || {};
                const s = d.chargingSlots || [null,null,null];
                const q = d.waitingQueue || [];
                
                const sOpt = s.map((_,i)=>`<option value="${i}">Slot ${i+1}</option>`).join('');
                document.getElementById('manSlot').innerHTML = sOpt;
                document.getElementById('qTarget').innerHTML = sOpt;
                
                const qOpt = q.length ? q.map((x,i)=>`<option value="${i}">#${i+1} ${x.plat}</option>`).join('') : '<option value="-1">Kosong</option>';
                document.getElementById('qIdx').innerHTML = qOpt;

                document.getElementById('blockList').innerText = "List Blokir: " + (d.blockedList||[]).join(', ');
            });
        };

        // RENDER LOGS
        function renderLogs(snap) {
            const c = document.getElementById('logContainer');
            if(snap.empty) return;
            let h = '';
            snap.forEach(doc => {
                const d = doc.data();
                const time = d.timestamp?.toDate().toLocaleTimeString('id-ID');
                let status = 'INFO';
                let tips = '';
                
                if(d.action.includes('FAIL') || d.action.includes('GAGAL')) {
                    status = 'KRITIS'; tips = 'Cek koneksi atau data duplikat.';
                } else if(d.action.includes('ASSIGN')) {
                    status = 'AWAS';
                }

                h += `
                <div class="log-card status-${status}">
                    <div class="log-head"><span>${time}</span><span>${d.user || 'SYSTEM'}</span></div>
                    <div class="log-body"><b>${d.action}</b>: ${d.plat} ${d.details ? `<br><span style="color:#888">${JSON.stringify(d.details)}</span>` : ''}</div>
                    ${tips ? `<div class="action-needed"><span class="action-title">⚠️ TINDAKAN</span>${tips}</div>` : ''}
                </div>`;
            });
            c.innerHTML = h;
        }

        function log(action, plat, det) { addDoc(logRef, {timestamp:new Date(), action, plat, user:'SUPERADMIN', details:det}); }

        // --- ACTIONS ---

        // 1. MANUAL ASSIGN (DENGAN RUMUS)
        window.manualAssign = () => {
            const s=document.getElementById('manSlot').value, p=document.getElementById('manPlat').value.toUpperCase(), b=parseInt(document.getElementById('manBat').value);
            if(!p) return alert('Isi Plat');
            
            // HITUNG DURASI
            const tar = 100;
            const dur = calculateDuration(b, tar);

            runTransaction(db, async(t)=>{
                const d=(await t.get(ref)).data();
                d.chargingSlots[s] = {plat:p, userName:'ADMIN', wa:'-', startBattery:b, targetLimit:tar, durationMinutes:dur, startTime:new Date()};
                t.update(ref, {chargingSlots:d.chargingSlots});
            }).then(()=>log('MANUAL_ASSIGN', p, {durasi:dur}));
        };

        // 2. CLEAR SLOT + AUTO PULL QUEUE (FIX)
        window.clearSlot = () => {
            const s = document.getElementById('manSlot').value;
            if(confirm('Kosongkan Slot & Tarik Antrian Otomatis?')) {
                runTransaction(db, async(t)=>{
                    const d = (await t.get(ref)).data();
                    const q = d.waitingQueue || [];
                    const oldP = d.chargingSlots[s]?.plat || 'Unknown';
                    
                    // KOSONGKAN SLOT DULU
                    d.chargingSlots[s] = null;
                    let pulled = 'TIDAK ADA ANTRIAN';

                    // CEK ANTRIAN: JIKA ADA, TARIK KE SLOT
                    if(q.length > 0) {
                        const nextItem = q.shift(); // Ambil paling depan
                        const tar = calculateTargetLimit(q.length);
                        const dur = calculateDuration(nextItem.startBattery, tar);
                        
                        // MASUKKAN KE SLOT
                        d.chargingSlots[s] = {
                            ...nextItem,
                            startTime: new Date(), // Langsung start
                            targetLimit: tar,
                            durationMinutes: dur
                        };
                        pulled = nextItem.plat;
                    }

                    t.update(ref, {
                        chargingSlots: d.chargingSlots, 
                        waitingQueue: q
                    });
                    
                    log('FORCE_CLEAR_AUTO_PULL', `Slot ${parseInt(s)+1}`, {cleared:oldP, pulled:pulled});
                });
            }
        };

        window.regQueue = () => {
            const p=document.getElementById('qPlat').value.toUpperCase(), n=document.getElementById('qName').value, w=document.getElementById('qWA').value, b=parseInt(document.getElementById('qBat').value);
            if(!p) return alert('Data Kurang');
            // HITUNG DURASI
            const tar = 100; // Default queue target
            const dur = calculateDuration(b, tar);

            runTransaction(db, async(t)=>{
                const d=(await t.get(ref)).data(); const q=d.waitingQueue||[];
                q.push({plat:p, userName:n, wa:w, startBattery:b, targetLimit:tar, durationMinutes:dur, startTime:null});
                t.update(ref, {waitingQueue:q});
            }).then(()=>log('ADMIN_REGISTER', p));
        };

        window.moveQueue = () => {
            const qi=document.getElementById('qIdx').value, si=document.getElementById('qTarget').value;
            if(qi<0) return alert('Antrian Kosong');
            runTransaction(db, async(t)=>{
                const d=(await t.get(ref)).data(); const q=d.waitingQueue; const s=d.chargingSlots;
                if(s[si]) throw "Slot Penuh";
                const item = q.splice(qi,1)[0];
                item.startTime = new Date();
                s[si] = item;
                t.update(ref, {chargingSlots:s, waitingQueue:q});
            }).then(()=>log('QUEUE_MOVE', `Slot ${parseInt(si)+1}`));
        };

        window.doBlock = () => {
            const p=document.getElementById('blockPlat').value.toUpperCase();
            if(p) { updateDoc(ref, {blockedList: arrayUnion(p)}); log('BLOCK_USER', p); }
        };
        window.doUnblock = () => {
            const p=document.getElementById('blockPlat').value.toUpperCase();
            if(p) { updateDoc(ref, {blockedList: arrayRemove(p)}); log('UNBLOCK_USER', p); }
        };
    </script>
</body>
</html>
