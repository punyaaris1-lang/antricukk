<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADMIN MONITOR - FC KG</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=JetBrains+Mono:wght@500;800&family=Inter:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #000000; 
            --panel: rgba(10, 10, 10, 0.95); 
            --accent: #00F0FF; /* Cyan */
            --warn: #FFCC00;   /* Kuning */
            --danger: #FF003C; /* Merah */
            --success: #39FF14; /* Hijau */
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.9)), url('1763947427555.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #fff; margin: 0; padding: 10px; padding-bottom: 80px; 
        }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }
        .h-title { font-family: 'Orbitron'; font-weight: 900; font-size: 20px; color: var(--accent); letter-spacing: 1px; }
        .header-btns { display: flex; gap: 5px; }
        .btn-head { border: 1px solid #fff; padding: 5px 10px; font-weight: 900; cursor: pointer; font-size: 10px; text-decoration: none; display: flex; align-items: center; justify-content: center;}
        .btn-logout { background: var(--danger); color: #fff; }
        .btn-view { background: var(--accent); color: #000; border-color: var(--accent); }

        /* MINI TV CLICKABLE */
        .mini-tv-label { font-family: 'Orbitron'; font-size: 10px; color: #aaa; margin-bottom: 5px; letter-spacing: 1px; }
        .mini-tv-container { display: flex; gap: 5px; margin-bottom: 20px; }
        .mini-slot { 
            flex: 1; background: #111; border: 2px solid #444; padding: 5px; height: 100px; 
            display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; transition: 0.2s; position: relative;
        }
        .mini-slot:active { transform: scale(0.95); border-color: #fff; }
        .mini-slot.active { border-color: var(--success); background: #051a05; }
        .click-hint { position: absolute; top: 0; right: 0; background: #333; color: #fff; font-size: 8px; padding: 2px 4px; border-bottom-left-radius: 4px; }

        .mtv-head { display: flex; justify-content: space-between; font-family: 'Orbitron'; font-size: 10px; color: #666; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .mini-slot.active .mtv-head { color: var(--success); }
        .mtv-plat { font-family: 'JetBrains Mono'; font-size: 13px; font-weight: 900; color: #fff; text-align: center; margin-top: 5px; letter-spacing: -0.5px; }
        .mtv-foot { display: flex; justify-content: space-between; align-items: center; margin-top: auto; background: #222; padding: 2px 4px; border-radius: 3px; }
        .mtv-bat { font-family: 'Orbitron'; color: var(--accent); font-weight: bold; font-size: 10px; }
        .mtv-timer { font-family: 'JetBrains Mono'; color: #fff; font-weight: 900; font-size: 11px; }

        /* CARD */
        .card { background: var(--panel); border: 1px solid #333; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .c-title { font-family: 'Orbitron'; color: var(--warn); font-size: 12px; border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 12px; letter-spacing: 1px; font-weight: 900; }

        /* INPUTS & BUTTONS */
        .row-group { display: flex; gap: 5px; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; background: #000; border: 1px solid #555; color: #fff; font-family: 'JetBrains Mono'; font-weight: bold; font-size: 14px; border-radius: 4px; }
        input:focus, select:focus { border-color: var(--accent); outline: none; }
        
        .btn { width: 100%; padding: 12px; border: none; font-family: 'Orbitron'; font-weight: 900; cursor: pointer; font-size: 12px; text-transform: uppercase; border-radius: 4px; margin-bottom: 5px; }
        .btn:active { transform: translateY(2px); opacity: 0.8; }
        .btn-blue { background: rgba(0, 240, 255, 0.2); border: 1px solid var(--accent); color: var(--accent); }
        .btn-red { background: rgba(255, 0, 60, 0.2); border: 1px solid var(--danger); color: var(--danger); }
        .btn-green { background: rgba(57, 255, 20, 0.2); border: 1px solid var(--success); color: var(--success); }
        .btn-grey { background: #333; color: #ccc; border: 1px solid #555; }
        .btn-warn { background: var(--warn); color: #000; border: none; }

        /* TOGGLE BUTTONS */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 11px; font-family: 'JetBrains Mono'; font-weight: bold; }
        .tgl-btn { background: #222; border: 1px solid #444; color: #555; padding: 5px 15px; cursor: pointer; font-weight: bold; font-family: 'Orbitron'; border-radius: 20px; }
        .tgl-btn.on { background: var(--success); color: #000; border-color: var(--success); }

        /* LOG BOX */
        .log-box { background: #000; border: 1px solid #333; height: 200px; overflow-y: auto; padding: 10px; font-family: 'JetBrains Mono'; font-size: 10px; color: #ccc; border-radius: 4px; }
        .log-row { margin-bottom: 4px; border-bottom: 1px solid #111; padding-bottom: 4px; display: flex; flex-wrap: wrap; }
        .l-time { color: var(--accent); margin-right: 5px; font-weight: bold; }
        .l-act { color: var(--warn); font-weight: bold; margin-right: 5px; }
        .l-msg { color: #fff; word-break: break-all; }

        /* SLOT CONTROL MODAL (USER VIEW CLONE) */
        #slotModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .sm-box { background: #111; border: 2px solid var(--accent); padding: 20px; width: 90%; max-width: 350px; text-align: center; border-radius: 15px; box-shadow: 0 0 30px rgba(0, 240, 255, 0.2); }
        .sm-title { font-family: 'Orbitron'; font-size: 18px; color: var(--accent); margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 10px; font-weight: 900; }
        .sm-timer { font-family: 'Orbitron'; font-size: 50px; color: #fff; font-weight: 900; line-height: 1; margin: 10px 0; text-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .sm-info { font-family: 'JetBrains Mono'; font-size: 12px; color: #888; margin-bottom: 20px; }
        .sm-btn-close { position: absolute; top: 20px; right: 20px; background: transparent; border: none; color: #fff; font-size: 20px; cursor: pointer; }

        /* PIN MODAL */
        #pinOverlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-input { font-size: 24px; text-align: center; letter-spacing: 10px; width: 200px; margin-bottom: 15px; border-color: var(--accent); }
    </style>
</head>
<body>

    <div id="pinOverlay">
        <h2 style="color:var(--accent); font-family:'Orbitron';">SECURE ACCESS</h2>
        <input type="password" id="adminPin" class="pin-input" placeholder="****" maxlength="4">
        <button onclick="checkPin()" class="btn btn-blue" style="width:200px;">UNLOCK</button>
    </div>

    <div id="slotModal">
        <button class="sm-btn-close" onclick="closeSlotModal()">✕</button>
        <div class="sm-box">
            <div class="sm-title" id="smTitle">SLOT CONTROL</div>
            <div class="sm-info" id="smInfo">PLAT | NAMA</div>
            <div class="sm-timer" id="smTimer">00:00</div>
            <div id="smControls">
                </div>
        </div>
    </div>

    <div id="mainContent" style="display:none;">
        <div class="header">
            <div class="h-title">ADMIN PANEL</div>
            <div class="header-btns">
                <button onclick="window.location.href='index.html'" class="btn-head btn-view">LIHAT TV</button>
                <button onclick="logout()" class="btn-head btn-logout">LOGOUT</button>
            </div>
        </div>

        <div class="mini-tv-label">KLIK SLOT UNTUK KONTROL (USER VIEW)</div>
        <div class="mini-tv-container">
            <div class="mini-slot" id="mtv-1" onclick="openSlotControl(0)">
                <div class="click-hint">OPEN</div>
                <div class="mtv-head"><span>SLOT 1</span><span id="s1-stat">OFF</span></div>
                <div class="mtv-plat" id="s1-plat">-</div>
                <div class="mtv-foot"><span class="mtv-bat" id="s1-bat">--%</span><span class="mtv-timer" id="s1-timer">--:--</span></div>
            </div>
            <div class="mini-slot" id="mtv-2" onclick="openSlotControl(1)">
                <div class="click-hint">OPEN</div>
                <div class="mtv-head"><span>SLOT 2</span><span id="s2-stat">OFF</span></div>
                <div class="mtv-plat" id="s2-plat">-</div>
                <div class="mtv-foot"><span class="mtv-bat" id="s2-bat">--%</span><span class="mtv-timer" id="s2-timer">--:--</span></div>
            </div>
            <div class="mini-slot" id="mtv-3" onclick="openSlotControl(2)">
                <div class="click-hint">OPEN</div>
                <div class="mtv-head"><span>SLOT 3</span><span id="s3-stat">OFF</span></div>
                <div class="mtv-plat" id="s3-plat">-</div>
                <div class="mtv-foot"><span class="mtv-bat" id="s3-bat">--%</span><span class="mtv-timer" id="s3-timer">--:--</span></div>
            </div>
        </div>

        <div class="card">
            <div class="c-title">TARIK ANTRIAN KE SLOT (MANUAL)</div>
            
            <label style="font-size:10px; color:#aaa;">PILIH ORANG DARI ANTRIAN, LALU PILIH SLOT:</label>
            <div class="row-group">
                <select id="qToSlotSrc" style="flex:2; font-weight:bold; color:var(--warn);"></select>
                <span style="padding:10px; color:#fff;">➔</span>
                <select id="qToSlotDest" style="flex:1; font-weight:bold; color:var(--accent);"></select>
            </div>
            <div class="row-group">
                <button onclick="moveQueueToSlot()" class="btn btn-green" style="flex:2;">MASUKKAN SEKARANG</button>
                <button onclick="autoFill()" class="btn btn-blue" style="flex:1;">AUTO FILL (SEMUA)</button>
            </div>

            <div style="border-top:1px dashed #333; margin:15px 0;"></div>

            <div class="c-title" style="color:#aaa; border:none; margin-bottom:5px;">MANAJEMEN DATABASE ANTRIAN</div>
            <select id="reorderSrc" style="margin-bottom:5px;"></select>
            
            <div class="row-group">
                <input id="reorderDest" type="number" placeholder="Pindah Ke No." style="flex:1; text-align:center;">
                <button onclick="reorderQueue()" class="btn btn-blue" style="flex:2;">PINDAH POSISI</button>
            </div>
            
            <div class="row-group">
                <button onclick="editQNumber()" class="btn btn-warn" style="flex:1;">UBAH NOMOR</button>
                <button onclick="deleteQueueItem()" class="btn btn-red" style="flex:1;">HAPUS DARI LIST</button>
            </div>
        </div>

        <div class="card">
            <div class="c-title">TAMBAH USER BARU (MANUAL)</div>
            <div class="row-group">
                <input id="qPlat" placeholder="PLAT NOMOR" style="flex:2;">
                <input id="qBat" type="number" placeholder="%" style="flex:1; text-align:center;">
            </div>
            <input id="qName" placeholder="NAMA (Opsional)" style="margin-bottom:5px;">
            <button onclick="regQueue()" class="btn btn-blue">DAFTARKAN</button>

            <div style="margin-top:20px; display:flex; gap:5px;">
                <button onclick="stopAll()" class="btn btn-red" style="flex:1;">STOP SEMUA SLOT</button>
                <button onclick="resetDB()" class="btn btn-red" style="flex:1;">RESET DB TOTAL</button>
            </div>
        </div>

        <div class="card">
            <div class="c-title">TOOLS LAINNYA</div>
            
            <label style="font-size:10px; color:#666;">PAKSA ISI SLOT (TANPA ANTRIAN)</label>
            <div class="row-group">
                <select id="manSlot" style="flex:1;"><option value="0">SLOT 1</option><option value="1">SLOT 2</option><option value="2">SLOT 3</option></select>
                <input id="manPlat" placeholder="PLAT" style="flex:2;">
                <input id="manBat" type="number" placeholder="%" style="flex:1; text-align:center;">
            </div>
            <button onclick="manualAssign()" class="btn btn-green">FORCE START</button>
            
            <div style="height:10px;"></div>
            
            <label style="font-size:10px; color:#666;">SALAH MASUK? KEMBALIKAN KE ANTRIAN</label>
            <div class="row-group">
                <select id="retSlot" style="flex:2;"><option value="0">SLOT 1</option><option value="1">SLOT 2</option><option value="2">SLOT 3</option></select>
                <button onclick="returnToQueue()" class="btn btn-grey" style="flex:1;">KEMBALIKAN</button>
            </div>
            
            <div style="height:10px;"></div>

            <label style="font-size:10px; color:#666;">REMOTE LAYOUT</label>
            <div class="row-group">
                <button id="btnTglTimer" class="btn btn-grey" style="flex:1;" onclick="toggleSetting('showTimer')">TIMER</button>
                <button id="btnTglBat" class="btn btn-grey" style="flex:1;" onclick="toggleSetting('showBattery')">BATRE</button>
                <button id="btnTglQ" class="btn btn-grey" style="flex:1;" onclick="toggleSetting('showQInfo')">ANTRIAN</button>
            </div>
        </div>

        <div class="card">
            <div class="c-title">SYSTEM LOG</div>
            <div id="termuxLog" class="log-box"><div class="log-row">Loading...</div></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, runTransaction, updateDoc, arrayUnion, collection, addDoc, query, orderBy, limit, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyALIlkIDALIk83K8s1htalvW6rmNNw02Go", authDomain: "sistem-antrian-b1c39.firebaseapp.com", projectId: "sistem-antrian-b1c39", storageBucket: "sistem-antrian-b1c39.firebasestorage.app", messagingSenderId: "454124587608", appId: "1:454124587608:web:34fbb0f5211067a67f982d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const ref = doc(db, "antrian", "utama");
        const settingsRef = doc(db, "antrian", "settings");
        const logRef = collection(db, "activityLog");

        let latestSlots = [null,null,null];
        let viewingSlotIdx = -1; 

        // --- AUTH ---
        window.checkPin = () => {
            if(document.getElementById('adminPin').value === "8080") {
                document.getElementById('pinOverlay').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                localStorage.setItem('adm_ok', '1');
            } else alert("PIN SALAH!");
        };
        if(localStorage.getItem('adm_ok')) {
            document.getElementById('pinOverlay').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }
        window.logout = () => { localStorage.removeItem('adm_ok'); location.reload(); };

        // --- REALTIME MONITORING ---
        onSnapshot(ref, (snap) => {
            const d = snap.data(); if(!d) return;
            latestSlots = d.chargingSlots || [null,null,null];
            
            // Render Mini TV
            latestSlots.forEach((s, i) => {
                const div = document.getElementById(`mtv-${i+1}`);
                const statSpan = document.getElementById(`s${i+1}-stat`);
                if(s && s.plat) {
                    div.classList.add('active');
                    document.getElementById(`s${i+1}-plat`).innerText = s.plat;
                    if(s.startTime) {
                        statSpan.innerText = "ON"; statSpan.style.color = "var(--accent)";
                    } else {
                        statSpan.innerText = "READY"; statSpan.style.color = "#fff";
                        document.getElementById(`s${i+1}-bat`).innerText = s.startBattery + "%";
                        document.getElementById(`s${i+1}-timer`).innerText = "WAIT";
                    }
                } else {
                    div.classList.remove('active');
                    document.getElementById(`s${i+1}-plat`).innerText = "-";
                    statSpan.innerText = "OFF"; statSpan.style.color = "#555";
                    document.getElementById(`s${i+1}-bat`).innerText = "--%";
                    document.getElementById(`s${i+1}-timer`).innerText = "--:--";
                }
            });

            // Update Modal Jika Sedang Terbuka
            if(viewingSlotIdx !== -1) renderSlotModal(viewingSlotIdx);

            // Update Dropdowns
            const q = d.waitingQueue || [];
            
            // Dropdown Manajemen Antrian
            const qOpt = q.length ? q.map((x,i)=>`<option value="${i}">#${x.qNo||i+1} ${x.plat}</option>`).join('') : '<option value="-1">KOSONG</option>';
            document.getElementById('reorderSrc').innerHTML = qOpt;
            
            // Dropdown Tarik ke Slot (Source)
            document.getElementById('qToSlotSrc').innerHTML = qOpt;

            // Dropdown Tarik ke Slot (Dest)
            const sOpt = latestSlots.map((s, i) => `<option value="${i}">SLOT ${i+1} (${s ? 'ISI' : 'KOSONG'})</option>`).join('');
            document.getElementById('qToSlotDest').innerHTML = sOpt;
        });

        // --- SLOT MODAL CONTROLLER (USER VIEW) ---
        window.openSlotControl = (i) => { viewingSlotIdx = i; document.getElementById('slotModal').style.display = 'flex'; renderSlotModal(i); };
        window.closeSlotModal = () => { document.getElementById('slotModal').style.display = 'none'; viewingSlotIdx = -1; };

        function renderSlotModal(i) {
            const s = latestSlots[i];
            const title = document.getElementById('smTitle');
            const info = document.getElementById('smInfo');
            const timer = document.getElementById('smTimer');
            const ctrls = document.getElementById('smControls');

            title.innerText = `KONTROL SLOT ${i+1}`;
            
            if(!s || !s.plat) {
                info.innerText = "SLOT KOSONG"; timer.innerText = "EMPTY";
                ctrls.innerHTML = `<button onclick="closeSlotModal()" class="btn btn-grey">TUTUP</button>`;
                return;
            }

            info.innerText = `${s.plat} | ${s.userName || 'USER'}`;
            
            if(s.startTime) {
                const st = s.startTime.toDate ? s.startTime.toDate() : new Date(s.startTime);
                const diff = (new Date(st.getTime() + s.durationMinutes*60000)) - new Date();
                const remSec = diff / 1000;
                let txt = "DONE";
                if(remSec > 0) { const m = Math.floor(remSec/60); const sc = Math.floor(remSec%60); txt = `${m}:${sc<10?'0'+sc:sc}`; }
                timer.innerText = txt; timer.style.color = "var(--accent)";
                ctrls.innerHTML = `<button class="btn btn-blue" onclick="editTimer(${i})">EDIT TIMER</button><button class="btn btn-warn" onclick="pauseSlot(${i})">PAUSE</button><button class="btn btn-red" onclick="stopSlot(${i})">STOP & SELESAI</button>`;
            } else {
                timer.innerText = "READY"; timer.style.color = "#fff";
                ctrls.innerHTML = `<button class="btn btn-green" onclick="startSlot(${i})">START</button><button class="btn btn-red" onclick="kickSlot(${i})">HAPUS DARI SLOT</button>`;
            }
        }

        // --- ACTIONS DARI MODAL ---
        window.startSlot = (i) => { if(confirm("MULAI CHARGING?")) { runTransaction(db, async(t)=>{ const d = (await t.get(ref)).data(); d.chargingSlots[i].startTime = new Date(); t.update(ref, {chargingSlots:d.chargingSlots}); addLog('START', `Slot ${i+1}`); }); } };
        window.stopSlot = (i) => { if(confirm("STOP & SELESAI?")) { runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); d.chargingSlots[i] = null; if(d.waitingQueue.length > 0) { const next = d.waitingQueue.shift(); d.waitingQueue.forEach((x,idx)=>x.qNo=idx+1); const dur = calcDur(next.startBattery, 98); d.chargingSlots[i] = {...next, startTime:null, durationMinutes:dur, targetLimit:98, readyTime:new Date(), qNo:null}; } t.update(ref, {chargingSlots:d.chargingSlots, waitingQueue:d.waitingQueue}); addLog('STOP', `Slot ${i+1}`); }); } };
        window.editTimer = (i) => { const m = prompt("Menit Baru:"); if(m && !isNaN(m)) { runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); d.chargingSlots[i].durationMinutes = parseInt(m); d.chargingSlots[i].startTime = new Date(); d.chargingSlots[i].isManualTime = true; t.update(ref, {chargingSlots:d.chargingSlots}); addLog('EDIT TIMER', `Slot ${i+1} -> ${m} min`); }); } };
        window.pauseSlot = (i) => { if(confirm("PAUSE SLOT?")) { runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); const s = d.chargingSlots[i]; if(s.startTime) { const st = s.startTime.toDate ? s.startTime.toDate() : new Date(s.startTime); const end = new Date(st.getTime() + s.durationMinutes*60000); const rem = Math.max(0, (end - new Date())/60000); d.chargingSlots[i] = {...s, startTime:null, durationMinutes:rem}; t.update(ref, {chargingSlots:d.chargingSlots}); addLog('PAUSE', `Slot ${i+1}`); } }); } };
        window.kickSlot = (i) => { if(confirm("HAPUS DARI SLOT?")) { runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); d.chargingSlots[i] = null; t.update(ref, {chargingSlots:d.chargingSlots}); addLog('KICK', `Slot ${i+1}`); }); } };

        // --- NEW: MOVE QUEUE TO SLOT (TARIK PAKSA) ---
        window.moveQueueToSlot = () => {
            const qIdx = document.getElementById('qToSlotSrc').value;
            const sIdx = document.getElementById('qToSlotDest').value;
            if(qIdx < 0) return alert("Pilih Antrian!");
            if(latestSlots[sIdx] !== null && !confirm("Slot ini sudah ada isinya. Timpa?")) return;

            runTransaction(db, async(t) => {
                const d = (await t.get(ref)).data();
                let q = d.waitingQueue || [];
                
                // Ambil data antrian
                const item = q.splice(qIdx, 1)[0];
                
                // Rapikan sisa antrian
                q.forEach((x, i) => x.qNo = i + 1);
                
                // Siapkan data slot
                const dur = calcDur(item.startBattery, 98);
                item.startTime = null; 
                item.durationMinutes = dur;
                item.readyTime = new Date();
                item.targetLimit = 98;
                item.qNo = null;

                // Masukkan ke slot
                d.chargingSlots[sIdx] = item;
                
                t.update(ref, { chargingSlots: d.chargingSlots, waitingQueue: q });
                addLog('MOVE', `Memindahkan ${item.plat} ke Slot ${parseInt(sIdx)+1}`);
            });
        };

        // --- NEW: AUTO FILL (ISI OTOMATIS) ---
        window.autoFill = () => {
            if(!confirm("Isi semua slot kosong dengan antrian teratas?")) return;
            
            runTransaction(db, async(t) => {
                const d = (await t.get(ref)).data();
                let q = d.waitingQueue || [];
                let s = d.chargingSlots || [null, null, null];
                let moved = 0;

                for (let i = 0; i < 3; i++) {
                    if (s[i] === null && q.length > 0) {
                        const item = q.shift();
                        const dur = calcDur(item.startBattery, 98);
                        item.startTime = null;
                        item.durationMinutes = dur;
                        item.readyTime = new Date();
                        item.qNo = null;
                        s[i] = item;
                        moved++;
                    }
                }

                if (moved > 0) {
                    q.forEach((x, i) => x.qNo = i + 1); // Renumber remaining
                    t.update(ref, { chargingSlots: s, waitingQueue: q });
                    addLog('AUTOFILL', `Mengisi ${moved} slot otomatis`);
                } else {
                    alert("Tidak ada slot kosong atau antrian habis.");
                }
            });
        };

        // --- NEW: DELETE QUEUE ITEM (HAPUS ANTRIAN) ---
        window.deleteQueueItem = () => {
            const srcIdx = document.getElementById('reorderSrc').value;
            if(srcIdx < 0) return alert("Pilih antrian dulu dari list!");
            
            if(confirm("Yakin hapus antrian ini?")) {
                runTransaction(db, async(t) => {
                    const d = (await t.get(ref)).data();
                    let q = d.waitingQueue || [];
                    const removed = q.splice(srcIdx, 1)[0]; 
                    q.forEach((item, index) => { item.qNo = index + 1; });
                    t.update(ref, {waitingQueue: q});
                    addLog('DELETE', `Menghapus antrian ${removed.plat}`);
                });
            }
        };

        // --- EDIT NOMOR ANTRIAN ---
        window.editQNumber = () => {
            const srcIdx = document.getElementById('reorderSrc').value;
            if(srcIdx < 0) return alert("Pilih antrian dulu!");
            const newNo = prompt("Masukkan Nomor Antrian Baru:");
            if(!newNo || isNaN(newNo)) return;
            runTransaction(db, async(t) => {
                const d = (await t.get(ref)).data();
                let q = d.waitingQueue || [];
                if(q[srcIdx]) {
                    q[srcIdx].qNo = parseInt(newNo);
                    t.update(ref, {waitingQueue: q});
                    addLog('EDIT NO', `${q[srcIdx].plat} -> #${newNo}`);
                }
            });
        };

        window.regQueue = () => {
            const p=document.getElementById('qPlat').value.toUpperCase(), n=document.getElementById('qName').value.toUpperCase()||"ADMIN", b=parseInt(document.getElementById('qBat').value)||0;
            if(!p) return alert("Plat Kosong!");
            runTransaction(db, async(t)=>{
                const d=(await t.get(ref)).data();
                let q=d.waitingQueue||[];
                q.forEach((x,i)=>x.qNo=i+1);
                q.push({plat:p, userName:n, wa:'-', startBattery:b, qNo:q.length+1});
                t.update(ref, {waitingQueue:q});
                addLog('REG', `${p} ke Antrian #${q.length}`);
            });
        };

        window.reorderQueue = () => {
            const src=document.getElementById('reorderSrc').value, dest=document.getElementById('reorderDest').value;
            if(src<0 || !dest) return alert("Data Salah");
            runTransaction(db, async(t)=>{
                const d=(await t.get(ref)).data();
                let q=d.waitingQueue;
                const item=q.splice(src,1)[0];
                q.splice(Math.max(0, Math.min(dest-1, q.length)), 0, item);
                q.forEach((x,i)=>x.qNo=i+1);
                t.update(ref, {waitingQueue:q});
                addLog('REORDER', `${item.plat} ke urutan ${dest}`);
            });
        };

        window.returnToQueue = () => {
            const sIdx = document.getElementById('retSlot').value;
            runTransaction(db, async(t) => {
                const d = (await t.get(ref)).data();
                const slotData = d.chargingSlots[sIdx];
                if(!slotData) throw "Slot Kosong!";
                let q = d.waitingQueue || [];
                q.forEach((item, i) => item.qNo = i + 1);
                const nextNo = q.length + 1;
                slotData.startTime = null; slotData.qNo = nextNo;
                q.push(slotData);
                d.chargingSlots[sIdx] = null;
                t.update(ref, { chargingSlots: d.chargingSlots, waitingQueue: q });
                addLog('RETURN', `${slotData.plat} ke Antrian #${nextNo}`);
            }).then(() => alert("SUKSES")).catch(e => alert(e));
        };

        window.manualAssign = () => {
            const s=document.getElementById('manSlot').value, p=document.getElementById('manPlat').value.toUpperCase(), b=parseInt(document.getElementById('manBat').value);
            if(!p) return alert("Isi Plat!");
            runTransaction(db, async(t)=>{
                const d=(await t.get(ref)).data();
                const dur = calcDur(b, 98);
                d.chargingSlots[s] = {plat:p, userName:'ADMIN', wa:'-', startBattery:b, durationMinutes:dur, startTime:new Date(), targetLimit:98, qNo:'ADM'};
                t.update(ref, {chargingSlots:d.chargingSlots});
                addLog('FORCE START', `Slot ${parseInt(s)+1}: ${p}`);
            });
        };

        window.swapSlots = () => {
            const a=document.getElementById('swapA').value, b=document.getElementById('swapB').value;
            if(a==b) return alert("Slot sama!");
            runTransaction(db, async(t)=>{
                const d=(await t.get(ref)).data();
                const tmp=d.chargingSlots[a]; d.chargingSlots[a]=d.chargingSlots[b]; d.chargingSlots[b]=tmp;
                t.update(ref, {chargingSlots:d.chargingSlots});
                addLog('SWAP', `S${parseInt(a)+1} <-> S${parseInt(b)+1}`);
            });
        };

        window.stopAll = () => { if(confirm("YAKIN STOP SEMUA?")) { updateDoc(ref, {chargingSlots:[null,null,null]}); addLog('SYSTEM', 'STOP ALL'); } };
        window.resetDB = () => { if(confirm("YAKIN RESET DB?")) { setDoc(ref, {chargingSlots:[null,null,null], waitingQueue:[], blockedList:[]}); addLog('SYSTEM', 'RESET DATABASE'); } };

        // --- LOG PARSING FIX ---
        onSnapshot(query(logRef, orderBy("timestamp", "desc"), limit(20)), (snap)=>{
            let h=''; 
            snap.forEach(doc=>{
                const d=doc.data();
                const tm = d.timestamp ? d.timestamp.toDate().toLocaleTimeString('en-GB') : '-';
                let detailText = d.details;
                if(typeof d.details === 'object') {
                    if(d.details.reason) detailText = `Info: ${d.details.reason}`;
                    else detailText = JSON.stringify(d.details); 
                }
                h+=`<div class="log-row"><span class="l-time">[${tm}]</span><span class="l-act">${d.action}</span><span class="l-msg">${detailText}</span></div>`;
            });
            document.getElementById('termuxLog').innerHTML=h;
        });

        function addLog(act, det) { addDoc(logRef, {timestamp:new Date(), action:act, details:det}); }

        // --- LAYOUT ---
        onSnapshot(settingsRef, (snap) => {
            const s = snap.data() || {};
            setTgl('btnTglTimer', s.showTimer); setTgl('btnTglBat', s.showBattery); setTgl('btnTglQ', s.showQInfo);
        });
        function setTgl(id, v) { const b=document.getElementById(id); if(v){b.classList.add('on'); b.innerText='ON';b.style.background='var(--success)';b.style.color='#000';} else {b.classList.remove('on'); b.innerText='OFF';b.style.background='#333';b.style.color='#777';} }
        window.toggleSetting = (k) => { runTransaction(db, async(t)=>{ const d=(await t.get(settingsRef)).data(); t.update(settingsRef, {[k]:!d[k]}); }); };
        window.updateSettings = () => { updateDoc(settingsRef, { timerPosition: document.getElementById('timerPos').value }); };

        // --- INTERVAL VISUAL TIMER ---
        setInterval(() => {
            latestSlots.forEach((s, i) => {
                if(s && s.plat && s.startTime) {
                    const st = s.startTime.toDate ? s.startTime.toDate() : new Date(s.startTime);
                    const diff = (new Date(st.getTime() + s.durationMinutes*60000)) - new Date();
                    const remSec = diff / 1000;
                    let txt = "DONE";
                    if(remSec > 0) {
                        const m = Math.floor(remSec/60);
                        const sc = Math.floor(remSec%60);
                        txt = `${m}:${sc<10?'0'+sc:sc}`;
                        const tot = s.durationMinutes * 60;
                        const elap = (new Date() - st)/1000;
                        let p = elap/tot; if(p>1)p=1;
                        let b = Math.round(s.startBattery + ((98-s.startBattery)*p));
                        document.getElementById(`s${i+1}-bat`).innerText = b+"%";
                    }
                    document.getElementById(`s${i+1}-timer`).innerText = txt;
                }
            });
        }, 1000);

        const CHARGING_CURVE = [ [100, 0], [91, 10], [81, 26], [75, 32], [72, 35], [70, 40], [69, 41], [61, 47], [59, 49], [56, 50], [54, 51], [51, 56], [48, 58], [42, 58], [28, 66], [22, 72], [0, 95] ];
        function calcDur(start, target) {
            let s=95, t=0;
            for(let i=0; i<CHARGING_CURVE.length-1; i++){ if(start<=CHARGING_CURVE[i][0] && start>=CHARGING_CURVE[i+1][0]) { const r=(CHARGING_CURVE[i][0]-start)/(CHARGING_CURVE[i][0]-CHARGING_CURVE[i+1][0]); s=CHARGING_CURVE[i][1]+r*(CHARGING_CURVE[i+1][1]-CHARGING_CURVE[i+1][1]); break; } }
            for(let i=0; i<CHARGING_CURVE.length-1; i++){ if(target<=CHARGING_CURVE[i][0] && target>=CHARGING_CURVE[i+1][0]) { const r=(CHARGING_CURVE[i][0]-target)/(CHARGING_CURVE[i][0]-CHARGING_CURVE[i+1][0]); t=CHARGING_CURVE[i][1]+r*(CHARGING_CURVE[i+1][1]-CHARGING_CURVE[i+1][1]); break; } }
            return Math.max(1, Math.ceil(s - t));
        }
    </script>
</body>
</html>
