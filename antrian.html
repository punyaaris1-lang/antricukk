<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FC KELAPA GADING</title>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --accent: #CCFF00; --cyan: #00F0FF; --red: #FF003C; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { font-family: 'Teko', sans-serif; background: #000 url('1763947427555.jpg') no-repeat center center fixed; background-size: cover; color: #fff; margin: 0; overflow: hidden; width: 100vw; height: 100dvh; display: flex; flex-direction: column; font-size: 20px; letter-spacing: 1px; }
        body::before { content: ''; position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.85), #000); z-index: 0; }
        
        /* HEADER FIX */
        .top-nav { height: 18vh; min-height: 120px; display: flex; flex-direction: column; justify-content: center; text-align: center; z-index: 10; position: relative; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); flex-shrink: 0; padding-bottom: 10px; }
        .main-title { font-size: clamp(40px, 6vh, 60px); font-weight: 700; line-height: 0.9; text-shadow: 0 0 15px rgba(0, 240, 255, 0.5); cursor: pointer; }
        .sub-title { font-size: 14px; color: var(--accent); letter-spacing: 4px; font-weight: 600; margin-top: 0px; text-transform: uppercase; }

        /* TOMBOL TUTORIAL (FIXED Z-INDEX & HIT AREA) */
        .tut-btn {
            background: rgba(0, 240, 255, 0.1); border: 1px solid var(--cyan); color: var(--cyan);
            font-family: 'JetBrains Mono'; font-size: 12px; padding: 8px 25px; border-radius: 20px;
            margin-top: 15px; cursor: pointer; width: fit-content; align-self: center;
            display: flex; align-items: center; gap: 8px; transition: 0.3s; font-weight: bold; letter-spacing: 1px;
            position: relative; z-index: 5000; /* SUPER HIGH Z-INDEX */
        }
        .tut-btn:active { background: var(--cyan); color: #000; }

        #logo-area { flex: 1; display: flex; justify-content: center; align-items: flex-start; padding-top: 20px; position: relative; z-index: 5; }
        .big-logo { width: 70%; max-width: 250px; height: auto; border-radius: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.1); animation: floatLogo 4s ease-in-out infinite; }
        @keyframes floatLogo { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }

        /* LAYOUTS */
        .screen { position: absolute; inset: 0; top: 12vh; bottom: 0; display: none; flex-direction: column; z-index: 10; justify-content: center; align-items: center; }
        .screen.active { display: flex; animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { from{opacity:0; transform:scale(0.95);} to{opacity:1; transform:scale(1);} }

        /* SLOTS */
        #screen-slots { flex-direction: row; align-items: center; justify-content: center; gap: 10px; padding: 0 15px; }
        .slot-container { width: 32%; height: 45vh; max-height: 380px; position: relative; transition: all 0.8s; }
        .slot-container:nth-child(2) { margin-top: -40px; }
        .onyx-card { width: 100%; height: 100%; background: rgba(10, 10, 10, 0.9); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; display: flex; flex-direction: column; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .cc-center { flex: 1; display: flex; align-items: center; justify-content: center; }
        .oc-num { font-weight: 700; font-size: clamp(90px, 15vw, 150px); line-height: 0.8; }
        .filled .oc-num { color: var(--cyan); text-shadow: 0 0 20px rgba(0, 240, 255, 0.4); }
        .empty .oc-num { color: #333; }
        .cc-top { padding: 10px; text-align: center; border-bottom: 1px solid #333; }
        .oc-name { font-size: 18px; font-weight: bold; }
        .oc-plat { font-family: 'JetBrains Mono'; font-size: 12px; color: var(--accent); }

        /* FOOTER & FINGERPRINT */
        .bottom-panel { height: 35vh; min-height: 250px; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; z-index: 20; position: fixed; bottom: 0; width: 100%; background: linear-gradient(to top, #000 90%, transparent); padding-bottom: 20px; }
        
        .stats-wrapper { display: grid; grid-template-columns: 1fr 2px 1fr; align-items: center; justify-items: center; width: 100%; max-width: 400px; margin-bottom: 15px; pointer-events: auto; }
        .stat-box { display: flex; flex-direction: column; align-items: center; text-align: center; width: 100%; }
        .stat-num { font-size: 70px; line-height: 0.8; color: #fff; font-weight: bold; text-shadow: 0 0 20px rgba(204,255,0,0.4); }
        .stat-label { font-size: 14px; color: var(--accent); letter-spacing: 2px; margin-top: 5px; opacity: 0.8; }
        .stat-line { width: 1px; height: 50px; background: linear-gradient(to bottom, transparent, var(--cyan), transparent); box-shadow: 0 0 10px var(--cyan); }
        
        .fp-wrapper { display: flex; flex-direction: column; align-items: center; position: relative; width:100%; justify-content:center; }
        .fp-text { font-family: 'Teko'; font-size: 24px; color: #fff; font-weight: 700; margin-bottom: 5px; text-shadow: 0 0 10px var(--cyan); letter-spacing: 1px; animation: textGlow 2s infinite alternate; }
        @keyframes textGlow { from{text-shadow: 0 0 5px var(--cyan);} to{text-shadow: 0 0 20px var(--cyan), 0 0 10px #fff;} }

        .fp-container { position: relative; width: 80px; height: 80px; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; pointer-events: auto; z-index: 5001; }
        .fp-btn { width: 70px; height: 70px; background: rgba(0,0,0,0.5); border: 1px solid var(--cyan); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 0 20px rgba(0,240,255,0.3); animation: pulse 2s infinite; }
        .fp-svg { width: 35px; height: 35px; fill: #fff; opacity: 0.9; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0, 240, 255, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(0, 240, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 240, 255, 0); } }

        /* TUTORIAL OVERLAY (FIXED) */
        #tutorialOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 6000; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
        .tut-text-box { width: 80%; text-align: center; color: #fff; margin-bottom: 30px; background: rgba(0,20,20,0.9); padding: 20px; border-radius: 15px; border: 1px solid var(--cyan); box-shadow: 0 0 30px rgba(0,240,255,0.2); }
        .tut-title { font-family: 'Teko'; font-size: 30px; color: var(--cyan); margin-bottom: 5px; text-shadow: 0 0 10px var(--cyan); }
        .tut-desc { font-family: 'JetBrains Mono'; font-size: 14px; color: #ccc; line-height: 1.5; }
        .tut-next-btn { padding: 10px 40px; border: 2px solid var(--accent); background: rgba(204,255,0,0.1); color: var(--accent); font-family: 'Teko'; font-size: 24px; border-radius: 50px; cursor: pointer; }
        .tut-highlight { position: relative; z-index: 6001 !important; box-shadow: 0 0 50px 20px rgba(255, 255, 255, 0.3) !important; background: rgba(0,0,0,0.8); border-radius: 10px; border: 2px solid #fff; }

        /* LOGIN SCREEN */
        .onyx-panel { width: 90%; max-width: 400px; background: rgba(10, 10, 10, 0.95); border: 1px solid rgba(0, 240, 255, 0.3); border-radius: 15px; padding: 25px; margin: auto; }
        .term-input { background: none; border: none; outline: none; color: var(--cyan); font-family: 'JetBrains Mono'; font-size: 16px; width: 60%; font-weight: bold; text-transform: uppercase; }
        .term-enter-btn { background: var(--cyan); color: #000; border: none; padding: 2px 8px; font-family: 'JetBrains Mono'; font-weight: bold; cursor: pointer; margin-left: auto; font-size: 12px; border-radius: 4px; animation: pulseBtn 1.5s infinite; }
        @keyframes pulseBtn { 0%{opacity:1;} 50%{opacity:0.7;} 100%{opacity:1;} }
        
        /* DASHBOARD */
        .limit-hud { width: 90%; max-width: 350px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--accent); border-radius: 8px; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; margin-top: 40px; }
        .hud-val { font-size: 24px; color: #fff; font-weight: bold; }
        .btn-minimize { background: transparent; border: 1px solid #555; color: #888; font-family: 'JetBrains Mono'; font-size: 10px; padding: 5px 15px; border-radius: 20px; position: absolute; top: 15px; right: 15px; cursor: pointer; z-index:300; }
        .btn-luxury { width: 90%; padding: 15px 0; background: linear-gradient(135deg, #ff0000 0%, #990000 100%); color: #fff; font-family: 'Teko'; font-size: 30px; border: none; border-radius: 15px; margin-top:20px; }
    </style>
</head>
<body>

    <div class="top-nav">
        <div class="main-title" ondblclick="toggleAdmin()">FC KELAPA GADING</div>
        <div class="sub-title">SELAMAT DATANG DI RUMAH MLU</div>
        <button class="tut-btn" onclick="startTutorial()">▶ TUTORIAL PEMAKAIAN</button>
    </div>

    <div id="logo-area"><img src="1763947427555.jpg" class="big-logo"></div>

    <div id="screen-slots" class="screen active" style="flex-direction:row; gap:10px; padding:0 20px;">
        <div class="slot-container" id="cont-0"><div class="onyx-card empty" id="card-0" onclick="handleSlotClick(0)"><div class="card-content"><div class="cc-top"><div class="oc-name" id="n-0">SLOT 1</div><div class="oc-plat" id="p-0"></div></div><div class="cc-center"><div class="oc-num" id="no-0">M</div></div><div class="cc-bottom"><button class="btn-action btn-select">PILIH</button></div></div></div></div>
        <div class="slot-container" id="cont-1"><div class="onyx-card empty" id="card-1" onclick="handleSlotClick(1)"><div class="card-content"><div class="cc-top"><div class="oc-name" id="n-1">SLOT 2</div><div class="oc-plat" id="p-1"></div></div><div class="cc-center"><div class="oc-num" id="no-1">L</div></div><div class="cc-bottom"><button class="btn-action btn-select">PILIH</button></div></div></div></div>
        <div class="slot-container" id="cont-2"><div class="onyx-card empty" id="card-2" onclick="handleSlotClick(2)"><div class="card-content"><div class="cc-top"><div class="oc-name" id="n-2">SLOT 3</div><div class="oc-plat" id="p-2"></div></div><div class="cc-center"><div class="oc-num" id="no-2">U</div></div><div class="cc-bottom"><button class="btn-action btn-select">PILIH</button></div></div></div></div>
    </div>

    <div id="screen-login" class="screen">
        <div class="onyx-panel" id="terminal-box"></div>
        <div style="text-align:center; margin-top:10px;"><button onclick="location.reload()" style="background:none; border:none; color:#666;">BATAL</button></div>
    </div>

    <div id="screen-active-dashboard" class="screen">
        <button class="btn-minimize" onclick="toggleDashboard(false)">LIHAT ANTRIAN</button>
        <div class="ad-container">
            <div class="limit-hud">
                <div><div style="font-size:10px; color:#888;">ANTRIAN</div><div class="hud-val" id="hud-q">0</div></div>
                <div style="width:1px; height:30px; background:#333;"></div>
                <div><div style="font-size:10px; color:#888;">MAX CHARGE</div><div class="hud-val" id="hud-max">100%</div></div>
            </div>
            <div style="text-align:center;">
                <div style="font-size:24px; color:var(--accent); font-weight:bold;" id="ad-slot-val">SLOT 1</div>
                <div style="font-size:40px; font-weight:bold;" id="ad-name-val">NAMA</div>
                <div style="font-family:'JetBrains Mono'; color:#aaa;" id="ad-plat-val">PLAT</div>
            </div>
            <div style="font-size:150px; font-weight:bold; color:var(--cyan); line-height:0.8;" id="ad-no-val">#12</div>
            <button class="btn-luxury" onclick="stopCharging(activeSlotIdx)">SELESAI</button>
        </div>
    </div>

    <div class="bottom-panel">
        <div class="stats-wrapper">
            <div class="stat-box"><div class="stat-num" id="slotCountVal">0</div><div class="stat-label">SLOT TERSEDIA</div></div>
            <div class="stat-line"></div>
            <div class="stat-box clickable" id="qBox" onclick="showQueueList()"><div class="stat-num" id="qCountVal">0</div><div class="stat-label">ANTRIAN</div></div>
        </div>
        <div class="fp-wrapper">
            <div class="fp-text" id="mainBtnText">DAFTAR</div>
            <div class="fp-container" id="fpCont" onclick="handleMainAction()">
                <div class="fp-btn" id="fpBtn">
                    <svg class="fp-svg" viewBox="0 0 24 24"><path d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28zM3.5 9.72c-.1 0-.2-.03-.29-.09-.23-.16-.28-.47-.12-.7.99-1.4 2.25-2.5 3.75-3.27C9.98 4.04 14 4.03 17.15 5.65c1.5.77 2.76 1.86 3.75 3.25.16.22.11.54-.12.7-.23.16-.54.11-.7-.12-.9-1.26-2.04-2.25-3.39-2.94-2.87-1.47-6.54-1.47-9.4.01-1.36.7-2.5 1.7-3.4 2.96-.08.14-.23.21-.39.21zm6.25 12.07c-.13 0-.26-.05-.35-.15-.87-.87-1.34-1.43-2.01-2.64-.69-1.23-1.05-2.73-1.05-4.34 0-2.97 2.54-5.39 5.66-5.39s5.66 2.42 5.66 5.39c0 .28-.22.5-.5.5s-.5-.22-.5-.5c0-2.42-2.09-4.39-4.66-4.39-2.57 0-4.66 1.97-4.66 4.39 0 1.44.32 2.77.93 3.85.64 1.15 1.08 1.64 1.85 2.42.19.2.19.51 0 .71-.11.1-.24.15-.37.15zm7.17-1.85c-1.19 0-2.24-.3-3.1-.89-1.49-1.01-2.38-2.65-2.38-4.39 0-.28.22-.5.5s.5.22.5.5c0 1.41.72 2.74 1.94 3.56.71.48 1.54.71 2.54.71.24 0 .64-.03 1.04-.1.27-.05.53.13.58.41.05.27-.13.53-.41.58-.57.11-1.07.12-1.21.12zM14.91 22c-.04 0-.09-.01-.13-.02-1.59-.44-2.63-1.03-3.72-2.1-1.4-1.39-2.17-3.24-2.17-5.22 0-1.62 1.38-2.94 3.08-2.94 1.7 0 3.08 1.32 3.08 2.94 0 1.07.93 1.94 2.08 1.94s2.08-.87 2.08-1.94c0-3.77-3.25-6.83-7.25-6.83-2.84 0-5.44 1.58-6.45 3.94-.11.25-.41.37-.67.26-.25-.11-.37-.41-.26-.67 1.13-2.62 4.07-4.39 7.38-4.39 4.53 0 8.25 3.42 8.25 7.69 0 1.62-1.38 2.94-3.08 2.94s-3.08-1.32-3.08-2.94c0-1.07-.93-1.94-2.08-1.94s-2.08.87-2.08 1.94c0 1.71.66 3.31 1.87 4.51.95.94 1.86 1.46 3.27 1.85.27.07.42.35.35.61-.05.23-.26.38-.47.38z"/></svg>
                </div>
            </div>
        </div>
    </div>

    <div id="tutorialOverlay">
        <div class="tut-text-box">
            <div class="tut-title" id="tutTitle">TUTORIAL</div>
            <div class="tut-desc" id="tutDesc">Penjelasan...</div>
        </div>
        <button class="tut-next-btn" onclick="nextTutorialStep()">LANJUT ></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, runTransaction, collection, addDoc, query, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp({ apiKey: "AIzaSyALIlkIDALIk83K8s1htalvW6rmNNw02Go", authDomain: "sistem-antrian-b1c39.firebaseapp.com", projectId: "sistem-antrian-b1c39" });
        const db = getFirestore(app);
        const mainRef = doc(db, "antrian", "utama");
        const historyRef = collection(db, "riwayatCharging");

        let localSlots = [null,null,null]; let localQueue = []; let myPlat = localStorage.getItem('myPlat'); let myIP = "";
        window.activeSlotIdx = -1; let isDashboardMinimized = false;
        let tempUserData = {}; let currentStep = 0;
        const steps = [ {q: "PLAT NOMOR", k: "plat"}, {q: "NAMA LENGKAP", k: "name"}, {q: "NOMOR WHATSAPP", k: "wa"} ];

        // --- TUTORIAL LOGIC (FIXED) ---
        let tutStep = 0;
        window.startTutorial = () => {
            document.getElementById('tutorialOverlay').style.display = 'flex';
            tutStep = 0; showTutStep();
        }
        window.nextTutorialStep = () => { tutStep++; showTutStep(); }
        function showTutStep() {
            document.querySelectorAll('.tut-highlight').forEach(el => el.classList.remove('tut-highlight'));
            const t = document.getElementById('tutTitle');
            const d = document.getElementById('tutDesc');
            
            // RESET SCREENS TO MAIN FOR TUTORIAL
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-slots').classList.add('active');

            if(tutStep === 0) {
                t.innerText = "1. DAFTAR"; d.innerText = "Klik Tombol Sidik Jari untuk daftar lalu isi data.";
                document.getElementById('fpBtn').classList.add('tut-highlight');
            } else if(tutStep === 1) {
                t.innerText = "2. PILIH SLOT"; d.innerText = "Jika slot kosong, klik kotak slot untuk mulai cas. SETELAH CAS SELESAI WAJIB KLIK TOMBOL SELESAI";
                document.getElementById('card-0').classList.add('tut-highlight');
            } else if(tutStep === 2) {
                t.innerText = "3. CEK ANTRIAN"; d.innerText = "Jika slot penuh, anda akan mendapat nomer antrian, dan tunggu giliran anda. Saat tiba giliran akan ada pilihan slot";
                document.getElementById('qBox').classList.add('tut-highlight');
            } else {
                document.getElementById('tutorialOverlay').style.display = 'none';
            }
        }

        window.toggleAdmin = () => {
             if(prompt("PIN ADMIN:") === "8080") { 
                 localStorage.setItem('adm_ok','1'); localStorage.setItem('admin_acc','1'); 
                 window.location.href='admin.html'; 
             }
        }

        window.handleMainAction = () => {
            if(window.activeSlotIdx !== -1 && isDashboardMinimized) window.toggleDashboard(true);
            else window.checkLocAndRegister();
        };

        window.toggleDashboard = (show) => {
            isDashboardMinimized = !show;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if(show) document.getElementById('screen-active-dashboard').classList.add('active');
            else document.getElementById('screen-slots').classList.add('active');
            updateMainButtonState();
        }

        function updateMainButtonState() {
            const txt = document.getElementById('mainBtnText');
            const btn = document.getElementById('fpBtn');
            if(window.activeSlotIdx !== -1 && isDashboardMinimized) {
                txt.innerText = "DASHBOARD"; txt.style.color = "var(--accent)"; btn.classList.add('back-mode');
            } else {
                txt.innerText = "DAFTAR"; txt.style.color = "#fff"; btn.classList.remove('back-mode');
            }
        }

        window.checkLocAndRegister = () => {
            if(localStorage.getItem('adm_ok')) { runLogin(); return; }
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(()=>{ runLogin(); }, ()=>{ alert("GPS Required"); });
            }
        };

        function runLogin() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-login').classList.add('active');
            currentStep = 0; tempUserData = {}; document.getElementById('terminal-box').innerHTML = ''; terminalPrompt();
        }

        function terminalPrompt() {
            const line = document.createElement("div"); line.className = "term-line";
            line.innerHTML = `> ${steps[currentStep].q}: <input class="term-input" autofocus>`;
            
            // VISUAL ENTER BUTTON
            const btn = document.createElement("button");
            btn.className = "term-enter-btn"; btn.innerText = "[ ENTER ↵ ]";
            btn.onclick = () => handleInput(line.querySelector("input"), btn);
            line.appendChild(btn);
            
            document.getElementById('terminal-box').appendChild(line);
            const input = line.querySelector("input"); input.focus();
            input.onkeydown = (e) => { if(e.key==="Enter") handleInput(input, btn); };
        }

        function handleInput(input, btn) {
            if(!input.value) return;
            tempUserData[steps[currentStep].k] = input.value.toUpperCase();
            input.disabled = true; btn.style.display = 'none';
            currentStep++;
            if(currentStep < steps.length) terminalPrompt();
            else executeRegistration();
        }

        function executeRegistration() {
            runTransaction(db, async(t) => {
                const d = (await t.get(mainRef)).data();
                let newNo = (d.recycledNumbers||[]).length>0 ? d.recycledNumbers.sort((a,b)=>a-b).shift() : (d.lastTicket||0)+1;
                let last = (d.recycledNumbers||[]).length>0 ? d.lastTicket : newNo;
                
                const u = { plat: tempUserData.plat, userName: tempUserData.name, wa: tempUserData.wa, qNo: newNo, entryTime: Date.now() };
                const q = d.waitingQueue || []; q.push(u);
                
                addDoc(historyRef, { ...u, timestamp: new Date() });
                t.update(mainRef, { waitingQueue:q, recycledNumbers:d.recycledNumbers||[], lastTicket:last });
                return newNo;
            }).then((no) => {
                localStorage.setItem('myPlat', tempUserData.plat); myPlat = tempUserData.plat;
                alert(`BERHASIL DAFTAR! ANTRIAN #${no}`);
                location.reload();
            });
        }

        onSnapshot(mainRef, (snap) => {
            const d = snap.data();
            localSlots = d.chargingSlots || [null,null,null];
            localQueue = d.waitingQueue || [];
            updateUI();
        });

        function updateUI() {
            let amICharging = false;
            document.getElementById('slotCountVal').innerText = localSlots.filter(s=>s===null).length;
            document.getElementById('qCountVal').innerText = localQueue.length;

            localSlots.forEach((s, i) => {
                const c = document.getElementById(`card-${i}`);
                if(s) {
                    c.classList.remove('empty'); c.classList.add('filled');
                    document.getElementById(`n-${i}`).innerText = s.userName;
                    document.getElementById(`p-${i}`).innerText = s.plat;
                    document.getElementById(`no-${i}`).innerText = "#" + s.qNo;
                    if(myPlat === s.plat) {
                        amICharging = true; window.activeSlotIdx = i;
                        if(!isDashboardMinimized) {
                            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                            document.getElementById('screen-active-dashboard').classList.add('active');
                        }
                        // Update Dashboard Data
                        document.getElementById('ad-slot-val').innerText = "SLOT " + (i+1);
                        document.getElementById('ad-name-val').innerText = s.userName;
                        document.getElementById('ad-plat-val').innerText = s.plat;
                        document.getElementById('ad-no-val').innerText = "#" + s.qNo;
                        
                        // LIMIT LOGIC
                        const q = localQueue.length;
                        let max = 100;
                        if(q>=3) max=95; if(q>=6) max=90; if(q>=10) max=85;
                        document.getElementById('hud-q').innerText = q;
                        document.getElementById('hud-max').innerText = max + "%";
                        if(max < 90) document.getElementById('hud-max').classList.add('warn');
                    }
                } else {
                    c.classList.remove('filled'); c.classList.add('empty');
                    document.getElementById(`n-${i}`).innerText = "SLOT " + (i+1);
                    document.getElementById(`p-${i}`).innerText = "";
                    document.getElementById(`no-${i}`).innerText = ["M","L","U"][i];
                }
            });

            if(!amICharging) {
                window.activeSlotIdx = -1;
                if(document.getElementById('screen-active-dashboard').classList.contains('active')) {
                    document.getElementById('screen-active-dashboard').classList.remove('active');
                    document.getElementById('screen-slots').classList.add('active');
                }
            }
            updateMainButtonState();
        }

        window.handleSlotClick = (i) => {
            if(!myPlat) return alert("DAFTAR DULU!");
            if(localSlots[i]) return;
            const qIdx = localQueue.findIndex(x=>x.plat===myPlat);
            if(qIdx > 0) return alert(`TUNGGU GILIRAN! ANTRIAN #${localQueue[0].qNo} BELUM MASUK.`);
            
            if(confirm(`PILIH SLOT ${i+1}?`)) {
                runTransaction(db, async(t)=>{
                    const d = (await t.get(mainRef)).data();
                    if(d.chargingSlots[i]) throw "Diambil";
                    const idx = d.waitingQueue.findIndex(x=>x.plat===myPlat);
                    const u = d.waitingQueue.splice(idx,1)[0];
                    u.startTime = Date.now(); d.chargingSlots[i] = u;
                    t.update(mainRef, {chargingSlots:d.chargingSlots, waitingQueue:d.waitingQueue});
                });
            }
        };

        window.stopCharging = (i) => {
            if(confirm("SELESAI?")) {
                runTransaction(db, async(t)=>{
                    const d = (await t.get(mainRef)).data();
                    const u = d.chargingSlots[i]; d.chargingSlots[i] = null;
                    addDoc(historyRef, {...u, finishTime:new Date(), timestamp:new Date()});
                    t.update(mainRef, {chargingSlots:d.chargingSlots});
                }).then(()=>{ localStorage.removeItem('myPlat'); location.reload(); });
            }
        };
    </script>
</body>
</html>
