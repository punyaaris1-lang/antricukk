<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FC Kelapa Gading - Smart Charging</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Syne:wght@700;800&display=swap" rel="stylesheet">
    <style>
        /* --- TEMA MAKA MOTORS (CYBER STYLE) --- */
        :root { 
            --volt-green: #D9FF00;
            --cyber-blue: #00F0FF;
            --bg-black: #050505;
            --text-main: #FFFFFF;
            --text-muted: #888888;
            --danger: #FF2A2A;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-black); color: var(--text-main); min-height: 100vh; overflow-x: hidden; padding-bottom: 80px; }
        body::before { content: ''; position: fixed; inset: 0; background: url('1763947427555.jpg') center/cover; opacity: 0.25; z-index: -1; filter: grayscale(100%) contrast(1.2); }
        .container { max-width: 480px; margin: 0 auto; padding: 20px 20px 120px; }
        
        /* HEADER */
        .header-top { position: sticky; top: 0; z-index: 50; background: linear-gradient(180deg, var(--bg-black) 80%, transparent); padding: 20px 0 15px; }
        .header-row { display: flex; justify-content: space-between; align-items: center; }
        h1 { font-family: 'Syne', sans-serif; font-size: 22px; margin: 0; color: var(--text-main); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 0 10px rgba(0, 240, 255, 0.3); }
        h1 span { color: var(--volt-green); }
        .subtitle { font-family: 'Inter'; color: var(--cyber-blue); font-size: 10px; letter-spacing: 3px; font-weight: 700; margin-top: 5px; text-transform: uppercase; }
        .btn-home { padding: 8px 16px; background: rgba(0,0,0,0.8); border: 1px solid var(--cyber-blue); color: var(--cyber-blue); border-radius: 4px; text-decoration: none; font-size: 10px; font-weight: 700; box-shadow: 0 0 5px rgba(0, 240, 255, 0.2); }

        /* INPUTS & CARDS */
        .glass-card { background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(10px); border: 1px solid var(--cyber-blue); border-radius: 8px; padding: 25px; margin-bottom: 25px; box-shadow: 0 0 15px rgba(0, 240, 255, 0.1); }
        label { display: block; font-size: 10px; color: var(--cyber-blue); margin-bottom: 8px; font-weight: 700; letter-spacing: 1px; }
        input.field { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 14px; border-radius: 4px; font-family: 'Inter'; font-size: 16px; font-weight: 700; text-align: center; margin-bottom: 15px; outline: none; transition: 0.3s; }
        input.field:focus { border-color: var(--volt-green); box-shadow: 0 0 10px rgba(217, 255, 0, 0.3); }
        .btn-cyan { width: 100%; background: var(--volt-green); border: none; padding: 16px; border-radius: 4px; color: #000; font-weight: 900; font-size: 14px; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 0 rgba(180, 210, 0, 1); transition: 0.1s; }
        .btn-cyan:active { transform: translateY(4px); box-shadow: none; }
        .btn-outline { width: 100%; padding: 15px; background: transparent; border: 1px dashed var(--cyber-blue); color: var(--cyber-blue); border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 11px; margin-top: 10px; }

        /* STATUS BAR */
        #quickStatusSummary { padding: 15px; background: #000; border: 1px solid var(--volt-green); border-radius: 6px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        #qsContent { display: flex; justify-content: space-between; width: 100%; font-family: 'Inter'; font-weight: 700; font-size: 12px; color: #aaa; }
        .qs-value { color: var(--volt-green); font-size: 16px; margin-left: 5px; font-weight: 900; }

        /* PLAYER */
        .player-wrapper { position: relative; margin-bottom: 25px; border: 1px solid var(--cyber-blue); border-radius: 6px; overflow: hidden; height: 70px; transition: height 0.3s ease; background: #000; }
        .player-wrapper.expanded { height: 300px; }
        #mp3PlayerFrame { width: 100%; height: 100%; border: none; }
        .player-toggle { position: absolute; bottom: 0; left: 0; right: 0; background: var(--cyber-blue); color: #000; text-align: center; font-size: 10px; padding: 4px; cursor: pointer; font-weight: 800; }

        /* SLOTS GRID */
        .slots-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 30px; }
        .slot-box { background: rgba(20, 20, 20, 0.95); border: 1px solid #444; border-radius: 6px; padding: 10px 5px; text-align: center; min-height: 350px; display: flex; flex-direction: column; justify-content: flex-start; position: relative; }
        .slot-box.active { border: 1px solid var(--cyber-blue); box-shadow: 0 0 10px rgba(0, 240, 255, 0.1); }
        .bat-icon { width: 55px; height: 90px; border: 2px solid #fff; border-radius: 6px; margin: 15px auto 10px; position: relative; display: flex; align-items: flex-end; padding: 3px; z-index: 1; }
        .bat-icon::before { content: ''; position: absolute; top: -6px; left: 50%; transform: translateX(-50%); width: 20px; height: 4px; background: #fff; border-radius: 2px 2px 0 0; }
        .bat-fill { width: 100%; background: var(--volt-green); border-radius: 3px; transition: height 0.5s; box-shadow: 0 0 15px var(--volt-green); }
        .bat-bolt { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 32px; color: #fff; z-index: 10; text-shadow: 0 2px 5px #000; }
        .pulsating-fill { animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { filter: brightness(1); } to { filter: brightness(1.3); box-shadow: 0 0 20px var(--volt-green); } }

        .bat-stats { font-size: 11px; text-align: center; margin-top: auto; margin-bottom: 10px; font-weight: 700; line-height: 1.5; background: #000; border: 1px solid #333; border-radius: 4px; padding: 5px 0; }
        .stat-row { display: flex; justify-content: space-between; padding: 0 6px; }
        .c-start { color: #888; }
        .c-target { color: #fff; }
        .c-now { color: var(--volt-green); font-weight: 900; font-size: 12px; }

        .btn-slot { width: 100%; padding: 10px 0; border: none; font-weight: 800; font-size: 10px; cursor: pointer; border-radius: 4px; margin-top: 5px; text-transform: uppercase; }
        .btn-edit { background: #222; border: 1px solid var(--cyber-blue); color: var(--cyber-blue); }
        .btn-stop { background: rgba(255, 42, 42, 0.1); border: 1px solid var(--danger); color: var(--danger); }
        .btn-start { background: var(--volt-green); color: #000; }

        /* QUEUE LIST */
        #queueList { max-height: 250px; overflow-y: auto; padding-right: 5px; }
        .queue-item-display { display: flex; justify-content: space-between; background: #111; padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left: 3px solid #333; align-items: center; }
        .queue-item-display.is-mine { border-left: 3px solid var(--volt-green); background: #1a1a1a; border-top: 1px solid #333; border-right: 1px solid #333; border-bottom: 1px solid #333; }

        /* MINI DASHBOARD (FULL) */
        .mini-dashboard { display: none; background: #000; border-top: 2px solid var(--cyber-blue); border-bottom: 2px solid var(--cyber-blue); padding: 20px; margin-top: 40px; margin-left: -20px; margin-right: -20px; }
        .mini-head { font-size: 12px; font-weight: 900; color: var(--cyber-blue); border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; text-align: left; letter-spacing: 2px; text-transform: uppercase; }
        .mini-section { border-bottom: 1px dashed #333; padding-bottom: 15px; margin-bottom: 15px; }
        .mini-label { font-size: 10px; color: #666; font-weight: 700; margin-bottom: 8px; display: block; text-transform: uppercase; }
        .mini-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .mini-btn { flex: 1; padding: 12px; border-radius: 4px; border: none; font-weight: 700; cursor: pointer; font-size: 10px; color: #fff; background: #222; border: 1px solid #333; }
        .mini-inp { flex: 1; background: #111; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 4px; font-size: 11px; width: 100%; outline: none; }
        .mini-inp:focus { border-color: var(--cyber-blue); }
        .bg-green { background: var(--volt-green); color: #000; border: none; }
        .bg-red { background: rgba(255, 42, 42, 0.1); color: var(--danger); border-color: var(--danger); }
        .bg-blue { background: rgba(0, 240, 255, 0.1); color: var(--cyber-blue); border-color: var(--cyber-blue); }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center; }
        .modal-box { background: #111; border: 1px solid var(--cyber-blue); padding: 25px; border-radius: 8px; width: 85%; max-width: 320px; text-align: center; }
        #choiceModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 99999; justify-content: center; align-items: center; }
        .choice-box { background: #050505; border: 1px solid var(--volt-green); padding: 40px 30px; border-radius: 12px; text-align: center; width: 85%; max-width: 350px; }
        .choice-btn { display: block; width: 100%; padding: 16px; margin-top: 15px; border-radius: 6px; font-weight: 800; cursor: pointer; border: none; font-size: 13px; }
    </style>
</head>
<body>
    <div id="loadingScreen" style="position:fixed;inset:0;background:#000;z-index:99999;display:flex;justify-content:center;align-items:center;color:var(--volt-green);font-family:'Inter';font-weight:900;letter-spacing:2px;font-size:12px;">LOADING SYSTEM...</div>
    
    <div id="choiceModal">
        <div class="choice-box">
            <h2 style="color:#fff;margin-top:0;">SELAMAT DATANG</h2>
            <p style="color:#666;font-size:12px;">Silakan pilih menu:</p>
            <button onclick="window.location.href='tutorial.html'" class="choice-btn" style="background:#222;color:#fff;border:1px solid #333;">PANDUAN TUTORIAL</button>
            <button onclick="closeChoiceModal()" class="choice-btn" style="background:var(--volt-green);color:#000;">LANGSUNG DAFTAR</button>
        </div>
    </div>

    <div id="masterModal" class="modal">
        <div id="modalBox" class="modal-box">
            <h3 id="mTitle" style="color:#fff;margin-top:0;font-size:16px;">INFO</h3>
            <p id="mMsg" style="color:#aaa;font-size:13px;line-height:1.5;"></p>
            <input id="mInputDuration" type="number" placeholder="Menit" style="display:none;width:100%;padding:12px;background:#222;border:1px solid #333;color:#fff;text-align:center;margin-bottom:15px;border-radius:4px;">
            <div style="display:flex;gap:10px;justify-content:center;margin-top:20px;">
                <button id="mBtnCancel" class="btn-slot btn-stop" style="display:none;width:100px;">BATAL</button>
                <button id="mBtnOk" class="btn-slot btn-start" style="width:100px;">OK</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header-top">
            <div class="header-row"><h1>FC <span>KELAPA GADING</span></h1><a href="admin.html" class="btn-home">ADMIN</a></div>
            <div class="subtitle">HOME OF MLU</div>
        </div>
        
        <div id="registrationArea"> 
            <div class="glass-card">
                <label>PLAT NOMOR KENDARAAN</label><input id="userPlat" class="field" style="text-transform:uppercase;" placeholder="CONTOH: B 1234 ABC">
                <label>NAMA PENGENDARA</label><input id="userName" class="field" placeholder="Nama Panggilan">
                <label>NOMOR WHATSAPP</label><input id="userWA" type="tel" class="field" placeholder="08xxxxxxxxxx">
                <label>SISA BATERAI SAAT INI (%)</label><input id="userBattery" type="number" class="field" placeholder="0-99">
                <button id="btnDaftar" class="btn-cyan">DAFTAR ANTRIAN</button>
            </div>
            <button onclick="monitorMode()" class="btn-outline">PANTAU STATUS (TANPA DAFTAR)</button>
        </div>
        
        <div id="quickStatusSummary">
            <div id="qsContent">
                <div>ANTRIAN <span id="qsQueueCountValue" class="qs-value">0</span></div>
                <div>MAX CAS <span id="qsMaxTargetValue" class="qs-value">100%</span></div>
            </div>
        </div>
        
        <div class="player-wrapper" id="pWrap">
            <iframe id="mp3PlayerFrame" src="https://punyaaris1-lang.github.io/music/" title="MLU Player" loading="lazy"></iframe>
            <div class="player-toggle" onclick="document.getElementById('pWrap').classList.toggle('expanded')">▼ BUKA / TUTUP LIST LAGU ▼</div>
        </div>
        
        <div id="statusArea" style="display:none;"> 
            <div style="margin-bottom:15px;font-size:10px;font-weight:700;color:var(--cyber-blue);letter-spacing:1px;text-transform:uppercase;">STATUS CHARGING STATION</div>
            <div class="slots-grid" id="slotsContainer"></div>
            <div class="glass-card" style="padding:20px;min-height:100px;">
                <div style="margin-bottom:15px;border-bottom:1px solid #333;padding-bottom:10px;font-size:12px;font-weight:700;display:flex;justify-content:space-between;color:#fff;">
                    <span>DAFTAR TUNGGU</span><span id="qCount" style="color:var(--volt-green)">(0)</span>
                </div>
                <div id="queueList"></div>
            </div>
        </div>

        <div id="miniAdminPanel" class="mini-dashboard">
            <div class="mini-head">SUPER ADMIN TOOLS</div>
            
            <div class="mini-section">
                <span class="mini-label">MANAJEMEN SLOT</span>
                <div class="mini-row">
                    <select id="miniSlotSelect" class="mini-inp"></select>
                    <input id="miniPlatInput" placeholder="Plat" class="mini-inp">
                    <input id="miniBatInput" placeholder="%" type="number" class="mini-inp" style="width:50px;">
                </div>
                <div class="mini-row">
                    <button onclick="miniManualAssign()" class="mini-btn bg-green">ISI SLOT</button>
                    <button onclick="miniClearSlot()" class="mini-btn bg-red">CLEAR</button>
                </div>
            </div>
            
            <div class="mini-section">
                <span class="mini-label">MANAJEMEN ANTRIAN (LENGKAP)</span>
                <div class="mini-row">
                    <input id="miniQPlat" placeholder="Plat" class="mini-inp">
                    <input id="miniQBat" type="number" placeholder="Bat %" class="mini-inp" style="width:60px;">
                </div>
                <div class="mini-row">
                    <input id="miniQName" placeholder="Nama" class="mini-inp">
                    <input id="miniQWA" placeholder="WhatsApp" class="mini-inp">
                </div>
                <div class="mini-row">
                    <button onclick="miniRegQ()" class="mini-btn bg-blue" style="width:100%">DAFTAR ANTRIAN</button>
                </div>
                
                <div style="margin-top:10px; border-top:1px dashed #333; padding-top:10px;">
                    <label class="mini-label">PINDAH ANTRIAN KE SLOT</label>
                    <div class="mini-row">
                        <select id="miniQIdx" class="mini-inp" style="flex:2"></select>
                        <span style="color:#444;align-self:center;">➜</span>
                        <select id="miniQTarget" class="mini-inp" style="flex:1"></select>
                    </div>
                    <button onclick="miniMoveQ()" class="mini-btn bg-green" style="width:100%">PROSES PINDAH</button>
                </div>

                <div style="margin-top:10px; border-top:1px dashed #333; padding-top:10px;">
                    <label class="mini-label">TUKAR URUTAN ANTRIAN</label>
                    <div class="mini-row">
                        <select id="miniQSwap1" class="mini-inp"></select>
                        <span style="color:#444;align-self:center;">⇄</span>
                        <select id="miniQSwap2" class="mini-inp"></select>
                    </div>
                    <button onclick="miniSwapQueuePositions()" class="mini-btn bg-blue" style="width:100%">TUKAR POSISI</button>
                </div>
            </div>

            <div class="mini-section" style="border:none;">
                <span class="mini-label">SYSTEM / DARURAT</span>
                <div class="mini-row">
                    <select id="miniSwap1" class="mini-inp"></select>
                    <select id="miniSwap2" class="mini-inp"></select>
                    <button onclick="miniSwap()" class="mini-btn">SWAP SLOT</button>
                </div>
                <div class="mini-row">
                    <input id="miniBlockPlat" placeholder="Plat Blokir" class="mini-inp">
                    <button onclick="miniBlock()" class="mini-btn bg-red">BLOK</button>
                    <button onclick="miniUnblock()" class="mini-btn">BUKA</button>
                </div>
                <div class="mini-row" style="margin-top:20px;">
                    <button onclick="miniStopAll()" class="mini-btn bg-red">STOP ALL</button>
                    <button onclick="miniReset()" class="mini-btn bg-red">RESET DB</button>
                </div>
                <button onclick="logoutUser()" class="mini-btn" style="width:100%; margin-top:20px; background:#111; color:#666; border:1px solid #333;">KELUAR MODE ADMIN</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, runTransaction, setDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyALIlkIDALIk83K8s1htalvW6rmNNw02Go", authDomain: "sistem-antrian-b1c39.firebaseapp.com", projectId: "sistem-antrian-b1c39", storageBucket: "sistem-antrian-b1c39.firebasestorage.app", messagingSenderId: "454124587608", appId: "1:454124587608:web:34fbb0f5211067a67f982d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const ref = doc(db, "antrian", "utama");
        
        const STATION_LOC = { lat: -6.171583, lng: 106.899844 }; 
        const MAX_DIST_KM = 0.2; 
        const FONTE_TOKEN = "MuR8CucXAsYd2YvWBxVo"; 

        let latestSlots = [null, null, null]; 
        let latestQueue = [];
        let isGpsBypassEnabled = localStorage.getItem('gpsBypass') === 'true';
        let isClearing = [false,false,false];

        function checkIsAdmin() { return localStorage.getItem('superAdminAuth') === 'true'; }

        const CHARGING_CURVE = [ [100,0], [99,2], [95,6], [91,10], [89,18], [81,26], [72,35], [61,47], [50,55], [20,72], [0,90] ];
        function getBatteryFromRemTime(rem) {
            if (rem <= 0) return 100;
            for (let i=0; i<CHARGING_CURVE.length-1; i++) {
                const [p1, t1] = CHARGING_CURVE[i]; const [p2, t2] = CHARGING_CURVE[i+1];
                if (rem >= t1 && rem <= t2) return Math.round(p1 - ((rem - t1) / (t2 - t1)) * (p1 - p2));
            }
            return 0;
        }
        function calculateDuration(start, target) {
            if (start >= target) return 5;
            let timeStart=90, timeTarget=0;
            for(let i=0; i<CHARGING_CURVE.length-1; i++){ if(start<=CHARGING_CURVE[i][0] && start>=CHARGING_CURVE[i+1][0]) { const r=(CHARGING_CURVE[i][0]-start)/(CHARGING_CURVE[i][0]-CHARGING_CURVE[i+1][0]); timeStart=CHARGING_CURVE[i][1]+r*(CHARGING_CURVE[i+1][1]-CHARGING_CURVE[i][1]); break; }}
            for(let i=0; i<CHARGING_CURVE.length-1; i++){ if(target<=CHARGING_CURVE[i][0] && target>=CHARGING_CURVE[i+1][0]) { const r=(CHARGING_CURVE[i][0]-target)/(CHARGING_CURVE[i][0]-CHARGING_CURVE[i+1][0]); timeTarget=CHARGING_CURVE[i][1]+r*(CHARGING_CURVE[i+1][1]-CHARGING_CURVE[i][1]); break; }}
            return Math.max(1, Math.ceil(timeStart - timeTarget));
        }
        function calculateTargetLimit(len) { return len>=6?90 : len>=3?95 : 100; }
        function parseDate(ts) { if(!ts) return null; if(ts.toDate) return ts.toDate(); if(ts instanceof Date) return ts; return new Date(ts); }

        function renderSlots(slots) {
            const c = document.getElementById('slotsContainer'); c.innerHTML='';
            const isAdmin = checkIsAdmin();
            const myPlat = localStorage.getItem('myPlat');
            const qLen = latestQueue.length;

            slots.forEach((m, i) => {
                const box = document.createElement('div'); box.className = 'slot-box';
                const isMine = myPlat === m?.plat;
                const canControl = isAdmin || isMine;

                if(isMine) box.classList.add('active');

                if(m && m.startTime) {
                    const st = parseDate(m.startTime);
                    const end = new Date(st.getTime() + m.durationMinutes*60000);
                    const rem = (end - new Date())/60000;
                    
                    if(rem <= 0) {
                        box.innerHTML = `<div style="font-weight:900;color:var(--danger);font-size:10px;">SLOT ${i+1}</div><div style="font-size:16px;font-weight:900;margin-top:5px;font-family:'Inter'">${m.plat}</div><div style="font-size:10px;color:#aaa;">${m.userName.split(' ')[0]}</div><div style="font-size:14px;color:var(--danger);font-weight:900;margin-top:10px;">SELESAI</div><div style="font-size:30px;">❌</div><div style="margin-top:auto">${canControl ? `<button onclick="act(${i},'stop','${m.plat}')" class="btn-slot btn-stop">KOSONGKAN</button>` : ''}</div>`;
                    } else {
                        if(isMine && rem < 5) box.classList.add('pulsating');
                        let dispBat = getBatteryFromRemTime(rem); dispBat = Math.min(Math.max(m.startBattery, dispBat), m.targetLimit);
                        box.innerHTML = `<div style="font-size:9px;font-weight:700;color:var(--volt-green)">SLOT ${i+1}</div><div style="font-size:16px;font-weight:900;margin-top:2px;font-family:'Inter'">${m.plat}</div><div style="font-size:10px;color:#fff;">${m.userName.split(' ')[0]}</div><div style="font-family:'Inter';font-size:22px;font-weight:900;color:var(--volt-green);margin:2px 0;">${formatTime(rem)}</div><div class="bat-icon"><span class="bat-bolt">⚡</span><div class="bat-fill pulsating-fill" style="height:${dispBat}%"></div></div><div class="bat-stats"><div class="stat-row"><span class="c-start">Awal:</span> <span class="c-start">${m.startBattery}%</span></div><div class="stat-row"><span class="c-target">Target:</span> <span class="c-target">${m.targetLimit}%</span></div><div class="stat-row"><span class="c-now">Kini:</span> <span class="c-now">${dispBat}%</span></div></div><div>${isAdmin ? `<button onclick="editTimer(${i})" class="btn-slot btn-edit">EDIT</button>` : ''} ${canControl ? `<button onclick="act(${i},'stop','${m.plat}')" class="btn-slot btn-stop">STOP</button>` : ''}</div>`;
                    }
                } else if(m) {
                    box.classList.add('active'); box.style.borderColor='var(--volt-green)';
                    box.innerHTML = `<div style="color:var(--volt-green);font-weight:700;font-size:10px;">SLOT ${i+1}</div><div style="font-size:16px;font-weight:900;margin-top:5px;font-family:'Inter'">${m.plat}</div><div style="font-size:10px;color:#aaa;">${m.userName.split(' ')[0]}</div><div style="font-family:'Syne';font-size:14px;font-weight:900;color:var(--volt-green);margin:10px 0;">READY</div><div class="bat-icon" style="border-color:var(--volt-green)"><div class="bat-fill" style="height:${m.startBattery}%;background:var(--volt-green)"></div></div><div style="margin-top:auto">${canControl ? `<button onclick="act(${i},'start')" class="btn-slot btn-start">MULAI</button><button onclick="act(${i},'stop','${m.plat}')" class="btn-slot btn-stop">BATAL</button>` : ''}</div>`;
                } else {
                    box.classList.remove('active'); box.style.borderColor='#444';
                    box.innerHTML = `<div style="color:#444;font-weight:700;font-size:10px;">SLOT ${i+1}</div><div style="color:#444;margin:20px 0;font-weight:700;">KOSONG</div><div style="font-size:24px;color:#222;font-weight:900;">- - -</div><div class="bat-icon" style="border-color:#222"><div class="bat-fill" style="height:0%;"></div></div>`;
                }
                c.appendChild(box);
            });
        }

        onSnapshot(ref, (s) => {
            const d=s.data()||{}; latestSlots=d.chargingSlots||[null,null,null]; latestQueue=d.waitingQueue||[];
            
            const myPlat = localStorage.getItem('myPlat');
            const isAdmin = checkIsAdmin();
            if (myPlat && !isAdmin) {
                const inSlot = latestSlots.some(s => s?.plat === myPlat);
                const inQueue = latestQueue.some(q => q.plat === myPlat);
                if (!inSlot && !inQueue) {
                    localStorage.removeItem('myPlat');
                    checkDisplayMode(); 
                }
            }

            checkDisplayMode();
            
            const qc = document.getElementById('queueList'); qc.innerHTML = latestQueue.length ? '' : '<div style="text-align:center;color:#444;font-size:12px;margin-top:20px;">Antrian Kosong</div>';
            
            const qLen = latestQueue.length;
            document.getElementById('qsQueueCountValue').innerText = qLen;
            document.getElementById('qCount').innerText = `(${qLen})`; 
            document.getElementById('qsMaxTargetValue').innerText = `${calculateTargetLimit(qLen)}%`;

            latestQueue.forEach((m,i)=>{ 
                const div=document.createElement('div'); 
                const isMine = myPlat === m.plat;
                div.className='queue-item-display '+(isMine?'is-mine':''); 
                
                let btn = '';
                if(isAdmin) btn = `<button onclick="cancelQ(${i})" style="border:none;background:transparent;color:var(--danger);font-weight:900;cursor:pointer;">&times;</button>`;
                else if(isMine) btn = `<button onclick="cancelQ(${i})" style="border:none;background:var(--danger);color:#fff;border-radius:4px;padding:3px 6px;font-size:9px;font-weight:bold;cursor:pointer;margin-left:5px;">BATAL</button>`;

                div.innerHTML=`<div style="display:flex;align-items:center;"><span style="font-family:'Inter';font-weight:900;font-size:16px;width:30px;color:var(--volt-green);">#${i+1}</span><div style="margin-left:5px;font-size:12px;color:#fff;"><b>${m.plat}</b> <span style="color:#aaa;">(${m.userName})</span></div></div><div style="display:flex;align-items:center;"><span style="font-size:12px;color:#fff;font-weight:700;">${m.startBattery}%</span>${btn}</div>`; 
                qc.appendChild(div); 
            });
            renderSlots(latestSlots);

            if(isAdmin) {
                const sOpts = latestSlots.map((_,i)=>`<option value="${i}">Slot ${i+1}</option>`).join('');
                document.getElementById('miniSlotSelect').innerHTML = sOpts;
                document.getElementById('miniQTarget').innerHTML = sOpts;
                document.getElementById('miniSwap1').innerHTML = sOpts;
                document.getElementById('miniSwap2').innerHTML = sOpts;
                
                const qOpts = latestQueue.length ? latestQueue.map((x,i)=>`<option value="${i}">#${i+1} ${x.plat}</option>`).join('') : '<option value="-1">Kosong</option>';
                document.getElementById('miniQIdx').innerHTML = qOpts;
                document.getElementById('miniQSwap1').innerHTML = qOpts;
                document.getElementById('miniQSwap2').innerHTML = qOpts;
            }
        });

        function getDist(lat1,lon1,lat2,lon2){ const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180; const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))); }
        
        document.getElementById('btnDaftar').onclick = () => {
            const p = document.getElementById('userPlat').value.toUpperCase().replace(/\s/g,'');
            const n = document.getElementById('userName').value.trim();
            const w = document.getElementById('userWA').value.trim();
            const b = parseInt(document.getElementById('userBattery').value);
            if(!p||!n||isNaN(b)) return alert('Data kurang');
            let strikes = parseInt(localStorage.getItem('gpsStrikes')||'0');
            if(strikes >= 3) return alert('ANDA DIBLOKIR KARENA LOKASI PALSU!');

            document.getElementById('btnDaftar').innerText="CEK LOKASI...";
            navigator.geolocation.getCurrentPosition((pos)=>{
                const dist = getDist(pos.coords.latitude, pos.coords.longitude, STATION_LOC.lat, STATION_LOC.lng);
                if(dist > MAX_DIST_KM && !isGpsBypassEnabled) {
                    strikes++; localStorage.setItem('gpsStrikes', strikes);
                    if(strikes>=3) { updateDoc(ref, {blockedList: arrayUnion(p)}); alert('3x Gagal. Anda Diblokir.'); }
                    else alert(`Kejauhan! Strike ${strikes}/3`);
                    document.getElementById('btnDaftar').innerText="DAFTAR ANTRIAN";
                    return;
                }
                processReg(p,n,w,b);
            }, ()=>alert('GPS Wajib Aktif!'));
        };

        function processReg(plat,name,wa,bat) {
            runTransaction(db, async(t)=>{
                const d=(await t.get(ref)).data()||{}; 
                if((d.blockedList||[]).includes(plat)) throw "BLOCKED";
                let s=d.chargingSlots||[null,null,null], q=d.waitingQueue||[];
                if(s.some(x=>x?.plat===plat)||q.some(x=>x?.plat===plat)) throw "Sudah terdaftar";
                const tar = calculateTargetLimit(q.length);
                const dur = calculateDuration(bat, tar);
                const idx = s.findIndex(x=>x===null);
                if(idx!==-1) { 
                    s[idx]={plat, userName:name, wa, startBattery:bat, targetLimit:tar, durationMinutes:dur, startTime:null}; // READY
                } else { 
                    q.push({plat, userName:name, wa, startBattery:bat, targetLimit:tar, durationMinutes:dur, startTime:null}); 
                }
                t.set(ref, {chargingSlots:s, waitingQueue:q}, {merge:true});
            }).then(()=>{ localStorage.setItem('myPlat',plat); alert('Berhasil!'); }).catch(e=>alert(e));
        }

        window.miniManualAssign = () => {
            const s=document.getElementById('miniSlotSelect').value;
            const p=document.getElementById('miniPlatInput').value.toUpperCase();
            const b=parseInt(document.getElementById('miniBatInput').value);
            if(!p || isNaN(b)) return alert('Lengkapi Data');
            const target = calculateTargetLimit(latestQueue.length); 
            const dur = calculateDuration(b, target);
            runTransaction(db, async(t)=>{
                const d=(await t.get(ref)).data();
                if(d.chargingSlots[s]) throw "Slot Penuh";
                d.chargingSlots[s]={plat:p, userName:'ADMIN', wa:'-', startBattery:b, targetLimit:target, durationMinutes:dur, startTime:null}; // READY
                t.update(ref,{chargingSlots:d.chargingSlots});
            }).catch(e=>alert(e));
        };
        window.miniClearSlot = () => {
            const s=document.getElementById('miniSlotSelect').value;
            if(confirm('Clear Paksa?')) {
                runTransaction(db, async(t)=>{
                    const d = (await t.get(ref)).data();
                    const q = d.waitingQueue || [];
                    d.chargingSlots[s] = null;
                    if(q.length > 0) {
                        const next = q.shift();
                        const tar = calculateTargetLimit(q.length); 
                        const dur = calculateDuration(next.startBattery, tar);
                        d.chargingSlots[s] = { ...next, startTime: null, targetLimit: tar, durationMinutes: dur }; // READY
                    }
                    t.update(ref, {chargingSlots:d.chargingSlots, waitingQueue:q});
                });
            }
        };
        
        window.miniRegQ = () => {
            const p = document.getElementById('miniQPlat').value.toUpperCase().replace(/\s/g,'');
            const n = document.getElementById('miniQName').value.trim() || 'ADMIN_INPUT';
            const w = document.getElementById('miniQWA').value.trim() || '-';
            const b = parseInt(document.getElementById('miniQBat').value);
            if(!p || isNaN(b)) return alert('Plat dan Baterai Wajib Diisi!');
            const tar = calculateTargetLimit(latestQueue.length + 1); 
            const dur = calculateDuration(b, tar);
            runTransaction(db, async(t)=>{
                const d=(await t.get(ref)).data(); const q=d.waitingQueue||[];
                q.push({plat:p, userName:n, wa:w, startBattery:b, targetLimit:tar, durationMinutes:dur, startTime:null});
                t.update(ref,{waitingQueue:q});
            }).then(() => {
                alert('Berhasil Daftar Antrian');
                document.getElementById('miniQPlat').value = '';
                document.getElementById('miniQName').value = '';
                document.getElementById('miniQWA').value = '';
                document.getElementById('miniQBat').value = '';
            }).catch(e => alert(e));
        };

        window.miniMoveQ = () => {
            const qi=document.getElementById('miniQIdx').value, si=document.getElementById('miniQTarget').value;
            if(qi<0) return;
            runTransaction(db, async(t)=>{
                const d=(await t.get(ref)).data(); const q=d.waitingQueue; const s=d.chargingSlots;
                if(s[si]) throw "Penuh";
                const item=q.splice(qi,1)[0]; 
                item.startTime=null; 
                item.targetLimit = calculateTargetLimit(q.length); 
                item.durationMinutes = calculateDuration(item.startBattery, item.targetLimit);
                s[si]=item;
                t.update(ref,{chargingSlots:s, waitingQueue:q});
            });
        };
        window.miniSwapQueuePositions = () => {
            const i1 = document.getElementById('miniQSwap1').value;
            const i2 = document.getElementById('miniQSwap2').value;
            if(i1 == i2 || i1 < 0 || i2 < 0) return alert('Pilih dua antrian berbeda');
            runTransaction(db, async(t)=>{
                const d = (await t.get(ref)).data();
                const q = d.waitingQueue || [];
                if(!q[i1] || !q[i2]) throw "Data berubah";
                [q[i1], q[i2]] = [q[i2], q[i1]];
                t.update(ref, {waitingQueue: q});
            }).then(()=> alert('Posisi Ditukar!')).catch(e=>alert(e));
        };
        window.miniSwap = () => {
            const s1=document.getElementById('miniSwap1').value, s2=document.getElementById('miniSwap2').value;
            if(s1==s2) return;
            runTransaction(db, async(t)=>{
                const d=(await t.get(ref)).data(); const s=d.chargingSlots;
                [s[s1],s[s2]]=[s[s2],s[s1]]; t.update(ref,{chargingSlots:s});
            });
        };
        window.miniBlock = () => { const p=document.getElementById('miniBlockPlat').value.toUpperCase(); if(p) updateDoc(ref,{blockedList:arrayUnion(p)}); };
        window.miniUnblock = () => { const p=document.getElementById('miniBlockPlat').value.toUpperCase(); if(p) updateDoc(ref,{blockedList:arrayRemove(p)}); };
        window.miniStopAll = () => { if(confirm('STOP ALL?')) updateDoc(ref,{chargingSlots:[null,null,null]}); };
        window.miniReset = () => { if(confirm('RESET DB??')) setDoc(ref,{chargingSlots:[null,null,null],waitingQueue:[],blockedList:[]}); };

        function formatTime(m){ const s=Math.round(m*60); return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        function checkDisplayMode() {
            document.getElementById('loadingScreen').style.display='none';
            const isAdmin = checkIsAdmin();
            const myPlat = localStorage.getItem('myPlat');

            if(!myPlat && !isAdmin && !sessionStorage.getItem('modalClosed')) {
                document.getElementById('choiceModal').style.display = 'flex';
            } else {
                document.getElementById('choiceModal').style.display = 'none';
            }

            if(myPlat || isAdmin) {
                document.getElementById('registrationArea').style.display='none';
                document.getElementById('statusArea').style.display='block';
            } else {
                document.getElementById('registrationArea').style.display='block';
                document.getElementById('statusArea').style.display='none';
            }
            document.getElementById('miniAdminPanel').style.display = isAdmin ? 'block' : 'none';
        }
        
        window.monitorMode = () => {
            document.getElementById('registrationArea').style.display = 'none';
            document.getElementById('statusArea').style.display = 'block';
        };
        
        window.closeChoiceModal = () => {
            document.getElementById('choiceModal').style.display = 'none';
            sessionStorage.setItem('modalClosed', 'true');
        };

        window.cancelQ = (i) => {
            if(confirm('Batalkan antrian?')) {
                runTransaction(db, async(t)=>{
                    const d = (await t.get(ref)).data();
                    d.waitingQueue.splice(i, 1);
                    t.update(ref, {waitingQueue: d.waitingQueue});
                }).then(()=> {
                    const isAdmin = checkIsAdmin();
                    if(!isAdmin) {
                        localStorage.removeItem('myPlat');
                        location.reload();
                    }
                });
            }
        };
        
        window.act = (i,t,p) => {
            if(t==='stop') if(confirm('Stop?')) runTransaction(db, async(tr)=>{ const d=(await tr.get(ref)).data(); d.chargingSlots[i]=null; if(d.waitingQueue.length){const n=d.waitingQueue.shift(); d.chargingSlots[i]={...n, startTime:null, durationMinutes:calculateDuration(n.startBattery,100)};} tr.update(ref,d); });
            if(t==='start') runTransaction(db, async(tr)=>{ const d=(await tr.get(ref)).data(); d.chargingSlots[i].startTime=new Date(); tr.update(ref,d); });
        };
        window.editTimer = (i) => {
            const m = prompt("Durasi Baru (Menit):");
            if(m) runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); d.chargingSlots[i].durationMinutes=parseInt(m); d.chargingSlots[i].startTime=new Date(); t.update(ref,d); });
        };
        window.logoutUser = () => { localStorage.removeItem('myPlat'); localStorage.removeItem('isAdminLoggedIn'); localStorage.removeItem('superAdminAuth'); location.reload(); };
        window.onload = checkDisplayMode;
        
        setInterval(()=>{
            if(latestSlots) {
                renderSlots(latestSlots);
                latestSlots.forEach((m,i)=>{
                    if(m && m.startTime && !isClearing[i]) {
                        const st = parseDate(m.startTime);
                        const rem = ((new Date(st.getTime() + m.durationMinutes*60000)) - new Date()) / 60000;
                        if(rem <= -1) {
                            isClearing[i]=true;
                            runTransaction(db, async(t)=>{
                                const d=(await t.get(ref)).data(); d.chargingSlots[i]=null;
                                if(d.waitingQueue.length){const n=d.waitingQueue.shift(); d.chargingSlots[i]={...n, startTime:null, durationMinutes:calculateDuration(n.startBattery,100)};} // AUTO CLEAR -> READY
                                t.update(ref,d);
                            }).finally(()=>isClearing[i]=false);
                        }
                    }
                });
            }
        }, 1000);
    </script>
</body>
</html>
