<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FC Kelapa Gading - Smart Charging</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Syne:wght@700;800&display=swap" rel="stylesheet">
    <style>
        /* TEMA NEON FINAL */
        :root { --accent: #CCFF00; --bg: #050505; --card-bg: #111; --text: #fff; --text-muted: #888; --cyan: #00d2ff; --soft-red: #FF3B30; --border: #333; --input-bg: #222; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; position: relative; overflow-x: hidden; }
        body::before { content: ''; position: fixed; inset: 0; background: url('1763947427555.jpg') center/cover; opacity: 0.35; z-index: -1; }
        .container { max-width: 480px; margin: 0 auto; padding: 20px 25px 120px; position: relative; z-index: 1; }
        
        /* HEADER */
        .header-top { position: sticky; top: 0; z-index: 50; background: linear-gradient(180deg, var(--bg) 90%, transparent); padding: 20px 25px 10px; margin: 0 -25px; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        h1 { font-family: 'Syne', sans-serif; font-size: clamp(1.8rem, 8vw, 24px); margin: 0; background: linear-gradient(to right, var(--text), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; text-shadow: 0 0 10px rgba(204, 255, 0, 0.4); letter-spacing: 1px; }
        .subtitle { font-family: 'Syne'; color: var(--text-muted); font-size: 10px; letter-spacing: 2px; margin-bottom: 25px; font-weight: 700; text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .btn-home { padding: 8px 15px; background: #222; border: 1px solid #444; color: var(--text); font-weight: 700; border-radius: 10px; text-decoration: none; font-size: 0.75rem; }

        /* INPUT & CARDS */
        .glass-card { background: var(--card-bg); backdrop-filter: blur(5px); border: 1px solid var(--border); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 25px; }
        label { display: block; font-family: 'Inter'; font-size: 10px; color: var(--accent); margin-bottom: 8px; letter-spacing: 1px; font-weight: 700; }
        input.field { width: 100%; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); padding: 15px; border-radius: 10px; font-family: 'Inter'; font-size: 20px; font-weight: 800; text-align: center; margin-bottom: 15px; outline: none; }
        input.field:focus { border-color: var(--accent); box-shadow: 0 0 10px rgba(204, 255, 0, 0.2); }
        .btn-cyan { width: 100%; background: linear-gradient(90deg, var(--accent), #e6ff66); border: none; padding: 16px; border-radius: 10px; color: #000; font-weight: 800; font-size: 16px; cursor: pointer; box-shadow: 0 0 20px rgba(204, 255, 0, 0.3); font-family: 'Inter', sans-serif; }

        /* STATUS BAR SEJAJAR */
        #quickStatusSummary { padding: 15px; background: var(--card-bg); border: 1px solid var(--cyan); border-radius: 10px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        #qsContent { display: flex; justify-content: space-between; width: 100%; font-family: 'Syne', sans-serif; font-weight: 900; font-size: 14px; }
        .qs-item { display: flex; align-items: baseline; gap: 5px; }
        .qs-value { color: var(--accent); font-size: 18px; text-shadow: 0 0 5px rgba(204,255,0,0.5); }

        /* SLOT GRID */
        .slots-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 30px; }
        .slot-box { background: var(--card-bg); border: 1px solid var(--border); border-radius: 15px; padding: 10px 5px; text-align: center; min-height: 250px; display: flex; flex-direction: column; justify-content: flex-start; position: relative; transition: 0.3s; }
        .slot-box.active { border-color: var(--accent); background: rgba(204, 255, 0, 0.05); box-shadow: 0 0 15px rgba(204, 255, 0, 0.2); }
        
        /* BATTERY ICON */
        .bat-icon { width: 40px; height: 65px; border: 2px solid #fff; border-radius: 6px; position: relative; margin: 10px auto 15px; display: flex; align-items: flex-end; padding: 3px; z-index: 5; background: rgba(0,0,0,0.5); }
        .bat-icon::before { content: ''; position: absolute; top: -6px; left: 10px; width: 16px; height: 4px; background: #fff; border-radius: 2px 2px 0 0; }
        .bat-fill { width: 100%; background: var(--accent); border-radius: 2px; transition: height 0.5s; box-shadow: 0 0 10px var(--accent); min-height: 2px; }
        .slot-box.active .bat-icon { border-color: var(--accent); } 
        .slot-box.active .bat-icon::before { background: var(--accent); }
        .pulsating-fill { animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { filter: brightness(1); box-shadow: 0 0 5px var(--accent); } to { filter: brightness(1.3); box-shadow: 0 0 20px var(--accent); } }
        .bat-bolt { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; color: #fff; z-index: 6; text-shadow: 0 0 5px #000; }

        /* TIMER DISPLAY - FONT DIGANTI JADI INTER */
        .timer-display { 
            font-family: 'Inter', sans-serif; /* FONT TEGAS */
            font-size: 24px; 
            font-weight: 900; 
            color: var(--accent); 
            text-shadow: 0 0 10px rgba(204, 255, 0, 0.5); 
            margin: 5px 0; 
            letter-spacing: -1px;
        }
        
        .bat-info-container { font-size: 9px; text-align: left; padding: 5px; background: rgba(0,0,0,0.5); border-radius: 5px; border: 1px solid var(--border); margin-bottom: auto; }
        .bat-info-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .info-label { color: var(--text-muted); font-weight: 600; }
        .info-value { color: var(--accent); font-weight: 800; }
        .btn-group { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .btn-act { width: 100%; padding: 8px 0; border: none; font-weight: 800; font-size: 10px; cursor: pointer; border-radius: 6px; text-transform: uppercase; font-family: 'Inter'; }
        .btn-start { background: var(--accent); color: #000; }
        .btn-stop { background: rgba(255, 59, 48, 0.15); border: 1px solid var(--soft-red); color: var(--soft-red); }
        .btn-edit { background: rgba(0, 210, 255, 0.15); border: 1px solid var(--cyan); color: var(--cyan); }

        /* MODAL POPUP */
        #choiceModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 99999; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .choice-box { background: #111; border: 2px solid var(--cyan); padding: 40px 30px; border-radius: 25px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 0 50px rgba(0, 210, 255, 0.3); animation: pop 0.4s; }
        .choice-btns { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
        .choice-btns .btn { padding: 15px; border-radius: 12px; font-weight: 800; cursor: pointer; text-decoration: none; font-size: 14px; display: block; }
        
        #mp3PlayerFrame { width: 100%; height: 200px; border: 2px solid var(--accent); border-radius: 15px; margin-bottom: 25px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--card-bg); border: 2px solid var(--accent); padding: 25px; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; }
        .btn-modal { padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; width: 48%; }
        .btn-modal.primary { background: var(--accent); color: #000; }
        
        /* ADMIN PANEL */
        .admin-panel { display: none; background: var(--card-bg); padding: 20px; border-radius: 15px; border: 1px solid var(--soft-red); margin-top: 20px; }
        .adm-row { display: flex; gap: 5px; margin-bottom: 10px; }
        .footer { text-align: center; margin-top: 40px; font-family: 'Syne'; font-size: 12px; color: var(--accent); font-weight: 700; }
        #loadingScreen { position: fixed; inset: 0; background: var(--bg); z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 80px; height: 80px; border: 4px solid rgba(255, 255, 255, 0.2); border-radius: 50%; border-top: 4px solid var(--accent); animation: spin 1s linear infinite; box-shadow: 0 0 15px var(--accent); margin-bottom: 20px; }
        .neon-text { font-family: 'Syne', sans-serif; font-size: 18px; color: var(--text); text-shadow: 0 0 5px var(--cyan); letter-spacing: 3px; text-align: center; }
        .queue-item-display { display: flex; justify-content: space-between; background: var(--card-bg); padding: 10px; margin-bottom: 5px; border-radius: 8px; border: 1px solid var(--border); }
        .queue-item-display.is-mine { border: 2px solid var(--cyan); background: rgba(0,210,255,0.05); }
        @keyframes pop { from{transform:scale(0.8); opacity:0} to{transform:scale(1); opacity:1} }
    </style>
</head>
<body>
    <div id="loadingScreen"><div class="neon-text">SELAMAT DATANG DI RUMAH MLU</div><div class="spinner"></div><div class="neon-text">FC KELAPA GADING</div></div>
    <audio id="alarmSound" loop><source src="data:audio/wav;base64,U..." type="audio/wav"></audio>

    <div id="choiceModal">
        <div class="choice-box">
            <div style="font-size:40px; margin-bottom:10px;">üëã</div>
            <h3 style="font-family:'Syne'; color:var(--cyan); margin:0 0 10px;">SELAMAT DATANG!</h3>
            <p style="color:#888; font-size:14px;">Pilih menu di bawah ini:</p>
            <div class="choice-btns">
                <a href="tutorial.html" class="btn" style="background:var(--cyan); color:#000; box-shadow:0 0 20px rgba(0,210,255,0.4);">PANDUAN TUTORIAL</a>
                <button class="btn" style="background:transparent; color:#fff; border:1px solid #666;" onclick="closeChoiceModal()">LANGSUNG DAFTAR</button>
            </div>
        </div>
    </div>

    <div id="masterModal" class="modal"><div id="modalBox" class="modal-box"><h3 id="mTitle" style="color:#fff;margin:0 0 10px;">TITLE</h3><p id="mMsg" style="color:#888;margin-bottom:20px;">Msg</p><input id="mInput" style="display:none;width:100%;padding:10px;margin-bottom:15px;background:#222;border:1px solid #444;color:#fff;text-align:center;" type="password"><input id="mInputDuration" style="display:none;width:100%;padding:10px;margin-bottom:15px;background:#222;border:1px solid #444;color:#fff;text-align:center;" type="number" placeholder="Menit"><div style="display:flex;gap:10px;"><button id="mBtnCancel" class="btn-modal" style="background:#333;color:#fff;display:none;">BATAL</button><button id="mBtnOk" class="btn-modal primary" style="width:100%">OK</button></div></div></div>
    
    <div class="container">
        <div class="header-top"><div class="header-row"><h1>FC KELAPA GADING</h1><a href="index.html" class="btn-home">üè† HOME</a></div><div class="subtitle">HOME OF MLU</div></div>
        
        <div id="registrationArea"> 
            <div class="glass-card">
                <label>PLAT NOMOR</label><input id="userPlat" class="field" style="text-transform:uppercase;" placeholder="PLAT">
                <label>NAMA</label><input id="userName" class="field" placeholder="Nama">
                <label>NO WA</label><input id="userWA" type="tel" class="field" placeholder="08xxxxxxxxxx">
                <label>BATERAI (%)</label><input id="userBattery" type="number" class="field" placeholder="0-99">
                <button id="btnDaftar" class="btn-cyan">DAFTAR ANTRIAN</button>
            </div>
        </div>
        
        <div id="quickStatusSummary">
            <div id="qsContent">
                <div class="qs-item"><span style="color:#888;font-weight:700;">ANTRIAN:</span> <span id="qsQueueCountValue" class="qs-value">0</span></div>
                <div class="qs-item"><span style="color:#888;font-weight:700;">MAX CAS:</span> <span id="qsMaxTargetValue" class="qs-value">100%</span></div>
            </div>
            <div id="frontQueueList" style="display:none;"></div>
        </div>
        
        <iframe id="mp3PlayerFrame" src="https://punyaaris1-lang.github.io/music/" title="MLU Player" loading="lazy"></iframe>
        
        <div id="statusArea" style="display:none;"> 
            <div style="margin-bottom:15px;font-size:12px;font-weight:600;color:#fff;">STATUS DETAIL SLOTS</div>
            <div class="slots-grid" id="slotsContainer"></div>
            <div class="glass-card" style="padding:15px;min-height:100px;">
                <div style="margin-bottom:10px;border-bottom:1px solid #333;padding-bottom:5px;font-size:12px;font-weight:600;">DAFTAR TUNGGU (<span id="qCount" style="color:var(--accent)">0</span>)</div>
                <div id="queueList"></div>
            </div>
        </div>
        
        <div id="logoutButtonContainer" style="display:none;margin-top:25px;"><button onclick="logoutUser()" class="btn-stop" style="width:100%;padding:12px;border-radius:10px;font-weight:700;">KELUAR / HAPUS DATA</button></div>
        
        <div class="admin-trigger" onclick="openAdminLogin()" style="text-align:center;margin:20px 0;font-size:10px;color:#666;cursor:pointer;">üîí ADMIN LOGIN</div>
        
        <div id="adminPanel" class="admin-panel">
            <h4 style="color:var(--soft-red);text-align:center;margin:0 0 15px;border-bottom:1px solid #333;padding-bottom:10px;">PANEL KONTROL ADMIN</h4>
            
            <div style="margin-bottom:10px;"><input type="checkbox" id="gpsBypassToggle" onclick="toggleGpsBypass()"> <span style="color:#fff;font-size:12px;">Bypass GPS</span></div>
            
            <label style="color:var(--accent)">MANAJEMEN SLOT</label>
            <div class="adm-row"><select id="manSlot" class="field" style="padding:10px;font-size:14px;width:30%;margin:0;"></select><input id="manPlat" class="field" placeholder="Plat" style="padding:10px;font-size:14px;width:70%;margin:0;"></div>
            <input id="manBattery" type="number" class="field" placeholder="Bat %" style="padding:10px;font-size:14px;margin-bottom:10px;">
            <button onclick="manualAssign()" class="btn-cyan" style="padding:10px;margin-bottom:5px;font-size:14px;width:100%;">ISI SLOT MANUAL</button>
            <button onclick="clearSlotManual()" class="btn-stop" style="width:100%;padding:10px;border-radius:8px;">KOSONGKAN SLOT</button>
            
            <hr style="border:0;border-top:1px solid #333;margin:15px 0;">
            
            <label style="color:var(--cyan)">MANAJEMEN ANTRIAN & PINDAH</label>
            <div style="margin-bottom:5px;font-size:10px;color:#888;">Tukar Antrian:</div>
            <div class="adm-row"><select id="queueSource" class="field" style="padding:10px;width:40%;margin:0;"></select><select id="queueTarget" class="field" style="padding:10px;width:40%;margin:0;"></select><button onclick="swapQueuePositions()" class="btn-act" style="width:20%;background:var(--accent);color:#000;">TUKAR</button></div>
            
            <div style="margin-bottom:5px;font-size:10px;color:#888;">Pindah Slot:</div>
            <div class="adm-row"><select id="slotSource" class="field" style="padding:10px;width:30%;margin:0;"></select><select id="slotTarget" class="field" style="padding:10px;width:30%;margin:0;"></select><button onclick="swapSlots()" class="btn-cyan" style="width:40%;padding:10px;margin:0;">PINDAH</button></div>
            
            <div style="margin-bottom:5px;font-size:10px;color:#888;">Antrian -> Slot:</div>
            <div class="adm-row"><select id="assignQueueIndex" class="field" style="padding:10px;width:50%;margin:0;"></select><select id="assignSlotTarget" class="field" style="padding:10px;width:50%;margin:0;"></select></div>
            <button onclick="assignQueueToSlot()" class="btn-cyan" style="padding:10px;margin-bottom:10px;width:100%;">MASUKKAN KE SLOT</button>
            
            <hr style="border:0;border-top:1px solid #333;margin:15px 0;">
            
            <label style="color:var(--soft-red)">DANGER ZONE</label>
            <div class="adm-row"><input id="blockPlatInput" class="field" placeholder="Plat Blokir" style="padding:10px;width:70%;margin:0;"><button onclick="blockUser()" class="btn-stop" style="width:30%;padding:10px;">BLOK</button></div>
            <button onclick="stopAll()" class="btn-stop" style="margin-top:10px;padding:10px;">STOP SEMUA (DARURAT)</button>
            <button onclick="resetAll()" class="btn-stop" style="margin-top:5px;padding:10px;background:none;border:1px solid var(--soft-red);color:var(--soft-red);">RESET DATABASE TOTAL</button>
            
            <hr style="border:0;border-top:1px solid #333;margin:15px 0;">
            <button onclick="logoutAdmin()" class="btn-stop" style="width:100%;padding:15px;border-radius:10px;font-weight:900;background:var(--soft-red);color:#000;">KELUAR ADMIN</button>
            
            <div onclick="document.getElementById('adminPanel').style.display='none'" style="text-align:center;margin-top:15px;font-size:10px;cursor:pointer;color:#888;">Tutup Panel</div>
        </div>

        <div class="footer">Aplikasi ini buatan MLU bukan punya Maka</div>
    </div>
        <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, runTransaction, setDoc, collection, addDoc, arrayRemove, arrayUnion } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging.js";

        // GLOBAL VARS
        let latestSlots = [null, null, null]; 
        let latestQueue = [];
        let isAdminLoggedIn = localStorage.getItem('isAdminLoggedIn') === 'true';
        let isGpsBypassEnabled = localStorage.getItem('gpsBypass') === 'true';
        let fcmToken = null;
        let audioCtx = null;
        let triggeredAlarms = new Set();

        const firebaseConfig = { apiKey: "AIzaSyALIlkIDALIk83K8s1htalvW6rmNNw02Go", authDomain: "sistem-antrian-b1c39.firebaseapp.com", projectId: "sistem-antrian-b1c39", storageBucket: "sistem-antrian-b1c39.firebasestorage.app", messagingSenderId: "454124587608", appId: "1:454124587608:web:34fbb0f5211067a67f982d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const ref = doc(db, "antrian", "utama");
        const messaging = getMessaging(app);
        const functions = getFunctions(app);
        const PUBLIC_VAPID_KEY = "BCdz35KcvwtCjbqwEPXAe0EoNRcL_OoKxP12lZRfN9IABufekdXlekacX6jCbmfsqg676roKjZ6tpwZAw";
        const STATION_LOC = { lat: -6.171583, lng: 106.899844 }; 
        const MAX_DIST_KM = 0.2; 
        const FONTE_TOKEN = "YOUR_FONTE_TOKEN_HERE"; 

        // --- KURVA WAKTU AGRESIF (91% -> 11 min) ---
        const CHARGING_CURVE = [[97,4],[95,7],[92,10],[91,11],[90,16],[89,20],[85,26],[82,32],[79,38],[77,42],[72,48],[67,55],[63,60],[61,62],[58,65],[51,68],[50,71],[49,71],[46,73],[40,77],[21,86],[18,88],[0,92]];

        function getBatteryFromRemTime(rem) {
            if (rem <= 0) return 100;
            if (rem < 4) return Math.round(100 - (rem/4)*3);
            for (let i=0; i<CHARGING_CURVE.length-1; i++) {
                const [p1, t1] = CHARGING_CURVE[i]; const [p2, t2] = CHARGING_CURVE[i+1];
                if (rem >= t1 && rem <= t2) return Math.round(p1 - ((rem-t1)/(t2-t1))*(p1-p2));
            }
            return 0;
        }
        
        function calculateDuration(start, target) {
            if (start>=target) return 5;
            let timeStart=0, timeTarget=0;
            if(start<=CHARGING_CURVE[CHARGING_CURVE.length-1][0]) timeStart=CHARGING_CURVE[CHARGING_CURVE.length-1][1];
            else if(start>CHARGING_CURVE[0][0]) timeStart=(100-start)*(CHARGING_CURVE[0][1]/(100-CHARGING_CURVE[0][0]));
            else { for(let i=0; i<CHARGING_CURVE.length-1; i++){ if(start<=CHARGING_CURVE[i][0] && start>=CHARGING_CURVE[i+1][0]) { const ratio = (CHARGING_CURVE[i][0]-start)/(CHARGING_CURVE[i][0]-CHARGING_CURVE[i+1][0]); timeStart = CHARGING_CURVE[i][1] + ratio*(CHARGING_CURVE[i+1][1]-CHARGING_CURVE[i][1]); break; } } }
            if(target<=CHARGING_CURVE[CHARGING_CURVE.length-1][0]) timeTarget=CHARGING_CURVE[CHARGING_CURVE.length-1][1];
            else if(target>CHARGING_CURVE[0][0]) timeTarget=(100-target)*(CHARGING_CURVE[0][1]/(100-CHARGING_CURVE[0][0]));
            else { for(let i=0; i<CHARGING_CURVE.length-1; i++){ if(target<=CHARGING_CURVE[i][0] && target>=CHARGING_CURVE[i+1][0]) { const ratio = (CHARGING_CURVE[i][0]-target)/(CHARGING_CURVE[i][0]-CHARGING_CURVE[i+1][0]); timeTarget = CHARGING_CURVE[i][1] + ratio*(CHARGING_CURVE[i+1][1]-CHARGING_CURVE[i][1]); break; } } }
            let dur = timeStart - timeTarget;
            if(start>=97 && target===100) dur=(target-start)*3;
            return Math.max(1, Math.ceil(dur));
        }
        
        function calculateTargetLimit(queueLength) {
            if (queueLength >= 6 && queueLength <= 10) return 90;
            if (queueLength > 10) return 85;
            if (queueLength >= 3 && queueLength <= 5) return 95;
            return 100;
        }

        // --- UI RENDER (UPDATED: NAMA MUNCUL & READY KECIL) ---
        function renderSlots(slots) {
            const c = document.getElementById('slotsContainer'); c.innerHTML='';
            slots.forEach((m, i) => {
                const box = document.createElement('div'); box.className = 'slot-box';
                const isMine = localStorage.getItem('myPlat')===m?.plat;
                if(isMine) box.classList.add('active');

                if(m && m.startTime) {
                    const end = new Date(m.startTime.seconds*1000 + m.durationMinutes*60000);
                    const rem = (end - new Date())/60000;
                    
                    if(rem <= 0) {
                        // SLOT SELESAI
                        if (!triggeredAlarms.has(m.plat)) triggeredAlarms.add(m.plat);
                        box.innerHTML=`
                            <div style="font-weight:700;color:var(--soft-red);font-size:12px;">SLOT ${i+1}</div>
                            <div style="font-size:20px;font-weight:900;margin-top:10px;font-family:'Inter'">${m.plat}</div>
                            <div style="font-size:11px;color:#aaa;font-weight:400;margin-bottom:10px;">${m.userName}</div>
                            
                            <div style="font-size:16px;color:var(--soft-red);font-weight:800;">SELESAI</div>
                            <div style="font-size:30px;">‚ùå</div>
                            <div class="btn-group"><button onclick="act(${i},'stop','${m.plat}')" class="btn-act btn-stop">KOSONGKAN</button></div>
                        `;
                    } else {
                        // SLOT BERJALAN
                        if(isMine && rem < 5) { box.classList.add('pulsating'); triggerAlarm(m.plat); }
                        let dispBat = getBatteryFromRemTime(rem);
                        dispBat = Math.max(m.startBattery, dispBat); dispBat = Math.min(m.targetLimit, dispBat);

                        box.innerHTML=`
                            <div style="font-size:10px;font-weight:700;color:var(--accent)">SLOT ${i+1}</div>
                            <div style="font-size:18px;font-weight:900;margin-top:5px;font-family:'Inter';letter-spacing:1px;">${m.plat}</div>
                            <div style="font-size:11px;color:#aaa;font-weight:400;margin-bottom:5px;">${m.userName}</div>
                            
                            <div class="timer-display">${formatTime(rem)}</div>
                            <div class="bat-icon"><span class="bat-bolt">‚ö°</span><div class="bat-fill pulsating-fill" style="height:${dispBat}%"></div></div>
                            
                            <div class="bat-info-container">
                                <div class="bat-info-row"><span class="info-label">Awal:</span><span class="info-value">${m.startBattery}%</span></div>
                                <div class="bat-info-row"><span class="info-label">Target:</span><span class="info-value">${m.targetLimit}%</span></div>
                                <div class="bat-info-row"><span class="info-label">Saat ini:</span><span class="info-value" style="color:#0f0">${dispBat}%</span></div>
                            </div>
                            
                            <div class="btn-group">
                                ${isAdminLoggedIn ? `<button onclick="editTimer(${i})" class="btn-act btn-edit">EDIT TIMER</button>` : ''}
                                <button onclick="act(${i},'stop','${m.plat}')" class="btn-act btn-stop">STOP & KOSONGKAN</button>
                            </div>
                        `;
                    }
                } else if(m) {
                    // SLOT READY (WAITING)
                    box.classList.add('active'); box.style.borderColor='var(--cyan)';
                    box.innerHTML=`
                        <div style="color:var(--cyan);font-weight:700;font-size:10px;">SLOT ${i+1}</div>
                        <div style="font-size:18px;font-weight:900;margin-top:5px;font-family:'Inter'">${m.plat}</div>
                        <div style="font-size:11px;color:#aaa;font-weight:400;margin-bottom:5px;">${m.userName}</div>
                        
                        <div style="font-family:'Syne';font-size:16px;font-weight:900;color:var(--cyan);margin-bottom:10px;">READY</div>
                        
                        <div class="bat-icon" style="border-color:var(--cyan)"><div class="bat-fill" style="height:${m.startBattery}%;background:var(--cyan)"></div></div>
                        
                        <div class="btn-group">
                            ${(isAdminLoggedIn || isMine) ? `<button onclick="act(${i},'start')" class="btn-act btn-start">MULAI CAS</button>` : ''}
                            <button onclick="act(${i},'stop','${m.plat}')" class="btn-act btn-stop">BATAL</button>
                        </div>`;
                } else {
                    // SLOT KOSONG
                    box.classList.remove('active'); box.style.borderColor='#333';
                    box.innerHTML=`<div style="color:#666;font-weight:700;font-size:10px;">SLOT ${i+1}</div><div style="color:#666;margin:20px 0;font-weight:700;">KOSONG</div><div style="font-size:24px;color:#333;font-weight:900;">- - -</div><div class="bat-icon" style="border-color:#333"><div class="bat-fill" style="height:0%;"></div></div><div class="btn-group"><button class="btn-act" style="visibility:hidden">.</button></div>`;
                }
                c.appendChild(box);
            });
        }

        // --- HELPERS ---
        function formatTime(m) { const s=Math.round(m*60); return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        function showPopup(type, t, m, ok=null) {
            const b = document.getElementById('masterModal'); 
            document.getElementById('mTitle').innerText=t; document.getElementById('mMsg').innerText=m;
            document.getElementById('mInput').style.display = type==='admin'?'block':'none';
            document.getElementById('mInputDuration').style.display = type==='timer'?'block':'none';
            document.getElementById('mBtnCancel').style.display = (type==='confirm'||type==='admin'||type==='timer')?'block':'none';
            b.style.display='flex';
            
            const btnOk = document.getElementById('mBtnOk'); const newBtn = btnOk.cloneNode(true); btnOk.parentNode.replaceChild(newBtn, btnOk);
            newBtn.onclick = () => {
                if(type==='admin') {
                    if(document.getElementById('mInput').value==='1131'){ 
                        localStorage.setItem('isAdminLoggedIn','true'); isAdminLoggedIn=true;
                        document.getElementById('adminPanel').style.display='block';
                        checkDisplayMode(); b.style.display='none';
                        showPopup('success', 'SUKSES', 'Login Admin Berhasil.');
                    } else alert('PIN Salah');
                } else if (type==='timer') {
                    const val = parseInt(document.getElementById('mInputDuration').value);
                    if(val>0 && ok) { b.style.display='none'; ok(val); }
                } else { b.style.display='none'; if(ok) ok(); }
            };
            document.getElementById('mBtnCancel').onclick = () => b.style.display='none';
        }

        function checkDisplayMode() {
            const myPlat = localStorage.getItem('myPlat');
            document.getElementById('loadingScreen').style.display='none';
            if (!myPlat && !isAdminLoggedIn && !sessionStorage.getItem('modalClosed')) document.getElementById('choiceModal').style.display = 'flex';
            else document.getElementById('choiceModal').style.display = 'none';

            if(isAdminLoggedIn) {
                document.getElementById('registrationArea').style.display='none';
                document.getElementById('statusArea').style.display='block';
                document.getElementById('adminPanel').style.display='block';
                document.getElementById('logoutButtonContainer').style.display='block';
            } else if(myPlat) {
                document.getElementById('registrationArea').style.display='none';
                document.getElementById('statusArea').style.display='block';
                document.getElementById('logoutButtonContainer').style.display='block';
            } else {
                document.getElementById('registrationArea').style.display='block';
                document.getElementById('statusArea').style.display='none';
                document.getElementById('logoutButtonContainer').style.display='none';
            }
        }
        
        window.closeChoiceModal = () => { document.getElementById('choiceModal').style.display = 'none'; sessionStorage.setItem('modalClosed', 'true'); }
        window.openAdminLogin = () => showPopup('admin','LOGIN','PIN:');
        window.logoutUser = () => showPopup('confirm','LOGOUT','Hapus data?',()=>{ localStorage.clear(); location.reload(); });
        window.logoutAdmin = () => { showPopup('confirm', 'KELUAR ADMIN', 'Yakin keluar admin?', () => { localStorage.removeItem('isAdminLoggedIn'); location.reload(); }); };

        // --- ACTIONS ---
        window.act = (i, type, plat) => {
            if(type==='stop') showPopup('confirm','STOP?',`Stop ${plat}?`, ()=>runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); d.chargingSlots[i]=null; if(d.waitingQueue.length){const n=d.waitingQueue.shift(); d.chargingSlots[i]={...n, startTime:null, durationMinutes:calculateDuration(n.startBattery,100)};} t.update(ref,d); }));
            if(type==='start') runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); d.chargingSlots[i].startTime=new Date(); t.update(ref,d); });
        };
        window.editTimer = (i) => { showPopup('timer', 'EDIT DURASI', 'Masukkan menit baru:', (newDur) => { runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); d.chargingSlots[i].durationMinutes=newDur; d.chargingSlots[i].startTime=new Date(); t.update(ref,d); }); }); }
        window.delQ = (i) => runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); d.waitingQueue.splice(i,1); t.update(ref,d); });
        
        // --- ADMIN ---
        window.manualAssign = () => { const s=document.getElementById('manSlot').value, p=document.getElementById('manPlat').value.toUpperCase(), b=parseInt(document.getElementById('manBattery').value); if(p && !isNaN(b)) runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); d.chargingSlots[s]={plat:p, userName:'ADMIN', wa:'-', startBattery:b, targetLimit:100, durationMinutes:calculateDuration(b,100), startTime:new Date()}; t.update(ref,d); }).then(()=>{showPopup('success','BERHASIL','Slot terisi');}); };
        window.clearSlotManual = () => { const s=document.getElementById('manSlot').value; runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); d.chargingSlots[s]=null; t.update(ref,d); }); };
        window.swapSlots = () => { const i1=document.getElementById('slotSource').value, i2=document.getElementById('slotTarget').value; if(i1<0||i2<0) return; runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); let s=d.chargingSlots; [s[i1],s[i2]]=[s[i2],s[i1]]; t.update(ref,{chargingSlots:s});}); };
        window.swapQueuePositions = () => { const i1=document.getElementById('queueSource').value, i2=document.getElementById('queueTarget').value; if(i1<0||i2<0) return; runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); let q=d.waitingQueue; [q[i1],q[i2]]=[q[i2],q[i1]]; t.update(ref,{waitingQueue:q});}); };
        window.assignQueueToSlot = () => { const qI=document.getElementById('assignQueueIndex').value, sI=document.getElementById('assignSlotTarget').value; if(qI<0) return; runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); let s=d.chargingSlots; let q=d.waitingQueue; if(s[sI]) throw "Slot penuh"; const m=q.splice(qI,1)[0]; s[sI]={...m, startTime:new Date(), durationMinutes:calculateDuration(m.startBattery,100)}; t.update(ref,{chargingSlots:s, waitingQueue:q}); }); };
        window.blockUser = () => { const p = document.getElementById('blockPlatInput').value.toUpperCase(); if(p) runTransaction(db, async(t)=>{ const d=(await t.get(ref)).data(); d.blockedList.push(p); t.update(ref,{blockedList:d.blockedList}); }).then(()=>showPopup('success','BLOKIR',`Plat ${p} diblokir`)); };
        window.stopAll = () => runTransaction(db, async(t)=>{ t.update(ref,{chargingSlots:[null,null,null]}); });
        window.resetAll = () => runTransaction(db, async(t)=>{ t.set(ref,{chargingSlots:[null,null,null],waitingQueue:[],blockedList:[]}); }).then(()=>location.reload());
        window.toggleGpsBypass = () => { isGpsBypassEnabled = document.getElementById('gpsBypassToggle').checked; localStorage.setItem('gpsBypass', isGpsBypassEnabled); showPopup('success', 'GPS BYPASS', `Mode bypass ${isGpsBypassEnabled ? 'ON' : 'OFF'}`); };

        // INIT
        async function requestNotificationPermission() { try { const reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js'); const perm = await Notification.requestPermission(); if (perm === 'granted') fcmToken = await getToken(messaging, { vapidKey: PUBLIC_VAPID_KEY, serviceWorkerRegistration: reg }); } catch (e) { console.error("SW/FCM Error", e); } }
        
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
        }

        onSnapshot(ref, (s) => { 
            const d=s.data()||{}; 
            latestSlots = d.chargingSlots || [null, null, null]; 
            latestQueue = d.waitingQueue || [];
            checkDisplayMode(); 
            
            const qc = document.getElementById('queueList'); qc.innerHTML = latestQueue.length ? '' : '<div style="text-align:center;color:#666;font-size:12px;">Antrian Kosong</div>';
            document.getElementById('qsQueueCountValue').innerText = latestQueue.length;
            document.getElementById('qsMaxTargetValue').innerText = `${calculateTargetLimit(latestQueue.length)}%`;
            latestQueue.forEach((m,i)=>{ const div=document.createElement('div'); div.className='queue-item-display '+(localStorage.getItem('myPlat')===m.plat?'is-mine':''); div.innerHTML=`<div style="display:flex;align-items:center;"><span style="font-family:'Syne';font-weight:800;width:20px;">#${i+1}</span><div style="margin-left:10px;font-size:12px;"><b>${m.plat}</b> (${m.userName})</div></div><div style="font-size:12px;color:#888;">${m.startBattery}% ${isAdminLoggedIn?`<span onclick="delQ(${i})" style="color:var(--soft-red);cursor:pointer;font-weight:bold;margin-left:8px;">‚úï</span>`:''}</div>`; qc.appendChild(div); });

            const qs = document.getElementById('queueSource'), qt = document.getElementById('queueTarget'), qa = document.getElementById('assignQueueIndex');
            qs.innerHTML=qt.innerHTML=qa.innerHTML='<option value="-1">-- Pilih --</option>';
            latestQueue.forEach((m,i)=>{ const opt = `<option value="${i}">#${i+1} ${m.plat}</option>`; qs.insertAdjacentHTML('beforeend',opt); qt.insertAdjacentHTML('beforeend',opt); qa.insertAdjacentHTML('beforeend',opt); });
            
            renderSlots(latestSlots); 
        });

        window.onload = () => { 
            checkDisplayMode(); 
            ['slotSource','slotTarget','assignSlotTarget','manSlot'].forEach(id=>{ const el=document.getElementById(id); el.innerHTML='<option value="-1">-- Pilih --</option>'; [0,1,2].forEach(i=>el.insertAdjacentHTML('beforeend',`<option value="${i}">Slot ${i+1}</option>`)); });
            if(document.getElementById('gpsBypassToggle')) document.getElementById('gpsBypassToggle').checked = isGpsBypassEnabled;
            requestNotificationPermission();
            setInterval(()=>{ if(latestSlots) renderSlots(latestSlots); }, 1000);

            // --- TOMBOL DAFTAR ---
            document.getElementById('btnDaftar').onclick = () => {
                const plat = document.getElementById('userPlat').value.toUpperCase().replace(/\s/g, '').trim();
                const name = document.getElementById('userName').value.trim(); 
                const wa = document.getElementById('userWA').value.trim();
                const bat = parseInt(document.getElementById('userBattery').value);

                if(!plat || !name || isNaN(bat)) return showPopup('error','DATA KURANG','Isi semua data.'); 
                if(bat < 0 || bat > 99) return showPopup('error','DATA INVALID','Baterai 0-99%.');
                
                document.getElementById('btnDaftar').innerText = "MENGAMBIL LOKASI...";
                
                if(isGpsBypassEnabled) {
                    processRegister(plat, name, wa, bat, null);
                } else {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition((p) => {
                            const dist = getDistanceFromLatLonInKm(p.coords.latitude, p.coords.longitude, STATION_LOC.lat, STATION_LOC.lng);
                            if(dist > MAX_DIST_KM) {
                                document.getElementById('btnDaftar').innerText = "DAFTAR ANTRIAN";
                                return showPopup('error','KEJAUHAN',`Jarak: ${dist.toFixed(2)}km. Harus < ${MAX_DIST_KM}km.`);
                            }
                            processRegister(plat, name, wa, bat, dist);
                        }, (e) => {
                            document.getElementById('btnDaftar').innerText = "DAFTAR ANTRIAN";
                            showPopup('error','GPS GAGAL', e.message);
                        }, {enableHighAccuracy: true});
                    } else {
                        showPopup('error','GPS GAGAL','Browser tidak dukung GPS.');
                    }
                }
            };

            function processRegister(plat, name, wa, bat, dist) {
                document.getElementById('btnDaftar').innerText = "PROSES...";
                runTransaction(db, async(t)=>{
                    const d = (await t.get(ref)).data() || {};
                    let s = d.chargingSlots || [null,null,null]; let q = d.waitingQueue || [];
                    if((d.blockedList||[]).includes(plat)) throw "Plat DIBLOKIR!";
                    if(s.some(x=>x?.plat===plat) || q.some(x=>x?.plat===plat)) throw "Plat sudah terdaftar!";
                    
                    const target = calculateTargetLimit(q.length); 
                    const dur = calculateDuration(bat, target);
                    const item = { plat, userName:name, wa, startBattery:bat, targetLimit:target, durationMinutes:dur, startTime:null }; 
                    
                    const empty = s.findIndex(x=>x===null);
                    if(empty!==-1) { s[empty] = item; } else { q.push(item); }
                    t.set(ref, {chargingSlots:s, waitingQueue:q}, {merge:true});
                }).then(() => {
                    localStorage.setItem('myPlat', plat); localStorage.setItem('userWA', wa);
                    showPopup('success', 'BERHASIL', 'Anda masuk antrian.');
                    checkDisplayMode();
                }).catch(e => {
                    showPopup('error','GAGAL', e);
                }).finally(() => {
                    document.getElementById('btnDaftar').innerText = "DAFTAR ANTRIAN";
                });
            }
        };
    </script>
</body>
</html>
