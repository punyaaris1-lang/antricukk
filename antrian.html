<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FC KELAPA GADING - LIVE SYSTEM</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="logo.png">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;400;500;600;700&family=Rajdhani:wght@500;600;700&family=Outfit:wght@300;400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* === GLOBAL SETUP === */
        :root { --bg: #000; --cyan: #00F0FF; --glass-card: rgba(20, 25, 30, 0.95); --glass-border: rgba(0, 240, 255, 0.3); --text-dim: rgba(255, 255, 255, 0.6); --danger: #ff003c; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        body { font-family: 'Rajdhani', sans-serif; background: #000; background-image: linear-gradient(to bottom, rgba(0,0,0,0.9), #000), url('logo.png'); background-size: cover; background-position: center; background-attachment: fixed; color: #fff; margin: 0; width: 100vw; min-height: 100vh; overflow-y: auto; display: flex; flex-direction: column; padding: 10px 20px 220px 20px; }

        /* HEADER */
        .header { flex: 0 0 auto; text-align: center; padding-top: 40px; margin-bottom: 20px; cursor: pointer; }
        .main-title { font-family: 'Teko'; font-size: 42px; line-height: 0.9; color: #fff; text-shadow: 0 0 15px rgba(0, 240, 255, 0.5); letter-spacing: 1px; margin-bottom: 5px; }
        .sub-title { font-size: 10px; color: var(--cyan); letter-spacing: 4px; font-weight: 700; text-transform: uppercase; }
        #btnInstallPWA { display: none; position: absolute; top: 10px; right: 10px; z-index: 999; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--cyan); color: var(--cyan); padding: 5px 10px; border-radius: 20px; font-size: 9px; font-weight: bold; cursor: pointer; box-shadow: 0 0 10px rgba(0, 240, 255, 0.2); animation: pulseBtn 2s infinite; }

        /* SLOT SYSTEM */
        .slot-section { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; flex: 0 0 auto; }
        .slot-card { position: relative; height: auto; min-height: 90px; background: var(--glass-card); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); border-radius: 16px; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .slot-card::before { content:''; position: absolute; left: 0; top: 20px; bottom: 20px; width: 4px; background: #333; border-radius: 0 4px 4px 0; transition: 0.3s; }
        .sc-info { display: flex; flex-direction: column; justify-content: center; width: 65%; }
        .sc-label { font-size: 9px; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 2px; }
        .sc-plat { font-family: 'Teko'; font-size: 38px; color: #fff; line-height: 0.9; letter-spacing: 0.5px; }
        .sc-user { font-size: 11px; color: var(--cyan); margin-top: 4px; opacity: 1; transition: 0.3s; font-weight: bold; display: flex; flex-direction: column; align-items: flex-start; gap: 2px; }
        
        .status-pill { font-size: 10px; padding: 6px 12px; border-radius: 20px; background: rgba(255,255,255,0.05); color: #888; font-weight: bold; letter-spacing: 1px; border: 1px solid rgba(255,255,255,0.1); white-space: nowrap; align-self: center; }
        .slot-card.active { background: linear-gradient(90deg, rgba(0,240,255,0.1), rgba(20,25,30,0.9)); border-color: var(--cyan); box-shadow: 0 0 20px rgba(0,240,255,0.15); }
        .slot-card.active::before { background: var(--cyan); box-shadow: 0 0 15px var(--cyan); }
        .slot-card.active .status-pill { color: #000; background: var(--cyan); border-color: var(--cyan); box-shadow: 0 0 10px var(--cyan); }
        .slot-card.empty .sc-plat { color: #555; font-size: 28px; }
        .btn-pilih { display: none; background: rgba(255, 215, 0, 0.2); border: 1px solid #FFD700; color: #FFD700; padding: 4px 10px; border-radius: 6px; margin-left: 10px; font-size: 10px; font-weight: bold; animation: blink 2s infinite; }
        .slot-card.empty .btn-pilih { display: inline-block; }
        .kudeta-btn { display:none; margin-top:5px; padding:6px; width:100%; background:var(--danger); color:#fff; font-weight:bold; font-size:10px; border:none; border-radius:4px; cursor:pointer; animation: pulseBtn 1s infinite; }
        .slot-card.active.can-kudeta { border: 1px solid var(--danger); }
        .slot-card.active.can-kudeta .kudeta-btn { display:block; }

        /* BADGE */
        .role-badge { position: relative; padding: 2px 8px; text-align: center; text-transform: uppercase; font-family: 'Teko', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 0.5px; border-radius: 4px; overflow: hidden; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.5); width: auto; min-width: 60px; margin-top: 2px; line-height: 1.2; }
        .badge-ketum { background: linear-gradient(45deg, #B8860B, #FFD700, #FFFACD, #FFD700, #B8860B); background-size: 200% 200%; color: #3b2a08; border: 1px solid #FFD700; animation: metalShine 3s infinite linear; text-shadow: 0 1px 0 rgba(255,255,255,0.4); }
        .badge-ketum::before { content: 'üëë '; margin-right:2px; font-size: 10px; }
        .badge-waketum { background: linear-gradient(45deg, #7f8c8d, #bdc3c7, #ffffff, #bdc3c7, #7f8c8d); background-size: 200% 200%; color: #000; border: 1px solid #fff; animation: metalShine 3s infinite linear; text-shadow: 0 1px 0 rgba(255,255,255,0.4); }
        .badge-satgas { background: repeating-linear-gradient(45deg, #000, #000 5px, #FFD700 5px, #FFD700 10px); background-size: 20px 20px; color: #fff; text-shadow: 0 0 3px #000; border: 1px solid #FFD700; animation: hazardMove 1s infinite linear; }
        .badge-satgas span { background: #000; padding: 0 4px; border-radius: 2px; z-index: 2; }
        .badge-sekjen { background: #001a1a; border: 1px solid #00F0FF; color: #00F0FF; box-shadow: 0 0 5px rgba(0,240,255,0.3); animation: pulseGlow 2s infinite; }
        .badge-office { background: #1a252f; border-left: 3px solid #95a5a6; color: #ecf0f1; font-family: sans-serif; font-weight: 800; font-size: 9px; }
        .badge-korlap { background: #1a0505; color: #ff3333; border: 1px solid #ff3333; overflow: hidden; }
        .badge-korlap::after { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 51, 51, 0.8), transparent); transform: skewX(-20deg); animation: radarScan 2s infinite linear; }
        .badge-pembina { background: linear-gradient(to bottom, #2c003e, #1a0024); border: 1px solid #d4af37; color: #d4af37; box-shadow: 0 0 5px rgba(212, 175, 55, 0.3); animation: pulseGold 3s infinite; }
        .badge-humas { background: #2d1b02; border: 1px solid #ff8c00; color: #ff8c00; }
        .badge-kacab { background: #00261a; border: 1px solid #00ff99; color: #00ff99; }
        .badge-custom { background: #222; border: 1px solid #555; color: #fff; letter-spacing: 0.5px; }
        .badge-family { background: #000; color: #fff; border: 1px solid rgba(0, 240, 255, 0.3); display: inline-flex; justify-content: center; gap: 1px; min-width: 80px; }
        .badge-family::before { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #00f0ff, transparent); animation: electricFlow 3s infinite linear; }
        .badge-turtle { background: #020402; border: 1px solid #39FF14; color: #39FF14; height: 24px; max-width: 140px; overflow: hidden; display: flex; align-items: center; position: relative; }
        .wind-fx { position: absolute; inset: 0; background: linear-gradient(90deg, transparent 50%, rgba(57,255,20,0.3) 50%); background-size: 20px 100%; transform: skewX(-20deg); opacity: 0; animation: windSpeed 6s infinite ease-in-out; z-index: 0; }
        .turtle-icon { position: absolute; font-size: 16px; animation: turtleRun 6s infinite; right: -20px; z-index: 2; }
        .turtle-text { z-index: 1; display: flex; gap: 0px; font-size: 10px; font-weight: bold; width: 100%; justify-content: center; }
        .turtle-text span { display: inline-block; animation: textChaos 6s infinite; }

        .char { display: inline-block; font-size: 11px; font-weight: 700; opacity: 0; transform: translateY(5px); animation: typeIn 3s infinite; text-shadow: 0 0 5px #00f0ff; }
        .char:nth-child(1) { animation-delay: 0.1s; } .char:nth-child(2) { animation-delay: 0.2s; } .char:nth-child(3) { animation-delay: 0.3s; }
        .char:nth-child(4) { animation-delay: 0.4s; } .char:nth-child(5) { animation-delay: 0.5s; } .char:nth-child(6) { animation-delay: 0.6s; }
        .char:nth-child(7) { animation-delay: 0.7s; } .char:nth-child(8) { animation-delay: 0.8s; } .char:nth-child(9) { animation-delay: 0.9s; }
        .char:nth-child(10) { animation-delay: 1.0s; } .char:nth-child(11) { animation-delay: 1.1s; } .char:nth-child(12) { animation-delay: 1.2s; }

        @keyframes metalShine { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        @keyframes hazardMove { 0% { background-position: 0 0; } 100% { background-position: 20px 0; } }
        @keyframes radarScan { 0% { left: -50%; } 100% { left: 150%; } }
        @keyframes electricFlow { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        @keyframes pulseGlow { 0%,100% { box-shadow: 0 0 5px rgba(0,240,255,0.3); border-color:#00F0FF; } 50% { box-shadow: 0 0 15px rgba(0,240,255,0.6); border-color:#fff; } }
        @keyframes pulseGold { 0%,100% { border-color:#d4af37; } 50% { border-color:#fff; box-shadow: 0 0 10px rgba(212,175,55,0.6); } }
        @keyframes windSpeed { 0% { opacity: 0; background-position: 0 0; } 10% { opacity: 1; } 20% { opacity: 0; background-position: -200px 0; } 100% { opacity: 0; } }
        @keyframes turtleRun { 0% { transform: translateX(0); right: -20px; } 15% { transform: translateX(-100px) skewX(-20deg); } 20% { transform: translateX(-100px) skewX(0deg); } 25% { transform: translateX(-100px) translateY(-5px) rotate(-180deg); } 30% { transform: translateX(-100px) translateY(0) rotate(-360deg); } 40% { transform: translateX(-100px) rotate(0deg); opacity: 1; } 90% { transform: translateX(-200px); opacity: 0; } 100% { opacity: 0; right: -20px; } }
        @keyframes textChaos { 0%, 13% { transform: translate(0,0); color: #39FF14; } 15% { transform: translate(calc(var(--d)*2px), calc(var(--r)*-1px)) rotate(calc(var(--r)*10deg)); color: #fff; filter: blur(1px); } 20% { transform: translate(0,0); color: #39FF14; filter: blur(0); } 100% { transform: translate(0,0); } }
        @keyframes typeIn { 0% { opacity: 0; transform: translateY(5px); } 10% { opacity: 1; transform: translateY(0); color: #00f0ff; } 20% { color: #fff; } 80% { opacity: 1; } 90%, 100% { opacity: 0; } }
        @keyframes breatheLogo { 0%,100%{transform:scale(1); filter:drop-shadow(0 0 15px rgba(0,240,255,0.6));} 50%{transform:scale(1.05); filter:drop-shadow(0 0 30px rgba(0,240,255,0.9));} }
        @keyframes blink { 0%,100%{opacity:0.4;} 50%{opacity:1;} }
        @keyframes popUp { from{opacity:0; transform:scale(0.8);} to{opacity:1; transform:scale(1);} }
        @keyframes pulseBtn { 0%{box-shadow: 0 0 20px rgba(0,240,255,0.4);} 50%{box-shadow: 0 0 40px rgba(0,240,255,0.8);} 100%{box-shadow: 0 0 20px rgba(0,240,255,0.4);} }

        /* UI ELEMENTS */
        .mid-action-area { flex: 1 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 50; min-height: 150px; margin-bottom: 20px; }
        .logo-btn { width: 100px; height: 100px; position: relative; cursor: pointer; transition: transform 0.2s; display: flex; justify-content: center; align-items: center; }
        .logo-img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 0 15px rgba(0, 240, 255, 0.6)); animation: breatheLogo 3s infinite ease-in-out; }
        .tap-hint { font-size: 11px; color: var(--cyan); letter-spacing: 2px; margin-top: 10px; font-weight: bold; text-shadow: 0 0 10px rgba(0,240,255,0.5); animation: blink 2s infinite; }
        .queue-section { flex: 0 0 auto; display: flex; gap: 10px; align-items: stretch; margin-bottom: 10px; }
        .q-box-next { flex: 2; background: #0a0a0a; border: 1px solid #333; border-radius: 16px; padding: 15px 20px; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .qbn-lbl { font-size: 9px; color: #888; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 5px; }
        .qbn-val { font-size: 20px; color: #fff; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .qbn-rank { color: var(--cyan); font-family: 'Teko'; font-size: 28px; }
        .q-box-total { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 16px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .qbt-lbl { font-size: 8px; color: #aaa; letter-spacing: 1px; text-align: center; }
        .qbt-val { font-family: 'Teko'; font-size: 42px; line-height: 0.8; color: #fff; margin-top: 2px; }

        /* üî• FIX POSISI MODAL (CENTERING) üî• */
        .screen-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); 
            backdrop-filter: blur(15px); z-index: 9999; 
            display: none; 
            flex-direction: column; 
            justify-content: center; /* VERTIKAL CENTER */
            align-items: center;     /* HORIZONTAL CENTER */
            overflow-y: auto; padding: 20px;
        }
        .screen-overlay.active { display: flex; animation: popUp 0.3s forwards; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); animation: fadeIn 0.2s; }
        .modal-box { width: 85%; max-width: 350px; background: #111; border: 1px solid var(--cyan); border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 0 30px rgba(0, 240, 255, 0.3); transform: scale(0.9); animation: popUp 0.3s forwards; }
        .modal-msg { font-size: 18px; color: #fff; margin-bottom: 25px; font-family: 'Rajdhani'; font-weight: 600; line-height: 1.4; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .btn-modal { flex: 1; padding: 12px; border: none; border-radius: 8px; font-family: 'Teko'; font-size: 20px; cursor: pointer; text-transform: uppercase; }
        .login-card { width: 100%; max-width: 320px; background: rgba(20, 25, 30, 0.95); border: 1px solid var(--cyan); border-radius: 20px; padding: 30px 20px; text-align: center; box-shadow: 0 0 50px rgba(0, 240, 255, 0.2); }
        .holo-input { background: transparent; border: none; border-bottom: 2px solid #333; width: 100%; color: #fff; font-family: 'Teko'; font-size: 42px; text-align: center; outline: none; margin: 20px 0; text-transform: uppercase; }
        .btn-next { width: 100%; padding: 15px; background: var(--cyan); color: #000; font-family: 'Rajdhani'; font-weight: bold; font-size: 18px; border-radius: 50px; border:none; cursor: pointer; box-shadow: 0 0 20px rgba(0,240,255,0.4); }
        .queue-status-card { flex: 0 0 auto; width: 100%; max-width: 400px; background: rgba(20, 25, 30, 0.9); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; display: flex; flex-direction: column; align-items: center; position: relative; margin-bottom: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 2; }
        .qsc-ring { width: 130px; height: 130px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.05); border-top: 4px solid var(--cyan); display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 0 30px rgba(0, 240, 255, 0.15); animation: spinRing 4s infinite linear; margin-bottom: 10px; position: relative; flex-shrink: 0; }
        .qsc-content { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; animation: counterSpin 4s infinite linear; }
        .qsc-rank-big { font-family: 'Teko'; font-size: 60px; line-height: 0.8; color: #fff; text-shadow: 0 0 20px var(--cyan); }
        .queue-list-wrapper { flex: 1; width: 100%; max-width: 400px; overflow-y: auto; min-height: 0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; margin-bottom: 10px; scrollbar-width: none; }
        #waitingDashboard { justify-content: flex-start !important; padding-top: 50px; }
        .scan-wrapper { position: relative; width: 200px; height: 200px; margin-bottom: 20px; border-radius: 20px; overflow: hidden; border: 2px solid var(--cyan); box-shadow: 0 0 30px rgba(0, 240, 255, 0.2); }
        .scan-logo { width: 100%; height: 100%; object-fit: cover; }
        .scan-beam { position: absolute; top: 0; left: 0; right: 0; height: 5px; background: var(--cyan); box-shadow: 0 0 15px var(--cyan); animation: scanMove 2s infinite ease-in-out; }
        .scan-status { font-family: 'Teko'; font-size: 24px; color: #fff; letter-spacing: 2px; animation: blink 1s infinite; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
        @keyframes scanMove { 0% { top: 0; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        @keyframes spinRing { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        @keyframes counterSpin { 0%{transform:rotate(0deg);} 100%{transform:rotate(-360deg);} }

        /* === üõë STATIC MODE: MATIKAN ANIMASI DI LIST ANTRIAN üõë === */
        #wdListContainer .role-badge *,
        #wdListContainer .role-badge::before,
        #wdListContainer .role-badge::after { animation: none !important; transition: none !important; }
        #wdListContainer .char { opacity: 1 !important; transform: none !important; color: #fff !important; text-shadow: none !important; }
        #wdListContainer .badge-turtle .turtle-icon { position: relative !important; right: auto !important; margin-left: 5px; }
        #wdListContainer .badge-turtle .wind-fx { display: none !important; }
        #wdListContainer .badge-family::before { display: none; }
        #wdListContainer .badge-korlap::after { display: none; }
        #wdListContainer .badge-satgas { animation: none !important; border-color: #ffaa00 !important; }
        #wdListContainer .badge-ketum, #wdListContainer .badge-waketum { animation: none !important; background: #B8860B; }

        /* üî• MODAL ATURAN (DEFAULT HIDDEN!) üî• */
        #modalRules { display: none !important; z-index: 25000; }
        #modalRules.active { display: flex !important; }
        
        .rule-box { border: 2px solid var(--danger); padding: 25px 20px; border-radius: 15px; background: #110000; width: 90%; max-width: 350px; position: relative; box-shadow: 0 0 30px rgba(255, 0, 60, 0.3); text-align: left; }
        .rule-title { font-family: 'Teko'; font-size: 36px; color: var(--danger); margin: 0 0 15px 0; line-height: 1; text-align: center; }
        .rule-item { font-size: 16px; color: #fff; margin-bottom: 15px; line-height: 1.3; border-bottom: 1px solid #333; padding-bottom: 10px; display:flex; gap:10px; }
        .rule-num { color: var(--danger); font-weight: bold; font-size: 24px; font-family: 'Teko'; flex-shrink:0; }
        .btn-rule-ok { background: var(--danger); color: #fff; border: 1px solid #fff; width: 100%; padding: 12px; font-family: 'Teko'; font-size: 20px; cursor: pointer; border-radius: 8px; margin-top: 10px; }
        .btn-rule-cancel { background: #333; color: #ccc; border: none; width: 100%; padding: 10px; font-family: 'Orbitron'; font-size: 12px; cursor: pointer; border-radius: 8px; margin-top: 5px; }

        /* üî• BROADCAST MODAL üî• */
        #broadcastModal { 
            display: none; position: fixed; inset: 0; background: rgba(50, 0, 0, 0.95); z-index: 30000; 
            justify-content: center; align-items: center; 
            animation: alertShake 0.5s; flex-direction: column; padding: 20px; 
        }
        #broadcastModal.active { display: flex !important; } /* PAKSA MUNCUL */
        
        #broadcastBox { background: #220000; border: 2px solid red; box-shadow: 0 0 50px red; padding: 30px; border-radius: 15px; width: 100%; max-width: 400px; text-align: center; position:relative; overflow:hidden; }
        #broadcastBox::before { content:''; position:absolute; top:0; left:0; width:100%; height:5px; background:red; animation: widthRun 1s infinite alternate; }
        @keyframes alertShake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        @keyframes widthRun { 0%{width:0; left:0;} 100%{width:100%; left:0;} }
    </style>
</head>
<body>

    <div id="broadcastModal">
        <div id="broadcastBox">
            <h1 style="color:red; font-family:'Teko'; font-size:40px; margin:0; text-shadow:0 0 10px red;">‚ö†Ô∏è PERHATIAN ‚ö†Ô∏è</h1>
            <p id="broadcastMsg" style="color:#fff; font-family:'JetBrains Mono'; font-size:16px; margin:20px 0; line-height:1.4;">-</p>
            <button onclick="closeBroadcast()" class="btn-rule-ok">MENGERTI</button>
        </div>
    </div>

    <div id="modalRules" class="screen-overlay" style="justify-content: center; align-items: center;">
        <div class="rule-box">
            <h2 class="rule-title">‚ö†Ô∏è ATURAN MAIN</h2>
            <div class="rule-item">
                <span class="rule-num">1</span>
                <div>JARAK MAKSIMAL 200 METER BUKAN BERARTI ANDA BISA DAFTAR DARI JAUH. 
                  <br>MOTOR DI ANTRIAN TP TIDAK ADA FISIK DI FC AKAN DIKELUARKAN</br>PASTIKAN SUDAH DI LOKASI BARU DAFTAR.</div>
            </div>
            <div class="rule-item" style="border:none;">
                <span class="rule-num">2</span>
                <div>DATANG DULUAN, NGECAS DULUAN. <br>PAHAM BOS KU?</br> </div>
            </div>
            <button onclick="proceedToScanner()" class="btn-rule-ok">SAYA PAHAM & LANJUT</button>
            <button onclick="closeModal('modalRules')" class="btn-rule-cancel">BATAL</button>
        </div>
    </div>

    <button id="btnInstallPWA" onclick="installPWA()">‚¨á INSTALL APP</button>

    <div id="customModal" class="modal-overlay">
        <div class="modal-box">
            <div id="modalMsg" class="modal-msg">MESSAGE</div>
            <input type="text" id="modalInput" class="holo-input" style="display:none; margin-bottom:20px; font-size:24px;">
            <div id="modalActions" class="modal-actions"></div>
        </div>
    </div>

    <div id="cyberPlayer" style="position: fixed; top: 20px; left: 20px; z-index: 9000; display: flex; flex-direction: column; align-items: flex-start;">
        <div class="cp-disc" onclick="togglePlayerPanel()" style="width: 45px; height: 45px; background: rgba(0,0,0,0.8); border: 2px solid #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: 0.3s; position: relative; z-index: 2;">
            <div class="cp-icon" style="font-size: 18px; filter: grayscale(100%);">üéµ</div>
        </div>
        <div class="cp-panel" id="cpPanel" style="position: absolute; top: 55px; left: 0; width: 260px; background: rgba(10, 15, 20, 0.95); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; display: none; flex-direction: column; gap: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.8);">
            <div class="cp-controls" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                <button class="cp-btn" onclick="prevSong()" style="background:none; border:1px solid #333; color:#fff; border-radius:50%; width:30px; height:30px;">‚èÆ</button>
                <div class="cp-title-scroll" id="cpTitle" style="flex: 1; overflow: hidden; white-space: nowrap; margin: 0 10px; font-family: 'Teko'; font-size: 16px; color: var(--cyan);">STOPPED</div>
                <button class="cp-btn" onclick="nextSong()" style="background:none; border:1px solid #333; color:#fff; border-radius:50%; width:30px; height:30px;">‚è≠</button>
            </div>
            <div class="cp-list" id="cpListContainer" style="max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px;"></div>
        </div>
    </div>
    <audio id="audioPlayer" onended="nextSong()"></audio>

    <div class="header" ondblclick="toggleAdmin()">
        <div class="main-title">FC KELAPA GADING</div>
        <div class="sub-title">SELAMAT DATANG DI RUMAH MLU</div>
    </div>

    <div class="slot-section" id="slotsContainer"></div>
    
    <div class="mid-action-area">
        <div class="logo-btn" onclick="window.handleMainAction()">
            <img src="logo.png" class="logo-img" alt="LOGO">
        </div>
        <div class="tap-hint" id="mainBtnLabel">TAP UNTUK DAFTAR</div>
        <div onclick="window.gantiMotor()" style="margin-top:15px; cursor:pointer; opacity:0.6; padding: 10px;">
            <span style="font-size:10px; color:#666; letter-spacing:1px; border-bottom:1px solid #444; padding-bottom:2px;">
                GANTI PLAT / RESET (ADMIN ONLY)
            </span>
        </div>
    </div>

    <div class="queue-section">
        <div class="q-box-next">
            <div class="qbn-lbl">SELANJUTNYA (NEXT)</div>
            <div class="qbn-val" id="nextQDisplay"><span class="qbn-rank">#--</span> ...</div>
        </div>
        <div class="q-box-total" onclick="openWaitingDashboard()">
            <div class="qbt-lbl">TOTAL</div>
            <div class="qbt-val" id="totalQDisplay">0</div>
        </div>
    </div>

    <div id="screen-login" class="screen-overlay">
        <div class="login-card">
            <div style="font-size:12px; color:var(--cyan); letter-spacing:2px; margin-bottom:10px;" id="stepLabel">LANGKAH 1</div>
            <div style="font-family:'Teko'; font-size:24px; color:#fff;" id="questionText">PLAT NOMOR</div>
            <input type="text" id="holoInputLogin" class="holo-input" placeholder="B 1234 XYZ" autocomplete="off" autocapitalize="characters" spellcheck="false" style="text-transform:uppercase;">
            <button class="btn-next" id="btnFinalRegister" onclick="nextStepAction()" style="background:#00F0FF; color:#000; border:none; margin-top:10px;">LANJUT</button>
            <button class="btn-cancel" onclick="cancelLogin()" style="margin-top:15px; background:none; border:none; color:#666; cursor:pointer;">BATAL</button>
        </div>
    </div>

    <div id="screen-scan" class="screen-overlay">
        <div class="scan-wrapper">
            <img src="logo.png" class="scan-logo" id="scanLogoImg">
            <div class="scan-beam"></div>
        </div>
        <div class="scan-status" id="scanText">MENCARI LOKASI...</div>
        <button id="btnRetryGPS" onclick="runLogin(true)" style="display:none; margin-top:20px; padding:10px; background:#333; color:#fff; border:1px solid #555; border-radius:8px; cursor:pointer; font-family:'Teko';">COBA LAGI (MODE RINGAN)</button>
        <button onclick="stopScanner()" class="btn-cancel" style="margin-top:20px; background:none; border:1px solid #333; color:#888; padding:8px 20px; border-radius:20px; cursor:pointer;">BATAL</button>
    </div>

    <div id="waitingDashboard" class="screen-overlay">
        <div class="header" style="flex: 0 0 auto; margin-bottom: 10px; padding-top: 0;">
            <div class="main-title" style="font-size:32px;">LIVE MONITOR</div>
            <div class="sub-title">STATUS ANTRIAN ANDA</div>
        </div>
        <div class="queue-status-card">
            <div class="qsc-ring">
                <div class="qsc-content">
                    <div class="qsc-rank-big" id="wdMyRank">#?</div>
                    <div style="font-size:10px; color:var(--cyan); letter-spacing:1px;">POSISI</div>
                </div>
            </div>
            <div style="text-align:center;">
                <div style="font-family:'Teko'; font-size:28px; color:#fff;" id="wdMyPlat">--</div>
                <div style="font-size:11px; color:#888; margin-top:5px;" id="wdEstTime">Estimasi: -- Menit</div>
            </div>
        </div>
        <div class="lbl-list" style="margin-bottom:10px; color:#888; font-size:12px;">Daftar Menunggu (Klik untuk detail)</div>
        
        <div class="queue-list-wrapper">
            <div id="wdListContainer"></div>
        </div>
        
        <div style="flex:0 0 auto; width:100%; max-width:400px; display:flex; gap:10px; padding-bottom: 10px;">
            <button onclick="document.getElementById('waitingDashboard').classList.remove('active')" style="flex:1; padding:15px; background:#111; color:#888; border:1px solid #333; border-radius:12px; font-family:'Teko'; font-size:18px;">‚ñº SEMBUNYIKAN</button>
            <button onclick="cancelQueue()" style="flex:1; padding:15px; background:rgba(255,0,0,0.1); color:red; border:1px solid red; border-radius:12px; font-family:'Teko'; font-size:18px;">BATALKAN</button>
        </div>
    </div>

    <div id="screen-active-dashboard" class="screen-overlay" style="background-image:radial-gradient(circle at 50% 30%, #0a151a 0%, #000 80%);">
        <button onclick="toggleDashboard(false)" style="position:absolute; top:20px; right:20px; background:rgba(255,255,255,0.1); border:1px solid #555; color:#ccc; padding:5px 15px; border-radius:20px; font-size:10px;">‚ñº MINIMIZE</button>
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div class="qsc-ring" style="width:200px; height:200px; box-shadow:0 0 50px rgba(0,240,255,0.2);">
                <div class="qsc-content">
                    <div style="font-size:10px; color:var(--cyan);">CHARGING TIME</div>
                    <div class="qsc-rank-big" id="timerVal">00:00</div>
                </div>
            </div>
        </div>
        <div style="width:100%; display:flex; justify-content:center;">
            <div class="login-card" style="margin-bottom:30px;">
                <div style="font-size:10px; color:#666;">INFO USER</div>
                <div style="font-family:'Teko'; font-size:42px; color:#fff;" id="ad-plat-val">--</div>
                <div style="font-size:12px; color:var(--cyan); font-weight:bold;" id="ad-name-val">--</div>
            </div>
        </div>
        <div style="width:100%; display:flex; justify-content:center;">
            <button onclick="stopCharging(activeSlotIdx)" style="width:100%; max-width:320px; padding:15px; background:linear-gradient(90deg, rgba(255,0,60,0.1), rgba(255,0,60,0.2)); border:1px solid #ff003c; color:#ff003c; border-radius:50px; font-family:'Rajdhani'; font-weight:bold; font-size:16px; margin-bottom:20px;">‚èπ HENTIKAN PENGISIAN</button>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, runTransaction, collection, addDoc, setDoc, updateDoc, arrayUnion, arrayRemove, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // === FIREBASE CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyB666i9lYWIpxOdkwpoX9EvFvHLmHczeq8",
            authDomain: "fcgadingnew22.firebaseapp.com",
            projectId: "fcgadingnew22",
            storageBucket: "fcgadingnew22.firebasestorage.app",
            messagingSenderId: "537736846678",
            appId: "1:537736846678:web:53788d71a196423ac08af7"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // === REFERENCES ===
        const mainRef = doc(db, "antrian", "utama");
        const historyRef = collection(db, "riwayatCharging");
        const logRef = collection(db, "activityLog"); 

        const STATION_LAT = -6.171583; 
        const STATION_LNG = 106.899844; 
        const MAX_DIST_KM = 0.2; 
        const $ = (id) => document.getElementById(id);

        // üõë LOGIC WELCOME SCREEN DIHAPUS TOTAL DI SINI üõë

        function escapeHtml(text) { if (!text) return ""; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        function cleanStr(s) { return s ? s.replace(/[^A-Z0-9]/gi, '').toUpperCase() : ''; }
        function addUserLog(action, details) { addDoc(logRef, { actor: "USER " + (localStorage.getItem('myPlat') || "GUEST"), action: action, details: details, timestamp: new Date() }).catch(e=>{}); }

        let localSlots = [null,null,null];
        let localQueue = [];
        let myPlat = localStorage.getItem('myPlat');
        let currentValidQR = "OFF"; 
        window.activeSlotIdx = -1;
        let amIInQueue = false;
        let chargeTimerInterval;
        let lastBroadcastTime = Date.now(); // Init waktu load biar ga spam notif lama

        // === REALTIME LISTENER ===
        onSnapshot(mainRef, (snap) => {
            if (!snap.exists()) return;
            const d = snap.data();
            localSlots = d.chargingSlots || [null,null,null];
            localQueue = d.waitingQueue || [];
            currentValidQR = (d.activeQrCode && d.activeQrCode !== "OFF") ? d.activeQrCode : "OFF";
            
            // üî• LOGIC BROADCAST FIX (PAKSA TAMPIL) üî•
            if (d.broadcast && d.broadcast.time > lastBroadcastTime) {
                lastBroadcastTime = d.broadcast.time;
                $('broadcastMsg').innerText = d.broadcast.msg;
                
                // FORCE DISPLAY FLEX (BIAR KE TENGAH)
                const modal = $('broadcastModal');
                modal.style.display = 'flex'; 
                
                // Audio alert
                const audio = new Audio("https://www.myinstants.com/media/sounds/nuclear-alarm.mp3");
                audio.volume = 0.5; audio.play().catch(()=>{});
            }

            updateUI();
        });

        window.closeBroadcast = () => { $('broadcastModal').style.display = 'none'; };

        function updateUI() {
            const container = $('slotsContainer'); container.innerHTML = '';
            let amICharging = false;
            let currentMyPlat = localStorage.getItem('myPlat');
            let amIQueue1 = false;
            
            if(localQueue.length > 0 && currentMyPlat) { if(cleanStr(localQueue[0]?.plat) === cleanStr(currentMyPlat)) amIQueue1 = true; }
            
            // JIKA GILIRAN USER & DASHBOARD KEBUKA -> TUTUP BIAR BISA PILIH SLOT
            if(amIQueue1 && $('waitingDashboard').classList.contains('active')) { 
                if(localSlots.some(s => s === null)) { 
                    $('waitingDashboard').classList.remove('active'); 
                    customAlert("GILIRAN ANDA! SILAHKAN PILIH SLOT KOSONG."); 
                } 
            }

            localSlots.forEach((s, i) => {
                const div = document.createElement('div');
                if (s) {
                    const isMe = (cleanStr(s.plat) === cleanStr(currentMyPlat));
                    if(isMe) { amICharging = true; window.activeSlotIdx = i; }
                    const durationMins = Math.floor((Date.now() - s.startTime) / 60000);
                    const canKudeta = amIQueue1 && !isMe && (durationMins >= 25);
                    
                    let kudetaHTML = '';
                    if(amIQueue1 && !isMe) {
                        if(canKudeta) kudetaHTML = `<button class="kudeta-btn" onclick="attemptKudeta(${i}, '${s.plat}')">‚ö° AMBIL ALIH (SUDAH ${durationMins} MENIT)</button>`;
                        else kudetaHTML = `<div style="font-size:9px; color:#555; margin-top:5px;">üîí KUDETA TERBUKA DALAM ${25 - durationMins} MENIT</div>`;
                    }
                    div.className = `slot-card active ${canKudeta ? 'can-kudeta' : ''}`;
                    div.innerHTML = `<div class="sc-info"><div class="sc-label">SLOT 0${i+1}</div><div class="sc-plat">${s.plat}</div><div class="sc-user">${escapeHtml(s.userName)} ${getBadgeHTML(s.role)}</div>${kudetaHTML}</div><div class="status-pill" style="background:${isMe?'var(--cyan)':'#000'}; color:${isMe?'#000':'var(--cyan)'}; border-color:var(--cyan);">${isMe?'ANDA':'CHARGING'}</div>`;
                    if(isMe) { $('ad-plat-val').innerText = s.plat; $('ad-name-val').innerText = s.userName; startChargeTimer(s.startTime); if(!$('screen-active-dashboard').classList.contains('minimized')) $('screen-active-dashboard').classList.add('active'); }
                } else {
                    div.className = `slot-card empty`;
                    let btn = amIQueue1 ? `<button class="btn-pilih" onclick="window.selectSlot(${i})">PILIH SLOT INI</button>` : '';
                    if(amIQueue1) div.style.border = "1px solid #FFD700";
                    div.innerHTML = `<div class="sc-info"><div class="sc-label">SLOT 0${i+1}</div><div class="sc-plat">OPEN</div></div><div style="display:flex; align-items:center;"><div class="status-pill">AVAILABLE</div>${btn}</div>`;
                }
                container.appendChild(div);
            });

            if(!amICharging) {
                window.activeSlotIdx = -1; $('screen-active-dashboard').classList.remove('active');
                if(chargeTimerInterval) clearInterval(chargeTimerInterval);
                amIInQueue = localQueue.some(q => cleanStr(q.plat) === cleanStr(currentMyPlat));
                const lbl = $('mainBtnLabel');
                if(amIInQueue) { lbl.innerText="LIHAT ANTRIAN ANDA"; lbl.style.color="#FFD700"; if($('waitingDashboard').classList.contains('active')) renderQueueDashboard(); } else { lbl.innerText="TAP UNTUK DAFTAR"; lbl.style.color="var(--cyan)"; }
            } else { $('mainBtnLabel').innerText = "BUKA DASHBOARD CHARGING"; $('mainBtnLabel').style.color = "var(--cyan)"; }

            $('totalQDisplay').innerText = localQueue.length;
            if(localQueue.length > 0) $('nextQDisplay').innerHTML = `<span class="qbn-rank">#${localQueue[0].qNo}</span> ${localQueue[0].plat}`;
            else $('nextQDisplay').innerHTML = `<span class="qbn-rank">-</span> KOSONG`;
        }

        // === üî• BADGE RENDERER YANG BENAR üî• ===
        function getBadgeHTML(role) {
            if(!role) return "";
            const r = role.toUpperCase();
            
            if(r === "KETUM") return `<div class="role-badge badge-ketum">KETUA UMUM</div>`;
            if(r === "WAKETUM") return `<div class="role-badge badge-waketum">WAKIL KETUA UMUM</div>`;
            if(r === "SATGAS") return `<div class="role-badge badge-satgas"><span>‚ö° SATUAN TUGAS ‚ö°</span></div>`;
            if(r === "SEKRETARIS" || r === "SEKJEN") return `<div class="role-badge badge-sekjen">SEKJEND</div>`;
            if(r === "KORLAP") return `<div class="role-badge badge-korlap">KOORDINATOR LAPANGAN</div>`;
            if(r === "PEMBINA") return `<div class="role-badge badge-pembina">DEWAN PEMBINA</div>`;
            if(r === "HUMAS") return `<div class="role-badge badge-humas">HUMAS MLU</div>`;
            if(r === "KACAB") return `<div class="role-badge badge-kacab">KEPALA CABANG</div>`;
            if(r === "OFFICE") return `<div class="role-badge badge-office">OFFICE MAKA KG</div>`;
            
            if(r === "PELAN" || r.includes("PELAN") || r.includes("TURTLE")) return `<div class="role-badge badge-turtle"><div class="wind-fx"></div><div class="turtle-text"><span style="--d:1;--r:1">P</span><span style="--d:-1;--r:-1">E</span><span style="--d:1;--r:2">L</span><span style="--d:-1;--r:-1">A</span><span style="--d:1;--r:1">N</span>&nbsp;<span style="--d:-1;--r:2">T</span><span style="--d:1;--r:-2">A</span><span style="--d:-1;--r:1">P</span><span style="--d:1;--r:-1">I</span>&nbsp;<span style="--d:-1;--r:2">K</span><span style="--d:1;--r:-1">E</span><span style="--d:-1;--r:1">N</span><span style="--d:1;--r:-2">C</span><span style="--d:-1;--r:1">E</span><span style="--d:1;--r:-1">N</span><span style="--d:-1;--r:2">G</span></div><div class="turtle-icon">üê¢</div></div>`;
            
            if(r === "MEMBER" || r === "KELUARGA MLU") return `<div class="role-badge badge-family"><span class="char">K</span><span class="char">E</span><span class="char">L</span><span class="char">U</span><span class="char">A</span><span class="char">R</span><span class="char">G</span><span class="char">A</span><span style="width:2px; display:inline-block;"></span><span class="char">M</span><span class="char">L</span><span class="char">U</span></div>`;
            
            return `<div class="role-badge badge-custom">${r}</div>`;
        }

        // === HANDLE BUTTON ===
        window.handleMainAction = () => {
            if(window.activeSlotIdx !== -1) { $('screen-active-dashboard').classList.add('active'); $('screen-active-dashboard').classList.remove('minimized'); return; }
            if(amIInQueue) { $('waitingDashboard').classList.add('active'); renderQueueDashboard(); return; }
            
            // ADMIN BYPASS DIMATIKAN SUPAYA BISA TEST ATURAN
            // if(localStorage.getItem('adm_ok')) { showLoginForm(); return; } 
            
            const myPlat = localStorage.getItem('myPlat');
            if(localQueue.some(q => q.plat === myPlat) || localSlots.some(s => s && s.plat === myPlat)) {
                customAlert("Anda sudah terdaftar!"); return;
            }
            
            // üî• PAKSA MUNCULIN MODAL RULES (FLEX) üî•
            const modal = $('modalRules');
            modal.style.display = 'flex';
            setTimeout(() => { modal.classList.add('active'); }, 10);
        };

        window.proceedToScanner = () => {
            closeModal('modalRules');
            if(currentValidQR !== "OFF") startScanner(); else runGPSCheck();
        };

        function runGPSCheck() {
            if(navigator.geolocation) {
                $('screen-scan').classList.add('active'); $('scanText').innerText = "VERIFIKASI LOKASI...";
                navigator.geolocation.getCurrentPosition((p) => {
                    if(getDist(p.coords.latitude, p.coords.longitude, STATION_LAT, STATION_LNG) > MAX_DIST_KM) { 
                        $('screen-scan').classList.remove('active'); customAlert("TERLALU JAUH DARI SHOWROOM."); 
                    } else showLoginForm();
                }, () => { $('scanText').innerText = "GPS ERROR"; $('btnRetryGPS').style.display = 'block'; }, { enableHighAccuracy: true, timeout: 10000 });
            } else customAlert("GPS Tidak Support.");
        }

        function showLoginForm() { 
            $('screen-scan').classList.remove('active'); 
            $('screen-login').classList.add('active'); 
            formStep = 0; formData = {}; renderStep(); 
        }

        let formStep=0; let formData={};
        const formConfig = [{l:"LANGKAH 1/2",q:"PLAT NOMOR",k:"plat"},{l:"LANGKAH 2/2",q:"NAMA ANDA",k:"name"}];
        
        $('holoInputLogin').addEventListener('input', function(e) {
            if(formConfig[formStep].k !== 'plat') return;
            let v = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            const match = v.match(/^([A-Z]{1,2})(\d{1,4})?([A-Z]{1,3})?$/);
            if (match) { let f = match[1]; if (match[2]) f += " " + match[2]; if (match[3]) f += " " + match[3]; this.value = f; }
        });

        window.nextStepAction = () => {
            let val = $('holoInputLogin').value.trim().toUpperCase(); if(!val) return;
            if(formConfig[formStep].k === 'plat') { 
                if(val.replace(/\s/g, '').length < 3) return customAlert("Plat invalid!"); 
                formData['plat'] = val; formStep++; renderStep(); 
            } else { 
                if(val.length < 3) return customAlert("Nama pendek!"); 
                formData['name'] = val; executeReg(); 
            }
        };

        function renderStep() { 
            $('stepLabel').innerText = formConfig[formStep].l; $('questionText').innerText = formConfig[formStep].q; 
            $('holoInputLogin').value = ""; $('holoInputLogin').focus(); 
            const btn = document.querySelector('.btn-next');
            btn.innerText = formStep === 1 ? "DAFTAR SEKARANG" : "LANJUT";
            btn.onclick = formStep === 1 ? executeReg : nextStepAction;
        }

        async function executeReg() {
            // AMBIL NAMA LANGSUNG
            const finalNameInput = $('holoInputLogin').value.trim().toUpperCase();
            if(finalNameInput.length < 3) return customAlert("Nama wajib diisi!");
            formData['name'] = finalNameInput; 

            const rawPlat = formData.plat;
            const rawName = formData.name;
            const cleanInput = cleanStr(rawPlat);
            
            const btn = document.querySelector('.btn-next');
            btn.innerText = "‚è≥ MENDAFTAR...";
            btn.disabled = true;

            let userRole = null; 
            try { 
                const m = await getDoc(doc(db, "members", cleanInput)); 
                if(m.exists()) userRole = m.data().role || "MEMBER"; 
            } catch(e){}
            
            runTransaction(db, async(t) => {
                const docSnap = await t.get(mainRef);
                const d = docSnap.data();
                if(d.chargingSlots.some(s => s && cleanStr(s.plat) === cleanInput) || d.waitingQueue.some(q => cleanStr(q.plat) === cleanInput)) return { status: "EXIST" };
                const n = (d.lastTicket||0)+1;
                const newUser = { plat: rawPlat, userName: rawName, qNo: n, entryTime: Date.now(), role: userRole };
                Object.keys(newUser).forEach(key => { if (newUser[key] === undefined) newUser[key] = null; });
                t.update(mainRef, { waitingQueue: arrayUnion(newUser), lastTicket: n });
                return { status: "NEW", data: newUser };
            }).then((res) => {
                btn.disabled = false;
                if(res && res.status === "EXIST") {
                    customAlert("Sesi aktif ditemukan.");
                    closeModal('screen-login');
                } else {
                    localStorage.setItem('myPlat', rawPlat); myPlat = rawPlat;
                    addUserLog("REGISTER", `User Baru: ${rawPlat}`); 
                    closeModal('screen-login');
                    customAlert("‚úÖ BERHASIL MASUK ANTRIAN! SILAHKAN PILIH SLOT (JIKA KOSONG).");
                }
            }).catch(e => {
                btn.disabled = false; btn.innerText = "DAFTAR SEKARANG"; customAlert("Gagal: " + e.message);
            });
        }

        let html5QrCode;
        window.startScanner = () => {
            $('screen-scan').classList.add('active'); $('scanText').innerText = "ARAHKAN KAMERA";
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 200 }, (decodedText) => {
                if(decodedText === currentValidQR) { stopScanner(); showLoginForm(); } else alert("QR CODE SALAH / EXPIRED!");
            }).catch(e => { alert("Error Kamera: " + e); stopScanner(); });
        };
        window.stopScanner = () => { if(html5QrCode) html5QrCode.stop().then(() => html5QrCode.clear()).catch(()=>{}); $('screen-scan').classList.remove('active'); };
        window.cancelLogin = () => { $('screen-login').classList.remove('active'); formStep = 0; formData = {}; };

        window.selectSlot = async (i) => {
            const ok = await customConfirm("Masuk Slot "+(i+1)+"?"); if(!ok) return;
            runTransaction(db, async(t)=>{
                const d = (await t.get(mainRef)).data();
                if(d.chargingSlots[i] || cleanStr(d.waitingQueue[0]?.plat) !== cleanStr(localStorage.getItem('myPlat'))) throw "Gagal memilih slot.";
                const u = d.waitingQueue.shift(); u.startTime = Date.now(); d.chargingSlots[i] = u;
                t.update(mainRef,{chargingSlots:d.chargingSlots, waitingQueue:d.waitingQueue});
            }).then(() => { addUserLog("START_CHARGE", `Masuk Slot ${i+1}`); }).catch(e => customAlert(e)); 
        };

        window.stopCharging = async (i) => {
            const ok = await customConfirm("Stop pengisian?"); if(!ok) return;
            runTransaction(db, async(t)=>{
                const d=(await t.get(mainRef)).data(); const u=d.chargingSlots[i]; d.chargingSlots[i]=null;
                if(u) addDoc(historyRef, {...u, finishTime:new Date(), action: "STOP_CHARGING"});
                t.update(mainRef,{chargingSlots:d.chargingSlots});
            }).then(()=>{ localStorage.removeItem('myPlat'); myPlat=null; window.activeSlotIdx=-1; toggleDashboard(false); updateUI(); });
        };

        window.cancelQueue = async () => {
            if(!await customConfirm("Batal antri?")) return;
            const myData = localQueue.find(q => cleanStr(q.plat) === cleanStr(localStorage.getItem('myPlat')));
            if(myData) await updateDoc(mainRef, { waitingQueue: arrayRemove(myData) });
            localStorage.removeItem('myPlat'); myPlat=null; amIInQueue=false; $('waitingDashboard').classList.remove('active');
        };

        window.attemptKudeta = async (slotIdx, targetPlat) => {
            const confirm = await customConfirm(`AMBIL ALIH SLOT ${slotIdx+1}?\nUser ${targetPlat} harus sudah selesai.`);
            if(!confirm) return;
            const currentMyPlat = localStorage.getItem('myPlat'); 
            runTransaction(db, async(t) => {
                const d = (await t.get(mainRef)).data();
                const targetSlot = d.chargingSlots[slotIdx];
                if(!targetSlot || cleanStr(targetSlot.plat) !== cleanStr(targetPlat)) throw "Slot berubah!";
                const meInDb = d.waitingQueue[0];
                if(cleanStr(meInDb?.plat) !== cleanStr(currentMyPlat)) throw "Posisi antrian berubah.";
                const durationMs = Date.now() - targetSlot.startTime;
                if(durationMs/60000 < 25) throw `Belum 25 Menit!`;
                const victim = targetSlot;
                addDoc(historyRef, {...victim, finishTime:new Date(), status: "KUDETA_BY_" + currentMyPlat, action: "KICKED_OUT"});
                const me = d.waitingQueue.shift(); me.startTime = Date.now(); d.chargingSlots[slotIdx] = me;
                t.update(mainRef, { chargingSlots: d.chargingSlots, waitingQueue: d.waitingQueue });
            }).then(() => { addUserLog("KUDETA", `Ambil Alih Slot ${slotIdx+1} dari ${targetPlat}`); customAlert("BERHASIL AMBIL ALIH!"); }).catch(e => customAlert("GAGAL: " + e));
        };

        window.gantiMotor = () => { if(!localStorage.getItem('adm_ok')) return customAlert("Admin Only!"); customConfirm("Hapus Sesi?").then(ok => { if(ok) { localStorage.removeItem('myPlat'); location.reload(); } }); };
        window.toggleAdmin = () => { let c = prompt("KODE:"); if(c === "1131"){ localStorage.setItem('adm_ok','1'); window.location.assign("admin.html"); } else if(c === "090815") window.location.assign("superadmin.html"); };
        window.openWaitingDashboard = () => { $('waitingDashboard').classList.add('active'); renderQueueDashboard(); };
        
        window.closeModal = (id) => { 
            const el = document.getElementById(id); 
            if(el) { el.classList.remove('active'); setTimeout(() => { el.style.display = 'none'; }, 300); }
        };

        const songs = [ { title: "OPENING THEME", file: "lagu1.mp3" }, { title: "SANTAI SORE", file: "lagu2.mp3" }, { title: "MODE BALAP", file: "lagu3.mp3" }, { title: "KOPLO ELITE", file: "dangdut_cyber.mp3" } ];
        let currentSongIdx = 0; const audio = $('audioPlayer');
        window.togglePlayerPanel = () => { const p = $('cpPanel'); if(p.classList.contains('show')) p.classList.remove('show'); else { p.classList.add('show'); renderSongList(); } };
        window.nextSong = () => { currentSongIdx = (currentSongIdx + 1) % songs.length; playSong(currentSongIdx); };
        window.prevSong = () => { currentSongIdx = (currentSongIdx - 1 + songs.length) % songs.length; playSong(currentSongIdx); };
        function playSong(idx) { audio.src = songs[idx].file; audio.play(); $('cpTitle').innerText = songs[idx].title; document.querySelector('.cp-disc').classList.add('playing'); renderSongList(); }
        function renderSongList() { const c = $('cpListContainer'); c.innerHTML = ''; songs.forEach((s, i) => { const d = document.createElement('div'); d.className = `cp-item ${i === currentSongIdx ? 'active' : ''}`; d.innerText = s.title; d.onclick = () => playSong(i); c.appendChild(d); }); }

        function getDist(lat1,lon1,lat2,lon2){const R=6371;const dLat=(lat2-lat1)*Math.PI/180;const dLon=(lon2-lon1)*Math.PI/180;const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));}
        function startChargeTimer(s){ if(chargeTimerInterval) clearInterval(chargeTimerInterval); chargeTimerInterval=setInterval(()=>{ const d=Math.floor((Date.now()-s)/1000); $('timerVal').innerText=`${Math.floor(d/60).toString().padStart(2,'0')}:${(d%60).toString().padStart(2,'0')}`; },1000); }
        window.toggleDashboard = (s) => { if(!s) $('screen-active-dashboard').classList.add('minimized'); else $('screen-active-dashboard').classList.remove('minimized'); if(s===false) $('screen-active-dashboard').classList.remove('active'); };
        
        function showModal(msg,type){ return new Promise(r=>{ const m=$('customModal'); $('modalMsg').innerHTML=msg; const acts=$('modalActions'); const inp=$('modalInput'); inp.style.display=type==='prompt'?'block':'none'; acts.innerHTML=''; if(type==='confirm') acts.innerHTML=`<button class="btn-modal" onclick="mRes(false)" style="background:#333;">BATAL</button><button class="btn-modal" onclick="mRes(true)" style="background:var(--cyan);color:#000;">YA</button>`; else acts.innerHTML=`<button class="btn-modal" onclick="mRes(true)" style="background:#333;">TUTUP</button>`; m.style.display='flex'; window.mRes=(v)=>{m.style.display='none';r(v);}; }); }
        const customAlert=m=>showModal(m,'alert'); const customConfirm=m=>showModal(m,'confirm');

        function renderQueueDashboard() {
            const c=$('wdListContainer'); c.innerHTML=''; const myPlat = localStorage.getItem('myPlat');
            const myIdx = localQueue.findIndex(q=>cleanStr(q.plat)===cleanStr(myPlat));
            if(myIdx!=-1) { $('wdMyRank').innerText="#"+(myIdx+1); $('wdMyPlat').innerText=myPlat; $('wdEstTime').innerText="Est: "+((myIdx+1)*20)+" Menit"; }
            localQueue.forEach((q,i)=>{
                const isMe = (cleanStr(q.plat)===cleanStr(myPlat));
                const d=document.createElement('div'); 
                d.style.cssText=`padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between; ${isMe ? 'background:rgba(0,240,255,0.1); border-left:3px solid var(--cyan);' : ''}`;
                
                d.innerHTML=`<div><span style="color:var(--cyan);">#${q.qNo}</span> ${q.plat}</div><div style="font-size:12px; display:flex; align-items:center;">${escapeHtml(q.userName)} ${getBadgeHTML(q.role)}</div>`;
                
                d.onclick = () => showQueueDetail(q); c.appendChild(d);
            });
        }

        window.showQueueDetail = (d) => {
            const t = d.entryTime ? new Date(d.entryTime).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) : "--:--";
            customAlert(`<div style="text-align:center;">${getBadgeHTML(d.role)}<div style="font-family:'Teko'; font-size:42px;">${d.plat}</div></div><div style="text-align:left;"><b>NAMA:</b> ${escapeHtml(d.userName)}<br><b>TIKET:</b> #${d.qNo}<br><b>JAM:</b> ${t} WIB</div>`);
        };
        
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; $('btnInstallPWA').style.display = 'block'; });
        window.installPWA = async () => { if (deferredPrompt) { deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; if (outcome === 'accepted') { deferredPrompt = null; $('btnInstallPWA').style.display = 'none'; } } };
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

        const style=document.createElement('style'); style.innerHTML=`@keyframes scanMove {0%{top:0} 100%{top:100%}} .screen-overlay.minimized {display:none !important;}`; document.head.appendChild(style);
    </script>
