<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FC KELAPA GADING - LIVE SYSTEM</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;400;500;600&family=Rajdhani:wght@500;600;700&family=Outfit:wght@300;400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* === 1. GLOBAL SETUP === */
        :root {
            --bg: #000;
            --cyan: #00F0FF;
            --glass-card: rgba(20, 25, 30, 0.95);
            --glass-border: rgba(0, 240, 255, 0.3);
            --text-dim: rgba(255, 255, 255, 0.6);
            --danger: #ff003c;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        
        body { 
            font-family: 'Rajdhani', sans-serif;
            background: #000;
            background-image: linear-gradient(to bottom, rgba(0,0,0,0.9), #000), url('logo.png'); 
            background-size: cover; 
            background-position: center;
            background-attachment: fixed;
            color: #fff; 
            margin: 0; 
            width: 100vw; 
            min-height: 100vh; 
            height: auto;      
            overflow-y: auto;  
            display: flex; 
            flex-direction: column;
            padding: 10px 20px 40px 20px;
        }

        /* === 2. HEADER === */
        .header { flex: 0 0 auto; text-align: center; padding-top: 40px; margin-bottom: 20px; cursor: pointer; }
        .main-title { 
            font-family: 'Teko'; font-size: 42px; line-height: 0.9; color: #fff; 
            text-shadow: 0 0 15px rgba(0, 240, 255, 0.5); letter-spacing: 1px; margin-bottom: 5px;
        }
        .sub-title { font-size: 10px; color: var(--cyan); letter-spacing: 4px; font-weight: 700; text-transform: uppercase; }

        /* === 3. SLOT AREA === */
        .slot-section { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; flex: 0 0 auto; }
        .slot-card {
            position: relative; height: 85px; 
            background: var(--glass-card); backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); border-radius: 16px;
            padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
            transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .slot-card::before {
            content:''; position: absolute; left: 0; top: 20px; bottom: 20px; width: 4px;
            background: #333; border-radius: 0 4px 4px 0; transition: 0.3s;
        }
        .sc-info { display: flex; flex-direction: column; justify-content: center; width: 65%; }
        .sc-label { font-size: 9px; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 2px; }
        .sc-plat { font-family: 'Teko'; font-size: 38px; color: #fff; line-height: 0.9; letter-spacing: 0.5px; }
        .sc-user { font-size: 11px; color: var(--cyan); margin-top: -2px; opacity: 0; transition: 0.3s; font-weight: bold; }
        .status-pill {
            font-size: 10px; padding: 6px 12px; border-radius: 20px;
            background: rgba(255,255,255,0.05); color: #888; font-weight: bold; letter-spacing: 1px;
            border: 1px solid rgba(255,255,255,0.1); white-space: nowrap;
        }
        .slot-card.active { background: linear-gradient(90deg, rgba(0,240,255,0.1), rgba(20,25,30,0.9)); border-color: var(--cyan); box-shadow: 0 0 20px rgba(0,240,255,0.15); }
        .slot-card.active::before { background: var(--cyan); box-shadow: 0 0 15px var(--cyan); }
        .slot-card.active .sc-plat { text-shadow: 0 0 15px rgba(0,240,255,0.6); }
        .slot-card.active .sc-user { opacity: 1; }
        .slot-card.active .status-pill { color: #000; background: var(--cyan); border-color: var(--cyan); box-shadow: 0 0 10px var(--cyan); }
        .slot-card.empty .sc-plat { color: #555; font-size: 28px; letter-spacing: 2px; }
        .btn-pilih { display: none; background: rgba(255, 215, 0, 0.2); border: 1px solid #FFD700; color: #FFD700; padding: 4px 10px; border-radius: 6px; margin-left: 10px; font-size: 10px; font-weight: bold; animation: blink 2s infinite; }
        .slot-card.empty .btn-pilih { display: inline-block; }

        /* === 4. MIDDLE BUTTON & LOGO === */
        .mid-action-area { 
            flex: 1 0 auto; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            position: relative; z-index: 50; 
            min-height: 150px; 
            margin-bottom: 20px;
        }
        .logo-btn { width: 100px; height: 100px; position: relative; cursor: pointer; transition: transform 0.2s; display: flex; justify-content: center; align-items: center; }
        .logo-img { 
            width: 100%; height: 100%; object-fit: contain; 
            filter: drop-shadow(0 0 15px rgba(0, 240, 255, 0.6)); 
            animation: breatheLogo 3s infinite ease-in-out; 
        }
        .tap-hint { font-size: 11px; color: var(--cyan); letter-spacing: 2px; margin-top: 10px; font-weight: bold; text-shadow: 0 0 10px rgba(0,240,255,0.5); animation: blink 2s infinite; }
        .logo-btn:active { transform: scale(0.9); }

        /* === 5. QUEUE INFO === */
        .queue-section { 
            flex: 0 0 auto; 
            display: flex; gap: 10px; align-items: stretch; margin-bottom: 10px; 
        }
        .q-box-next { flex: 2; background: #0a0a0a; border: 1px solid #333; border-radius: 16px; padding: 15px 20px; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .qbn-lbl { font-size: 9px; color: #888; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 5px; }
        .qbn-val { font-size: 20px; color: #fff; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .qbn-rank { color: var(--cyan); font-family: 'Teko'; font-size: 28px; }
        .q-box-total { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 16px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .qbt-lbl { font-size: 8px; color: #aaa; letter-spacing: 1px; text-align: center; }
        .qbt-val { font-family: 'Teko'; font-size: 42px; line-height: 0.8; color: #fff; margin-top: 2px; }

        /* === 6. NEW WELCOME SCREEN (RULES) === */
        .welcome-card {
            width: 90%; max-width: 400px;
            background: linear-gradient(180deg, rgba(20, 25, 30, 0.98), rgba(10, 10, 15, 0.98));
            border: 1px solid var(--cyan); border-radius: 24px;
            padding: 30px 25px; display: flex; flex-direction: column;
            box-shadow: 0 0 60px rgba(0, 240, 255, 0.15);
        }
        .rules-list { display: flex; flex-direction: column; gap: 12px; margin: 20px 0; max-height: 50vh; overflow-y: auto; }
        .rule-item {
            display: flex; gap: 12px; align-items: center;
            padding: 12px 15px; border-radius: 12px;
            background: rgba(0, 240, 255, 0.05);
            border-left: 2px solid var(--cyan);
            font-size: 14px; line-height: 1.4; color: #ddd;
        }
        .rule-icon { font-size: 18px; min-width: 25px; text-align: center; }
        .btn-agree {
            width: 100%; padding: 15px; border-radius: 50px; border: none;
            background: var(--cyan); color: #000;
            font-family: 'Teko'; font-size: 22px; font-weight: 600; letter-spacing: 1px;
            cursor: pointer; box-shadow: 0 0 20px rgba(0,240,255,0.4);
            animation: pulseBtn 2s infinite;
        }

        /* === 7. SCREENS & OVERLAYS === */
        .screen-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(15px); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;}
        .screen-overlay.active { display: flex; animation: fadeIn 0.3s forwards; }
        
        /* Modal & Login Styles */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); animation: fadeIn 0.2s; }
        .modal-box { width: 85%; max-width: 350px; background: #111; border: 1px solid var(--cyan); border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 0 30px rgba(0, 240, 255, 0.3); transform: scale(0.9); animation: popUp 0.3s forwards; }
        .modal-msg { font-size: 18px; color: #fff; margin-bottom: 25px; font-family: 'Rajdhani'; font-weight: 600; line-height: 1.4; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .btn-modal { flex: 1; padding: 12px; border: none; border-radius: 8px; font-family: 'Teko'; font-size: 20px; cursor: pointer; text-transform: uppercase; }
        .btn-yes { background: var(--cyan); color: #000; box-shadow: 0 0 15px rgba(0,240,255,0.3); }
        .btn-no { background: #222; color: #888; border: 1px solid #444; }
        
        .login-card { width: 100%; max-width: 320px; background: rgba(20, 25, 30, 0.95); border: 1px solid var(--cyan); border-radius: 20px; padding: 30px 20px; text-align: center; box-shadow: 0 0 50px rgba(0, 240, 255, 0.2); }
        .holo-input { background: transparent; border: none; border-bottom: 2px solid #333; width: 100%; color: #fff; font-family: 'Teko'; font-size: 42px; text-align: center; outline: none; margin: 20px 0; text-transform: uppercase; }
        .btn-next { width: 100%; padding: 15px; background: var(--cyan); color: #000; font-family: 'Rajdhani'; font-weight: bold; font-size: 18px; border-radius: 50px; border:none; cursor: pointer; box-shadow: 0 0 20px rgba(0,240,255,0.4); }

        /* === 8. WAITING & ACTIVE DASHBOARD === */
        #waitingDashboard { justify-content: flex-start !important; padding-top: 50px; }
        .queue-status-card { flex: 0 0 auto; width: 100%; max-width: 400px; background: rgba(20, 25, 30, 0.9); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; display: flex; flex-direction: column; align-items: center; position: relative; margin-bottom: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 2; }
        .qsc-ring { width: 130px; height: 130px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.05); border-top: 4px solid var(--cyan); display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 0 30px rgba(0, 240, 255, 0.15); animation: spinRing 4s infinite linear; margin-bottom: 10px; position: relative; flex-shrink: 0; }
        .qsc-content { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; animation: counterSpin 4s infinite linear; }
        .qsc-rank-big { font-family: 'Teko'; font-size: 60px; line-height: 0.8; color: #fff; text-shadow: 0 0 20px var(--cyan); }
        .queue-list-wrapper { flex: 1; width: 100%; max-width: 400px; overflow-y: auto; min-height: 0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; margin-bottom: 10px; scrollbar-width: none; }
        .ql-item { display: grid; grid-template-columns: 50px 1fr; align-items: center; padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.08); gap: 15px; }
        .ql-rank-box { font-family: 'Teko'; font-size: 24px; color: #666; text-align: center; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 5px 0; }
        .ql-info-box { display: flex; flex-direction: column; justify-content: center; text-align: left; }
        .ql-plat { font-weight: bold; font-size: 16px; color: #fff; letter-spacing: 1px; }
        .ql-name { font-size: 12px; color: var(--cyan); margin-top: 2px; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; }
        .ql-item.active { background: linear-gradient(90deg, rgba(0,240,255,0.15), transparent); border-left: 4px solid var(--cyan); padding-left: 11px; }
        .ql-item.active .ql-rank-box { color: #000; background: var(--cyan); box-shadow: 0 0 10px var(--cyan); }

        /* === 9. MUSIC PLAYER === */
        #cyberPlayer { position: fixed; top: 20px; left: 20px; z-index: 9000; display: flex; flex-direction: column; align-items: flex-start; }
        .cp-disc { width: 45px; height: 45px; background: rgba(0,0,0,0.8); border: 2px solid #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: 0.3s; position: relative; z-index: 2; }
        .cp-disc.playing { border-color: var(--cyan); box-shadow: 0 0 15px var(--cyan); animation: spinDisc 3s infinite linear; }
        .cp-icon { font-size: 18px; filter: grayscale(100%); transition: 0.3s; }
        .cp-disc.playing .cp-icon { filter: grayscale(0%); color: var(--cyan); }
        .cp-panel { position: absolute; top: 55px; left: 0; width: 260px; background: rgba(10, 15, 20, 0.95); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; display: none; flex-direction: column; gap: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); transform-origin: top left; animation: popUp 0.3s; }
        .cp-panel.show { display: flex; }
        .cp-controls { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .cp-btn { background: none; border: 1px solid #333; color: #fff; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .cp-title-scroll { flex: 1; overflow: hidden; white-space: nowrap; margin: 0 10px; font-family: 'Teko'; font-size: 16px; color: var(--cyan); }
        .cp-list { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .cp-item { font-size: 11px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #aaa; }
        .cp-item.active { border-left: 2px solid var(--cyan); color: var(--cyan); background: rgba(0,240,255,0.1); }

        /* === 10. SCAN SCREEN FIX === */
        .scan-wrapper { position: relative; width: 200px; height: 200px; margin-bottom: 20px; border-radius: 20px; overflow: hidden; border: 2px solid var(--cyan); box-shadow: 0 0 30px rgba(0, 240, 255, 0.2); }
        .scan-logo { width: 100%; height: 100%; object-fit: cover; }
        .scan-beam { position: absolute; top: 0; left: 0; right: 0; height: 5px; background: var(--cyan); box-shadow: 0 0 15px var(--cyan); animation: scanMove 2s infinite ease-in-out; }
        .scan-status { font-family: 'Teko'; font-size: 24px; color: #fff; letter-spacing: 2px; animation: blink 1s infinite; }

        /* Keyframes */
        @keyframes breatheLogo { 0%,100%{transform:scale(1); filter:drop-shadow(0 0 15px rgba(0,240,255,0.6));} 50%{transform:scale(1.05); filter:drop-shadow(0 0 30px rgba(0,240,255,0.9));} }
        @keyframes blink { 0%,100%{opacity:0.4;} 50%{opacity:1;} }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
        @keyframes scanMove { 0% { top: 0; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        @keyframes spinRing { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        @keyframes counterSpin { 0%{transform:rotate(0deg);} 100%{transform:rotate(-360deg);} }
        @keyframes spinDisc { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        @keyframes popUp { from{opacity:0; transform:scale(0.8);} to{opacity:1; transform:scale(1);} }
        @keyframes pulseBtn { 0%{box-shadow: 0 0 20px rgba(0,240,255,0.4);} 50%{box-shadow: 0 0 40px rgba(0,240,255,0.8);} 100%{box-shadow: 0 0 20px rgba(0,240,255,0.4);} }
    </style>
</head>
<body>

    <div id="screen-welcome" class="screen-overlay" style="z-index: 20000;">
        <div class="welcome-card">
            <div class="main-title" style="text-align: center; font-size: 36px; margin-bottom: 5px;">PERATURAN</div>
            <div class="sub-title" style="text-align: center; margin-bottom: 20px;">SHOWROOM FC KELAPA GADING</div>

            <div class="rules-list">
                <div class="rule-item"> <div class="rule-icon">üîå</div> <div>Cas di dalam showroom? HP wajib ditinggal (Silahkan tunggu diluar).</div> </div>
                <div class="rule-item"> <div class="rule-icon">üõµ</div> <div>Parkir yang rapi, kepala motor saling berhadapan kanan kiri.</div> </div>
                <div class="rule-item"> <div class="rule-icon">üßπ</div> <div>Wajib menjaga kebersihan area showroom.</div> </div>
                <div class="rule-item"> <div class="rule-icon">üö´</div> <div>Dilarang makan & minum di dalam area showroom.</div> </div>
                <div class="rule-item"> <div class="rule-icon">üì≤</div> <div>Wajib scan barcode/daftar sebelum cas motor.</div> </div>
            </div>

            <button class="btn-agree" onclick="closeWelcome()">SAYA PAHAM & SETUJU</button>
        </div>
    </div>

    <div id="customModal" class="modal-overlay">
        <div class="modal-box">
            <div id="modalMsg" class="modal-msg">MESSAGE HERE</div>
            <input type="text" id="modalInput" class="holo-input" style="display:none; margin-bottom:20px; font-size:24px;">
            <div id="modalActions" class="modal-actions"></div>
        </div>
    </div>

    <div id="cyberPlayer">
        <div class="cp-disc" onclick="togglePlayerPanel()">
            <div class="cp-icon">üéµ</div>
        </div>
        <div class="cp-panel" id="cpPanel">
            <div class="cp-controls">
                <button class="cp-btn" onclick="prevSong()">‚èÆ</button>
                <div class="cp-title-scroll" id="cpTitle">STOPPED</div>
                <button class="cp-btn" onclick="nextSong()">‚è≠</button>
            </div>
            <div class="cp-list" id="cpListContainer"></div>
        </div>
    </div>
    <audio id="audioPlayer" onended="nextSong()"></audio>

    <div class="header" ondblclick="toggleAdmin()">
        <div class="main-title">FC KELAPA GADING</div>
        <div class="sub-title">SELAMAT DATANG DI RUMAH MLU</div>
    </div>

    <div class="slot-section" id="slotsContainer">
        <div class="slot-card empty"><div class="sc-info"><div class="sc-label">SLOT --</div><div class="sc-plat">LOADING...</div></div></div>
    </div>
    <div class="mid-action-area">
        <div class="logo-btn" onclick="window.handleMainAction()">
            <img src="logo.png" class="logo-img" alt="LOGO ERROR">
        </div>
        <div class="tap-hint" id="mainBtnLabel">TAP UNTUK DAFTAR</div>

        <div onclick="window.gantiMotor()" style="margin-top:15px; cursor:pointer; opacity:0.6; padding: 10px;">
            <span style="font-size:10px; color:#666; letter-spacing:1px; border-bottom:1px solid #444; padding-bottom:2px;">
                GANTI PLAT / RESET (ADMIN ONLY)
            </span>
        </div>
    </div>

    <div class="queue-section">
        <div class="q-box-next">
            <div class="qbn-lbl">SELANJUTNYA (NEXT)</div>
            <div class="qbn-val" id="nextQDisplay"><span class="qbn-rank">#--</span> ...</div>
        </div>
        <div class="q-box-total" onclick="openWaitingDashboard()">
            <div class="qbt-lbl">TOTAL</div>
            <div class="qbt-val" id="totalQDisplay">0</div>
        </div>
    </div>

    <div id="screen-login" class="screen-overlay">
        <div class="login-card">
            <div style="font-size:12px; color:var(--cyan); letter-spacing:2px; margin-bottom:10px;" id="stepLabel">LANGKAH 1</div>
            <div style="font-family:'Teko'; font-size:24px; color:#fff;" id="questionText">PLAT NOMOR</div>
            <input type="text" id="holoInput" class="holo-input" placeholder="..." autocomplete="off">
            <button class="btn-next" onclick="nextStepAction()">LANJUT</button>
            <button class="btn-cancel" onclick="cancelLogin()" style="margin-top:15px; background:none; border:none; color:#666;">BATAL</button>
        </div>
    </div>

    <div id="screen-scan" class="screen-overlay">
        <div class="scan-wrapper">
            <img src="logo.png" class="scan-logo" id="scanLogoImg">
            <div class="scan-beam"></div>
        </div>
        <div class="scan-status" id="scanText">MENGHUBUNGKAN...</div>
    </div>

    <div id="waitingDashboard" class="screen-overlay">
        <div class="header" style="flex: 0 0 auto; margin-bottom: 10px; padding-top: 0;">
            <div class="main-title" style="font-size:32px;">LIVE MONITOR</div>
            <div class="sub-title">STATUS ANTRIAN ANDA</div>
        </div>
        
        <div class="queue-status-card">
            <div class="qsc-ring">
                <div class="qsc-content">
                    <div class="qsc-rank-big" id="wdMyRank">#?</div>
                    <div style="font-size:10px; color:var(--cyan); letter-spacing:1px;">POSISI</div>
                </div>
            </div>
            <div style="text-align:center;">
                <div style="font-family:'Teko'; font-size:28px; color:#fff;" id="wdMyPlat">--</div>
                <div style="font-size:11px; color:#888; margin-top:5px;" id="wdEstTime">Estimasi: -- Menit</div>
            </div>
        </div>

        <div class="lbl-list" style="margin-bottom:10px; color:#888; font-size:12px;">Daftar Menunggu</div>

        <div class="queue-list-wrapper">
            <div id="wdListContainer"></div>
        </div>
        
        <div style="flex:0 0 auto; width:100%; max-width:400px; display:flex; gap:10px; padding-bottom: 10px;">
            <button onclick="document.getElementById('waitingDashboard').classList.remove('active')" style="flex:1; padding:15px; background:#111; color:#888; border:1px solid #333; border-radius:12px; font-family:'Teko'; font-size:18px;">‚ñº SEMBUNYIKAN</button>
            <button onclick="cancelQueue()" style="flex:1; padding:15px; background:rgba(255,0,0,0.1); color:red; border:1px solid red; border-radius:12px; font-family:'Teko'; font-size:18px;">BATALKAN</button>
        </div>
    </div>

    <div id="screen-active-dashboard" class="screen-overlay" style="background-image:radial-gradient(circle at 50% 30%, #0a151a 0%, #000 80%);">
        <button onclick="toggleDashboard(false)" style="position:absolute; top:20px; right:20px; background:rgba(255,255,255,0.1); border:1px solid #555; color:#ccc; padding:5px 15px; border-radius:20px; font-size:10px;">‚ñº MINIMIZE</button>
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div class="qsc-ring" style="width:200px; height:200px; box-shadow:0 0 50px rgba(0,240,255,0.2);">
                <div class="qsc-content">
                    <div style="font-size:10px; color:var(--cyan);">CHARGING TIME</div>
                    <div class="qsc-rank-big" id="timerVal">00:00</div>
                </div>
            </div>
        </div>
        <div style="width:100%; display:flex; justify-content:center;">
            <div class="login-card" style="margin-bottom:30px;">
                <div style="font-size:10px; color:#666;">INFO USER</div>
                <div style="font-family:'Teko'; font-size:42px; color:#fff;" id="ad-plat-val">--</div>
                <div style="font-size:12px; color:var(--cyan); font-weight:bold;" id="ad-name-val">--</div>
            </div>
        </div>
        <div style="width:100%; display:flex; justify-content:center;">
            <button onclick="stopCharging(activeSlotIdx)" style="width:100%; max-width:320px; padding:15px; background:linear-gradient(90deg, rgba(255,0,60,0.1), rgba(255,0,60,0.2)); border:1px solid #ff003c; color:#ff003c; border-radius:50px; font-family:'Rajdhani'; font-weight:bold; font-size:16px; margin-bottom:20px;">‚èπ HENTIKAN PENGISIAN</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, runTransaction, collection, addDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // === 1. FIREBASE CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyB666i9lYWIpxOdkwpoX9EvFvHLmHczeq8",
            authDomain: "fcgadingnew22.firebaseapp.com",
            projectId: "fcgadingnew22",
            storageBucket: "fcgadingnew22.firebasestorage.app",
            messagingSenderId: "537736846678",
            appId: "1:537736846678:web:53788d71a196423ac08af7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app); 
        
        const mainRef = doc(db, "antrian", "utama");
        const historyRef = collection(db, "riwayatCharging");

        // === 2. WELCOME SCREEN LOGIC (FIX: HANYA MUNCUL 1 KALI) ===
        const $ = (id) => document.getElementById(id);
        
        // Cek LocalStorage saat load: Apakah 'welcome_done' sudah ada?
        if (!localStorage.getItem('welcome_done')) {
            // Jika belum ada, munculkan layar welcome
            $('screen-welcome').classList.add('active');
        }

        window.closeWelcome = () => {
            // Simpan status ke memori HP agar tidak muncul lagi
            localStorage.setItem('welcome_done', 'true');
            
            const screen = $('screen-welcome');
            screen.style.opacity = '0';
            setTimeout(() => {
                screen.classList.remove('active');
                screen.style.opacity = '1'; 
            }, 300);
        };

        // === 3. MUSIC PLAYER DATA & LOGIC ===
        const rawMusicList = [
          { "url": "https://mlump3player.netlify.app/Ada%20Apa%20Denganmu.mp3" }, { "url": "https://mlump3player.netlify.app/anji-menunggu-kamu.mp3" }, { "url": "https://mlump3player.netlify.app/Anugerah%20Terindah%20Yang%20Pernah%20Kumiliki.mp3" }, { "url": "https://mlump3player.netlify.app/armada_asalkan_kau_bahagia.mp3" }, { "url": "https://mlump3player.netlify.app/armada_harusnya_aku.mp3" }, { "url": "https://mlump3player.netlify.app/Bendera%20-%20Cokelat%20-%202003.mp3" }, { "url": "https://mlump3player.netlify.app/Bintang%20Di%20Surga.mp3" }, { "url": "https://mlump3player.netlify.app/Bon%20Jovi%20-%20Always%20.MP3" }, { "url": "https://mlump3player.netlify.app/Bon%20Jovi%20-%20Its%20My%20Life%20.mp3" }, { "url": "https://mlump3player.netlify.app/Bon%20Jovi%20-%20Livin'%20On%20A%20Prayer%20.MP3" }, { "url": "https://mlump3player.netlify.app/Bon%20Jovi%20-%20You%20Give%20Love%20A%20Bad%20Name.mp3" }, { "url": "https://mlump3player.netlify.app/Bunda%20-%20Potret%20-%201997.mp3" }, { "url": "https://mlump3player.netlify.app/Cukup%20Siti%20Nurbaya%20-%20Dewa%2019%20-%201995.mp3" }, { "url": "https://mlump3player.netlify.app/Dan%20-%20Sheila%20On%207%20-%201999.mp3" }, { "url": "https://mlump3player.netlify.app/Janji%20-%20Gigi%20-%201995.mp3" }, { "url": "https://mlump3player.netlify.app/Mungkin%20Nanti.mp3" }, { "url": "https://mlump3player.netlify.app/PADI%20-%20Kasih%20Tak%20Sampai.mp3" }, { "url": "https://mlump3player.netlify.app/PADI%20-%20Semua%20Tak%20Sama.mp3" }, { "url": "https://mlump3player.netlify.app/Pelangi%20Di%20Matamu.mp3" }, { "url": "https://mlump3player.netlify.app/Pesawat%20Tempurku%20-%20Iwan%20Fals%20-%201987.mp3" }, { "url": "https://mlump3player.netlify.app/Slank%20-%20Terlalu%20Manis.mp3" }, { "url": "https://mlump3player.netlify.app/Sobat%20-%20Padi%20-%201999.mp3" }, { "url": "https://mlump3player.netlify.app/Stinky%20-%20Mungkinkah%20(Official%20Lyric%20Video).mp3" }, { "url": "https://mlump3player.netlify.app/Surat%20Buat%20Wakil%20Rakyat%20-%20Iwan%20Fals%20-%201981.mp3" }, { "url": "https://mlump3player.netlify.app/Terbang%20-%20Gigi%20-%201997.mp3" }, { "url": "https://mlump3player.netlify.app/Terbunuh%20Sepi%20-%20Slank%20-%201994.mp3" }, { "url": "https://mlump3player.netlify.app/Virgoun%20-%20Surat%20Cinta%20Untuk%20Starla.mp3" }
        ];

        const playlist = rawMusicList.map(item => {
            let cleanTitle = decodeURIComponent(item.url.split('/').pop());
            cleanTitle = cleanTitle.replace(/.mp3/gi, '').replace(/_/g, ' ').replace(/-/g, ' ');
            return { title: cleanTitle.toUpperCase(), url: item.url };
        });

        // Player UI Logic
        let currentTrack = 0;
        const audio = $('audioPlayer');
        const disc = document.querySelector('.cp-disc');
        const pContainer = $('cpListContainer');
        
        playlist.forEach((s, i) => {
            const div = document.createElement('div');
            div.className = `cp-item`;
            div.id = `track-${i}`;
            div.innerText = `${i+1}. ${s.title}`;
            div.onclick = () => window.playSong(i);
            pContainer.appendChild(div);
        });

        window.togglePlayerPanel = () => { $('cpPanel').classList.toggle('show'); };

        window.playSong = (idx) => {
            if (idx !== undefined) currentTrack = idx;
            document.querySelectorAll('.cp-item').forEach(el => el.classList.remove('active'));
            const activeItem = $('track-' + currentTrack);
            if(activeItem) {
                activeItem.classList.add('active');
                activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            audio.src = playlist[currentTrack].url;
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    disc.classList.add('playing');
                    $('cpTitle').innerText = playlist[currentTrack].title;
                }).catch(error => {
                    disc.classList.remove('playing');
                    $('cpTitle').innerText = "TAP TO PLAY";
                });
            }
        };

        window.nextSong = () => { currentTrack = (currentTrack + 1) % playlist.length; window.playSong(); };
        window.prevSong = () => { currentTrack = (currentTrack - 1 + playlist.length) % playlist.length; window.playSong(); };

        // === 4. MODAL UTILS ===
        function showModal(msg, type = 'alert') {
            return new Promise((resolve) => {
                const modal = $('customModal');
                const txt = $('modalMsg');
                const acts = $('modalActions');
                const input = $('modalInput');
                
                txt.innerText = msg;
                acts.innerHTML = '';
                input.style.display = 'none';
                input.value = '';

                if (type === 'confirm') {
                    acts.innerHTML = `
                        <button class="btn-modal btn-no" id="mBtnNo">TIDAK</button>
                        <button class="btn-modal btn-yes" id="mBtnYes">YA</button>
                    `;
                    $('mBtnNo').onclick = () => { modal.style.display='none'; resolve(false); };
                    $('mBtnYes').onclick = () => { modal.style.display='none'; resolve(true); };
                } else if (type === 'prompt') {
                    input.style.display = 'block';
                    input.focus();
                    acts.innerHTML = `<button class="btn-modal btn-yes" id="mBtnOk">OK</button>`;
                    $('mBtnOk').onclick = () => { modal.style.display='none'; resolve(input.value); };
                } else {
                    acts.innerHTML = `<button class="btn-modal btn-yes" id="mBtnOk">TUTUP</button>`;
                    $('mBtnOk').onclick = () => { modal.style.display='none'; resolve(true); };
                }
                modal.style.display = 'flex';
            });
        }
        const customAlert = (msg) => showModal(msg, 'alert');
        const customConfirm = (msg) => showModal(msg, 'confirm');
        const customPrompt = (msg) => showModal(msg, 'prompt');


        // === 5. CORE SYSTEM LOGIC ===
        let localSlots = [null, null, null];
        let localQueue = [];
        let myPlat = localStorage.getItem('myPlat');
        window.activeSlotIdx = -1;
        let isDashboardMinimized = false;
        let amIInQueue = false;
        let chargeTimerInterval;
        const STATION_LAT = -6.171583; const STATION_LNG = 106.899844; const MAX_DIST_KM = 0.2;

        onSnapshot(mainRef, (snap) => {
            if (!snap.exists()) { setDoc(mainRef, { chargingSlots: [null, null, null], waitingQueue: [], lastTicket: 0 }); return; }
            const d = snap.data();
            localSlots = d.chargingSlots || [null,null,null];
            localQueue = d.waitingQueue || [];
            updateUI();
        });

        function updateUI() {
            const container = $('slotsContainer');
            container.innerHTML = '';
            let amICharging = false;

            localSlots.forEach((s, i) => {
                const div = document.createElement('div');
                if (s) {
                    const isMe = (s.plat === myPlat);
                    if(isMe) { amICharging = true; window.activeSlotIdx = i; }
                    div.className = `slot-card active`;
                    div.innerHTML = `
                        <div class="sc-info">
                            <div class="sc-label">SLOT 0${i+1}</div>
                            <div class="sc-plat">${s.plat}</div>
                            <div class="sc-user">${s.userName}</div>
                        </div>
                        <div class="status-pill" style="background:var(--cyan); color:#000;">${isMe ? 'ANDA' : 'CHARGING'}</div>
                    `;
                    if(isMe) {
                        if($('ad-plat-val')) $('ad-plat-val').innerText = s.plat;
                        if($('ad-name-val')) $('ad-name-val').innerText = s.userName;
                        startChargeTimer(s.startTime || s.entryTime || Date.now());
                        if(!isDashboardMinimized) $('screen-active-dashboard').classList.add('active');
                    }
                } else {
                    div.className = `slot-card empty`;
                    let btn = '';
                    if(amIInQueue && localQueue.length>0 && localQueue[0].plat===myPlat) {
                        btn = `<button class="btn-pilih" onclick="window.selectSlot(${i})">PILIH</button>`;
                    }
                    div.innerHTML = `
                        <div class="sc-info"><div class="sc-label">SLOT 0${i+1}</div><div class="sc-plat">OPEN</div></div>
                        <div style="display:flex; align-items:center;"><div class="status-pill">AVAILABLE</div>${btn}</div>
                    `;
                }
                container.appendChild(div);
            });

            if(!amICharging) {
                window.activeSlotIdx = -1;
                $('screen-active-dashboard').classList.remove('active');
                if(chargeTimerInterval) clearInterval(chargeTimerInterval);
            }

            $('totalQDisplay').innerText = localQueue.length;
            if(localQueue.length > 0) $('nextQDisplay').innerHTML = `<span class="qbn-rank">#${localQueue[0].qNo}</span> ${localQueue[0].plat}`;
            else $('nextQDisplay').innerHTML = `<span class="qbn-rank">-</span> KOSONG`;

            amIInQueue = localQueue.some(q => q.plat === myPlat);
            const lbl = $('mainBtnLabel');
            if(window.activeSlotIdx !== -1) { lbl.innerText="DASHBOARD CHARGING"; lbl.style.color="var(--cyan)"; }
            else if(amIInQueue) { lbl.innerText="STATUS ANTRIAN ANDA"; lbl.style.color="#FFD700"; if($('waitingDashboard').classList.contains('active')) renderQueueDashboard(); }
            else { lbl.innerText="TAP UNTUK DAFTAR"; lbl.style.color="var(--cyan)"; }
        }

        window.handleMainAction = () => {
            if(audio.paused && playlist.length > 0) window.playSong();

            if(window.activeSlotIdx !== -1) { $('screen-active-dashboard').classList.add('active'); isDashboardMinimized=false; return; }
            if(amIInQueue) { openWaitingDashboard(); return; }
            if(localStorage.getItem('adm_ok')) { runLogin(); return; }
            
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => {
                    if(getDist(p.coords.latitude, p.coords.longitude, STATION_LAT, STATION_LNG) > MAX_DIST_KM) customAlert("Kejauhan (Max 200m)");
                    else runLogin();
                }, () => customAlert("GPS Error / Tidak Aktif"));
            } else customAlert("Browser tidak support GPS");
        };

        // === LOGIN FLOW ===
        let formStep=0; let formData={};
        const formConfig = [
            {l:"LANGKAH 1/2", q:"PLAT NOMOR?", k:"plat", p:"CONTOH: B 1234 XYZ"},
            {l:"LANGKAH 2/2", q:"NAMA ANDA?", k:"name", p:"NAMA LENGKAP"}
        ];

        window.runLogin = () => { formStep=0; formData={}; $('screen-login').classList.add('active'); renderStep(); };
        window.cancelLogin = () => { $('screen-login').classList.remove('active'); };

        function renderStep() {
            const c=formConfig[formStep]; $('stepLabel').innerText=c.l; $('questionText').innerText=c.q;
            $('holoInput').value=""; $('holoInput').placeholder=c.p; $('holoInput').focus();
        }

        function formatPlatNomor(raw) {
            let clean = raw.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
            const match = clean.match(/^([A-Z]{1,2})(\d{1,4})([A-Z]{1,3})$/);
            if (match) return `${match[1]} ${match[2]} ${match[3]}`; 
            else return clean.replace(/([A-Z]+)(\d+)([A-Z]*)/, '$1 $2 $3').trim();
        }

        window.nextStepAction = () => {
            let rawVal = $('holoInput').value;
            if(!rawVal) return;

            if(formConfig[formStep].k === 'plat') {
                rawVal = formatPlatNomor(rawVal);
                if(rawVal.length < 3) { customAlert("Plat nomor tidak valid!"); return; }
            } else {
                rawVal = rawVal.toUpperCase();
            }

            formData[formConfig[formStep].k] = rawVal; 
            formStep++;
            if(formStep < 2) renderStep(); else { $('screen-login').classList.remove('active'); startScan(); }
        };

        function startScan() {
            $('screen-scan').classList.add('active');
            $('scanLogoImg').style.filter="grayscale(100%) opacity(0.5)"; $('scanText').innerText="MENGHUBUNGKAN...";
            setTimeout(()=>{ $('scanLogoImg').style.filter="grayscale(0%) opacity(1)"; $('scanText').innerText="AKSES DITERIMA"; }, 1500);
            setTimeout(()=>{ executeReg(); }, 2500);
        }

        function executeReg() {
            runTransaction(db, async(t) => {
                const d = (await t.get(mainRef)).data();
                if([...d.chargingSlots, ...d.waitingQueue].find(x=>x && x.plat===formData.plat)) return "DUPLICATE";
                let n = (d.lastTicket||0)+1;
                
                d.waitingQueue.push({
                    plat: formData.plat, 
                    userName: formData.name, 
                    qNo: n, 
                    entryTime: Date.now()
                });
                
                t.update(mainRef, {waitingQueue:d.waitingQueue, lastTicket:n});
            }).then(async (r) => {
                $('screen-scan').classList.remove('active');
                if(r==="DUPLICATE") { 
                    const reLogin = await customConfirm("Plat sudah terdaftar. Login ulang?");
                    if(reLogin) { runLogin(); } 
                }
                else { 
                    localStorage.setItem('myPlat',formData.plat); 
                    myPlat=formData.plat; 
                    openWaitingDashboard(); 
                }
            });
        }

        // QUEUE DASHBOARD
        window.openWaitingDashboard = () => { $('waitingDashboard').classList.add('active'); renderQueueDashboard(); };
        function renderQueueDashboard() {
            const list=$('wdListContainer'); list.innerHTML='';
            const idx = localQueue.findIndex(q=>q.plat===myPlat);
            if(idx!==-1) { $('wdMyRank').innerText="#"+(idx+1); $('wdMyPlat').innerText=myPlat; $('wdEstTime').innerText="Est: "+((idx+1)*20)+" Menit"; }
            else { $('wdMyRank').innerText="#?"; $('wdMyPlat').innerText="--"; }
            
            localQueue.forEach((q,i)=>{
                const isMe = q.plat === myPlat;
                const div=document.createElement('div'); 
                div.className=`ql-item ${isMe?'active':''}`;
                if(isMe) div.id = 'myQItem'; 

                div.innerHTML=`
                    <div class="ql-rank-box">#${i+1}</div>
                    <div class="ql-info-box">
                        <div class="ql-plat">${q.plat}</div>
                        <div class="ql-name">${q.userName}</div>
                    </div>
                `;
                list.appendChild(div);
            });

            setTimeout(() => {
                const myItem = document.getElementById('myQItem');
                if(myItem) myItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }

        window.cancelQueue = async () => {
            const ok = await customConfirm("Batal antri?");
            if(!ok) return;
            runTransaction(db, async(t)=>{
                const d=(await t.get(mainRef)).data(); const i=d.waitingQueue.findIndex(x=>x.plat===myPlat);
                if(i!==-1){ d.waitingQueue.splice(i,1); t.update(mainRef,{waitingQueue:d.waitingQueue}); }
            }).then(()=>{ 
                localStorage.removeItem('myPlat'); 
                myPlat = null; 
                amIInQueue = false;
                $('waitingDashboard').classList.remove('active'); 
                updateUI(); 
            });
        };

        window.selectSlot = async (i) => {
            const ok = await customConfirm("Masuk Slot "+(i+1)+"?");
            if(!ok) return;
            runTransaction(db, async(t)=>{
                const d=(await t.get(mainRef)).data();
                if(d.chargingSlots[i]) throw "Penuh"; if(d.waitingQueue[0].plat!==myPlat) throw "Bukan Giliran";
                const u=d.waitingQueue.shift(); u.startTime=Date.now(); d.chargingSlots[i]=u;
                t.update(mainRef,{chargingSlots:d.chargingSlots, waitingQueue:d.waitingQueue});
            }).catch(e => customAlert(e));
        };

        window.stopCharging = async (i) => {
            const ok = await customConfirm("Stop pengisian?");
            if(!ok) return;
            runTransaction(db, async(t)=>{
                const d=(await t.get(mainRef)).data();
                const u=d.chargingSlots[i]; d.chargingSlots[i]=null;
                if(u) addDoc(historyRef, {...u, finishTime:new Date()});
                t.update(mainRef,{chargingSlots:d.chargingSlots});
            }).then(()=>{ 
                localStorage.removeItem('myPlat'); 
                myPlat = null; 
                window.activeSlotIdx = -1;
                toggleDashboard(false); 
                updateUI();
            });
        };
        
        window.toggleDashboard = (s) => { if(s) $('screen-active-dashboard').classList.add('active'); else $('screen-active-dashboard').classList.remove('active'); isDashboardMinimized=!s; };
        function startChargeTimer(s){ if(chargeTimerInterval) clearInterval(chargeTimerInterval); chargeTimerInterval=setInterval(()=>{ const d=Math.floor((Date.now()-s)/1000); $('timerVal').innerText=`${Math.floor(d/60).toString().padStart(2,'0')}:${(d%60).toString().padStart(2,'0')}`; },1000); }
        function getDist(lat1,lon1,lat2,lon2){const R=6371;const dLat=(lat2-lat1)*Math.PI/180;const dLon=(lon2-lon1)*Math.PI/180;const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));}
        
        // === FIX ADMIN REDIRECT ===
        window.toggleAdmin = async () => { 
            const code = await customPrompt("KODE ADMIN:");
            if(code === "1131"){
                localStorage.setItem('adm_ok','1'); 
                await customAlert("LOGIN SUKSES! MENGALIHKAN...");
                // FIX: PINDAH KE HALAMAN ADMIN
                window.location.href = 'admin.html';
            } else {
                await customAlert("KODE SALAH!");
            }
        };

        // === UPDATE: GANTI MOTOR (ADMIN PROTECTED) ===
        window.gantiMotor = async () => {
            const code = await customPrompt("MASUKKAN KODE ADMIN UNTUK UBAH PLAT:");
            
            if(code !== "1131") {
                await customAlert("AKSES DITOLAK! Hanya admin yang boleh ubah data.");
                return;
            }

            if (window.activeSlotIdx !== -1) {
                const confirm = await customConfirm("User ini sedang charging. Stop paksa?");
                if (!confirm) return;
                await stopCharging(window.activeSlotIdx);
                return;
            }

            if (amIInQueue) {
                const confirm = await customConfirm("User ini ada di antrian. Hapus antrian?");
                if (!confirm) return;
                await cancelQueue();
                return;
            }

            const reset = await customConfirm("Reset Login di HP ini?");
            if (reset) {
                localStorage.removeItem('myPlat');
                myPlat = null; 
                window.activeSlotIdx = -1;
                amIInQueue = false;
                toggleDashboard(false);
                $('waitingDashboard').classList.remove('active');
                $('screen-login').classList.remove('active');
                updateUI();
                await customAlert("HP berhasil di-reset. Silakan daftar ulang.");
            }
        };
    </script>
</body>
</html>
