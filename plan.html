<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAKA - PLAN TRIP</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Teko:wght@300;500;700&family=Rajdhani:wght@500;600;800&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #050505; --gold: #FFD700; --cyan: #00F0FF; --red: #FF003C; --green: #39FF14;
            --glass-bg: rgba(10, 10, 10, 0.9);
            --border: 1px solid rgba(255, 215, 0, 0.3);
        }

        body { margin: 0; padding: 0; font-family: 'Rajdhani', sans-serif; background: var(--bg); color: #ddd; padding-bottom: 90px; }
        
        /* --- HEADER --- */
        .header { text-align: center; padding: 20px; border-bottom: 1px solid #333; background: linear-gradient(180deg, #111 0%, #050505 100%); }
        .main-title { font-family: 'Black Ops One'; font-size: 28px; color: #fff; line-height: 1; letter-spacing: 1px; }
        .sub-title { font-size: 12px; color: var(--gold); letter-spacing: 3px; font-weight: bold; margin-top: 5px; }

        /* --- FORM INPUT --- */
        .container { padding: 20px; }
        
        .input-group { position: relative; margin-bottom: 15px; }
        .input-icon { position: absolute; left: 15px; top: 12px; color: var(--gold); font-size: 18px; z-index: 2; }
        
        .form-control {
            width: 100%; padding: 12px 45px 12px 45px; /* Padding kanan ditambah buat tombol GPS */
            background: #111; border: 1px solid #333; border-radius: 5px;
            color: #fff; font-family: 'Rajdhani'; font-weight: bold; font-size: 16px;
            box-sizing: border-box; transition: 0.3s;
        }
        .form-control:focus { border-color: var(--cyan); outline: none; box-shadow: 0 0 10px rgba(0, 240, 255, 0.2); }
        .form-control.gps-active { border-color: var(--green); color: var(--green); background: rgba(0, 255, 0, 0.05); }

        /* TOMBOL GPS KHUSUS */
        .gps-trigger {
            position: absolute; right: 10px; top: 8px;
            background: none; border: 1px solid var(--cyan); color: var(--cyan);
            width: 35px; height: 35px; border-radius: 5px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 18px; transition: 0.2s;
        }
        .gps-trigger:active { background: var(--cyan); color: #000; }

        .btn-add {
            width: 100%; background: transparent; border: 1px dashed #555; color: #888;
            padding: 10px; font-family: 'Teko'; font-size: 18px; cursor: pointer;
            margin-bottom: 15px; transition: 0.2s;
        }
        .btn-add:active { background: #111; color: #fff; border-color: #fff; }

        .btn-action {
            width: 100%; padding: 15px; background: var(--gold); color: #000;
            border: none; font-family: 'Black Ops One'; font-size: 20px; letter-spacing: 1px;
            clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
            cursor: pointer; text-transform: uppercase; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        .btn-action:active { transform: scale(0.98); }

        /* --- RESULT CARD --- */
        .route-card {
            background: #080808; border: 1px solid #333; margin-top: 25px;
            padding: 20px; border-radius: 10px; position: relative;
        }
        .route-card.aman { border-left: 4px solid var(--green); }
        .route-card.nekat { border-left: 4px solid var(--red); }

        .card-title { font-family: 'Black Ops One'; font-size: 18px; color: #fff; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .badge { font-family: 'Teko'; padding: 2px 8px; font-size: 14px; border-radius: 2px; color: #000; }
        .badge.aman { background: var(--green); }
        .badge.nekat { background: var(--red); color: #fff; }

        /* TIMELINE */
        .timeline { position: relative; padding-left: 20px; border-left: 2px dashed #333; margin-left: 10px; }
        .t-item { position: relative; margin-bottom: 25px; }
        .t-dot { 
            position: absolute; left: -26px; top: 0; width: 10px; height: 10px; 
            background: #000; border: 2px solid var(--gold); border-radius: 50%;
            box-shadow: 0 0 10px var(--gold);
        }
        .t-info { background: #111; padding: 10px; border: 1px solid #333; border-radius: 5px; }
        .t-name { font-family: 'Teko'; font-size: 18px; color: var(--cyan); line-height: 1; }
        .t-meta { font-size: 12px; color: #888; display: flex; justify-content: space-between; margin-top: 5px; }
        .t-bat { font-weight: bold; }
        
        .bat-ok { color: var(--green); }
        .bat-low { color: var(--red); animation: blink 1s infinite; }

        /* MAP */
        #map { height: 300px; width: 100%; background: #000; border: 1px solid #333; margin-top: 20px; }
        .leaflet-layer { filter: brightness(0.7) contrast(1.1) grayscale(20%); } /* Dark Map Filter */

        /* LOADING */
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999;
            display: none; align-items: center; justify-content: center; flex-direction: column;
        }
        .scanner-line { width: 100%; height: 2px; background: var(--cyan); box-shadow: 0 0 10px var(--cyan); animation: scan 1s infinite alternate; width: 200px; }
        .loading-text { font-family: 'Orbitron'; color: var(--cyan); margin-top: 20px; letter-spacing: 2px; font-size: 14px; animation: blink 0.5s infinite; }

        /* DOCK NAV */
        .dock-container { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; 
            background: #000; border-top: 1px solid #333; 
            display: grid; grid-template-columns: 1fr 1fr 1fr; 
            align-items: center; z-index: 1001; 
        }
        .nav-item { 
            text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #444; transition: 0.3s; height: 100%; position: relative;
        }
        .nav-item.active { color: var(--gold); }
        .nav-item.active .nav-icon { text-shadow: 0 0 15px var(--gold); transform: translateY(-2px); }
        .nav-item.active::after {
            content: ''; position: absolute; bottom: 0; width: 40px; height: 3px; 
            background: var(--gold); box-shadow: 0 0 10px var(--gold);
        }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }
        .nav-text { font-family: 'Teko'; font-size: 16px; letter-spacing: 1px; font-weight: bold; }

        @keyframes blink { 0%,100% {opacity:1} 50% {opacity:0.3} }
        @keyframes scan { from{width:10px} to{width:200px} }

    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="scanner-line"></div>
        <div class="loading-text">CALCULATING ROUTE...</div>
    </div>

    <div class="header">
        <div class="main-title">TACTICAL PLANNER</div>
        <div class="sub-title">MAKA LINTAS UTARA INTELLIGENCE</div>
    </div>

    <div class="container">
        <div id="db-status" style="text-align:center; font-size:10px; color:#555; margin-bottom:10px; font-family:'Orbitron';">INITIALIZING SATELLITE...</div>

        <div id="waypoints">
            <div class="input-group">
                <div class="input-icon">Start</div>
                <input type="text" id="start-input" class="form-control loc-input" placeholder="LOKASI AWAL (Atau Tap GPS ‚û°)">
                <div class="gps-trigger" onclick="useCurrentLocation()">üéØ</div>
            </div>

            <div class="input-group">
                <div class="input-icon">End</div>
                <input type="text" class="form-control loc-input" placeholder="TUJUAN AKHIR (Contoh: Bandung)">
            </div>
        </div>
        
        <button class="btn-add" onclick="addStop()">+ TAMBAH PERSINGGAHAN</button>

        <div class="input-group">
            <div class="input-icon">‚ö°</div>
            <input type="number" id="battery" class="form-control" value="100" placeholder="BATERAI AWAL (%)" style="color:var(--gold);">
        </div>

        <button class="btn-action" onclick="calculateRoute()">ANALISA RUTE</button>

        <div id="result-area"></div>
        <div id="map" style="display:none;"></div>
    </div>

    <div class="dock-container">
        <a href="lokasi_fc.html" class="nav-item">
            <div class="nav-icon">üó∫Ô∏è</div><span class="nav-text">PETA FC</span>
        </a>
        <a href="system.html" class="nav-item">
            <div class="nav-icon">üè†</div><span class="nav-text">SYSTEM</span>
        </a>
        <a href="plan_trip.html" class="nav-item active">
            <div class="nav-icon">üö©</div><span class="nav-text">PLAN TRIP</span>
        </a>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        // INIT MAP
        const map = L.map('map').setView([-6.2, 106.8], 10);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 }).addTo(map);
        
        let fcLocations = [];
        let mapLayers = L.layerGroup().addTo(map);
        const SHEET_ID = '1EJOTMMfGpBMFPqR0LzbMbh7tZUcTCZld4x387OO9aJM'; 
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Sheet1`;

        // GLOBAL VARS UNTUK GPS
        let gpsStartCoords = null; 

        // LOAD DATABASE
        window.onload = function() {
            Papa.parse(CSV_URL, {
                download: true, header: true,
                complete: function(res) {
                    res.data.forEach(row => {
                        let lat = null, lng = null, name = "FC Station";
                        Object.values(row).forEach(val => {
                            if(val) {
                                let num = parseFloat(val.toString().replace(',','.'));
                                if(!isNaN(num)) {
                                    if(num < -5 && num > -11) lat = num;
                                    if(num > 95 && num < 141) lng = num;
                                }
                            }
                        });
                        if(row['Nama']) name = row['Nama']; else if(row['Lokasi']) name = row['Lokasi'];
                        if(lat && lng) fcLocations.push({ name, lat, lng });
                    });
                    document.getElementById('db-status').innerHTML = '‚úÖ DATABASE CONNECTED - ' + fcLocations.length + ' POINTS';
                    document.getElementById('db-status').style.color = 'var(--green)';
                }
            });
        };

        // --- FITUR GPS ---
        function useCurrentLocation() {
            const input = document.getElementById('start-input');
            if(!navigator.geolocation) return alert("Browser tidak support GPS");
            
            input.value = "MENCARI LOKASI...";
            input.classList.remove('gps-active');

            navigator.geolocation.getCurrentPosition((pos) => {
                const { latitude, longitude } = pos.coords;
                gpsStartCoords = { lat: latitude, lon: longitude, name: "LOKASI SAYA (GPS)" };
                
                input.value = "[ GPS LOKASI SAYA TERKUNCI ]";
                input.classList.add('gps-active'); // Efek Hijau
            }, (err) => {
                alert("Gagal mengambil lokasi GPS. Pastikan GPS nyala.");
                input.value = "";
            }, { enableHighAccuracy: true });
        }

        function addStop() {
            const div = document.createElement('div');
            div.className = 'input-group';
            div.innerHTML = `<div class="input-icon" style="font-size:12px; top:15px;">STOP</div><input type="text" class="form-control loc-input" placeholder="NAMA KOTA/LOKASI"><div style="position:absolute; right:10px; top:10px; color:red; cursor:pointer;" onclick="this.parentElement.remove()">x</div>`;
            document.getElementById('waypoints').insertBefore(div, document.getElementById('waypoints').lastElementChild);
        }

        async function calculateRoute() {
            const inputs = document.querySelectorAll('.loc-input');
            const batStart = parseInt(document.getElementById('battery').value);
            const resArea = document.getElementById('result-area');
            const loading = document.getElementById('loading-overlay');
            const mapDiv = document.getElementById('map');
            
            let inputTexts = [];
            inputs.forEach(i => { if(i.value.trim()) inputTexts.push(i.value.trim()); });
            
            if(inputTexts.length < 2) return alert("MASUKKAN LOKASI AWAL & TUJUAN!");

            loading.style.display = 'flex';
            mapLayers.clearLayers();
            resArea.innerHTML = '';
            mapDiv.style.display = 'none';

            try {
                // 1. GEOCODE INPUTS (CEK APAKAH PAKAI GPS?)
                let points = [];
                for(let i=0; i<inputTexts.length; i++) {
                    const txt = inputTexts[i];
                    
                    // Logic Khusus Start Point: Jika pakai GPS, pakai koordinat langsung
                    if(i === 0 && gpsStartCoords && txt === "[ GPS LOKASI SAYA TERKUNCI ]") {
                        points.push(gpsStartCoords);
                    } else {
                        // Kalau manual ketik, cari di nominatim
                        const c = await getGeo(txt);
                        if(!c) throw new Error(`LOKASI TIDAK DITEMUKAN: ${txt}`);
                        points.push(c);
                    }
                }

                // 2. HITUNG JARAK OSRM (Rute Langsung)
                const directRoute = await getOSRM(points);
                const totalDistKm = directRoute.distance / 1000;
                
                // Logic Baterai Sederhana (1% = 1KM)
                const needed = Math.ceil(totalDistKm);
                const finalBat = batStart - needed;

                // 3. LOGIC KEPUTUSAN
                if (finalBat >= 10) {
                    renderResult('aman', 'RUTE LANGSUNG (AMAN)', points, batStart, null);
                    drawMap(points, '#39FF14');
                } else {
                    const bestCharger = await findBestCharger(points[0], points[points.length-1], batStart);
                    
                    if (bestCharger) {
                        renderResult('aman', 'RUTE VIA CHARGER', points, batStart, bestCharger);
                        drawComplexRoute(points[0], bestCharger, points[points.length-1]);
                    } else {
                        renderResult('nekat', 'PERINGATAN: TIDAK ADA CHARGER TERJANGKAU', points, batStart, null);
                        drawMap(points, '#FF003C');
                    }
                }
                
                mapDiv.style.display = 'block';
                setTimeout(() => map.invalidateSize(), 500);

            } catch (e) {
                alert(e.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        async function findBestCharger(start, end, currentBat) {
            let candidates = [];
            for (let fc of fcLocations) {
                const distFromStart = getCrowDist(start.lat, start.lon, fc.lat, fc.lng);
                if (distFromStart <= (currentBat - 5)) {
                    candidates.push({ ...fc, distFromStart });
                }
            }
            if (candidates.length === 0) return null; 

            candidates.sort((a,b) => {
                const distA = getCrowDist(a.lat, a.lng, end.lat, end.lon);
                const distB = getCrowDist(b.lat, b.lng, end.lat, end.lon);
                return distA - distB;
            });

            let bestFC = null;
            let minTotalDist = 999999;
            const checkLimit = Math.min(candidates.length, 3);
            
            for(let i=0; i<checkLimit; i++) {
                const fc = candidates[i];
                const route = await getOSRM([start, {lat: fc.lat, lon: fc.lng}, end]);
                const totalDist = route.distance / 1000;
                if (totalDist < minTotalDist) {
                    minTotalDist = totalDist;
                    bestFC = fc;
                }
            }
            return bestFC;
        }

        async function renderResult(type, title, points, startBat, charger) {
            const area = document.getElementById('result-area');
            let html = `<div class="route-card ${type}">
                <div class="card-title">
                    <span>${title}</span>
                    <span class="badge ${type}">${type === 'aman' ? 'RECOMMENDED' : 'WARNING'}</span>
                </div>
                <div class="timeline">`;

            let stops = [];
            if (charger) {
                stops = [points[0], {name: charger.name + " (CHARGING)", lat: charger.lat, lon: charger.lng, isCharge: true}, points[points.length-1]];
            } else {
                stops = points;
            }

            let currentBat = startBat;

            for (let i = 0; i < stops.length; i++) {
                const pt = stops[i];
                let distInfo = "";
                let batClass = "bat-ok";

                if (i > 0) {
                    const prev = stops[i-1];
                    const leg = await getOSRM([prev, pt]);
                    const dist = leg.distance / 1000;
                    const used = Math.ceil(dist);
                    currentBat -= used;
                    distInfo = `<span style="color:var(--gold)">‚¨á ${dist.toFixed(1)} KM (-${used}%)</span>`;
                }

                if (pt.isCharge) {
                    currentBat = 100; 
                    distInfo += ` <span style="color:var(--cyan); font-weight:bold;">[ ISI PENUH ]</span>`;
                }

                if (currentBat < 20) batClass = "bat-low";

                html += `
                <div class="t-item">
                    <div class="t-dot"></div>
                    <div class="t-info">
                        <div class="t-name">${pt.name.split(',')[0]}</div>
                        <div class="t-meta">
                            <span>${distInfo}</span>
                            <span class="t-bat ${batClass}">${currentBat}%</span>
                        </div>
                    </div>
                </div>`;
            }

            let gmapsLink = `https://www.google.com/maps/dir/`;
            stops.forEach(s => gmapsLink += `${s.lat},${s.lon}/`);

            html += `</div>
                <a href="${gmapsLink}" target="_blank" class="btn-action" style="margin-top:20px; text-decoration:none; display:block; text-align:center; font-size:16px;">BUKA GOOGLE MAPS</a>
            </div>`;

            area.innerHTML = html;
        }

        async function drawMap(points, color) {
            const r = await getOSRM(points);
            const coords = decodePolyline(r.geometry);
            L.polyline(coords, {color: color, weight: 5}).addTo(mapLayers);
            points.forEach((p, i) => {
                const iconColor = i === 0 ? 'green' : (i === points.length-1 ? 'red' : 'gold');
                L.circleMarker([p.lat, p.lon], {radius: 8, color: iconColor, fillColor: iconColor, fillOpacity: 1}).addTo(mapLayers).bindPopup(p.name);
            });
            map.fitBounds(L.polyline(coords).getBounds(), {padding:[50,50]});
        }

        async function drawComplexRoute(start, mid, end) {
            drawMap([start, {lat:mid.lat, lon:mid.lng, name:mid.name}, end], '#00F0FF');
        }

        async function getGeo(q) {
            try {
                const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`);
                const d = await r.json();
                if(d[0]) return { lat: parseFloat(d[0].lat), lon: parseFloat(d[0].lon), name: d[0].display_name };
            } catch(e) {}
            return null;
        }

        async function getOSRM(pts) {
            const s = pts.map(p => `${p.lon},${p.lat}`).join(';');
            const r = await fetch(`https://router.project-osrm.org/route/v1/driving/${s}?overview=full`);
            const d = await r.json();
            return d.routes[0];
        }

        function getCrowDist(lat1, lon1, lat2, lon2) {
            const R = 6371; const p = Math.PI/180;
            const a = 0.5 - Math.cos((lat2-lat1)*p)/2 + Math.cos(lat1*p)*Math.cos(lat2*p)*(1-Math.cos((lon2-lon1)*p))/2;
            return 2 * R * Math.asin(Math.sqrt(a));
        }

        function decodePolyline(str) {
            let index=0,lat=0,lng=0,coordinates=[],shift=0,result=0,byte=null,latitude_change,longitude_change,factor=1e5;
            while(index<str.length){
                byte=null;shift=0;result=0;
                do{byte=str.charCodeAt(index++)-63;result|=(byte&0x1f)<<shift;shift+=5;}while(byte>=0x20);
                latitude_change=((result&1)?~(result>>1):(result>>1)); shift=result=0;
                do{byte=str.charCodeAt(index++)-63;result|=(byte&0x1f)<<shift;shift+=5;}while(byte>=0x20);
                longitude_change=((result&1)?~(result>>1):(result>>1));
                lat+=latitude_change;lng+=longitude_change;
                coordinates.push([lat/factor,lng/factor]);
            }
            return coordinates;
        }
    </script>
</body>
</html>
