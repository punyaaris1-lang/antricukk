<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLU Ultimate Planner</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #06b6d4; --primary-dark: #0891b2; --primary-light: #cffafe;
            --accent: #3b82f6; --danger: #ef4444; --warning: #f59e0b;
            --text-dark: #0f172a; --bg-body: #f8fafc;
            --shadow-card: 0 10px 25px -5px rgba(6, 182, 212, 0.15), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        body { font-family: 'Manrope', sans-serif; margin: 0; background: var(--bg-body); color: var(--text-dark); }
        .app-container { max-width: 600px; margin: 0 auto; background: #ffffff; min-height: 100vh; padding-bottom: 40px; }
        
        /* HEADER */
        .header { 
            background: linear-gradient(135deg, #0f172a, #1e293b); color: white; 
            padding: 25px 20px; border-bottom: 4px solid var(--primary);
            text-align: center; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .header h2 { margin: 0; font-size: clamp(1.1rem, 5vw, 1.5rem); font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase; white-space: nowrap; }
        .header p { margin: 5px 0 0; font-size: 0.85em; opacity: 0.8; font-weight: 400; }

        .content { padding: 20px; margin-top: -15px; }

        /* INPUTS */
        .input-group { position: relative; margin-bottom: 12px; }
        .input-icon { position: absolute; left: 15px; top: 14px; width: 20px; text-align: center; z-index: 2; }
        .form-control { width: 100%; padding: 14px 14px 14px 45px; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 15px; background: #f8fafc; font-family: inherit; box-sizing: border-box; transition: 0.3s; }
        .form-control:focus { border-color: var(--primary); background: #fff; outline: none; box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1); }
        
        .btn-add { background: var(--primary-light); color: var(--primary-dark); width: 100%; padding: 12px; border: 1px dashed var(--primary); border-radius: 12px; cursor: pointer; font-weight: 700; margin-bottom: 20px; font-size: 0.9em; transition: 0.3s; }
        .btn-action { 
            width: 100%; padding: 16px; background: linear-gradient(to right, var(--primary), var(--accent)); 
            color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 800; cursor: pointer; 
            margin-top: 15px; box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4); text-transform: uppercase; letter-spacing: 1px; transition: 0.2s;
        }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(6, 182, 212, 0.5); }

        /* RESULT CARD */
        .route-card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid #e2e8f0; box-shadow: var(--shadow-card); position: relative; overflow: hidden; }
        .route-card.aman { border-left: 6px solid #10b981; } 
        .route-card.nekat { border-left: 6px solid #f97316; } 
        .route-card.darurat { border-left: 6px solid #ef4444; background: #fff5f5; }

        .card-header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f1f5f9; }
        .badge-type { padding: 6px 12px; border-radius: 8px; font-size: 0.75em; font-weight: 800; color: white; text-transform: uppercase; }
        
        .btn-swap { background: #f1f5f9; color: #475569; border: none; font-size: 0.75em; padding: 8px 12px; border-radius: 20px; cursor: pointer; font-weight: 700; display: flex; align-items: center; gap: 5px; }

        /* TIMELINE */
        .timeline { position: relative; padding-left: 30px; margin-top: 10px; }
        .timeline::before { content: ''; position: absolute; left: 7px; top: 5px; bottom: 5px; width: 2px; background: #e2e8f0; }
        .t-item { position: relative; margin-bottom: 25px; }
        .t-dot { position: absolute; left: -30px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: white; border: 3px solid #cbd5e1; z-index: 2; box-shadow: 0 0 0 3px white; }
        .dist-label { position: absolute; left: -68px; top: 25px; width: 60px; text-align: right; font-size: 0.7em; color: #64748b; font-weight: 600; background: #fff; padding-right: 5px; }
        .t-title { font-weight: 700; font-size: 0.95em; color: #1e293b; }
        .t-desc { font-size: 0.85em; color: #64748b; margin-top: 2px; }

        /* KONFIRMASI ALAMAT - HIGHLIGHTED */
        .addr-box {
            margin-top: 5px; font-size: 0.75em; color: #0e7490; background: #ecfeff;
            padding: 6px 10px; border-radius: 6px; border-left: 3px solid var(--primary);
            font-style: italic; line-height: 1.4; display: block;
        }

        .info-dest { margin-top: 20px; padding: 15px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 0.85em; color: #475569; display: flex; align-items: center; gap: 12px; }

        #map { height: 350px; width: 100%; border-radius: 16px; margin-top: 25px; border: 2px solid #e2e8f0; }
        .gmaps-btn { display: block; text-align: center; background: #fff; border: 2px solid #e2e8f0; color: var(--text-dark); padding: 14px; border-radius: 12px; margin-top: 15px; text-decoration: none; font-weight: 800; font-size: 0.9em; transition: 0.2s; }
        
        .remove-btn { color: #ef4444; background: none; border: none; font-size: 1.2em; padding: 0 15px; cursor: pointer; }

        /* LOADING LASER */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .scan-container { position: relative; width: 180px; height: 180px; }
        .img-bw { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; filter: grayscale(100%) contrast(1.2) brightness(0.8); opacity: 0.5; }
        .scan-mask { position: absolute; top: 0; left: 0; width: 100%; height: 0%; overflow: hidden; border-bottom: 3px solid #00f2ff; box-shadow: 0 5px 20px rgba(0, 242, 255, 0.8); animation: laserScan 2.5s infinite ease-in-out alternate; background: transparent; }
        .img-color { width: 180px; height: 180px; object-fit: contain; }
        @keyframes laserScan { 0% { height: 0%; } 100% { height: 100%; } }
        .loading-text { margin-top: 30px; color: #00f2ff; font-family: 'Manrope', sans-serif; font-weight: 700; letter-spacing: 2px; font-size: 1em; text-transform: uppercase; animation: blinkText 1s infinite; }
        @keyframes blinkText { 50% { opacity: 0.5; } }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.7); z-index: 9999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: white; width: 90%; max-width: 400px; max-height: 80vh; border-radius: 20px; padding: 25px; overflow-y: auto; }
        .alt-item { padding: 15px; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
    </style>
</head>
<body>

<div id="loading-overlay" class="loading-overlay">
    <div class="scan-container">
        <img src="1763947427555.jpg" class="img-bw" onerror="this.style.display='none'">
        <div class="scan-mask">
            <img src="1763947427555.jpg" class="img-color" onerror="this.src='https://via.placeholder.com/150/000000/FFFFFF?text=MLU'">
        </div>
    </div>
    <div class="loading-text">SYSTEM SCANNING...</div>
</div>

<div class="app-container">
    <div class="header">
        <h2>PLAN YOUR TRIP WITH MLU SYSTEM</h2>
        <p>made with <i class="fas fa-heart" style="color:var(--primary)"></i> for MLU member</p>
    </div>

    <div class="content">
        <div id="db-status" style="text-align:center; font-size:0.8em; margin-bottom:15px; color:#64748b; font-weight:600;">‚è≥ Connecting Database...</div>

        <div id="waypoints">
            <div class="input-group">
                <div class="input-icon"><i class="fas fa-circle" style="color:var(--primary)"></i></div>
                <input type="text" class="form-control loc-input" placeholder="Titik Awal (Start)">
            </div>
            <div class="input-group">
                <div class="input-icon"><i class="fas fa-map-marker-alt" style="color:#ef4444"></i></div>
                <input type="text" class="form-control loc-input" placeholder="Tujuan Akhir (Finish)">
            </div>
        </div>
        
        <button class="btn-add" onclick="addStop()"><i class="fas fa-plus"></i> Tambah Titik Singgah</button>

        <div class="input-group">
            <div class="input-icon"><i class="fas fa-bolt" style="color:#f59e0b"></i></div>
            <input type="number" id="battery" class="form-control" value="20" placeholder="Baterai Awal (%)" style="font-weight: 700;">
        </div>

        <button class="btn-action" onclick="calculateRoute()">ANALISA RUTE DETAIL</button>

        <div id="result-area" style="margin-top:30px;"></div>
        <div id="map"></div>
    </div>
</div>

<div id="modal-overlay" class="modal-overlay">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-weight:800; font-size:1.1em;">
            <span>Pilih Charger Lain</span>
            <span onclick="closeModal()" style="cursor:pointer; color:#94a3b8;">‚úï</span>
        </div>
        <div id="modal-list"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script>
    const map = L.map('map').setView([-6.2, 106.8], 10);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '¬© CARTO' }).addTo(map);
    
    let fcLocations = [];
    let mapLayers = L.layerGroup().addTo(map);
    let currentData = { points: [], bat: 0, safeList: [], nekatList: [], nearDest: null };

    const SHEET_ID = '1EJOTMMfGpBMFPqR0LzbMbh7tZUcTCZld4x387OO9aJM';
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Sheet1`;

    window.onload = function() {
        Papa.parse(CSV_URL, {
            download: true, header: true,
            complete: function(res) {
                res.data.forEach(row => {
                    const lat = parseFloat((row['lat']||'').replace(',', '.'));
                    const lng = parseFloat((row['lng']||'').replace(',', '.'));
                    if(!isNaN(lat)) fcLocations.push({
                        name: row['Nama'] || Object.values(row)[0],
                        lat: lat, lng: lng,
                        biaya: row['biaya'] || 'Berbayar'
                    });
                });
                document.getElementById('db-status').innerHTML = '‚úÖ Database Siap';
            }
        });
    };

    function addStop() {
        const div = document.createElement('div');
        div.className = 'input-group';
        div.innerHTML = `<div class="input-icon"><i class="fas fa-stop-circle" style="color:#94a3b8"></i></div><input type="text" class="form-control loc-input" placeholder="Singgah"><button class="remove-btn" onclick="this.parentElement.remove()">√ó</button>`;
        document.getElementById('waypoints').insertBefore(div, document.getElementById('waypoints').lastElementChild);
    }

    async function calculateRoute() {
        const inputs = document.querySelectorAll('.loc-input');
        const batStart = parseInt(document.getElementById('battery').value);
        const resArea = document.getElementById('result-area');
        const loading = document.getElementById('loading-overlay');
        
        let inputTexts = [];
        inputs.forEach(i => { if(i.value.trim()) inputTexts.push(i.value.trim()); });
        if(inputTexts.length < 2) return alert("Minimal 2 lokasi!");

        loading.style.display = 'flex';
        mapLayers.clearLayers();
        resArea.innerHTML = '';

        try {
            await new Promise(r => setTimeout(r, 3000));

            let points = [];
            for(let txt of inputTexts) {
                const c = await getGeo(txt);
                if(!c) throw new Error(`‚ùå Lokasi "${txt}" tidak ditemukan.`);
                points.push(c);
            }

            const directRoute = await getOSRM(points);
            const totalDist = directRoute.distance / 1000;
            const batNeeded = Math.ceil(totalDist);
            const sisaAkhir = batStart - batNeeded;
            const nearDest = await findNearestFC(points[points.length-1]);

            currentData = { points, bat: batStart, nearDest, safeList: [], nekatList: [] };

            if (sisaAkhir >= 20) {
                const itinerary = await buildItinerary(points, batStart, null); 
                resArea.innerHTML = renderCard('aman', '‚úÖ RUTE LANGSUNG AMAN', itinerary, nearDest, false);
                drawRoute(points, '#10b981');
            } 
            else {
                // FIND CHARGERS (FORCE FIND ENABLED)
                const opts = await findChargerOptions(points, batStart);
                currentData.safeList = opts.safeList;
                currentData.nekatList = opts.nekatList;

                // OPSI 1: SAFE
                if(opts.safeList.length > 0) {
                    const itinSafe = await buildItinerary(points, batStart, opts.safeList[0]);
                    resArea.innerHTML += `<div id="card-aman-cont">${renderCard('aman', 'üõ°Ô∏è OPSI 1: RUTIN AMAN', itinSafe, nearDest, true)}</div>`;
                    drawComplexRoute(points, opts.safeList[0], '#10b981');
                }

                // OPSI 2: NEKAT / DARURAT
                if(opts.nekatList.length > 0) {
                    let idx = 0;
                    // Hindari duplikat jika opsi safe = nekat
                    if(opts.safeList.length > 0 && opts.nekatList[0].name === opts.safeList[0].name && opts.nekatList.length > 1) idx = 1;
                    
                    // Cek apakah ini mode darurat (force find)
                    const isEmergency = opts.nekatList[idx].distFromStart > batStart;
                    const cardType = isEmergency ? 'darurat' : 'nekat';
                    const title = isEmergency ? '‚ö†Ô∏è OPSI DARURAT (FORCE FIND)' : 'üöÄ OPSI 2: LEBIH CEPAT';

                    const itinNekat = await buildItinerary(points, batStart, opts.nekatList[idx]);
                    resArea.innerHTML += `<div id="card-nekat-cont">${renderCard(cardType, title, itinNekat, nearDest, true)}</div>`;
                    
                    if(isEmergency && opts.safeList.length === 0) {
                        drawComplexRoute(points, opts.nekatList[idx], '#ef4444');
                    }
                }
            }

        } catch (e) {
            alert(e.message);
        } finally {
            loading.style.display = 'none';
        }
    }

    // --- FORCE FIND LOGIC ---
    async function findChargerOptions(points, batStart) {
        const start = points[0]; const end = points[points.length-1];
        let safeList = [];
        let nekatList = [];
        let absoluteList = []; // Untuk force find

        fcLocations.forEach(fc => {
            const d = getCrowDist(start.lat, start.lon, fc.lat, fc.lng);
            const dEnd = getCrowDist(fc.lat, fc.lng, end.lat, end.lon);
            const direct = getCrowDist(start.lat, start.lon, end.lat, end.lon);
            const detour = (d + dEnd) - direct;
            const data = { ...fc, distFromStart: d, detour: detour };

            if(d <= (batStart - 5)) safeList.push(data);
            if(d <= batStart) nekatList.push(data);
            
            absoluteList.push(data); // Masukkan semua ke absolute
        });

        // Sorting
        safeList.sort((a,b) => a.distFromStart - b.distFromStart);
        nekatList.sort((a,b) => a.detour - b.detour);
        absoluteList.sort((a,b) => a.distFromStart - b.distFromStart); // Terdekat mutlak

        // FORCE FIND: Jika Safe & Nekat kosong, isi Nekat dengan Absolute Nearest
        if(safeList.length === 0 && nekatList.length === 0) {
            nekatList = absoluteList.slice(0, 3); // Ambil 3 terdekat fisik
        }

        return { safeList, nekatList };
    }

    async function buildItinerary(originalPoints, startBat, charger) {
        let path = [];
        if (charger) {
            const chargerPoint = { lat: charger.lat, lon: charger.lng, name: charger.name, isCharger: true };
            path = [originalPoints[0], chargerPoint, ...originalPoints.slice(1)];
        } else {
            path = [...originalPoints];
        }

        let timelineData = [];
        let currentBat = startBat;
        
        for (let i = 0; i < path.length; i++) {
            let distToNext = 0;
            if (i < path.length - 1) {
                const leg = await getOSRM([path[i], path[i+1]]);
                distToNext = leg.distance / 1000;
            }

            let pointData = {
                name: path[i].name.split(',')[0],
                fullName: path[i].name, // ADDRESS CONFIRMATION
                isCharger: path[i].isCharger,
                currentBat: currentBat,
                distToNext: distToNext
            };

            if (path[i].isCharger) {
                currentBat = 100; 
            }
            if (i < path.length - 1) {
                currentBat = Math.floor(currentBat - Math.ceil(distToNext));
            }
            timelineData.push(pointData);
        }
        return { path, timelineData };
    }

    function renderCard(type, title, itineraryData, nearDest, showSwap) {
        let color = '#10b981';
        if(type === 'nekat') color = '#f97316';
        if(type === 'darurat') color = '#ef4444';

        const swapHtml = showSwap ? `<button class="btn-swap" onclick="openModal('${type}')"><i class="fas fa-sync"></i> Ganti Charger</button>` : '';
        
        let html = `
        <div class="route-card ${type}">
            <div class="card-header-flex">
                <div class="badge-type" style="background:${color}">${title}</div>
                ${swapHtml}
            </div>
            <div class="timeline">`;

        itineraryData.timelineData.forEach((pt, index) => {
            const isLast = index === itineraryData.timelineData.length - 1;
            let dotColor = '#cbd5e1'; 
            if(index === 0) dotColor = '#06b6d4'; 
            if(pt.isCharger) dotColor = color; 
            if(isLast) dotColor = '#10b981'; 

            let distHtml = !isLast ? `<div class="dist-label">‚¨á ${pt.distToNext.toFixed(1)} km</div>` : '';
            
            let batColor = '#10b981';
            if(pt.currentBat < 0) batColor = '#ef4444'; // Minus
            else if(pt.currentBat < 20) batColor = '#ef4444';
            else if(pt.currentBat < 40) batColor = '#f59e0b';

            // CONFIRMATION ADDRESS BOX
            let addrHtml = pt.isCharger ? '' : `<span class="addr-box">üìç ${pt.fullName}</span>`;

            let content = `
                <div class="t-title">${pt.name} ${pt.isCharger ? '‚ö°' : ''}</div>
                ${addrHtml}
                <div class="t-desc">${pt.isCharger ? '<b style="color:'+color+'">ISI DAYA (100%)</b>' : 'Sisa Baterai: <b style="color:'+batColor+'">'+pt.currentBat+'%</b>'}</div>
            `;

            html += `
            <div class="t-item">
                <div class="t-dot" style="border-color:${dotColor}"></div>
                ${distHtml}
                <div class="t-content">${content}</div>
            </div>`;
        });

        let link = `https://www.google.com/maps/dir/`;
        itineraryData.path.forEach(p => link += `${p.lat},${p.lon}/`);

        html += `</div>
            <div class="info-dest">
                <i class="fas fa-charging-station fa-lg"></i>
                <div><b>FC Terdekat Tujuan:</b> ${nearDest.name} (${nearDest.dist.toFixed(1)} km)</div>
            </div>
            <a href="${link}" target="_blank" class="gmaps-btn" style="border-color:${color}; color:${color}">üó∫Ô∏è BUKA GOOGLE MAPS</a>
        </div>`;

        return html;
    }

    async function drawComplexRoute(origPoints, charger, color) {
        const stopCoord = {lat: charger.lat, lon: charger.lng};
        const path = [origPoints[0], stopCoord, ...origPoints.slice(1)];
        const r = await getOSRM(path);
        const l = decodePolyline(r.geometry);
        L.polyline(l, {color: color, weight: 6}).addTo(mapLayers);
        
        path.forEach((p, idx) => {
            L.circleMarker([p.lat, p.lon], {radius: 6, color: idx===1?'orange':'blue'}).addTo(mapLayers);
        });
        L.marker([charger.lat, charger.lng]).addTo(mapLayers).bindPopup(charger.name).openPopup();
        map.fitBounds(L.latLngBounds(l), {padding:[40,40]});
    }

    function openModal(type) {
        const list = type === 'aman' ? currentData.safeList : currentData.nekatList;
        const div = document.getElementById('modal-list');
        div.innerHTML = '';
        list.forEach(opt => {
            div.innerHTML += `<div class="alt-item" onclick="selectAlt('${type}', '${opt.name}')">
                <div style="font-weight:700; color:#0e7490">${opt.name}</div>
                <div style="font-size:0.85em; color:#64748b">Jarak: ${opt.distFromStart.toFixed(1)} km | Detour: ${opt.detour.toFixed(1)} km</div>
            </div>`;
        });
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    
    async function selectAlt(type, name) {
        closeModal();
        const list = type === 'aman' ? currentData.safeList : currentData.nekatList;
        const selected = list.find(x => x.name === name);
        const container = type === 'aman' ? 'card-aman-cont' : 'card-nekat-cont';
        
        // Cek darurat
        const isEmergency = selected.distFromStart > currentData.bat;
        const cardType = isEmergency ? 'darurat' : (type === 'aman' ? 'aman' : 'nekat');
        const title = isEmergency ? '‚ö†Ô∏è OPSI DARURAT' : (type === 'aman' ? 'üõ°Ô∏è OPSI 1: RUTIN AMAN' : 'üöÄ OPSI 2: LEBIH CEPAT');

        document.getElementById(container).style.opacity = '0.5';
        const itin = await buildItinerary(currentData.points, currentData.bat, selected);
        document.getElementById(container).innerHTML = renderCard(cardType, title, itin, currentData.nearDest, true);
        document.getElementById(container).style.opacity = '1';
        
        mapLayers.clearLayers();
        drawComplexRoute(currentData.points, selected, isEmergency ? '#ef4444' : (type==='aman'?'#10b981':'#f97316'));
    }

    async function getGeo(q) {
        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q+" Indonesia")}&limit=1&addressdetails=1`);
        const d = await r.json();
        if(d[0]) return { lat: parseFloat(d[0].lat), lon: parseFloat(d[0].lon), name: d[0].display_name };
        return null;
    }
    async function getOSRM(pts) {
        const s = pts.map(p => `${p.lon},${p.lat}`).join(';');
        const r = await fetch(`https://router.project-osrm.org/route/v1/driving/${s}?overview=full`);
        const d = await r.json();
        return d.routes[0];
    }
    async function findNearestFC(coord) {
        let sorted = fcLocations.map(fc => {
            return {...fc, dist: getCrowDist(coord.lat, coord.lon, fc.lat, fc.lng)};
        }).sort((a,b) => a.dist - b.dist);
        return sorted[0];
    }
    function getCrowDist(lat1, lon1, lat2, lon2) {
        const R = 6371; const p = Math.PI/180;
        const a = 0.5 - Math.cos((lat2-lat1)*p)/2 + Math.cos(lat1*p)*Math.cos(lat2*p)*(1-Math.cos((lon2-lon1)*p))/2;
        return 2 * R * Math.asin(Math.sqrt(a));
    }
    function decodePolyline(str) {
        let index=0,lat=0,lng=0,coordinates=[],shift=0,result=0,byte=null,latitude_change,longitude_change,factor=1e5;
        while(index<str.length){
            byte=null;shift=0;result=0;
            do{byte=str.charCodeAt(index++)-63;result|=(byte&0x1f)<<shift;shift+=5;}while(byte>=0x20);
            latitude_change=((result&1)?~(result>>1):(result>>1)); shift=result=0;
            do{byte=str.charCodeAt(index++)-63;result|=(byte&0x1f)<<shift;shift+=5;}while(byte>=0x20);
            longitude_change=((result&1)?~(result>>1):(result>>1));
            lat+=latitude_change;lng+=longitude_change;
            coordinates.push([lat/factor,lng/factor]);
        }
        return coordinates;
    }
</script>
</body>
</html>
