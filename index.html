<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>MAKA FastCharging</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Syne:wght@700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        :root {
            --bg: #050505;
            --card: #111;
            --card-border: #222;
            --accent: #CCFF00; /* Kuning Stabilo */
            --cyan: #00d2ff;
            --danger: #FF3B30;
            --text: #ffffff;
            --text-mute: #888;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* LOADER (Dikembalikan ke tampilan awal) */
        .loader { position: fixed; inset:0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease-out; }
        .loader-logo { width: 150px; margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(204, 255, 0, 0.3)); animation: floatLogo 3s infinite; }
        /* Placeholder logo untuk demo */
        .loader-logo-placeholder { font-family: 'Syne'; font-size: 2.5rem; color: var(--accent); letter-spacing: 2px; font-weight: 700; }
        @keyframes floatLogo { 0%{transform:translateY(0)} 50%{transform:translateY(-10px)} 100%{transform:translateY(0)} }
        #animText1 { font-size: 1rem; color: var(--accent); margin-bottom: 5px; font-weight: 600; }
        #animText2 { font-family: 'Syne'; font-size: 1.8rem; font-weight: 800; color: #fff; text-transform: uppercase; margin-bottom: 10px; text-align: center; }
        #animText3 { font-size: 0.9rem; color: var(--cyan); letter-spacing: 2px; font-weight: 700; text-transform: uppercase; margin-bottom: 40px; opacity: 1; transition: opacity 1s; text-align: center; }
        .loader-actions { display: flex; flex-direction: column; gap: 15px; width: 80%; max-width: 300px; opacity: 1; transform: translateY(0); transition: all 0.8s ease; }
        .btn-entry { padding: 15px; border-radius: 12px; font-weight: 800; text-transform: uppercase; border: none; width: 100%; cursor: pointer; }
        .btn-entry.primary { background: var(--accent); color: #000; }
        .btn-entry.secondary { background: rgba(255,255,255,0.1); border: 1px solid #333; color: var(--text); }


        /* HEADER (Menggunakan style awal Anda) */
        .header { padding: 20px 25px 10px; display: flex; justify-content: space-between; align-items: flex-start; flex-shrink: 0; position: relative; z-index: 50; background: linear-gradient(180deg, #050505 90%, transparent); }
        .header-text { display: flex; flex-direction: column; max-width: 55%; }
        .label-top { font-size: 0.7rem; color: var(--text-mute); letter-spacing: 1px; font-weight: 700; margin-bottom: 5px; }
        .header h1 { font-family: 'Inter', sans-serif; font-size: 10vw; margin: 0; line-height: 0.9; font-weight: 900; letter-spacing: -1px; color: #fff; }
        .label-bottom { font-size: 0.75rem; color: var(--accent); letter-spacing: 1px; font-weight: 700; margin-top: 8px; }

        /* KONTROL KANAN ATAS (TOGGLE + MENU) */
        .top-controls { display: flex; flex-direction: column; align-items: flex-end; gap: 12px; position: absolute; right: 25px; top: 25px; }
        
        /* TOGGLE SWITCH */
        .toggle-mode { background: #222; border: 1px solid #444; border-radius: 20px; display: flex; padding: 2px; }
        .t-btn { padding: 6px 12px; font-size: 0.65rem; font-weight: 800; color: #888; cursor: pointer; border-radius: 18px; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .t-btn.active { background: var(--accent); color: #000; }

        /* MENU BUTTONS (Dihapus) */
        .menu-row { display: none; } 

        /* CONTAINER UTAMA */
        #view-list { display: flex; flex-direction: column; flex: 1; overflow: hidden; width: 100%; }
        #view-map { display: none; flex: 1; width: 100%; height: 100%; position: relative; }
        #fullMap { width: 100%; height: 100%; }

        /* HERO SECTION (Dipertahankan seperti Gambar 4 lama) */
        .hero-section { padding: 10px 25px; margin-bottom: 20px; flex-shrink: 0; }
        .hero-card { background: var(--card); border: 1px solid var(--card-border); border-radius: 24px; padding: 20px; position: relative; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: flex; flex-direction: column; min-height: 180px; justify-content: center; transition: 0.3s; }
        
        /* LIST SECTION (Dipertahankan seperti Gambar 4 lama) */
        .list-section { flex: 1; overflow-y: auto; padding-bottom: 50px; }
        .city-group { margin-bottom: 30px; }
        .city-header { padding: 0 25px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .city-title { color: var(--text); font-family: 'Syne'; font-weight: 700; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .city-line { height: 1px; background: #333; flex-grow: 1; }
        
        /* FIXED: Horizontal Scroll (Netflix Style) */
        .h-scroll { 
            display: flex; gap: 15px; overflow-x: auto; 
            padding: 0 25px; scroll-snap-type: x mandatory; 
            scrollbar-width: none; 
        }
        .h-scroll::-webkit-scrollbar { display: none; }

        /* MINI CARD (Gaya selang-seling Gambar 4) */
        .mini-card { 
            min-width: 160px; width: 160px; height: 190px; 
            border-radius: 18px; padding: 15px; 
            display: flex; flex-direction: column; justify-content: space-between; 
            scroll-snap-align: start; flex-shrink: 0; text-decoration: none; position: relative; overflow: hidden; 
            transition: transform 0.2s; cursor: pointer; 
            background: linear-gradient(145deg, #111, #1a1a1a); border: 1px solid #333; color: white;
        }
        .mini-card.style-2 { background: linear-gradient(145deg, #022c22, #064e3b); border: 1px solid #065f46; color: #d1fae5; }
        .mini-card.style-3 { background: linear-gradient(145deg, #0f172a, #1e293b); border: 1px solid #1e3a8a; color: #bfdbfe; }
        .mini-top h3 { margin: 0 0 8px 0; font-size: 0.9rem; line-height: 1.3; font-weight: 700; color: inherit; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .mini-info { font-size: 0.7rem; opacity: 0.8; margin-top: 5px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 5px; line-height: 1.4; z-index: 2; color: inherit; }
        .mini-dist { font-size: 0.85rem; color: var(--accent); font-weight: 800; z-index: 2; text-align: right; margin-top: 5px; }


        /* TIME PLANNER CSS (Ditampilkan di view-list saat mode planner aktif) */
        .planner-card { 
            background: var(--card); border: 1px solid var(--card-border); 
            border-radius: 24px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
        }
        .input-group { position: relative; margin-bottom: 12px; }
        .input-group label { display: block; font-size: 0.75rem; color: var(--text-mute); margin-bottom: 5px; font-weight: 600; }
        .input-group input { 
            width: 100%; padding: 12px; padding-right: 120px; 
            background: #1a1a1a; border: 1px solid #333; 
            border-radius: 10px; color: var(--text); font-size: 0.9rem;
            font-family: 'Inter', sans-serif;
        }
        .input-group input:focus { border-color: var(--cyan); outline: none; }
        .btn-input-append { 
            position: absolute; right: 8px; top: 29px; 
            padding: 6px 10px; background: var(--cyan); 
            color: #000; border: none; border-radius: 8px; 
            font-size: 0.75rem; font-weight: 700; cursor: pointer;
        }
        .input-group .unit-append {
            position: absolute; right: 15px; top: 38px;
            font-size: 0.9rem; font-weight: 700; color: var(--accent);
        }
        .btn-plan {
            width: 100%; padding: 14px; background: var(--accent); color: #000; 
            border: none; border-radius: 12px; font-weight: 800; 
            text-transform: uppercase; cursor: pointer; margin-top: 15px;
        }
        
        /* MAP OVERLAY MODAL (Hasil Rute Perjalanan) */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); backdrop-filter: blur(5px); z-index: 9999; 
            display: none; justify-content: center; align-items: center; 
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-content { 
            background: var(--card); border-radius: 20px; width: 90%; max-width: 450px; 
            padding: 25px; position: relative; 
            box-shadow: 0 15px 50px rgba(204, 255, 0, 0.1);
        }
        .modal-close { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; color: var(--text-mute); cursor: pointer; }
        
        /* Mini Map di dalam Modal */
        #mapModal #map { height: 250px; border-radius: 15px; margin-top: 20px; background: #000; border: 1px solid #333; }
        #mapTitle { font-size: 1.5rem; font-weight: 800; margin: 0 0 5px 0; color: var(--accent); }
        /* Teks Deskripsi Rute yang Diperbaiki */
        #mapSub { 
            font-size: 0.85rem; color: #ddd; margin-bottom: 15px; white-space: pre-line;
            border-left: 3px solid var(--cyan); padding-left: 10px; line-height: 1.6;
            font-weight: 500;
        }
        .modal-actions { display: flex; justify-content: space-between; margin-top: 20px; }
        .modal-actions button, .modal-actions a {
             flex-grow: 1; padding: 12px; border-radius: 10px; border: none; 
             font-weight: 800; cursor: pointer; margin: 0 5px; text-align: center;
             text-decoration: none; display: block; text-transform: uppercase;
        }
        #btnBack { background: #333; color: #fff; }
        #btnGmaps { background: var(--accent); color: #000; }

        /* CUSTOM ICON CSS */
        .leaflet-marker-icon.custom-marker { border: 3px solid #000; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .leaflet-routing-container { display: none; }
        
    </style>
</head>
<body>

    <div id="loader" class="loader">
        <img src="mlu-logo.png" alt="Logo" class="loader-logo" style="width:150px;">
        <div id="animText1">SELAMAT DATANG</div>
        <div id="animText2">SAHABAT MLU</div>
        <div id="animText3">‚Ä¢ MLU | Mau Ape Lu ‚Ä¢</div>
        <div class="loader-actions" id="loaderBtns">
            <button class="btn-entry primary" onclick="enterApp('home')">LOKASI FC ‚ö°</button>
            <button class="btn-entry primary" style="background:var(--cyan); color:#000;" onclick="enterApp('planner')">PLAN RUTE üó∫Ô∏è</button> <button class="btn-entry secondary" onclick="alert('Fitur Antrian FC Gading Segera Hadir!')">ANTRIAN FC GADING</button> </div>
    </div>

    <div class="header">
        <div class="header-text">
            <div class="label-top">LOKASI</div>
            <h1>FAST<br>CHARGING</h1>
            <div class="label-bottom">MAKA LINTAS UTARA</div>
        </div>
        <div class="top-controls">
            <div class="toggle-mode">
                <div id="btnList" class="t-btn active" onclick="switchView('list')">‚ò∞ LIST</div>
                <div id="btnMap" class="t-btn" onclick="switchView('map')">üó∫Ô∏è PETA</div>
                <div id="btnPlanner" class="t-btn" onclick="switchView('planner')">‚è±Ô∏è PLANNER</div>
            </div>
            </div>
    </div>

    <div id="view-list">
        <div class="hero-section" id="listHero">
            <div id="foundState" class="hero-card">
                 <div style="font-size:1.5rem; font-weight:900; color:#fff;">Lokasi Anda:</div>
                 <p id="userLocText" style="margin-top:5px;">Mencari sinyal GPS...</p>
            </div>
        </div>
        
        <div id="plannerSection" class="hero-section" style="padding-top:0; margin-bottom:10px; display:none;">
            <div class="planner-card">
                <h2 style="font-size:1.1rem; color:var(--accent); margin:0 0 15px 0; font-weight:800; letter-spacing:0.5px;">PERENCANAAN RUTE EV</h2>

                <div class="input-group">
                    <label for="startLoc">Lokasi Awal</label>
                    <input type="text" id="startLoc" placeholder="Masukkan Alamat Awal">
                    <button class="btn-input-append" onclick="setUserLocationAsStart()">Lokasi Saya</button>
                </div>
                
                <div class="input-group" style="margin-top:10px;">
                    <label for="soc">Sisa Baterai (SOC)</label>
                    <input type="number" id="soc" value="80" min="5" max="100">
                    <span class="unit-append">%</span>
                </div>

                <div class="input-group" style="margin-top:10px;">
                    <label for="destLoc">Lokasi Tujuan</label>
                    <input type="text" id="destLoc" placeholder="Masukkan Alamat Tujuan">
                </div>

                <button class="btn-plan" onclick="planTrip()">RENCANAKAN RUTE üó∫Ô∏è</button>
            </div>
        </div>
        
        <div class="list-section" id="mainListContainer">
            </div>
    </div>

    <div id="view-map">
        <div id="map-container"></div>
    </div>

    <div id="mapOverlay" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('mapOverlay').classList.remove('active');">‚úï</span>
            <h2 id="mapTitle"></h2>
            <p id="mapSub"></p>
            <div id="mapModal" class="map-container">
                 <div id="map"></div> </div>
            <div class="modal-actions">
                <button id="btnBack" onclick="document.getElementById('mapOverlay').classList.remove('active');">KEMBALI</button>
                <a id="btnGmaps" target="_blank">MULAI JALAN (GOOGLE MAPS) ‚Üó</a>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script>
        
        // --- KONFIGURASI API & DATA ---
        const JAWG_API = "l1PdBwk1arfZcY7wECff2jE2Ts7qpJyMqGGqHK8cjCxcLb6m0FPHm1sExB5NvLyA"; 
        const URL_LOKASI = "https://docs.google.com/spreadsheets/d/1EJOTMMfGpBMFPqR0LzbMbh7tZUcTCZld4x387OO9aJM/export?format=csv"; 
        
        let map = null;
        let userLat = null;
        let userLng = null;
        const scrollState = {};
        let chargers = []; 

        const MIN_RANGE_KM = 5; // Jarak buffer 5km
        const MIN_CHARGE_PERCENT = 80; // Minimal baterai yang disarankan setelah charging di tengah jalan
        
        // --- HELPER FUNCTIONS (Dilanjutkan di Bagian 2/3) ---

                 // Lanjutan dari Script Bagian 1/3

        // --- HELPER FUNCTIONS ---

        // Menghitung jarak garis lurus (Haversine)
        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius bumi dalam km
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return (R * c).toFixed(1);
        }
        
        // Helper: Geocoding (Nominatim - GRATIS)
        async function geocodeAddress(address) {
            try {
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`;
                const response = await fetch(url, { headers: { 'User-Agent': 'MAKA-FastCharging-App/1.0' } });
                const data = await response.json();
                
                if (data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lng = parseFloat(result.lon);
                    return { lat: lat, lng: lng, address: result.display_name.split(',').slice(0, 3).join(', ') }; // Ambil 3 bagian alamat teratas
                }
                return null;
            } catch(error) {
                console.error("Geocoding (Nominatim) error:", error);
                return null;
            }
        }
        
        // Helper: Hitung Jarak Rute (OSRM - GRATIS)
        async function getRouteDistance(start, end) {
            const OSRM_URL = `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=false`;
            
            try {
                const response = await fetch(OSRM_URL);
                const data = await response.json();
                
                if (data.code === 'Ok' && data.routes.length > 0) {
                    const distanceKm = data.routes[0].distance / 1000;
                    return distanceKm;
                }
                return null; 
            } catch(error) {
                console.error("OSRM Routing error:", error);
                return null;
            }
        }
        
        // --- DATA LOAD ---
        
        async function loadDataBackground() {
            try {
                // Memuat data FC nyata dari Google Sheet
                const txtLoc = await fetch(URL_LOKASI).then(r=>r.text());

                // Parsing CSV data (Asumsi: Name, City, Type, Status, Lat, Lng)
                chargers = txtLoc.split('\n').slice(1).map((r, i) => {
                    const c = r.split(',');
                    let latVal = parseFloat(c[4]);
                    let lngVal = parseFloat(c[5]);
                    
                    if(c.length < 5 || isNaN(latVal) || isNaN(lngVal)) return null; 

                    return { 
                        id: `FC-${i}`,
                        name: c[0].trim(), 
                        city: c[1].trim(), 
                        type: c[2].trim(),
                        status: c[3] ? c[3].toLowerCase().trim() : 'available', 
                        lat: latVal, 
                        lng: lngVal, 
                        distance: '--' 
                    };
                }).filter(i=>i);

                getUserLocation(); 
            } catch(e) {
                console.error("Gagal memuat data lokasi:", e);
                // Jika gagal, tampilkan list tanpa FC
                chargers = []; 
                getUserLocation(); 
            }
        }

        // --- PLANNER ACTIONS ---

        function setUserLocationAsStart() {
            if (userLat && userLng) {
                document.getElementById('startLoc').value = `${userLat.toFixed(6)}, ${userLng.toFixed(6)}`;
                alert('Lokasi Anda berhasil diatur sebagai lokasi awal (Koordinat).');
            } else {
                alert('GPS belum terdeteksi. Harap tunggu atau masukkan koordinat/alamat manual.');
            }
        }

        // Action: Rencanakan Perjalanan (Logika Inti)
        async function planTrip() {
            const startAddr = document.getElementById('startLoc').value;
            const soc = parseFloat(document.getElementById('soc').value);
            const destAddr = document.getElementById('destLoc').value;
            
            if (!startAddr || !destAddr || isNaN(soc) || soc < 5 || soc > 100) {
                alert('Harap isi Lokasi Awal, Sisa Baterai (5-100%), dan Lokasi Tujuan dengan benar.');
                return;
            }
            
            // Konversi Baterai ke Jarak Tempuh (Range)
            const initialRangeKm = soc - MIN_RANGE_KM; 
            
            // 1. Geocode Lokasi Awal dan Tujuan
            let startLoc;
            // Coba parse koordinat jika ada koma
            if (startAddr.includes(',')) { 
                const parts = startAddr.split(',').map(s => parseFloat(s.trim()));
                if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                     startLoc = { lat: parts[0], lng: parts[1], address: `Koordinat Awal: ${startAddr}` };
                }
            }
            if(!startLoc) { 
                startLoc = await geocodeAddress(startAddr);
            }
            if (!startLoc) {
                alert(`Gagal menemukan koordinat untuk Lokasi Awal: ${startAddr}`);
                return;
            }
            
            const destLoc = await geocodeAddress(destAddr);
            if (!destLoc) {
                alert(`Gagal menemukan koordinat untuk Lokasi Tujuan: ${destAddr}`);
                return;
            }
            
            // 2. Hitung Jarak Rute Langsung
            const directDistKm = await getRouteDistance(startLoc, destLoc);
            if (directDistKm === null) {
                alert('Gagal menghitung jarak rute langsung. Coba lagi.');
                return;
            }
            
            // Hitung sisa baterai jika rute langsung
            const finalSocDirect = Math.max(0, soc - directDistKm - MIN_RANGE_KM);
            
            // 3. Tentukan Rencana (A: Langsung atau B: Via FC)
            let finalRoute = [];
            let routeSummary = "";
            let fcNearbyDest = null;
            
            if (directDistKm <= initialRangeKm) {
                // A. Rute Langsung (Baterai Cukup)
                
                // Cari FC terdekat dari Tujuan untuk rekomendasi
                let nearestFCToDest = null;
                let minDistToDest = Infinity;
                chargers.forEach(c => {
                    const dist = parseFloat(getDist(destLoc.lat, destLoc.lng, c.lat, c.lng));
                    if (dist < minDistToDest) {
                        minDistToDest = dist;
                        nearestFCToDest = c;
                    }
                });
                
                fcNearbyDest = { dist: minDistToDest, fc: nearestFCToDest };
                
                routeSummary = `‚úÖ **RUTE LANGSUNG (Baterai Cukup)**\n`;
                routeSummary += `Estimasi Perjalanan: **${directDistKm.toFixed(1)} km**\n`;
                routeSummary += `Baterai Awal: **${soc}%** | Sisa Baterai di Tujuan: **${Math.round(finalSocDirect)}%**\n\n`;
                routeSummary += `**Rute Anda:**\n`;
                routeSummary += `[START] ${startLoc.address} \n`;
                routeSummary += `‚Üí [END] ${destLoc.address}\n\n`;
                
                if (fcNearbyDest.fc) {
                    const socNeededForDestFC = Math.ceil(fcNearbyDest.dist) + MIN_RANGE_KM;
                    routeSummary += `**CATATAN PENTING (DI TUJUAN):**\n`;
                    routeSummary += `FC terdekat dari ${destLoc.address} adalah **${fcNearbyDest.fc.name}** (Jarak ${fcNearbyDest.dist} km).\n`;
                    routeSummary += `Jika Anda ingin kembali dari tujuan, Anda butuh minimal **${socNeededForDestFC}%** baterai untuk mencapai FC tersebut.`;
                }

                finalRoute = [startLoc, destLoc];

            } else {
                // B. Rute Via FC (Baterai Tidak Cukup)
                
                // Cari FC Terdekat dari Lokasi Awal
                let nearestFC = null;
                let minDist = Infinity;
                chargers.forEach(c => {
                    const dist = parseFloat(getDist(startLoc.lat, startLoc.lng, c.lat, c.lng));
                    if (dist < minDist) {
                        minDist = dist;
                        nearestFC = c;
                    }
                });
                
                if (!nearestFC) {
                    alert('Tidak ditemukan FC terdekat. Perjalanan via FC dibatalkan.');
                    return;
                }
                
                const fcLoc = { lat: nearestFC.lat, lng: nearestFC.lng, address: nearestFC.name };
                
                // Hitung Jarak Rute Awal -> FC
                const startToFCDist = await getRouteDistance(startLoc, fcLoc);
                if (startToFCDist === null) {
                    alert('Gagal menghitung jarak rute ke FC. Coba lagi.');
                    return;
                }
                
                // Hitung baterai yang tersisa di FC
                const socArrivalFC = soc - startToFCDist - MIN_RANGE_KM;
                
                if (socArrivalFC < 0) {
                    alert(`‚ùå **Baterai Terlalu Rendah.** Jarak ke FC terdekat (${nearestFC.name}) adalah ${startToFCDist.toFixed(1)} km, melebihi daya jelajah (${initialRangeKm.toFixed(1)} km). Perjalanan tidak aman.`);
                    return;
                }
                
                // Jarak Rute FC -> Tujuan
                const fcToDestDist = await getRouteDistance(fcLoc, destLoc);
                const totalDist = startToFCDist + fcToDestDist;
                
                // Perhitungan SOC untuk perjalanan setelah charging (Asumsi: Charging hingga MIN_CHARGE_PERCENT)
                const socNeededToDest = fcToDestDist + MIN_RANGE_KM;
                
                let socCharged = Math.max(MIN_CHARGE_PERCENT, socNeededToDest + 10); // Charge minimal 80% atau lebih dari yang dibutuhkan
                if (socCharged > 100) socCharged = 100;
                
                const finalSocViaFC = Math.max(0, socCharged - socNeededToDest);
                
                routeSummary = `‚ö†Ô∏è **RUTE VIA FC (Baterai Tidak Cukup)**\n`;
                routeSummary += `Estimasi Total Jarak: **${totalDist.toFixed(1)} km**\n`;
                routeSummary += `Baterai Awal: **${soc}%** | Baterai dibutuhkan (${directDistKm.toFixed(1)} km): **${Math.ceil(directDistKm) + MIN_RANGE_KM}%**\n\n`;
                routeSummary += `**Rute Disarankan (Singgah Cas):**\n`;
                routeSummary += `**[1] ${startLoc.address}** \n`;
                routeSummary += `‚Üí **[2] ${nearestFC.name} (FC)**: ${startToFCDist.toFixed(1)} km. Baterai tiba: **${Math.round(socArrivalFC)}%**.\n`;
                routeSummary += `   Disarankan Cas minimal **${socCharged}%** (Daya jelajah ${socCharged} km).\n`;
                routeSummary += `‚Üí **[3] ${destLoc.address}**: ${fcToDestDist.toFixed(1)} km. Sisa Baterai tiba: **${Math.round(finalSocViaFC)}%** (dari SOC ${socCharged}%).`;

                finalRoute = [startLoc, fcLoc, destLoc];
                
            }
            
            // Tampilkan Rute di Map Modal
            openPlanMapModal(finalRoute, routeSummary, finalStart, finalDest);
        }
        
        // --- MAP FUNCTIONS (Dilanjutkan di Bagian 3/3) ---

                // Lanjutan dari Script Bagian 2/3

        // --- MAP FUNCTIONS (PLANNER & SINGLE) ---
        
        let routingControl = null;

        // Fungsi untuk menampilkan Rute Terencana (3 titik atau lebih)
        function openPlanMapModal(waypoints, summary, finalStart, finalDest) {
            document.getElementById('mapOverlay').classList.add('active');
            document.getElementById('mapTitle').innerText = 'RUTE PERJALANAN TERENCANA';
            
            // Menggunakan bahasa yang lebih mudah dipahami
            document.getElementById('mapSub').innerHTML = summary;
            
            // Mempersiapkan Link Google Maps (hanya bisa 2 titik)
            const gmapsUrl = `https://www.google.com/maps/dir/${finalStart.lat},${finalStart.lng}/${finalDest.lat},${finalDest.lng}/`;
            document.getElementById('btnGmaps').href = gmapsUrl;
            document.getElementById('btnGmaps').innerText = 'MULAI JALAN (GOOGLE MAPS) ‚Üó';
            
            setTimeout(() => {
                // Hapus dan Buat Ulang Peta di Modal
                const mapElement = document.getElementById('map');
                if(map) { map.remove(); map = null; }
                
                map = L.map(mapElement, {zoomControl: false}).setView([waypoints[0].lat, waypoints[0].lng], 10);
                L.tileLayer(`https://tile.jawg.io/jawg-matrix/{z}/{x}/{y}{r}.png?access-token=${JAWG_API}`, {}).addTo(map);

                if (routingControl) {
                    map.removeControl(routingControl);
                    routingControl = null;
                }
                
                // Tambahkan Rute ke Peta
                const leafletWaypoints = waypoints.map(w => L.latLng(w.lat, w.lng));
                
                routingControl = L.Routing.control({
                    waypoints: leafletWaypoints,
                    lineOptions: { styles: [{color: '#CCFF00', opacity: 0.9, weight: 6}] },
                    createMarker: function(i, waypoint, n) { 
                        let iconColor = '#FF3B30'; // Merah (Start)
                        if (i === n - 1) iconColor = '#06c258'; // Hijau (End)
                        else if (n > 2 && i === 1) iconColor = '#00d2ff'; // Biru Cyan (FC/Singgah)

                        const customIcon = L.divIcon({
                            html: `<div style="background:${iconColor}; width:15px; height:15px; border-radius:50%; border:3px solid #000; box-shadow:0 0 10px rgba(0,0,0,0.5);"></div>`,
                            className: 'custom-marker',
                            iconSize: [15, 15],
                            iconAnchor: [7.5, 7.5]
                        });
                        
                        return L.marker(waypoint.latLng, {icon: customIcon})
                                .bindPopup(waypoints[i].address);
                    },
                    addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true, show: false
                }).addTo(map);
                
                routingControl.on('routesfound', function(e) {
                    var routes = e.routes;
                    map.fitBounds(routes[0].bounds);
                });

            }, 300);
        }

        // Buka modal map untuk rute ke satu charger
        function openMapModal(charger) {
            document.getElementById('mapOverlay').classList.add('active');
            document.getElementById('mapTitle').innerText = charger.name.toUpperCase();
            document.getElementById('mapSub').innerHTML = `Jarak dari Anda: **${charger.distance} km** | Status: **${charger.status.toUpperCase()}** | Tipe: **${charger.type}**`;
            
            if (userLat && userLng) {
                 const gmapsUrl = `https://www.google.com/maps/dir/${userLat},${userLng}/${charger.lat},${charger.lng}/`;
                 document.getElementById('btnGmaps').href = gmapsUrl;
                 document.getElementById('btnGmaps').innerText = 'NAVIGASI (GOOGLE MAPS) ‚Üó';
            } else {
                 document.getElementById('btnGmaps').href = `https://www.google.com/maps/search/?api=1&query=${charger.lat},${charger.lng}`;
                 document.getElementById('btnGmaps').innerText = 'LIHAT DI GOOGLE MAPS ‚Üó';
            }

            setTimeout(() => {
                const mapElement = document.getElementById('map');
                if(map) { map.remove(); map = null; }
                
                map = L.map(mapElement, {zoomControl: false}).setView([charger.lat, charger.lng], 13);
                L.tileLayer(`https://tile.jawg.io/jawg-matrix/{z}/{x}/{y}{r}.png?access-token=${JAWG_API}`, {}).addTo(map);

                if (routingControl) {
                    map.removeControl(routingControl);
                    routingControl = null;
                }

                if (userLat && userLng) {
                     routingControl = L.Routing.control({
                        waypoints: [
                            L.latLng(userLat, userLng),
                            L.latLng(charger.lat, charger.lng)
                        ],
                        routeWhileDragging: false,
                        lineOptions: { styles: [{color: '#CCFF00', opacity: 0.8, weight: 6}] },
                        createMarker: function(i, waypoint, n) { return null; },
                        fitSelectedRoutes: true,
                        show: false
                    }).addTo(map);
                    
                    routingControl.on('routesfound', function(e) {
                        var routes = e.routes;
                        map.fitBounds(routes[0].bounds);
                    });
                    
                } else {
                    L.marker([charger.lat, charger.lng]).addTo(map).bindPopup(charger.name).openPopup();
                }

            }, 300);
        }

        // Inisialisasi peta utama (VIEW MAP)
        function initFullMap() {
            if (map) { map.remove(); map = null; }
            if (chargers.length === 0) return;
            
            const centerLat = userLat || chargers[0].lat;
            const centerLng = userLng || chargers[0].lng;
            
            map = L.map('map-container', {zoomControl: false}).setView([centerLat, centerLng], 12);
            L.tileLayer(`https://tile.jawg.io/jawg-matrix/{z}/{x}/{y}{r}.png?access-token=${JAWG_API}`, {}).addTo(map);
            
            chargers.forEach(c => {
                 const statusClass = c.status;
                 let iconColor = statusClass === 'available' ? '#CCFF00' : statusClass === 'busy' ? '#FF3B30' : '#888';
                 
                 const customIcon = L.divIcon({
                    html: `<div style="background:${iconColor}; width:15px; height:15px; border-radius:50%; border:3px solid #000; box-shadow:0 0 10px rgba(0,0,0,0.5);"></div>`,
                    className: 'custom-marker',
                    iconSize: [15, 15],
                    iconAnchor: [7.5, 7.5]
                });

                L.marker([c.lat, c.lng], {icon: customIcon})
                 .addTo(map)
                 .bindPopup(`<b>${c.name}</b><br>${c.city}<br>Status: ${statusClass}`);
            });

            if (userLat && userLng) {
                const userIcon = L.divIcon({
                    html: `<div style="background:#00d2ff; width:20px; height:20px; border-radius:50%; border:3px solid #000; box-shadow:0 0 10px rgba(0,0,0,0.8);"></div>`,
                    className: 'custom-marker',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                L.marker([userLat, userLng], {icon: userIcon})
                 .addTo(map)
                 .bindPopup("Lokasi Saya");
            }
            setTimeout(() => { map.invalidateSize(); }, 200);
        }


        // Render List Charger (sesuai Gambar 4 Lama)
        function renderChargers(data) {
            const container = document.getElementById('mainListContainer');
            container.innerHTML = ''; 

            const grouped = data.reduce((acc, charger) => {
                (acc[charger.city] = acc[charger.city] || []).push(charger);
                return acc;
            }, {});

            let colorIdx = 0;
            for (const city in grouped) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'city-group';
                groupDiv.innerHTML = `<div class="city-header"><div class="city-title">${city}</div><div class="city-line"></div></div><div class="h-scroll" data-city="${city}"></div>`;
                
                const scrollContainer = groupDiv.querySelector('.h-scroll');
                scrollContainer.addEventListener('scroll', function() {
                    scrollState[city] = this.scrollLeft;
                });
                
                grouped[city].forEach(c => {
                    const statusClass = c.status;
                    const styleClass = `style-${(colorIdx % 3) + 1}`;
                    colorIdx++;
                    
                    const card = document.createElement('div');
                    card.className = `mini-card ${styleClass}`;
                    // Menggunakan JSON.stringify untuk passing data ke onclick
                    const itemJson = JSON.stringify(c).replace(/'/g, "\\'");

                    card.setAttribute('onclick', `openMapModal(${itemJson})`);

                    card.innerHTML = `
                        <div class="mini-top">
                            <h3>${c.name}</h3>
                            <div class="mini-info">${c.type}</div>
                        </div>
                        <div class="mini-bot">
                            <div class="mini-dist">${c.distance} KM</div>
                        </div>
                    `;
                    scrollContainer.appendChild(card);
                });
                container.appendChild(groupDiv);
            }
            restoreScrollState();
        }

        // Switch View (List/Map/Planner)
        function switchView(mode) {
            const listBtn = document.getElementById('btnList');
            const mapBtn = document.getElementById('btnMap');
            const plannerBtn = document.getElementById('btnPlanner'); 
            
            const plannerSection = document.getElementById('plannerSection'); 
            const listHero = document.getElementById('listHero'); 
            
            const listView = document.getElementById('view-list');
            const mapView = document.getElementById('view-map');
            const mainListContainer = document.getElementById('mainListContainer');
            
            document.querySelectorAll('.t-btn').forEach(btn => btn.classList.remove('active'));
            
            listHero.style.display = 'block'; 
            plannerSection.style.display = 'none'; 
            mainListContainer.style.display = 'block'; 
            
            if(mode === 'list') {
                listBtn.classList.add('active');
                listView.style.display = 'flex'; mapView.style.display = 'none';
                
            } else if(mode === 'map') {
                mapBtn.classList.add('active'); 
                listView.style.display = 'none'; mapView.style.display = 'block';
                initFullMap();
            } else if(mode === 'planner') { 
                plannerBtn.classList.add('active');
                listView.style.display = 'flex'; mapView.style.display = 'none';
                
                // Mode Planner: Sembunyikan List FC dan Hero List, tampilkan Planner Card
                listHero.style.display = 'none'; 
                plannerSection.style.display = 'block';
                mainListContainer.style.display = 'none'; 
            }
        }

        // Dapatkan Lokasi Pengguna (GPS)
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLat = position.coords.latitude;
                        userLng = position.coords.longitude;
                        document.getElementById('userLocText').innerText = `(${userLat.toFixed(4)}, ${userLng.toFixed(4)})`;
                        
                        const updatedChargers = chargers.map(c => ({
                            ...c,
                            distance: getDist(userLat, userLng, c.lat, c.lng)
                        })).sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance)); 
                        
                        renderChargers(updatedChargers);
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        document.getElementById('userLocText').innerText = "GPS Error/Tidak Aktif. Jarak default.";
                        renderChargers(chargers); 
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                document.getElementById('userLocText').innerText = "Geolocation tidak didukung.";
                renderChargers(chargers); 
            }
        }
        
        // --- STARTUP APLIKASI ---

        function enterApp(mode) {
             document.getElementById('loader').style.opacity = '0';
             setTimeout(() => { document.getElementById('loader').style.display = 'none'; }, 600);
             if(mode === 'home') switchView('list');
             if(mode === 'planner') switchView('planner');
        }

        function restoreScrollState() {
            document.querySelectorAll('.city-group').forEach(group => {
                const title = group.querySelector('.city-title').innerText;
                if(scrollState[title]) group.querySelector('.h-scroll').scrollLeft = scrollState[title];
            });
        }
        
        // Simulasikan Intro/Loader
        function runIntro() {
             // Agar user bisa melihat loader dan memilih tombol
             document.getElementById('loader').style.opacity = '1';
             loadDataBackground(); 
        }
        
        runIntro(); 
        
    </script>
</body>
</html>
