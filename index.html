<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FC KELAPA GADING - lCINEMATIC VIEW</title>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;500;700&family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- STYLE DASAR --- */
        :root { --bg: #000000; --accent: #CCFF00; --blue: #00F0FF; --red: #ff003c; }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #fff; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* HEADER */
        .top-nav { height: 12vh; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
        .main-title { font-family: 'Teko'; font-size: 40px; font-weight: 700; line-height: 1; color: #fff; text-shadow: 0 0 10px rgba(0, 240, 255, 0.5); margin: 0; }
        .brand-sub { font-size: 10px; color: var(--accent); letter-spacing: 4px; font-weight: 700; }

        /* --- KONSEP SPLIT IMAGE (CANVAS) --- */
        #frontView { 
            height: 53vh; 
            display: flex; 
            justify-content: center; 
            align-items: stretch; /* Biar tinggi sama rata */
            padding: 20px 10px; 
            gap: 5px; /* Jarak antar slot tipis aja biar nyatu */
            width: 100%; 
        }

        .onyx-card { 
            position: relative; 
            width: 33%; /* Bagi 3 rata */
            border-radius: 8px; /* Radius dikit aja */
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            padding: 15px 5px; 
            overflow: hidden; 
            transition: 0.5s ease-in-out; /* Transisi halus pas nyala */
            
            /* BACKGROUND SETUP (SPLIT IMAGE) */
            /* GANTI URL INI DENGAN NAMA FILE GAMBAR LU */
            background-image: url('1000240467.jpg'); 
            background-size: 305% 100%; /* Zoom biar muat 3 kartu */
            background-repeat: no-repeat;
            
            /* DEFAULT: MATI (HITAM PUTIH & GELAP) */
            filter: grayscale(100%) brightness(0.25) contrast(1.2);
            border: none; /* Border ilang sesuai request */
            box-shadow: inset 0 0 20px #000; /* Shadow dalem biar depth */
        }

        /* POSISI POTONGAN GAMBAR */
        #card-1 { background-position: 0% 50%; }     /* Kiri */
        #card-2 { background-position: 50% 50%; }    /* Tengah */
        #card-3 { background-position: 100% 50%; }   /* Kanan */

        /* EFEK NYALA (ACTIVE) */
        .onyx-card.charging, .onyx-card.full {
            /* Warna Asli Keluar */
            filter: grayscale(0%) brightness(1.1) contrast(1.1);
            box-shadow: 0 0 30px rgba(255, 80, 0, 0.4); /* Glow Api Oranye */
            transform: scale(1.02); /* Pop up dikit */
            z-index: 10;
        }
        
        /* CONTENT DALAM KARTU (Text Shadow Wajib Tebal Biar Kebaca di atas Gambar) */
        .oc-header, .oc-body, .oc-footer { position: relative; z-index: 2; text-align: center; text-shadow: 0 2px 4px #000, 0 0 10px #000; }
        
        .oc-plat { font-family:'Inter'; font-weight: 900; font-size: 18px; color: #fff; margin-bottom: 2px; }
        
        /* POSISI BADGE & NAMA */
        .oc-user-block { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 40px; }
        .oc-name { font-size: 10px; color: #ddd; text-transform: uppercase; font-weight: 800; letter-spacing: 1px; }
        
        /* BADGE STYLE (KECIL) */
        .mini-badge {
            margin-top: 4px;
            padding: 2px 6px;
            font-size: 8px;
            font-family: 'Orbitron';
            font-weight: bold;
            background: rgba(0,0,0,0.8);
            border: 1px solid #555;
            border-radius: 4px;
            color: #ccc;
            display: none; /* Default hidden */
        }
        
        .oc-body { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        
        /* ANGKA BESAR */
        .oc-big-num { font-family: 'Teko', sans-serif; font-weight: 500; color: #555; line-height: 0.8; transition: 0.3s; }
        .num-charging { font-size: 70px; color: #fff; text-shadow: 0 0 20px var(--red); } /* Warna Angka Putih Glow Merah */
        .num-ready { font-size: 30px; letter-spacing: 2px; color: #444; } 

        .oc-status { font-family: 'JetBrains Mono'; font-size: 9px; font-weight: 700; padding: 4px 8px; border-radius: 4px; display: inline-block; background: rgba(0,0,0,0.8); color: #888; border: 1px solid #333; }
        
        /* WARNA STATUS AKTIF */
        .onyx-card.charging .oc-status { border-color: var(--blue); color: var(--blue); box-shadow: 0 0 5px var(--blue); }
        .onyx-card.full .oc-status { border-color: var(--accent); color: var(--accent); animation: blink 1s infinite; }

        /* PROGRESS BAR DI BAWAH */
        .oc-progress-bg { position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: rgba(0,0,0,0.5); z-index: 5; }
        .oc-progress-fill { height: 100%; width: 0%; background: var(--blue); transition: width 1s linear; box-shadow: 0 0 10px var(--blue); }

        @keyframes blink { 50% { opacity: 0.5; } }

        /* FOOTER AREA */
        .control-area { height: 35vh; background: linear-gradient(to top, #000 10%, transparent 100%); display: flex; flex-direction: column; align-items: center; z-index: 50; }
        .info-row { margin-top: 10px; }
        .antrian-text { font-family: 'Orbitron'; font-size: 18px; font-weight: 900; color: #666; }
    </style>
</head>
<body onclick="firstInteraction()">

    <div class="top-nav">
        <h1 class="main-title">FC KELAPA GADING</h1>
        <div class="brand-sub">LIVE MONITORING</div>
    </div>

    <div id="frontView">
        <div class="onyx-card" id="card-1">
            <div class="oc-header">
                <div class="oc-plat" id="p1-plat">-</div>
                <div class="oc-user-block">
                    <div class="oc-name" id="p1-name"></div>
                    <div class="mini-badge" id="p1-badge">MEMBER</div> </div>
            </div>
            <div class="oc-body"><div class="oc-big-num num-ready" id="p1-main">OFF</div></div>
            <div class="oc-footer">
                <div class="oc-status" id="p1-status">READY</div>
                <div style="font-size:10px; margin-top:2px;" id="p1-timer"></div>
            </div>
            <div class="oc-progress-bg"><div class="oc-progress-fill" id="p1-bar"></div></div>
        </div>

        <div class="onyx-card" id="card-2">
            <div class="oc-header">
                <div class="oc-plat" id="p2-plat">-</div>
                <div class="oc-user-block">
                    <div class="oc-name" id="p2-name"></div>
                    <div class="mini-badge" id="p2-badge">MEMBER</div>
                </div>
            </div>
            <div class="oc-body"><div class="oc-big-num num-ready" id="p2-main">OFF</div></div>
            <div class="oc-footer">
                <div class="oc-status" id="p2-status">READY</div>
                <div style="font-size:10px; margin-top:2px;" id="p2-timer"></div>
            </div>
            <div class="oc-progress-bg"><div class="oc-progress-fill" id="p2-bar"></div></div>
        </div>

        <div class="onyx-card" id="card-3">
            <div class="oc-header">
                <div class="oc-plat" id="p3-plat">-</div>
                <div class="oc-user-block">
                    <div class="oc-name" id="p3-name"></div>
                    <div class="mini-badge" id="p3-badge">MEMBER</div>
                </div>
            </div>
            <div class="oc-body"><div class="oc-big-num num-ready" id="p3-main">OFF</div></div>
            <div class="oc-footer">
                <div class="oc-status" id="p3-status">READY</div>
                <div style="font-size:10px; margin-top:2px;" id="p3-timer"></div>
            </div>
            <div class="oc-progress-bg"><div class="oc-progress-fill" id="p3-bar"></div></div>
        </div>
    </div>

    <div class="control-area">
        <div class="info-row">
            <div id="qCountDisplay" class="antrian-text">QUEUE: 0</div>
        </div>
        </div>

    <audio id="audio" crossorigin="anonymous"></audio>

    <script type="module">
        // --- COPY BAGIAN FIREBASE CONFIG & LOGIC DARI SCRIPT SEBELUMNYA ---
        // --- HANYA UPDATE BAGIAN updateFrontView() DI BAWAH INI ---

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyALIlkIDALIk83K8s1htalvW6rmNNw02Go", authDomain: "sistem-antrian-b1c39.firebaseapp.com", projectId: "sistem-antrian-b1c39", storageBucket: "sistem-antrian-b1c39.firebasestorage.app", messagingSenderId: "454124587608", appId: "1:454124587608:web:34fbb0f5211067a67f982d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const ref = doc(db, "antrian", "utama");

        // FUNGSI UPDATE TAMPILAN
        function updateFrontView(slots) {
            slots.forEach((m, i) => {
                const elCard = document.getElementById(`card-${i+1}`);
                const elPlat = document.getElementById(`p${i+1}-plat`);
                const elName = document.getElementById(`p${i+1}-name`);
                const elBadge = document.getElementById(`p${i+1}-badge`);
                const elMain = document.getElementById(`p${i+1}-main`);
                const elStatus = document.getElementById(`p${i+1}-status`);
                const elBar = document.getElementById(`p${i+1}-bar`);
                const elTimer = document.getElementById(`p${i+1}-timer`);

                // Reset Class
                elCard.classList.remove('charging', 'full'); 
                elMain.classList.remove('num-charging', 'num-ready'); 
                elBar.style.width = '0%';
                elBadge.style.display = 'none';

                if (m && m.plat) {
                     // DATA ADA -> ISI SLOT
                     elPlat.innerText = m.plat;
                     elName.innerText = m.userName || "USER";
                     
                     // UPDATE BADGE (Di sini posisinya)
                     if(m.role) {
                         elBadge.innerText = m.role;
                         elBadge.style.display = 'inline-block';
                         // Kasih warna khusus buat badge kalau mau
                         if(m.role === 'KETUM') elBadge.style.borderColor = 'gold';
                         else elBadge.style.borderColor = '#555';
                     }

                     if(m.startTime) {
                        const totalSec = m.durationMinutes * 60; 
                        const st = m.startTime.toDate ? m.startTime.toDate() : new Date(m.startTime); 
                        const elapsedSec = (new Date() - st) / 1000;
                        let progress = elapsedSec / totalSec; if(progress > 1) progress = 1;
                        let estBat = Math.round(m.startBattery + ((98 - m.startBattery) * progress)); if(estBat > 98) estBat = 98;
                        
                        elBar.style.width = (progress * 100) + "%";

                        if(elapsedSec >= totalSec) {
                            elMain.innerText = "FULL"; 
                            elStatus.innerText = "DONE"; 
                            elCard.classList.add('full'); 
                            elMain.classList.add('num-charging');
                        } else {
                            elMain.innerText = estBat + "%"; 
                            elStatus.innerText = "CHRG"; 
                            elCard.classList.add('charging'); // INI YG BIKIN GAMBAR NYALA
                            elMain.classList.add('num-charging');
                        }
                     } else { 
                        // Booking tapi belum start
                        elMain.innerText = "WAIT"; 
                        elStatus.innerText = "BOOKED";
                        elMain.classList.add('num-ready');
                     }
                } else { 
                    // SLOT KOSONG
                    elPlat.innerText = "-"; 
                    elName.innerText = "";
                    elMain.innerText = "OFF"; // Atau Logo MLU Mati
                    elStatus.innerText = "READY";
                    elMain.classList.add('num-ready');
                }
            });
        }

        // LISTENER FIREBASE
        onSnapshot(ref, (snap) => {
            const d = snap.data(); if(!d) return;
            const slots = d.chargingSlots || [null, null, null];
            document.getElementById('qCountDisplay').innerText = "QUEUE: " + (d.waitingQueue ? d.waitingQueue.length : 0);
            updateFrontView(slots);
        });

        // Tambahin kode Music Player dll disini kalau perlu
    </script>
</body>
</html>
