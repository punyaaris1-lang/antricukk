<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>MAKA FastCharging</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Syne:wght@700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        :root {
            --bg: #050505;
            --card: #111;
            --card-border: #222;
            --accent: #CCFF00; /* Kuning Stabilo */
            --cyan: #00d2ff;
            --danger: #FF3B30;
            --text: #ffffff;
            --text-mute: #888;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        
        /* LOADER */
        .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .loader-logo { font-family: 'Syne', sans-serif; font-size: 2.5rem; color: var(--accent); letter-spacing: 2px; font-weight: 700; }
        .loader-logo span { color: var(--text); }
        .loader-text { margin-top: 20px; text-align: center; }
        #animText1, #animText2 { font-weight: 800; font-size: 1.5rem; }
        .letter { display: inline-block; opacity: 0; transform: translateY(-20px); transition: opacity 0.2s, transform 0.2s; }
        .letter.active { opacity: 1; transform: translateY(0); }
        #animText3 { font-size: 0.8rem; color: var(--text-mute); opacity: 0; transition: opacity 0.5s; }
        .loader-actions { position: absolute; bottom: 50px; opacity: 0; transition: opacity 0.5s; }
        .loader-actions.show { opacity: 1; }
        .loader-actions button { background: var(--accent); color: #000; border: none; padding: 12px 25px; border-radius: 10px; font-weight: 700; margin: 0 10px; cursor: pointer; }

        /* HEADER */
        header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: var(--bg); border-bottom: 1px solid #1a1a1a; z-index: 10; position: relative; }
        .logo { font-family: 'Syne', sans-serif; font-size: 1.2rem; color: var(--accent); font-weight: 700; letter-spacing: 1px; }
        .toggle-mode { display: flex; background: #1a1a1a; border-radius: 10px; padding: 3px; }
        .t-btn { padding: 8px 12px; font-size: 0.75rem; font-weight: 600; cursor: pointer; border-radius: 8px; color: var(--text-mute); transition: background 0.3s, color 0.3s; }
        .t-btn.active { background: var(--accent); color: #000; }
        .nav-icons span { font-size: 1.2rem; margin-left: 15px; cursor: pointer; color: var(--text-mute); }
        
        /* CONTENT LAYOUT */
        .content-container { height: calc(100vh - 56px); overflow: hidden; display: flex; flex-direction: column; }
        
        /* VIEW LIST (HOME) */
        #view-list { flex-grow: 1; overflow-y: auto; padding: 0 20px; display: flex; flex-direction: column; }
        .hero-section { padding-top: 20px; padding-bottom: 10px; }
        .hero-section h1 { font-size: 1.8rem; font-weight: 900; margin: 0 0 5px 0; line-height: 1.2; }
        .hero-section p { font-size: 0.85rem; color: var(--text-mute); margin: 0; }

        /* TIME PLANNER CSS */
        .planner-card { 
            background: var(--card); border: 1px solid var(--card-border); 
            border-radius: 24px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
        }
        .input-group { position: relative; margin-bottom: 12px; }
        .input-group label { display: block; font-size: 0.75rem; color: var(--text-mute); margin-bottom: 5px; font-weight: 600; }
        .input-group input { 
            width: 100%; padding: 12px; padding-right: 120px; 
            background: #1a1a1a; border: 1px solid #333; 
            border-radius: 10px; color: var(--text); font-size: 0.9rem;
            font-family: 'Inter', sans-serif;
        }
        .input-group input:focus { border-color: var(--cyan); outline: none; }
        .btn-input-append { 
            position: absolute; right: 8px; top: 29px; 
            padding: 6px 10px; background: var(--cyan); 
            color: #000; border: none; border-radius: 8px; 
            font-size: 0.75rem; font-weight: 700; cursor: pointer;
        }
        .input-group .unit-append {
            position: absolute; right: 15px; top: 38px;
            font-size: 0.9rem; font-weight: 700; color: var(--accent);
        }
        .btn-plan {
            width: 100%; padding: 14px; background: var(--accent); color: #000; 
            border: none; border-radius: 12px; font-weight: 800; 
            text-transform: uppercase; cursor: pointer; margin-top: 15px;
        }


        /* LIST GROUP */
        .list-group { margin-bottom: 20px; }
        .city-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 15px; }
        .h-scroll { display: flex; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory; }
        .h-scroll::-webkit-scrollbar { display: none; }
        .charger-card { 
            flex: 0 0 auto; width: 280px; background: var(--card); 
            border: 1px solid var(--card-border); border-radius: 18px; 
            padding: 15px; margin-right: 15px; scroll-snap-align: start; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .card-title { font-size: 1rem; font-weight: 700; }
        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; }
        .status-badge.available { background: var(--accent); color: #000; }
        .status-badge.busy { background: var(--danger); color: #fff; }
        .status-badge.offline { background: var(--text-mute); color: #fff; }
        .card-info { font-size: 0.8rem; color: var(--text-mute); margin-bottom: 8px; }
        .card-info span { color: var(--text); font-weight: 600; }
        .card-actions { display: flex; justify-content: space-between; margin-top: 15px; }
        .card-actions button { 
            flex-grow: 1; padding: 10px; border-radius: 10px; border: none; 
            font-weight: 700; cursor: pointer; margin-right: 5px; 
        }
        .btn-map { background: var(--cyan); color: #000; }
        .btn-route { background: var(--accent); color: #000; margin-right: 0; }

        /* VIEW MAP */
        #view-map { flex-grow: 1; display: none; }
        #map-container { height: 100%; width: 100%; }
        .leaflet-marker-icon.custom-marker { border: 3px solid #000; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .leaflet-routing-container { display: none; } /* Sembunyikan panel routing */
        
        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 999; display: none; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--card); border-radius: 20px; width: 90%; max-width: 450px; padding: 25px; position: relative; }
        .modal-close { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; color: var(--text-mute); cursor: pointer; }
        #mapModal #map { height: 300px; border-radius: 15px; margin-top: 20px; }
        #mapTitle { font-size: 1.5rem; font-weight: 800; margin: 0 0 5px 0; }
        #mapSub { font-size: 0.85rem; color: var(--text-mute); margin-bottom: 15px; white-space: pre-line;}
        .modal-actions { display: flex; justify-content: space-between; margin-top: 20px; }
        .modal-actions button, .modal-actions a {
             flex-grow: 1; padding: 12px; border-radius: 10px; border: none; 
             font-weight: 700; cursor: pointer; margin: 0 5px; text-align: center;
             text-decoration: none; display: block;
        }
        #btnBack { background: var(--text-mute); color: #000; }
        #btnGmaps { background: var(--accent); color: #000; }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 100; display: none; padding: 20px;
            overflow-y: auto;
        }
        .modal.show { display: block; }
        .modal h2 { font-size: 2rem; font-weight: 900; color: var(--accent); margin-top: 40px; }
        .modal p { font-size: 0.9rem; line-height: 1.5; color: var(--text-mute); }
        .modal ul { list-style: none; padding: 0; }
        .modal li { margin-bottom: 10px; padding-left: 20px; position: relative; }
        .modal li::before { content: '‚Ä¢'; position: absolute; left: 0; color: var(--cyan); font-weight: 800; }
    </style>
</head>
<body>

    <div class="loader">
        <div class="loader-logo">MAKA<span>FC</span></div>
        <div class="loader-text">
            <p id="animText1"></p>
            <p id="animText2"></p>
            <p id="animText3">Connecting to MAKA Network...</p>
        </div>
        <div class="loader-actions">
            <button onclick="document.querySelector('.loader').style.opacity = '0'; setTimeout(() => document.querySelector('.loader').style.display = 'none', 500);">Lanjutkan ke App</button>
        </div>
    </div>

    <header>
        <div class="logo">MAKA<span>FC</span></div>
        <div class="toggle-mode">
            <div id="btnList" class="t-btn active" onclick="switchView('list')">‚ò∞ LIST</div>
            <div id="btnMap" class="t-btn" onclick="switchView('map')">üó∫Ô∏è PETA</div>
            <div id="btnPlanner" class="t-btn" onclick="switchView('planner')">‚è±Ô∏è PLANNER</div>
        </div>
        <div class="nav-icons">
            <span onclick="nav('news')">üì∞</span>
            <span onclick="nav('sos')">üö®</span>
        </div>
    </header>

    <div class="content-container">
        
        <div id="view-list">
            
            <div class="hero-section">
                <h1>Halo Sahabat MLU!</h1>
                <p id="userLocText">Mencari lokasi Anda...</p>
            </div>
            
            <div id="plannerSection" class="hero-section" style="padding-top:0; margin-bottom:10px; display:none;">
                <div class="planner-card">
                    <h2 style="font-size:1.1rem; color:var(--accent); margin:0 0 15px 0; font-weight:800; letter-spacing:0.5px;">PERENCANA WAKTU</h2>

                    <div class="input-group">
                        <label for="startLoc">Lokasi Awal</label>
                        <input type="text" id="startLoc" placeholder="Masukkan Alamat Awal">
                        <button class="btn-input-append" onclick="setUserLocationAsStart()">Lokasi Saya</button>
                    </div>
                    
                    <div class="input-group" style="margin-top:10px;">
                        <label for="soc">Sisa Baterai (SOC)</label>
                        <input type="number" id="soc" value="80" min="5" max="100">
                        <span class="unit-append">%</span>
                    </div>

                    <div class="input-group" style="margin-top:10px;">
                        <label for="destLoc">Lokasi Tujuan</label>
                        <input type="text" id="destLoc" placeholder="Masukkan Alamat Tujuan">
                    </div>

                    <button class="btn-plan" onclick="planTrip()">RENCANAKAN RUTE üó∫Ô∏è</button>
                </div>
            </div>
            <div id="charger-lists">
                </div>
            
        </div>

        <div id="view-map">
            <div id="map-container">
                </div>
        </div>

    </div>

    <div id="mapOverlay" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('mapOverlay').classList.remove('active');">‚úï</span>
            <h2 id="mapTitle"></h2>
            <p id="mapSub"></p>
            <div id="map"></div>
            <div class="modal-actions">
                <button id="btnBack" onclick="document.getElementById('mapOverlay').classList.remove('active');">KEMBALI</button>
                <a id="btnGmaps" target="_blank">LIHAT DI GOOGLE MAPS ‚Üó</a>
            </div>
        </div>
    </div>
    
    <div id="modal-news" class="modal">
        <span class="modal-close" onclick="closeModal()">‚úï</span>
        <h2>BERITA & INFO</h2>
        <p>Informasi terbaru dari MAKA FastCharging:</p>
        <ul>
            <li>**2025/11/01:** Jaringan di Jawa Timur diperluas ke 5 kota baru.</li>
            <li>**2025/10/15:** Skema harga baru untuk charging malam hari (Midnight Rate).</li>
            <li>**2025/09/28:** Integrasi dengan sistem pembayaran QRIS telah aktif.</li>
        </ul>
        <p>Selalu cek notifikasi resmi kami untuk detail lebih lanjut.</p>
    </div>

    <div id="modal-sos" class="modal">
        <span class="modal-close" onclick="closeModal()">‚úï</span>
        <h2>LAYANAN DARURAT (SOS)</h2>
        <p>Jika Anda mengalami masalah saat charging atau darurat di jalan:</p>
        <ul>
            <li>**Hubungi Call Center:** +62 21 8000 7777 (24 Jam)</li>
            <li>**Bantuan Teknis Charger:** Laporkan kode ID charger ke petugas.</li>
            <li>**Roadside Assistance:** Tekan tombol ini untuk meminta bantuan derek terdekat.</li>
        </ul>
        <div style="margin-top: 20px;">
             <button style="width: 100%; padding: 15px; background: var(--danger); color: #fff; border: none; border-radius: 12px; font-weight: 800; cursor: pointer;">PANGGIL BANTUAN SEKARANG</button>
        </div>
    </div>


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script>
        
        // --- KONFIGURASI API & DATA ---
        // Ganti dengan API Key JAWG Anda untuk Map Tiles
        const JAWG_API = "l1PdBwk1arfZcY7wECff2jE2Ts7qpJyMqGGqHK8cjCxcLb6m0FPHm1sExB5NvLyA"; 
        
        // URL Data Lokasi FC Anda dari Google Sheet (REAL DATA)
        const URL_LOKASI = "https://docs.google.com/spreadsheets/d/1EJOTMMfGpBMFPqR0LzbMbh7tZUcTCZld4x387OO9aJM/export?format=csv"; 
        
        let map = null;
        let userLat = null;
        let userLng = null;
        const scrollState = {};
        let chargers = []; // Data FC akan dimuat di sini

        const MIN_RANGE_KM = 5; // Jarak buffer 5km untuk planner
        
        // --- HELPER FUNCTIONS ---

        // Menghitung jarak garis lurus (Haversine)
        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius bumi dalam km
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return (R * c).toFixed(1);
        }
        
        // Helper: Geocoding (Alamat ke Koordinat) menggunakan Nominatim (GRATIS)
        async function geocodeAddress(address) {
            try {
                // Menggunakan Nominatim (OpenStreetMap) Geocoding API
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`;
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'MAKA-FastCharging-App/1.0'
                    }
                });
                const data = await response.json();
                
                if (data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lng = parseFloat(result.lon);
                    
                    return { lat: lat, lng: lng, address: result.display_name }; 
                }
                
                return null;

            } catch(error) {
                console.error("Geocoding (Nominatim) error:", error);
                return null;
            }
        }
        
        // Helper: Hitung Jarak Rute (bukan jarak garis lurus)
        async function getRouteDistance(start, end) {
            // Menggunakan OSRM (Open Source Routing Machine) untuk jarak rute (GRATIS)
            const OSRM_URL = `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=false`;
            
            try {
                const response = await fetch(OSRM_URL);
                const data = await response.json();
                
                if (data.code === 'Ok' && data.routes.length > 0) {
                    const distanceKm = data.routes[0].distance / 1000;
                    return distanceKm;
                }
                return null; 
            } catch(error) {
                console.error("OSRM Routing error:", error);
                return null;
            }
        }
        
        // --- DATA LOAD ---
        
        async function loadDataBackground() {
            try {
                const txtLoc = await fetch(URL_LOKASI).then(r=>r.text());

                // Parsing CSV data dari Google Sheet (Menggunakan format asli Anda: Name, City, Type, Status, Lat, Lng)
                chargers = txtLoc.split('\n').slice(1).map((r, i) => {
                    const c = r.split(',');
                    let latVal = parseFloat(c[4]);
                    let lngVal = parseFloat(c[5]);
                    
                    // Validasi data
                    if(c.length < 5 || isNaN(latVal) || isNaN(lngVal)) return null; 

                    return { 
                        id: `FC-${i}`,
                        name: c[0], 
                        city: c[1], 
                        type: c[2],
                        // Status harus huruf kecil untuk class CSS
                        status: c[3] ? c[3].toLowerCase() : 'available', 
                        lat: latVal, 
                        lng: lngVal, 
                        distance: '--' 
                    };
                }).filter(i=>i);

                getUserLocation(); // Setelah data dimuat, dapatkan lokasi user dan render list

            } catch(e) {
                console.error("Gagal memuat data lokasi:", e);
                chargers = []; 
                getUserLocation(); 
            }
        }

            // Lanjutan dari Script Bagian 1/3 (Tarik data dari Google Sheet)

        // --- PLANNER ACTIONS ---

        // Action: Set Lokasi Pengguna sebagai Awal
        function setUserLocationAsStart() {
            if (userLat && userLng) {
                document.getElementById('startLoc').value = `${userLat.toFixed(6)}, ${userLng.toFixed(6)}`;
                alert('Lokasi Anda berhasil diatur sebagai lokasi awal.');
            } else {
                alert('GPS belum terdeteksi. Harap tunggu atau masukkan koordinat/alamat manual.');
            }
        }

        // Action: Rencanakan Perjalanan (Logika Inti)
        async function planTrip() {
            const startAddr = document.getElementById('startLoc').value;
            const soc = parseFloat(document.getElementById('soc').value);
            const destAddr = document.getElementById('destLoc').value;
            
            if (!startAddr || !destAddr || isNaN(soc) || soc < 5 || soc > 100) {
                alert('Harap isi Lokasi Awal, Sisa Baterai (5-100%), dan Lokasi Tujuan dengan benar.');
                return;
            }
            
            // 1. Geocode Lokasi Awal
            let startLoc;
            if (startAddr.includes(',')) { 
                const parts = startAddr.split(',').map(s => parseFloat(s.trim()));
                if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                     startLoc = { lat: parts[0], lng: parts[1], address: startAddr };
                }
            }
            if(!startLoc) { 
                startLoc = await geocodeAddress(startAddr);
            }
            if (!startLoc) {
                alert(`Gagal menemukan koordinat untuk Lokasi Awal: ${startAddr}`);
                return;
            }
            
            // 2. Geocode Lokasi Tujuan
            const destLoc = await geocodeAddress(destAddr);
            if (!destLoc) {
                alert(`Gagal menemukan koordinat untuk Lokasi Tujuan: ${destAddr}`);
                return;
            }
            
            // 3. Hitung Jarak Daya Jelajah
            const rangeKm = soc - MIN_RANGE_KM; 
            if (rangeKm < 0) {
                 alert(`Sisa Baterai terlalu rendah (${soc}%). Perjalanan dibatalkan.`);
                 return;
            }

            // 4. Hitung Jarak Rute Langsung
            const directDistKm = await getRouteDistance(startLoc, destLoc);
            if (directDistKm === null) {
                alert('Gagal menghitung jarak rute langsung. Coba lagi.');
                return;
            }
            
            // 5. Tentukan Rencana (A atau B)
            let finalRoute = [];
            let routeSummary = "";
            let finalStart = startLoc;
            let finalDest = destLoc;
            
            const isRangeSufficient = directDistKm <= rangeKm;
            
            if (isRangeSufficient) {
                // A. Rute Langsung (Baterai Cukup)
                routeSummary = `‚úÖ **Rute Langsung (Baterai Cukup).**\nTotal Jarak: **${directDistKm.toFixed(1)} km**\n\n**Rute:**\n${startLoc.address} \n$\rightarrow$ ${destLoc.address}`;
                finalRoute = [startLoc, destLoc];

            } else {
                // B. Rute Via FC (Baterai Tidak Cukup)
                
                // Cari FC Terdekat dari Lokasi Awal
                let nearestFC = null;
                let minDist = Infinity;
                chargers.forEach(c => {
                    const dist = parseFloat(getDist(startLoc.lat, startLoc.lng, c.lat, c.lng));
                    if (dist < minDist) {
                        minDist = dist;
                        nearestFC = c;
                    }
                });
                
                if (!nearestFC) {
                    alert('Tidak ditemukan FC terdekat dari lokasi Anda. Perjalanan via FC dibatalkan.');
                    return;
                }
                
                const fcLoc = { lat: nearestFC.lat, lng: nearestFC.lng, address: nearestFC.name };
                
                // Hitung Jarak Rute Awal -> FC
                const startToFCDist = await getRouteDistance(startLoc, fcLoc);
                if (startToFCDist === null) {
                    alert('Gagal menghitung jarak rute ke FC. Coba lagi.');
                    return;
                }
                
                // Cek apakah jarak ke FC cukup dengan baterai saat ini
                if (startToFCDist > rangeKm) {
                    alert(`‚ùå **Baterai Tidak Cukup.** Jarak ke FC terdekat (${nearestFC.name}) adalah ${startToFCDist.toFixed(1)} km, melebihi daya jelajah Anda (${rangeKm.toFixed(1)} km). Perjalanan tidak aman.`);
                    return;
                }
                
                // Rute Awal -> FC -> Tujuan
                const fcToDestDist = await getRouteDistance(fcLoc, destLoc);
                if (fcToDestDist === null) {
                    alert('Gagal menghitung jarak rute FC ke Tujuan. Coba lagi.');
                    return;
                }
                
                const totalDist = startToFCDist + fcToDestDist;
                
                routeSummary = `‚ö†Ô∏è **Rute Via FC (Baterai Tidak Cukup).**\nTotal Jarak: **${totalDist.toFixed(1)} km**\n\n**Rute:**\n${startLoc.address} \n$\rightarrow$ **${nearestFC.name} (FC)** \n$\rightarrow$ ${destLoc.address}`;
                finalRoute = [startLoc, fcLoc, destLoc];
                
            }
            
            // 6. Tampilkan Rute di Map Modal
            openPlanMapModal(finalRoute, routeSummary, finalStart, finalDest);
        }
        
        // --- MAP FUNCTIONS (PLANNER & SINGLE) ---
        
        let routingControl = null;
        
        // Fungsi untuk menampilkan Rute Terencana (3 titik atau lebih)
        function openPlanMapModal(waypoints, summary, finalStart, finalDest) {
            document.getElementById('mapOverlay').classList.add('active');
            document.getElementById('mapTitle').innerText = 'Rute Perjalanan Terencana';
            document.getElementById('mapSub').innerHTML = summary.replace(/\n/g, '<br>');
            
            const gmapsUrl = `https://www.google.com/maps/dir/${finalStart.lat},${finalStart.lng}/${finalDest.lat},${finalDest.lng}`;
            document.getElementById('btnGmaps').href = gmapsUrl;
            document.getElementById('btnGmaps').innerText = 'MULAI JALAN (GOOGLE MAPS) ‚Üó';
            
            setTimeout(() => {
                if(map) { map.remove(); map = null; }
                
                map = L.map('map', {zoomControl: false}).setView([waypoints[0].lat, waypoints[0].lng], 10);
                L.tileLayer(`https://tile.jawg.io/jawg-matrix/{z}/{x}/{y}{r}.png?access-token=${JAWG_API}`, {}).addTo(map);

                if (routingControl) {
                    map.removeControl(routingControl);
                    routingControl = null;
                }
                
                const leafletWaypoints = waypoints.map(w => L.latLng(w.lat, w.lng));
                
                routingControl = L.Routing.control({
                    waypoints: leafletWaypoints,
                    lineOptions: { styles: [{color: '#CCFF00', opacity: 0.9, weight: 6}] },
                    createMarker: function(i, waypoint, n) { 
                        let iconColor = '#FF3B30'; // Merah (Start)
                        if (i === n - 1) iconColor = '#06c258'; // Hijau (End)
                        else if (n > 2 && i === 1) iconColor = '#00d2ff'; // Biru Cyan (FC)

                        const customIcon = L.divIcon({
                            html: `<div style="background:${iconColor}; width:15px; height:15px; border-radius:50%; border:3px solid #000; box-shadow:0 0 10px rgba(0,0,0,0.5);"></div>`,
                            className: 'custom-marker',
                            iconSize: [15, 15],
                            iconAnchor: [7.5, 7.5]
                        });
                        
                        return L.marker(waypoint.latLng, {icon: customIcon})
                                .bindPopup(waypoints[i].address);
                    },
                    addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true, show: false
                }).addTo(map);
                
                routingControl.on('routesfound', function(e) {
                    var routes = e.routes;
                    map.fitBounds(routes[0].bounds);
                });

            }, 300);
        }
                // Lanjutan dari Script Bagian 2/3

        // Buka modal map untuk rute ke satu charger
        function openMapModal(charger) {
            document.getElementById('mapOverlay').classList.add('active');
            document.getElementById('mapTitle').innerText = charger.name;
            document.getElementById('mapSub').innerText = `Jarak: ${charger.distance} km | Status: ${charger.status.toUpperCase()}`;
            
            if (userLat && userLng) {
                 const gmapsUrl = `https://www.google.com/maps/dir/${userLat},${userLng}/${charger.lat},${charger.lng}`;
                 document.getElementById('btnGmaps').href = gmapsUrl;
                 document.getElementById('btnGmaps').innerText = 'NAVIGASI (GOOGLE MAPS) ‚Üó';
            } else {
                 document.getElementById('btnGmaps').href = `https://www.google.com/maps/@${charger.lat},${charger.lng},15z`;
                 document.getElementById('btnGmaps').innerText = 'LIHAT DI GOOGLE MAPS ‚Üó';
            }

            setTimeout(() => {
                if(map) { map.remove(); map = null; }
                
                map = L.map('map', {zoomControl: false}).setView([charger.lat, charger.lng], 13);
                L.tileLayer(`https://tile.jawg.io/jawg-matrix/{z}/{x}/{y}{r}.png?access-token=${JAWG_API}`, {}).addTo(map);

                if (routingControl) {
                    map.removeControl(routingControl);
                    routingControl = null;
                }

                if (userLat && userLng) {
                     routingControl = L.Routing.control({
                        waypoints: [
                            L.latLng(userLat, userLng),
                            L.latLng(charger.lat, charger.lng)
                        ],
                        routeWhileDragging: false,
                        lineOptions: { styles: [{color: '#CCFF00', opacity: 0.8, weight: 6}] },
                        createMarker: function(i, waypoint, n) { return null; },
                        fitSelectedRoutes: true,
                        show: false
                    }).addTo(map);
                    
                    routingControl.on('routesfound', function(e) {
                        var routes = e.routes;
                        map.fitBounds(routes[0].bounds);
                    });
                    
                } else {
                    L.marker([charger.lat, charger.lng]).addTo(map).bindPopup(charger.name).openPopup();
                }

            }, 300);
        }
        
        // Inisialisasi peta utama
        function initFullMap() {
            if (map) { map.remove(); map = null; }
            if (chargers.length === 0) return;
            
            const centerLat = userLat || chargers[0].lat;
            const centerLng = userLng || chargers[0].lng;
            
            map = L.map('map-container', {zoomControl: false}).setView([centerLat, centerLng], 12);
            L.tileLayer(`https://tile.jawg.io/jawg-matrix/{z}/{x}/{y}{r}.png?access-token=${JAWG_API}`, {}).addTo(map);
            
            chargers.forEach(c => {
                 const statusClass = c.status;
                 let iconColor = statusClass === 'available' ? '#CCFF00' : statusClass === 'busy' ? '#FF3B30' : '#888';
                 
                 const customIcon = L.divIcon({
                    html: `<div style="background:${iconColor}; width:15px; height:15px; border-radius:50%; border:3px solid #000; box-shadow:0 0 10px rgba(0,0,0,0.5);"></div>`,
                    className: 'custom-marker',
                    iconSize: [15, 15],
                    iconAnchor: [7.5, 7.5]
                });

                L.marker([c.lat, c.lng], {icon: customIcon})
                 .addTo(map)
                 .bindPopup(`<b>${c.name}</b><br>${c.city}<br>Status: ${statusClass}`);
            });

            if (userLat && userLng) {
                const userIcon = L.divIcon({
                    html: `<div style="background:#00d2ff; width:20px; height:20px; border-radius:50%; border:3px solid #000; box-shadow:0 0 10px rgba(0,0,0,0.8);"></div>`,
                    className: 'custom-marker',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                L.marker([userLat, userLng], {icon: userIcon})
                 .addTo(map)
                 .bindPopup("Lokasi Saya");
            }
        }


        // Render List Charger
        function renderChargers(data) {
            const container = document.getElementById('charger-lists');
            container.innerHTML = ''; 

            const grouped = data.reduce((acc, charger) => {
                (acc[charger.city] = acc[charger.city] || []).push(charger);
                return acc;
            }, {});

            for (const city in grouped) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'list-group';
                groupDiv.innerHTML = `<div class="city-title">${city}</div><div class="h-scroll" data-city="${city}"></div>`;
                
                const scrollContainer = groupDiv.querySelector('.h-scroll');
                scrollContainer.addEventListener('scroll', function() {
                    scrollState[city] = this.scrollLeft;
                });
                
                grouped[city].forEach(c => {
                    const statusClass = c.status;
                    const card = document.createElement('div');
                    card.className = 'charger-card';
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-title">${c.name}</div>
                            <div class="status-badge ${statusClass}">${statusClass.toUpperCase()}</div>
                        </div>
                        <div class="card-info">ID: <span>${c.id}</span></div>
                        <div class="card-info">Tipe: <span>${c.type}</span></div>
                        <div class="card-info">Jarak: <span>${c.distance} km</span></div>
                        <div class="card-actions">
                            <button class="btn-map" onclick='openMapModal(${JSON.stringify(c)})'>PETA</button>
                            <button class="btn-route" onclick='openMapModal(${JSON.stringify(c)})'>RUTE</button>
                        </div>
                    `;
                    scrollContainer.appendChild(card);
                });
                container.appendChild(groupDiv);
            }
            restoreScrollState();
        }

        // Switch View (List/Map/Planner)
        function switchView(mode) {
            const listBtn = document.getElementById('btnList');
            const mapBtn = document.getElementById('btnMap');
            const plannerBtn = document.getElementById('btnPlanner'); 
            
            const plannerSection = document.getElementById('plannerSection'); 
            const heroSection = document.querySelector('.hero-section'); 
            
            const listView = document.getElementById('view-list');
            const mapView = document.getElementById('view-map');
            const chargerLists = document.getElementById('charger-lists');
            
            document.querySelectorAll('.t-btn').forEach(btn => btn.classList.remove('active'));
            
            heroSection.style.display = 'block'; 
            plannerSection.style.display = 'none'; 
            chargerLists.style.display = 'block'; 
            
            if(mode === 'list') {
                listBtn.classList.add('active');
                listView.style.display = 'flex'; mapView.style.display = 'none';
                
            } else if(mode === 'map') {
                mapBtn.classList.add('active'); 
                listView.style.display = 'none'; mapView.style.display = 'block';
                initFullMap();
            } else if(mode === 'planner') { 
                plannerBtn.classList.add('active');
                listView.style.display = 'flex'; mapView.style.display = 'none';
                heroSection.style.display = 'none'; 
                plannerSection.style.display = 'block';
                chargerLists.style.display = 'none'; 
            }
        }

        // Dapatkan Lokasi Pengguna (GPS)
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLat = position.coords.latitude;
                        userLng = position.coords.longitude;
                        document.getElementById('userLocText').innerText = `Lokasi Anda: ${userLat.toFixed(4)}, ${userLng.toFixed(4)}`;
                        
                        const updatedChargers = chargers.map(c => ({
                            ...c,
                            distance: getDist(userLat, userLng, c.lat, c.lng)
                        })).sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance)); 
                        
                        renderChargers(updatedChargers);
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        document.getElementById('userLocText').innerText = "Lokasi tidak terdeteksi. Jarak menggunakan data default.";
                        renderChargers(chargers); 
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                document.getElementById('userLocText').innerText = "Geolocation tidak didukung browser ini. Jarak menggunakan data default.";
                renderChargers(chargers); 
            }
        }
        
        // --- MODAL & NAVIGASI ---

        function nav(p) {
            document.querySelectorAll('.modal').forEach(m=>m.classList.remove('show'));
            if(p==='news') document.getElementById('modal-news').classList.add('show');
            if(p==='sos') document.getElementById('modal-sos').classList.add('show');
        }
        function closeModal() { document.querySelectorAll('.modal').forEach(m=>m.classList.remove('show')); }

        // --- ANIMASI & INIT ---
        
        function restoreScrollState() {
            document.querySelectorAll('.list-group').forEach(group => {
                const title = group.querySelector('.city-title').innerText;
                if(scrollState[title]) group.querySelector('.h-scroll').scrollLeft = scrollState[title];
            });
        }

        function animateText(id, txt, delay) {
            const el = document.getElementById(id);
            el.innerHTML = txt.split('').map(l => `<span class="letter">${l===' '?'¬†':l}</span>`).join('');
            const letters = el.querySelectorAll('.letter');
            let i=0; return new Promise(r=>{ const t=setInterval(()=>{ if(i<letters.length){letters[i].classList.add('active');i++}else{clearInterval(t);r()} }, delay) });
        }
        
        async function runIntro() {
            await animateText('animText1', "SELAMAT DATANG", 40);
            await animateText('animText2', "SAHABAT MLU", 30);
            document.getElementById('animText3').style.opacity = '1'; 
            setTimeout(() => { document.querySelector('.loader-actions').classList.add('show'); }, 500);
            loadDataBackground(); // Memuat data lokasi FC dari Google Sheet
        }
        
        runIntro(); 
        
    </script>
</body>
</html>
