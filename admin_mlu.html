<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin MLU - Database</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">
<style>
/* STYLE KHUSUS ADMIN */
body {
  background-color: #050505; color: #fff; font-family: 'Rajdhani', sans-serif; padding: 20px;
}
h2 { color: #00f0ff; font-family: 'Orbitron', sans-serif; text-align: center; }
.controls { max-width: 800px; margin: 0 auto 20px auto; display: flex; justify-content: space-between; align-items: center; }
.count { font-weight: bold; color: #aaa; }
button {
  padding: 10px 20px; background: #00f0ff; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-family: 'Orbitron', sans-serif;
}
button:hover { background: #00c3ff; box-shadow: 0 0 10px #00f0ff; }

/* TABLE STYLE */
.table-responsive { overflow-x: auto; max-width: 800px; margin: auto; border: 1px solid #333; border-radius: 8px; }
table { width: 100%; border-collapse: collapse; background: #111; min-width: 600px; }
th, td { padding: 12px; text-align: left; border-bottom: 1px solid #222; }
th { background: #1a1a1a; color: #00f0ff; font-family: 'Orbitron', sans-serif; font-size: 14px; }
tr:hover { background: #1f1f1f; }
.loading { text-align: center; color: #666; padding: 20px; }
.error-msg { color: #ff3333; text-align: center; padding: 20px; font-weight: bold; }
</style>
</head>
<body>

<h2>DATABASE ANGGOTA MLU</h2>

<div class="controls">
  <span class="count" id="totalData">Total: 0 Anggota</span>
  <button onclick="downloadExcel()">DOWNLOAD EXCEL (.CSV)</button>
</div>

<div class="table-responsive">
  <table id="tabelAnggota">
    <thead>
      <tr>
        <th>NAMA</th>
        <th>WHATSAPP</th>
        <th>DOMISILI</th>
        <th>LINTAS</th>
        <th>TGL DAFTAR</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="5" class="loading">Menghubungkan ke Database...</td></tr>
    </tbody>
  </table>
</div>

<script type="module">
  // CONFIG SUDAH SAYA ISI SESUAI PUNYA KAMU
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
      apiKey: "AIzaSyB666i9lYWIpxOdkwpoX9EvFvHLmHczeq8",
      authDomain: "fcgadingnew22.firebaseapp.com",
      projectId: "fcgadingnew22",
      storageBucket: "fcgadingnew22.firebasestorage.app",
      messagingSenderId: "537736846678",
      appId: "1:537736846678:web:53788d71a196423ac08af7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  let allData = [];

  // 1. FUNGSI LOAD DATA
  async function loadData() {
    const tbody = document.getElementById("tbody");
    try {
      // SAYA HAPUS "orderBy" DULU SUPAYA JAMINAN MUNCUL (Kadang orderBy bikin error kalau index belum siap)
      const q = collection(db, "anggota_mlu"); 
      const snapshot = await getDocs(q);
      
      let html = "";
      allData = []; 
      let count = 0;

      if (snapshot.empty) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px;">DATABASE MASIH KOSONG<br><small>(Coba isi form dulu)</small></td></tr>';
        return;
      }

      snapshot.forEach(doc => {
        const d = doc.data();
        allData.push(d);
        count++;
        
        // Format Tanggal (Cek apakah ada datanya)
        let tglTampil = "-";
        if (d.tgl) {
            tglTampil = new Date(d.tgl).toLocaleDateString("id-ID") + " " + new Date(d.tgl).toLocaleTimeString("id-ID");
        }
        
        html += `
          <tr>
            <td><strong>${d.nama || '-'}</strong></td>
            <td><a href="https://wa.me/${d.hp ? d.hp.replace(/^0/, '62') : ''}" target="_blank" style="color:#00f0ff;text-decoration:none">${d.hp || '-'}</a></td>
            <td>${d.alamat || '-'}</td>
            <td>${d.lintas || '-'}</td>
            <td style="font-size:12px; color:#888;">${tglTampil}</td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
      document.getElementById("totalData").innerText = "Total: " + count + " Anggota";

    } catch (e) {
      console.error("ERROR ADMIN:", e);
      tbody.innerHTML = `<tr><td colspan="5" class="error-msg">
        GAGAL MEMUAT DATA!<br>
        <small>${e.message}</small><br><br>
        Tips: Cek tab "Rules" di Firebase Console kamu.
      </td></tr>`;
    }
  }

  // 2. FUNGSI DOWNLOAD
  window.downloadExcel = function() {
    if(allData.length === 0) { alert("Data masih kosong!"); return; }

    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Nama Lengkap,No HP,Alamat,Lintas,Waktu Daftar\r\n";

    allData.forEach(d => {
      const nama = (d.nama || "").replace(/,/g, " ");
      const hp = "'" + (d.hp || "");
      const alamat = (d.alamat || "").replace(/,/g, " ").replace(/\n/g, " ");
      const lintas = (d.lintas || "").replace(/,/g, " & ");
      const tgl = d.tgl ? new Date(d.tgl).toLocaleString("id-ID") : "-";

      csvContent += `${nama},${hp},${alamat},${lintas},${tgl}\r\n`;
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "Database_MLU.csv");
    document.body.appendChild(link);
    link.click();
  }

  loadData();
</script>

</body>
</html>
