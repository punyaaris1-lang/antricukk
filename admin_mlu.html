<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin MLU - Database</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">
<style>
/* STYLE ADMIN */
body { background-color: #050505; color: #fff; font-family: 'Rajdhani', sans-serif; padding: 20px; }
h2 { color: #00f0ff; font-family: 'Orbitron', sans-serif; text-align: center; margin-bottom: 20px; }
.controls { max-width: 1000px; margin: 0 auto 20px auto; display: flex; justify-content: space-between; align-items: center; background: #111; padding: 15px; border-radius: 8px; border: 1px solid #333; }
.count { font-weight: bold; color: #aaa; font-family: 'Orbitron', sans-serif; }
button { padding: 10px 20px; background: linear-gradient(45deg, #00c3ff, #00f0ff); border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-family: 'Orbitron', sans-serif; color: #000; }
button:hover { transform: translateY(-2px); box-shadow: 0 0 15px rgba(0, 240, 255, 0.6); }

.table-responsive { overflow-x: auto; max-width: 1000px; margin: auto; border: 1px solid #333; border-radius: 8px; }
table { width: 100%; border-collapse: collapse; background: #111; min-width: 900px; }
th, td { padding: 12px; text-align: left; border-bottom: 1px solid #222; }
th { background: #1a1a1a; color: #00f0ff; font-family: 'Orbitron', sans-serif; font-size: 13px; letter-spacing: 1px; }
tr:hover { background: #1f1f1f; }
.plat-cell { font-family: 'Orbitron', sans-serif; color: #ffcc00; font-weight: bold; }
.prog-cell { color: #0f0; font-weight: bold; }
.loading { text-align: center; color: #666; padding: 30px; }
</style>
</head>
<body>

<h2>DATABASE ANGGOTA MLU</h2>

<div class="controls">
  <span class="count" id="totalData">Total: 0 Anggota</span>
  <button onclick="downloadExcel()">DOWNLOAD EXCEL (.CSV)</button>
</div>

<div class="table-responsive">
  <table id="tabelAnggota">
    <thead>
      <tr>
        <th>NAMA</th>
        <th>WHATSAPP</th>
        <th>PLAT NOMOR</th>
        <th>PROGRAM</th> <th>DOMISILI</th>
        <th>LINTAS</th>
        <th>WAKTU DAFTAR</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="7" class="loading">Memuat data...</td></tr>
    </tbody>
  </table>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
      apiKey: "AIzaSyB666i9lYWIpxOdkwpoX9EvFvHLmHczeq8",
      authDomain: "fcgadingnew22.firebaseapp.com",
      projectId: "fcgadingnew22",
      storageBucket: "fcgadingnew22.firebasestorage.app",
      messagingSenderId: "537736846678",
      appId: "1:537736846678:web:53788d71a196423ac08af7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  let allData = [];

  async function loadData() {
    const tbody = document.getElementById("tbody");
    try {
      const q = collection(db, "anggota_mlu");
      const snapshot = await getDocs(q);
      
      let html = "";
      allData = []; 
      let count = 0;

      if (snapshot.empty) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px;">DATABASE KOSONG</td></tr>';
        return;
      }

      snapshot.forEach(doc => {
        const d = doc.data();
        allData.push(d);
        count++;
        
        const tglTampil = d.tgl ? new Date(d.tgl).toLocaleDateString("id-ID") : "-";
        
        html += `
          <tr>
            <td><strong>${d.nama || '-'}</strong></td>
            <td><a href="https://wa.me/${d.hp ? d.hp.replace(/^0/, '62').replace(/[^0-9]/g, '') : ''}" target="_blank" style="color:#00f0ff;text-decoration:none">${d.hp || '-'}</a></td>
            <td class="plat-cell">${d.plat || '-'}</td>
            <td class="prog-cell">${d.program || 'Umum'}</td> <td>${d.alamat || '-'}</td>
            <td>${d.lintas || '-'}</td>
            <td style="font-size:12px; color:#888;">${tglTampil}</td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
      document.getElementById("totalData").innerText = "Total: " + count + " Anggota";

    } catch (e) {
      console.error(e);
      tbody.innerHTML = `<tr><td colspan="7" style="color:red;text-align:center">Error: ${e.message}</td></tr>`;
    }
  }

  window.downloadExcel = function() {
    if(allData.length === 0) { alert("Data kosong!"); return; }

    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Nama Lengkap,No HP,Plat Nomor,Program,Alamat,Lintas,Waktu Daftar\r\n";

    allData.forEach(d => {
      const nama = (d.nama || "").replace(/,/g, " ");
      const hp = "'" + (d.hp || "");
      const plat = (d.plat || "").replace(/,/g, " ");
      const program = (d.program || "Umum").replace(/,/g, " "); // PROGRAM
      const alamat = (d.alamat || "").replace(/,/g, " ").replace(/\n/g, " ");
      const lintas = (d.lintas || "").replace(/,/g, " & ");
      const tgl = d.tgl ? new Date(d.tgl).toLocaleString("id-ID") : "-";

      csvContent += `${nama},${hp},${plat},${program},${alamat},${lintas},${tgl}\r\n`;
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "Database_MLU_Program.csv");
    document.body.appendChild(link);
    link.click();
  }

  loadData();
</script>

</body>
</html>
