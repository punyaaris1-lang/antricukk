<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PETA LOKASI</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;500;700&family=Rajdhani:wght@500;600;700;800;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --bg: #050505; 
            --primary: #00F0FF;       
            --primary-dim: rgba(0, 240, 255, 0.15);
            --accent: #FF003C;
            --gray-dark: #222;
            --gray-light: #555;
            
            --font-tech: 'Rajdhani', sans-serif;
            --font-num: 'Teko', sans-serif;
            --font-head: 'Orbitron', sans-serif;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: var(--bg); overflow: hidden; font-family: var(--font-tech); color: #fff; }

        /* HEADER (RAJDHANI BOLD) */
        .header-fixed {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
            background: linear-gradient(180deg, #000 0%, rgba(0,15,20,0.95) 70%, transparent 100%);
            padding: 20px; text-align: center; pointer-events: none;
            border-bottom: 1px solid rgba(0, 240, 255, 0.1);
        }
        .main-title { 
            font-family: var(--font-tech); font-weight: 800; font-size: 32px; color: #fff; 
            line-height: 1; text-shadow: 0 0 20px var(--primary); letter-spacing: 2px;
            text-transform: uppercase;
        }
        .sub-title { 
            font-family: var(--font-tech); font-size: 11px; color: var(--primary); 
            letter-spacing: 4px; font-weight: 700; text-transform: uppercase; margin-top: 5px;
            display: inline-block; border-bottom: 2px solid var(--primary); padding-bottom: 3px;
        }

        /* MAP */
        #map { width: 100%; height: 100vh; z-index: 1; background: #020205; }
        .leaflet-control-attribution { display: none; }

        /* --- MARKER DESIGN --- */
        .marker-wrapper {
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            width: 150px !important; height: auto !important;
            transform: translate(-50%, -100%);
        }

        /* LABEL NAMA (Kotak Hitam + Border Cyan) */
        .pin-label-box {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--primary);
            color: var(--primary);
            font-family: 'Teko', sans-serif;
            font-weight: 600; font-size: 16px; /* Font lebih besar */
            text-transform: uppercase; letter-spacing: 0.5px;
            padding: 2px 8px; border-radius: 4px;
            margin-bottom: 2px;
            white-space: nowrap;
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.3);
            text-align: center;
            z-index: 100;
        }

        /* PIN BASIC */
        .pin-body {
            width: 24px; height: 38px;
            background: linear-gradient(180deg, var(--primary) 0%, #000 90%);
            border: 1px solid #fff;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            box-shadow: 0 0 20px var(--primary);
            display: flex; align-items: center; justify-content: center;
        }
        .pin-body::after {
            content: ''; width: 6px; height: 6px; background: #fff;
            box-shadow: 0 0 5px #fff;
        }

        /* USER MARKER */
        .user-wrap { position: relative; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; }
        .user-pulse {
            position: absolute; width: 100%; height: 100%;
            border-radius: 50%; border: 2px solid var(--primary);
            opacity: 0; animation: pulse 1.5s infinite;
        }
        .user-img {
            width: 40px; height: 40px; border-radius: 50%;
            border: 2px solid #fff; box-shadow: 0 0 20px var(--primary);
            object-fit: cover; background: #000; position: relative; z-index: 2;
        }
        @keyframes pulse { 0% {transform: scale(0.5); opacity: 1;} 100% {transform: scale(1.5); opacity: 0;} }

        /* INFO CARD */
        .info-card {
            position: fixed; bottom: 100px; left: 15px; right: 15px; 
            background: #0a0a0a; border: 1px solid var(--primary); 
            padding: 20px; z-index: 1500; 
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
            transform: translateY(150%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 50px rgba(0, 240, 255, 0.1);
        }
        .info-card.active { transform: translateY(0); }
        .close-btn { position: absolute; top: 10px; right: 15px; color: #555; font-size: 24px; cursor: pointer; }
        
        .card-label { font-size: 10px; color: var(--primary); font-weight: 800; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; font-family: var(--font-head); }
        .card-title { font-family: var(--font-tech); font-weight: 800; font-size: 26px; line-height: 1; margin-bottom: 5px; color: #fff; text-transform: uppercase; }
        .card-sub { font-size: 14px; color: #aaa; margin-bottom: 15px; font-family: var(--font-tech); padding-bottom: 10px; border-bottom: 1px solid #333; }
        
        .btn-nav {
            display: block; width: 100%; padding: 12px; background: var(--primary); color: #000;
            text-align: center; font-family: var(--font-head); font-weight: 800; font-size: 16px;
            text-decoration: none; text-transform: uppercase; letter-spacing: 1px;
            clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
        }

        /* DOCK NAV */
        .dock-container {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 80px;
            background: rgba(2, 5, 8, 0.98); border-top: 2px solid var(--primary);
            display: grid; grid-template-columns: 1fr 1fr 1fr; align-items: center;
            z-index: 2000;
        }
        .nav-item { text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--gray-light); transition: 0.3s; height: 100%; }
        
        /* MENU TENGAH (ANTRIAN) - MATI/GREY */
        .nav-item.center-btn { transform: translateY(-30px); }
        .center-icon-box { 
            width: 65px; height: 65px; background: #000; 
            border: 2px solid var(--gray-light); /* Grey Border */
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 0 10px rgba(0,0,0,0.5); /* No Glow */
            font-size: 26px; color: var(--gray-light); /* Grey Icon */
            position: relative; z-index: 10;
        }
        
        /* MENU KIRI (PETA) - AKTIF/CYAN */
        .nav-item.active { color: var(--primary); text-shadow: 0 0 15px var(--primary); }
        .nav-icon { font-size: 22px; margin-bottom: 4px; }
        .nav-text { font-family: var(--font-head); font-size: 10px; letter-spacing: 2px; font-weight: 700; margin-top: 5px; }

    </style>
</head>
<body>

    <div class="header-fixed">
        <div class="main-title">TACTICAL MAP</div>
        <div class="sub-title">LIVE TRACKING SYSTEM</div>
    </div>

    <div id="map"></div>

    <div id="infoCard" class="info-card">
        <div class="close-btn" onclick="closeCard()">Ã—</div>
        <div class="card-label">LOKASI TERPILIH</div>
        <div class="card-title" id="fcName">...</div>
        <div class="card-sub" id="fcAddr">...</div>
        <a href="#" id="btnMaps" target="_blank" class="btn-nav">BUKA GOOGLE MAPS</a>
    </div>

    <div class="dock-container">
        <div class="nav-item active">
            <i class="fas fa-map-marked-alt nav-icon"></i><span class="nav-text">PETA FC</span>
        </div>
        
        <a href="system.html" class="nav-item center-btn">
            <div class="center-icon-box"><i class="fas fa-charging-station"></i></div>
            <span class="nav-text" style="margin-top:8px;">ANTRIAN</span>
        </a>
        
        <a href="plan.html" class="nav-item">
            <i class="fas fa-route nav-icon"></i><span class="nav-text">TRIP PLAN</span>
        </a>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        // 1. INIT MAP
        const map = L.map('map', {zoomControl: false}).setView([-6.2, 106.8], 11);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { 
            maxZoom: 19, opacity: 0.9 
        }).addTo(map);

        // 2. ICON USER
        const userIcon = L.divIcon({
            className: 'custom-user',
            html: `<div class="user-wrap"><div class="user-pulse"></div><img src="logo.png" class="user-img"></div>`,
            iconSize: [60, 60], iconAnchor: [30, 30]
        });
        
        // 3. DATA
        const SHEET_ID = '1EJOTMMfGpBMFPqR0LzbMbh7tZUcTCZld4x387OO9aJM'; 
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Sheet1`;

        let userLat = null, userLng = null;

        // 4. LOGIC
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                userLat = pos.coords.latitude;
                userLng = pos.coords.longitude;
                L.marker([userLat, userLng], {icon: userIcon, zIndexOffset: 1000}).addTo(map);
                map.setView([userLat, userLng], 14); 
                loadFCData(true);
            }, () => { loadFCData(false); });
        } else { loadFCData(false); }

        function loadFCData(hasUserLoc) {
            Papa.parse(CSV_URL, {
                download: true, header: true,
                complete: function(results) {
                    let nearestDist = Infinity;
                    let nearestFC = null;

                    results.data.forEach(row => {
                        let lat=null, lng=null, name="FC"; // Default FC

                        // --- FIX PENCARIAN NAMA (Cari kolom Nama/Lokasi/Station secara case-insensitive) ---
                        const keys = Object.keys(row);
                        for(let k of keys) {
                            let cleanKey = k.toLowerCase().trim();
                            if(cleanKey.includes('nama') || cleanKey.includes('lokasi') || cleanKey.includes('station')) {
                                if(row[k] && row[k].trim() !== "") {
                                    name = row[k]; // KETEMU! Update nama
                                    break;
                                }
                            }
                        }

                        // Parse Koordinat
                        Object.values(row).forEach(val => { if(val){ let v=String(val).replace(',','.'); if(!isNaN(parseFloat(v)) && parseFloat(v)<-5) lat=parseFloat(v); if(!isNaN(parseFloat(v)) && parseFloat(v)>95) lng=parseFloat(v); }});
                        
                        if (lat && lng) {
                            if(hasUserLoc) {
                                const dist = Math.sqrt(Math.pow(lat-userLat, 2) + Math.pow(lng-userLng, 2));
                                if(dist < nearestDist) { nearestDist = dist; nearestFC = { name, addr: row['Alamat'], lat, lng }; }
                            }

                            // GENERATE MARKER + LABEL
                            const fcIcon = L.divIcon({ 
                                className: 'custom-pin', 
                                html: `
                                    <div class="marker-wrapper">
                                        <div class="pin-label-box">${name}</div>
                                        <div class="pin-body"></div>
                                    </div>
                                `, 
                                iconSize: [150, 80], 
                                iconAnchor: [75, 80] 
                            });

                            const m = L.marker([lat, lng], {icon: fcIcon}).addTo(map);
                            m.on('click', () => showInfo(name, row['Alamat'] || "Detail lokasi belum tersedia", lat, lng));
                        }
                    });

                    if(nearestFC) {
                        showInfo(nearestFC.name, nearestFC.addr, nearestFC.lat, nearestFC.lng);
                    }
                }
            });
        }

        function showInfo(name, addr, lat, lng) {
            document.getElementById('fcName').innerText = name;
            document.getElementById('fcAddr').innerText = addr || "Alamat tidak tersedia";
            document.getElementById('btnMaps').href = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            document.getElementById('infoCard').classList.add('active');
        }
        function closeCard() { document.getElementById('infoCard').classList.remove('active'); }
    </script>
</body>
</html>
